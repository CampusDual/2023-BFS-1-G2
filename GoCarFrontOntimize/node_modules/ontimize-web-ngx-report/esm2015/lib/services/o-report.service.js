/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/o-report.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector } from "@angular/core";
import { Observable, OErrorDialogManager, OntimizeEEService, Util } from 'ontimize-web-ngx';
import { HttpEventType, HttpHeaders, HttpRequest } from "@angular/common/http";
import { share } from 'rxjs/operators';
import * as i0 from "@angular/core";
export class OReportService extends OntimizeEEService {
    /**
     * @param {?} injector
     */
    constructor(injector) {
        super(injector);
        this.injector = injector;
        super.configureService(this.getDefaultServiceConfiguration());
        this.oErrorDialogManager = injector.get(OErrorDialogManager);
    }
    /**
     * @param {?} reportparams
     * @return {?}
     */
    createReport(reportparams) {
        /** @type {?} */
        const body = JSON.stringify(reportparams);
        /** @type {?} */
        const url = this.urlBase + '/dynamicjasper/report';
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    }
    /**
     * @param {?=} preferencesparams
     * @return {?}
     */
    saveAsPreferences(preferencesparams) {
        /** @type {?} */
        const body = JSON.stringify(preferencesparams);
        /** @type {?} */
        const url = this.urlBase + '/preferences/save';
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    }
    /**
     * @param {?} id
     * @param {?=} preferencesparams
     * @return {?}
     */
    savePreferences(id, preferencesparams) {
        /** @type {?} */
        const body = JSON.stringify(preferencesparams);
        /** @type {?} */
        const url = this.urlBase + '/preferences/update/' + id;
        return this.doRequest({
            method: 'PUT',
            url: url,
            body: body
        });
    }
    /**
     * @param {?=} entity
     * @param {?=} service
     * @return {?}
     */
    getPreferences(entity, service) {
        /** @type {?} */
        const url = this.urlBase + '/preferences/preferences?entity=' + entity + '&service=' + service + "&type=REPORT";
        return this.doRequest({
            method: 'GET',
            url: url
        });
    }
    /**
     * @param {?=} functionparams
     * @return {?}
     */
    getFunctions(functionparams) {
        /** @type {?} */
        const body = JSON.stringify(functionparams);
        /** @type {?} */
        const url = this.urlBase + '/dynamicjasper/functionsName';
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    }
    /**
     * @param {?=} id
     * @return {?}
     */
    deletePreferences(id) {
        /** @type {?} */
        const url = this.urlBase + '/preferences/remove/' + id;
        return this.doRequest({
            method: 'DELETE',
            url: url
        });
    }
    /**
     * overridden method to add error callback for all requests
     * @param {?} param
     * @return {?}
     */
    doRequest(param) {
        return super.doRequest({
            method: param.method,
            url: param.url,
            body: param.body,
            errorCallBack: this.errorCallBack
        });
    }
    /**
     * @param {?} httpErrorResponse
     * @return {?}
     */
    errorCallBack(httpErrorResponse) {
        /** @type {?} */
        const error = httpErrorResponse.error;
        if (Util.isObject(error)) {
            if (error['code'] === 1 && Util.isDefined(error['message'])) {
                this.showNotificationError(error['message']);
                return;
            }
        }
        this.showNotificationError('MESSAGES.ERROR_QUERY');
    }
    /**
     * @param {?} error
     * @return {?}
     */
    showNotificationError(error) {
        this.oErrorDialogManager.openErrorDialog(error);
    }
    /**
     * @param {?} files
     * @param {?} entity
     * @param {?=} data
     * @return {?}
     */
    upload(files, entity, data) {
        /** @type {?} */
        const dataObservable = new Observable((/**
         * @param {?} observer
         * @return {?}
         */
        observer => {
            /** @type {?} */
            let url = `${this.urlBase}/reportstore/${entity}`;
            /** @type {?} */
            const toUpload = new FormData();
            files.forEach((/**
             * @param {?} item
             * @return {?}
             */
            item => {
                item.prepareToUpload();
                item.isUploading = true;
                toUpload.append('name', item.name);
                toUpload.append('file', item.file);
            }));
            if (data) {
                toUpload.append('data', JSON.stringify(data));
            }
            /** @type {?} */
            const request = new HttpRequest('POST', url, toUpload, {
                headers: this.buildHeadersReport(),
                reportProgress: true
            });
            this.httpClient.request(request).subscribe((/**
             * @param {?} resp
             * @return {?}
             */
            resp => {
                if (HttpEventType.UploadProgress === resp.type) {
                    // Upload progress event received
                    /** @type {?} */
                    const progressData = {
                        loaded: resp.loaded,
                        total: resp.total
                    };
                    observer.next(progressData);
                }
                else if (HttpEventType.Response === resp.type) {
                    // Full response received
                    if (resp.body) {
                        this.bodyCode(resp, observer);
                    }
                    else {
                        observer.next(resp.body);
                    }
                }
            }), (/**
             * @param {?} error
             * @return {?}
             */
            error => {
                console.error(error);
                if (error.status === 401) {
                    this.authService.logout();
                }
                else {
                    observer.error(error);
                }
            }), (/**
             * @return {?}
             */
            () => observer.complete()));
        }));
        return dataObservable.pipe(share());
    }
    /**
     * @protected
     * @param {?} resp
     * @param {?} observer
     * @return {?}
     */
    bodyCode(resp, observer) {
        if (resp.body['code'] === 3) {
            this.authService.logout();
        }
        else if (resp.body['code'] === 1) {
            observer.error(resp.body['message']);
        }
        else if (resp.body['code'] === 0) {
            // RESPONSE
            observer.next(resp.body);
        }
        else {
            // Unknow state -> error
            observer.error('Service unavailable');
        }
    }
    /**
     * @param {?=} _kv
     * @param {?=} _av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @param {?=} offset
     * @param {?=} _pagesize
     * @param {?=} _orderby
     * @return {?}
     */
    advancedQuery(_kv, _av, entity, _sqltypes, offset, _pagesize, _orderby) {
        offset = (Util.isDefined(offset)) ? offset : this.offset;
        // Calculate page
        /** @type {?} */
        let page = 0;
        if (Util.isDefined(offset)) {
            page = Math.trunc(offset / 10) + 1;
        }
        /** @type {?} */
        let url = this.urlBase + '/reportstore/' + entity + '/?format=json' + '&page=' + page;
        return this.doRequest({
            method: 'GET',
            url: url
        });
    }
    /**
     * @param {?=} kv
     * @param {?=} _av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    query(kv, _av, entity, _sqltypes) {
        /** @type {?} */
        const identifier = kv['UUID'];
        /** @type {?} */
        let url = '';
        if (Object.keys(kv).length === 0) {
            url = `${this.urlBase}/reportstore/${entity}`;
        }
        else {
            url = `${this.urlBase}/reportstore/${entity}/` + identifier;
        }
        return this.doRequest({
            method: 'GET',
            url: url
        });
    }
    /**
     * @param {?=} av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @param {?=} filter
     * @return {?}
     */
    fillReport(av, entity, _sqltypes, filter) {
        /** @type {?} */
        const identifier = av[0];
        /** @type {?} */
        let params = '';
        for (let i = 1; i < av.length; i++)
            params = params + av[i].toString() + ',';
        /** @type {?} */
        let body = JSON.stringify({
            params: params,
            filter: filter
        });
        /** @type {?} */
        let url = `${this.urlBase}/reportstore/${entity}/` + identifier;
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    }
    /**
     * @param {?=} kv
     * @param {?=} _entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    delete(kv, _entity, _sqltypes) {
        /** @type {?} */
        const identifier = kv.valueOf()[Object.keys(kv)[0]];
        /** @type {?} */
        let url = `${this.urlBase}/reportstore/removeReport/` + identifier;
        return this.doRequest({
            method: 'DELETE',
            url: url
        });
    }
    /**
     * @param {?=} kv
     * @param {?=} av
     * @param {?=} _entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    update(kv, av, _entity, _sqltypes) {
        /** @type {?} */
        const identifier = kv.valueOf()[Object.keys(kv)[0]];
        /** @type {?} */
        let url = `${this.urlBase}/reportstore/updateReport/` + identifier;
        return this.doRequest({
            method: 'PUT',
            url: url,
            body: av
        });
    }
    /**
     * @protected
     * @return {?}
     */
    buildHeadersReport() {
        /** @type {?} */
        let headers = new HttpHeaders({ 'Access-Control-Allow-Origin': '*' });
        /** @type {?} */
        const sessionId = this.authService.getSessionInfo().id;
        if (Util.isDefined(sessionId)) {
            headers = headers.append('Authorization', 'Bearer ' + sessionId);
        }
        return headers;
    }
}
OReportService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
/** @nocollapse */
OReportService.ctorParameters = () => [
    { type: Injector }
];
/** @nocollapse */ OReportService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function OReportService_Factory() { return new OReportService(i0.ɵɵinject(i0.INJECTOR)); }, token: OReportService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @protected
     */
    OReportService.prototype.oErrorDialogManager;
    /**
     * @type {?}
     * @protected
     */
    OReportService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1yZXBvcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gtcmVwb3J0LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL28tcmVwb3J0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyRCxPQUFPLEVBQUUsVUFBVSxFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUF3QyxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsSSxPQUFPLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBSXZDLE1BQU0sT0FBTyxjQUFlLFNBQVEsaUJBQWlCOzs7O0lBR25ELFlBQXNCLFFBQWtCO1FBQ3RDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQURJLGFBQVEsR0FBUixRQUFRLENBQVU7UUFFdEMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLG1CQUFtQixHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQXNCLG1CQUFtQixDQUFDLENBQUM7SUFDcEYsQ0FBQzs7Ozs7SUFFTSxZQUFZLENBQUMsWUFBMEI7O2NBRXRDLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUN6QixZQUFZLENBQ2I7O2NBQ0ssR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLEdBQUcsdUJBQXVCO1FBRWxELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNwQixNQUFNLEVBQUUsTUFBTTtZQUNkLEdBQUcsRUFBRSxHQUFHO1lBQ1IsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDLENBQUM7SUFDTCxDQUFDOzs7OztJQUVNLGlCQUFpQixDQUFDLGlC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QUFHLFVBQVU7UUFFbEUsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ3BCLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLEdBQUcsRUFBRSxHQUFHO1NBQ1QsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7Ozs7Ozs7SUFFTSxNQUFNLENBQUMsRUFBVyxFQUFFLEVBQWtCLEVBQUUsT0FBZ0IsRUFBRSxTQUFrQjs7Y0FDM0UsVUFBVSxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDOztZQUMvQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyw0QkFBNEIsR0FBRyxVQUFVO1FBRWxFLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNwQixNQUFNLEVBQUUsS0FBSztZQUNiLEdBQUcsRUFBRSxHQUFHO1lBQ1IsSUFBSSxFQUFFLEVBQUU7U0FDVCxDQUFDLENBQUM7SUFDTCxDQUFDOzs7OztJQUVTLGtCQUFrQjs7WUFDdEIsT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDLEVBQUUsNkJBQTZCLEVBQUUsR0FBRyxFQUFFLENBQUM7O2NBQy9ELFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsRUFBRSxDQUFDLEVBQUU7UUFDdEQsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQzdCLE9BQU8sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxTQUFTLEdBQUcsU0FBUyxDQUFDLENBQUM7U0FDbEU7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOzs7WUFoUUYsVUFBVSxTQUFDLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRTs7OztZQVBiLFFBQVE7Ozs7Ozs7O0lBUzNCLDZDQUFtRDs7Ozs7SUFFdkMsa0NBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgT1JlcG9ydFBhcmFtIH0gZnJvbSBcIi4uL3R5cGVzL3JlcG9ydC1wYXJhbS50eXBlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBPRXJyb3JEaWFsb2dNYW5hZ2VyLCBPbnRpbWl6ZUVFU2VydmljZSwgU2VydmljZVJlcXVlc3RQYXJhbSwgU2VydmljZVJlc3BvbnNlLCBVdGlsIH0gZnJvbSAnb250aW1pemUtd2ViLW5neCc7XG5pbXBvcnQgeyBIdHRwRXZlbnRUeXBlLCBIdHRwSGVhZGVycywgSHR0cFJlcXVlc3QgfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uL2h0dHBcIjtcbmltcG9ydCB7IHNoYXJlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgT1JlcG9ydFNlcnZpY2UgZXh0ZW5kcyBPbnRpbWl6ZUVFU2VydmljZSB7XG4gIHByb3RlY3RlZCBvRXJyb3JEaWFsb2dNYW5hZ2VyOiBPRXJyb3JEaWFsb2dNYW5hZ2VyO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICBzdXBlcihpbmplY3Rvcik7XG4gICAgc3VwZXIuY29uZmlndXJlU2VydmljZSh0aGlzLmdldERlZmF1bHRTZXJ2aWNlQ29uZmlndXJhdGlvbigpKTtcbiAgICB0aGlzLm9FcnJvckRpYWxvZ01hbmFnZXIgPSBpbmplY3Rvci5nZXQ8T0Vycm9yRGlhbG9nTWFuYWdlcj4oT0Vycm9yRGlhbG9nTWFuYWdlcik7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlUmVwb3J0KHJlcG9ydHBhcmFtczogT1JlcG9ydFBhcmFtKTogT2JzZXJ2YWJsZTxhbnk+IHtcblxuICAgIGNvbnN0IGJvZHkgPSBKU09OLnN0cmluZ2lmeShcbiAgICAgIHJlcG9ydHBhcmFtc1xuICAgIClcbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL2R5bmFtaWNqYXNwZXIvcmVwb3J0JztcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIHVybDogdXJsLFxuICAgICAgYm9keTogYm9keVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNhdmVBc1ByZWZlcmVuY2VzKHByZWZlcmVuY2VzcGFyYW1zPzogb2JqZWN0KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICBwcmVmZXJlbmNlc3BhcmFtc1xuICAgIClcbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL3ByZWZlcmVuY2VzL3NhdmUnO1xuXG4gICAgcmV0dXJuIHRoaXMuZG9SZXF1ZXN0KHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBib2R5XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc2F2ZVByZWZlcmVuY2VzKGlkOiBudW1iZXIsIHByZWZlcmVuY2VzcGFyYW1zPzogb2JqZWN0KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICBwcmVmZXJlbmNlc3BhcmFtc1xuICAgIClcbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL3ByZWZlcmVuY2VzL3VwZGF0ZS8nICsgaWQ7XG5cbiAgICByZXR1cm4gdGhpcy5kb1JlcXVlc3Qoe1xuICAgICAgbWV0aG9kOiAnUFVUJyxcbiAgICAgIHVybDogdXJsLFxuICAgICAgYm9keTogYm9keVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldFByZWZlcmVuY2VzKGVudGl0eT86IHN0cmluZywgc2VydmljZT86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG5cbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL3ByZWZlcmVuY2VzL3ByZWZlcmVuY2VzP2VudGl0eT0nICsgZW50aXR5ICsgJyZzZXJ2aWNlPScgKyBzZXJ2aWNlICsgXCImdHlwZT1SRVBPUlRcIjtcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KTtcblxuICB9XG4gIHB1YmxpYyBnZXRGdW5jdGlvbnMoZnVuY3Rpb25wYXJhbXM/OiBvYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuXG4gICAgY29uc3QgYm9keSA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgZnVuY3Rpb25wYXJhbXNcbiAgICApXG4gICAgY29uc3QgdXJsID0gdGhpcy51cmxCYXNlICsgJy9keW5hbWljamFzcGVyL2Z1bmN0aW9uc05hbWUnO1xuXG4gICAgcmV0dXJuIHRoaXMuZG9SZXF1ZXN0KHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBib2R5XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlUHJlZmVyZW5jZXMoaWQ/OiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuXG4gICAgY29uc3QgdXJsID0gdGhpcy51cmxCYXNlICsgJy9wcmVmZXJlbmNlcy9yZW1vdmUvJyArIGlkO1xuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdERUxFVEUnLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KTtcblxuICB9XG5cbiAgLyoqIG92ZXJyaWRkZW4gbWV0aG9kIHRvIGFkZCBlcnJvciBjYWxsYmFjayBmb3IgYWxsIHJlcXVlc3RzICovXG4gIGRvUmVxdWVzdChwYXJhbTogU2VydmljZVJlcXVlc3RQYXJhbSk6IE9ic2VydmFibGU8U2VydmljZVJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIHN1cGVyLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6IHBhcmFtLm1ldGhvZCxcbiAgICAgIHVybDogcGFyYW0udXJsLFxuICAgICAgYm9keTogcGFyYW0uYm9keSxcbiAgICAgIGVycm9yQ2FsbEJhY2s6IHRoaXMuZXJyb3JDYWxsQmFja1xuICAgIH0pO1xuICB9XG5cblxuICBlcnJvckNhbGxCYWNrKGh0dHBFcnJvclJlc3BvbnNlOiBhbnkpIHtcbiAgICBjb25zdCBlcnJvciA9IGh0dHBFcnJvclJlc3BvbnNlLmVycm9yO1xuICAgIGlmIChVdGlsLmlzT2JqZWN0KGVycm9yKSkge1xuICAgICAgaWYgKGVycm9yWydjb2RlJ10gPT09IDEgJiYgVXRpbC5pc0RlZmluZWQoZXJyb3JbJ21lc3NhZ2UnXSkpIHtcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uRXJyb3IoZXJyb3JbJ21lc3NhZ2UnXSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uRXJyb3IoJ01FU1NBR0VTLkVSUk9SX1FVRVJZJyk7XG5cbiAgfVxuXG4gIHNob3dOb3RpZmljYXRpb25FcnJvcihlcnJvcjogc3RyaW5nKSB7XG4gICAgdGhpcy5vRXJyb3JEaWFsb2dNYW5hZ2VyLm9wZW5FcnJvckRpYWxvZyhlcnJvcik7XG4gIH1cblxuICB1cGxvYWQoZmlsZXM6IGFueVtdLCBlbnRpdHk6IHN0cmluZywgZGF0YT86IG9iamVjdCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgZGF0YU9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiB7XG5cbiAgICAgIGxldCB1cmwgPSBgJHt0aGlzLnVybEJhc2V9L3JlcG9ydHN0b3JlLyR7ZW50aXR5fWA7XG5cbiAgICAgIGNvbnN0IHRvVXBsb2FkOiBhbnkgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgIGZpbGVzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGl0ZW0ucHJlcGFyZVRvVXBsb2FkKCk7XG4gICAgICAgIGl0ZW0uaXNVcGxvYWRpbmcgPSB0cnVlO1xuICAgICAgICB0b1VwbG9hZC5hcHBlbmQoJ25hbWUnLCBpdGVtLm5hbWUpO1xuICAgICAgICB0b1VwbG9hZC5hcHBlbmQoJ2ZpbGUnLCBpdGVtLmZpbGUpO1xuICAgICAgfSk7XG5cbiAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgIHRvVXBsb2FkLmFwcGVuZCgnZGF0YScsIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBIdHRwUmVxdWVzdCgnUE9TVCcsIHVybCwgdG9VcGxvYWQsIHtcbiAgICAgICAgaGVhZGVyczogdGhpcy5idWlsZEhlYWRlcnNSZXBvcnQoKSxcbiAgICAgICAgcmVwb3J0UHJvZ3Jlc3M6IHRydWVcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmh0dHBDbGllbnQucmVxdWVzdChyZXF1ZXN0KS5zdWJzY3JpYmUocmVzcCA9PiB7XG4gICAgICAgIGlmIChIdHRwRXZlbnRUeXBlLlVwbG9hZFByb2dyZXNzID09PSByZXNwLnR5cGUpIHtcbiAgICAgICAgICAvLyBVcGxvYWQgcHJvZ3Jlc3MgZXZlbnQgcmVjZWl2ZWRcbiAgICAgICAgICBjb25zdCBwcm9ncmVzc0RhdGEgPSB7XG4gICAgICAgICAgICBsb2FkZWQ6IHJlc3AubG9hZGVkLFxuICAgICAgICAgICAgdG90YWw6IHJlc3AudG90YWxcbiAgICAgICAgICB9O1xuICAgICAgICAgIG9ic2VydmVyLm5leHQocHJvZ3Jlc3NEYXRhKTtcbiAgICAgICAgfSBlbHNlIGlmIChIdHRwRXZlbnRUeXBlLlJlc3BvbnNlID09PSByZXNwLnR5cGUpIHtcbiAgICAgICAgICAvLyBGdWxsIHJlc3BvbnNlIHJlY2VpdmVkXG4gICAgICAgICAgaWYgKHJlc3AuYm9keSkge1xuICAgICAgICAgICAgdGhpcy5ib2R5Q29kZShyZXNwLCBvYnNlcnZlcik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzcC5ib2R5KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIGlmIChlcnJvci5zdGF0dXMgPT09IDQwMSkge1xuICAgICAgICAgIHRoaXMuYXV0aFNlcnZpY2UubG9nb3V0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgICAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGF0YU9ic2VydmFibGUucGlwZShzaGFyZSgpKTtcbiAgfVxuICBwcm90ZWN0ZWQgYm9keUNvZGUocmVzcCwgb2JzZXJ2ZXIpIHtcbiAgICBpZiAocmVzcC5ib2R5Wydjb2RlJ10gPT09IDMpIHtcbiAgICAgIHRoaXMuYXV0aFNlcnZpY2UubG9nb3V0KCk7XG4gICAgfSBlbHNlIGlmIChyZXNwLmJvZHlbJ2NvZGUnXSA9PT0gMSkge1xuICAgICAgb2JzZXJ2ZXIuZXJyb3IocmVzcC5ib2R5WydtZXNzYWdlJ10pO1xuICAgIH0gZWxzZSBpZiAocmVzcC5ib2R5Wydjb2RlJ10gPT09IDApIHtcbiAgICAgIC8vIFJFU1BPTlNFXG4gICAgICBvYnNlcnZlci5uZXh0KHJlc3AuYm9keSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFVua25vdyBzdGF0ZSAtPiBlcnJvclxuICAgICAgb2JzZXJ2ZXIuZXJyb3IoJ1NlcnZpY2UgdW5hdmFpbGFibGUnKTtcbiAgICB9XG4gIH1cblxuXG4gIHB1YmxpYyBhZHZhbmNlZFF1ZXJ5KF9rdj86IE9iamVjdCwgX2F2PzogQXJyYXk8c3RyaW5nPiwgZW50aXR5Pzogc3RyaW5nLCBfc3FsdHlwZXM/OiBPYmplY3QsIG9mZnNldD86IG51bWJlciwgX3BhZ2VzaXplPzogbnVtYmVyLCBfb3JkZXJieT86IEFycmF5PE9iamVjdD4pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIG9mZnNldCA9IChVdGlsLmlzRGVmaW5lZChvZmZzZXQpKSA/IG9mZnNldCA6IHRoaXMub2Zmc2V0O1xuXG4gICAgLy8gQ2FsY3VsYXRlIHBhZ2VcbiAgICBsZXQgcGFnZSA9IDA7XG4gICAgaWYgKFV0aWwuaXNEZWZpbmVkKG9mZnNldCkpIHtcbiAgICAgIHBhZ2UgPSBNYXRoLnRydW5jKG9mZnNldCAvIDEwKSArIDE7XG4gICAgfVxuXG4gICAgbGV0IHVybCA9IHRoaXMudXJsQmFzZSArICcvcmVwb3J0c3RvcmUvJyArIGVudGl0eSArICcvP2Zvcm1hdD1qc29uJyArICcmcGFnZT0nICsgcGFnZTtcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBxdWVyeShrdj86IE9iamVjdCwgX2F2PzogQXJyYXk8c3RyaW5nPiwgZW50aXR5Pzogc3RyaW5nLCBfc3FsdHlwZXM/OiBPYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBrdlsnVVVJRCddO1xuICAgIGxldCB1cmwgPSAnJztcbiAgICBpZiAoT2JqZWN0LmtleXMoa3YpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdXJsID0gYCR7dGhpcy51cmxCYXNlfS9yZXBvcnRzdG9yZS8ke2VudGl0eX1gO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cmwgPSBgJHt0aGlzLnVybEJhc2V9L3JlcG9ydHN0b3JlLyR7ZW50aXR5fS9gICsgaWRlbnRpZmllcjtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5kb1JlcXVlc3Qoe1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIHVybDogdXJsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZmlsbFJlcG9ydChhdj86IEFycmF5PHN0cmluZz4sIGVudGl0eT86IHN0cmluZywgX3NxbHR5cGVzPzogT2JqZWN0LCBmaWx0ZXI/OiBPYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBhdlswXTtcbiAgICBsZXQgcGFyYW1zID0gJyc7XG5cbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGF2Lmxlbmd0aDsgaSsrKVxuICAgICAgcGFyYW1zID0gcGFyYW1zICsgYXZbaV0udG9TdHJpbmcoKSArICcsJztcbiAgICBsZXQgYm9keSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHBhcmFtczogcGFyYW1zLFxuICAgICAgZmlsdGVyOiBmaWx0ZXJcbiAgICB9KVxuXG4gICAgbGV0IHVybCA9IGAke3RoaXMudXJsQmFzZX0vcmVwb3J0c3RvcmUvJHtlbnRpdHl9L2AgKyBpZGVudGlmaWVyO1xuXG4gICAgcmV0dXJuIHRoaXMuZG9SZXF1ZXN0KHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBib2R5XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlKGt2PzogT2JqZWN0LCBfZW50aXR5Pzogc3RyaW5nLCBfc3FsdHlwZXM/OiBPYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBrdi52YWx1ZU9mKClbT2JqZWN0LmtleXMoa3YpWzBdXTtcbiAgICBsZXQgdXJsID0gYCR7dGhpcy51cmxCYXNlfS9yZXBvcnRzdG9yZS9yZW1vdmVSZXBvcnQvYCArIGlkZW50aWZpZXI7XG5cbiAgICByZXR1cm4gdGhpcy5kb1JlcXVlc3Qoe1xuICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgIHVybDogdXJsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlKGt2PzogT2JqZWN0LCBhdj86IEFycmF5PHN0cmluZz4sIF9lbnRpdHk/OiBzdHJpbmcsIF9zcWx0eXBlcz86IE9iamVjdCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgaWRlbnRpZmllciA9IGt2LnZhbHVlT2YoKVtPYmplY3Qua2V5cyhrdilbMF1dO1xuICAgIGxldCB1cmwgPSBgJHt0aGlzLnVybEJhc2V9L3JlcG9ydHN0b3JlL3VwZGF0ZVJlcG9ydC9gICsgaWRlbnRpZmllcjtcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBhdlxuICAgIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIGJ1aWxkSGVhZGVyc1JlcG9ydCgpOiBIdHRwSGVhZGVycyB7XG4gICAgbGV0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoeyAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonIH0pO1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuYXV0aFNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKS5pZDtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQoc2Vzc2lvbklkKSkge1xuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuYXBwZW5kKCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgc2Vzc2lvbklkKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlcnM7XG4gIH1cblxufVxuIl19