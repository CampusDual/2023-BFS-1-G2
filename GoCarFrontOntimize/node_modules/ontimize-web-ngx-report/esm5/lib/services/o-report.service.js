/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/o-report.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Injector } from "@angular/core";
import { Observable, OErrorDialogManager, OntimizeEEService, Util } from 'ontimize-web-ngx';
import { HttpEventType, HttpHeaders, HttpRequest } from "@angular/common/http";
import { share } from 'rxjs/operators';
import * as i0 from "@angular/core";
var OReportService = /** @class */ (function (_super) {
    tslib_1.__extends(OReportService, _super);
    function OReportService(injector) {
        var _this = _super.call(this, injector) || this;
        _this.injector = injector;
        _super.prototype.configureService.call(_this, _this.getDefaultServiceConfiguration());
        _this.oErrorDialogManager = injector.get(OErrorDialogManager);
        return _this;
    }
    /**
     * @param {?} reportparams
     * @return {?}
     */
    OReportService.prototype.createReport = /**
     * @param {?} reportparams
     * @return {?}
     */
    function (reportparams) {
        /** @type {?} */
        var body = JSON.stringify(reportparams);
        /** @type {?} */
        var url = this.urlBase + '/dynamicjasper/report';
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    };
    /**
     * @param {?=} preferencesparams
     * @return {?}
     */
    OReportService.prototype.saveAsPreferences = /**
     * @param {?=} preferencesparams
     * @return {?}
     */
    function (preferencesparams) {
        /** @type {?} */
        var body = JSON.stringify(preferencesparams);
        /** @type {?} */
        var url = this.urlBase + '/preferences/save';
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    };
    /**
     * @param {?} id
     * @param {?=} preferencesparams
     * @return {?}
     */
    OReportService.prototype.savePreferences = /**
     * @param {?} id
     * @param {?=} preferencesparams
     * @return {?}
     */
    function (id, preferencesparams) {
        /** @type {?} */
        var body = JSON.stringify(preferencesparams);
        /** @type {?} */
        var url = this.urlBase + '/preferences/update/' + id;
        return this.doRequest({
            method: 'PUT',
            url: url,
            body: body
        });
    };
    /**
     * @param {?=} entity
     * @param {?=} service
     * @return {?}
     */
    OReportService.prototype.getPreferences = /**
     * @param {?=} entity
     * @param {?=} service
     * @return {?}
     */
    function (entity, service) {
        /** @type {?} */
        var url = this.urlBase + '/preferences/preferences?entity=' + entity + '&service=' + service + "&type=REPORT";
        return this.doRequest({
            method: 'GET',
            url: url
        });
    };
    /**
     * @param {?=} functionparams
     * @return {?}
     */
    OReportService.prototype.getFunctions = /**
     * @param {?=} functionparams
     * @return {?}
     */
    function (functionparams) {
        /** @type {?} */
        var body = JSON.stringify(functionparams);
        /** @type {?} */
        var url = this.urlBase + '/dynamicjasper/functionsName';
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    };
    /**
     * @param {?=} id
     * @return {?}
     */
    OReportService.prototype.deletePreferences = /**
     * @param {?=} id
     * @return {?}
     */
    function (id) {
        /** @type {?} */
        var url = this.urlBase + '/preferences/remove/' + id;
        return this.doRequest({
            method: 'DELETE',
            url: url
        });
    };
    /** overridden method to add error callback for all requests */
    /**
     * overridden method to add error callback for all requests
     * @param {?} param
     * @return {?}
     */
    OReportService.prototype.doRequest = /**
     * overridden method to add error callback for all requests
     * @param {?} param
     * @return {?}
     */
    function (param) {
        return _super.prototype.doRequest.call(this, {
            method: param.method,
            url: param.url,
            body: param.body,
            errorCallBack: this.errorCallBack
        });
    };
    /**
     * @param {?} httpErrorResponse
     * @return {?}
     */
    OReportService.prototype.errorCallBack = /**
     * @param {?} httpErrorResponse
     * @return {?}
     */
    function (httpErrorResponse) {
        /** @type {?} */
        var error = httpErrorResponse.error;
        if (Util.isObject(error)) {
            if (error['code'] === 1 && Util.isDefined(error['message'])) {
                this.showNotificationError(error['message']);
                return;
            }
        }
        this.showNotificationError('MESSAGES.ERROR_QUERY');
    };
    /**
     * @param {?} error
     * @return {?}
     */
    OReportService.prototype.showNotificationError = /**
     * @param {?} error
     * @return {?}
     */
    function (error) {
        this.oErrorDialogManager.openErrorDialog(error);
    };
    /**
     * @param {?} files
     * @param {?} entity
     * @param {?=} data
     * @return {?}
     */
    OReportService.prototype.upload = /**
     * @param {?} files
     * @param {?} entity
     * @param {?=} data
     * @return {?}
     */
    function (files, entity, data) {
        var _this = this;
        /** @type {?} */
        var dataObservable = new Observable((/**
         * @param {?} observer
         * @return {?}
         */
        function (observer) {
            /** @type {?} */
            var url = _this.urlBase + "/reportstore/" + entity;
            /** @type {?} */
            var toUpload = new FormData();
            files.forEach((/**
             * @param {?} item
             * @return {?}
             */
            function (item) {
                item.prepareToUpload();
                item.isUploading = true;
                toUpload.append('name', item.name);
                toUpload.append('file', item.file);
            }));
            if (data) {
                toUpload.append('data', JSON.stringify(data));
            }
            /** @type {?} */
            var request = new HttpRequest('POST', url, toUpload, {
                headers: _this.buildHeadersReport(),
                reportProgress: true
            });
            _this.httpClient.request(request).subscribe((/**
             * @param {?} resp
             * @return {?}
             */
            function (resp) {
                if (HttpEventType.UploadProgress === resp.type) {
                    // Upload progress event received
                    /** @type {?} */
                    var progressData = {
                        loaded: resp.loaded,
                        total: resp.total
                    };
                    observer.next(progressData);
                }
                else if (HttpEventType.Response === resp.type) {
                    // Full response received
                    if (resp.body) {
                        _this.bodyCode(resp, observer);
                    }
                    else {
                        observer.next(resp.body);
                    }
                }
            }), (/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                console.error(error);
                if (error.status === 401) {
                    _this.authService.logout();
                }
                else {
                    observer.error(error);
                }
            }), (/**
             * @return {?}
             */
            function () { return observer.complete(); }));
        }));
        return dataObservable.pipe(share());
    };
    /**
     * @protected
     * @param {?} resp
     * @param {?} observer
     * @return {?}
     */
    OReportService.prototype.bodyCode = /**
     * @protected
     * @param {?} resp
     * @param {?} observer
     * @return {?}
     */
    function (resp, observer) {
        if (resp.body['code'] === 3) {
            this.authService.logout();
        }
        else if (resp.body['code'] === 1) {
            observer.error(resp.body['message']);
        }
        else if (resp.body['code'] === 0) {
            // RESPONSE
            observer.next(resp.body);
        }
        else {
            // Unknow state -> error
            observer.error('Service unavailable');
        }
    };
    /**
     * @param {?=} _kv
     * @param {?=} _av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @param {?=} offset
     * @param {?=} _pagesize
     * @param {?=} _orderby
     * @return {?}
     */
    OReportService.prototype.advancedQuery = /**
     * @param {?=} _kv
     * @param {?=} _av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @param {?=} offset
     * @param {?=} _pagesize
     * @param {?=} _orderby
     * @return {?}
     */
    function (_kv, _av, entity, _sqltypes, offset, _pagesize, _orderby) {
        offset = (Util.isDefined(offset)) ? offset : this.offset;
        // Calculate page
        /** @type {?} */
        var page = 0;
        if (Util.isDefined(offset)) {
            page = Math.trunc(offset / 10) + 1;
        }
        /** @type {?} */
        var url = this.urlBase + '/reportstore/' + entity + '/?format=json' + '&page=' + page;
        return this.doRequest({
            method: 'GET',
            url: url
        });
    };
    /**
     * @param {?=} kv
     * @param {?=} _av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    OReportService.prototype.query = /**
     * @param {?=} kv
     * @param {?=} _av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    function (kv, _av, entity, _sqltypes) {
        /** @type {?} */
        var identifier = kv['UUID'];
        /** @type {?} */
        var url = '';
        if (Object.keys(kv).length === 0) {
            url = this.urlBase + "/reportstore/" + entity;
        }
        else {
            url = this.urlBase + "/reportstore/" + entity + "/" + identifier;
        }
        return this.doRequest({
            method: 'GET',
            url: url
        });
    };
    /**
     * @param {?=} av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @param {?=} filter
     * @return {?}
     */
    OReportService.prototype.fillReport = /**
     * @param {?=} av
     * @param {?=} entity
     * @param {?=} _sqltypes
     * @param {?=} filter
     * @return {?}
     */
    function (av, entity, _sqltypes, filter) {
        /** @type {?} */
        var identifier = av[0];
        /** @type {?} */
        var params = '';
        for (var i = 1; i < av.length; i++)
            params = params + av[i].toString() + ',';
        /** @type {?} */
        var body = JSON.stringify({
            params: params,
            filter: filter
        });
        /** @type {?} */
        var url = this.urlBase + "/reportstore/" + entity + "/" + identifier;
        return this.doRequest({
            method: 'POST',
            url: url,
            body: body
        });
    };
    /**
     * @param {?=} kv
     * @param {?=} _entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    OReportService.prototype.delete = /**
     * @param {?=} kv
     * @param {?=} _entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    function (kv, _entity, _sqltypes) {
        /** @type {?} */
        var identifier = kv.valueOf()[Object.keys(kv)[0]];
        /** @type {?} */
        var url = this.urlBase + "/reportstore/removeReport/" + identifier;
        return this.doRequest({
            method: 'DELETE',
            url: url
        });
    };
    /**
     * @param {?=} kv
     * @param {?=} av
     * @param {?=} _entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    OReportService.prototype.update = /**
     * @param {?=} kv
     * @param {?=} av
     * @param {?=} _entity
     * @param {?=} _sqltypes
     * @return {?}
     */
    function (kv, av, _entity, _sqltypes) {
        /** @type {?} */
        var identifier = kv.valueOf()[Object.keys(kv)[0]];
        /** @type {?} */
        var url = this.urlBase + "/reportstore/updateReport/" + identifier;
        return this.doRequest({
            method: 'PUT',
            url: url,
            body: av
        });
    };
    /**
     * @protected
     * @return {?}
     */
    OReportService.prototype.buildHeadersReport = /**
     * @protected
     * @return {?}
     */
    function () {
        /** @type {?} */
        var headers = new HttpHeaders({ 'Access-Control-Allow-Origin': '*' });
        /** @type {?} */
        var sessionId = this.authService.getSessionInfo().id;
        if (Util.isDefined(sessionId)) {
            headers = headers.append('Authorization', 'Bearer ' + sessionId);
        }
        return headers;
    };
    OReportService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] }
    ];
    /** @nocollapse */
    OReportService.ctorParameters = function () { return [
        { type: Injector }
    ]; };
    /** @nocollapse */ OReportService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function OReportService_Factory() { return new OReportService(i0.ɵɵinject(i0.INJECTOR)); }, token: OReportService, providedIn: "root" });
    return OReportService;
}(OntimizeEEService));
export { OReportService };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    OReportService.prototype.oErrorDialogManager;
    /**
     * @type {?}
     * @protected
     */
    OReportService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1yZXBvcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gtcmVwb3J0LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL28tcmVwb3J0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckQsT0FBTyxFQUFFLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxpQkFBaUIsRUFBd0MsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEksT0FBTyxFQUFFLGFBQWEsRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0UsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDOztBQUd2QztJQUNvQywwQ0FBaUI7SUFHbkQsd0JBQXNCLFFBQWtCO1FBQXhDLFlBQ0Usa0JBQU0sUUFBUSxDQUFDLFNBR2hCO1FBSnFCLGNBQVEsR0FBUixRQUFRLENBQVU7UUFFdEMsaUJBQU0sZ0JBQWdCLGFBQUMsS0FBSSxDQUFDLDhCQUE4QixFQUFFLENBQUMsQ0FBQztRQUM5RCxLQUFJLENBQUMsbUJBQW1CLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBc0IsbUJBQW1CLENBQUMsQ0FBQzs7SUFDcEYsQ0FBQzs7Ozs7SUFFTSxxQ0FBWTs7OztJQUFuQixVQUFvQixZQUEwQjs7WUFFdEMsSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQ3pCLFlBQVksQ0FDYjs7WUFDSyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sR0FBRyx1QkFBdUI7UUFFbEQsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ3BCLE1BQU0sRUFBRSxNQUFNO1lBQ2QsR0FBRyxFQUFFLEdBQUc7WUFDUixJQUFJLEVBQUUsSUFBSTtTQUNYLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7O0lBRU0sMENBQWlCOzs7O0lBQXhCLFVB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LE1BQU0sRUFBRTs7OztnQkFQYixRQUFROzs7eUJBQTdCO0NBeVFDLEFBbFFELENBQ29DLGlCQUFpQixHQWlRcEQ7U0FqUVksY0FBYzs7Ozs7O0lBQ3pCLDZDQUFtRDs7Ozs7SUFFdkMsa0NBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgT1JlcG9ydFBhcmFtIH0gZnJvbSBcIi4uL3R5cGVzL3JlcG9ydC1wYXJhbS50eXBlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBPRXJyb3JEaWFsb2dNYW5hZ2VyLCBPbnRpbWl6ZUVFU2VydmljZSwgU2VydmljZVJlcXVlc3RQYXJhbSwgU2VydmljZVJlc3BvbnNlLCBVdGlsIH0gZnJvbSAnb250aW1pemUtd2ViLW5neCc7XG5pbXBvcnQgeyBIdHRwRXZlbnRUeXBlLCBIdHRwSGVhZGVycywgSHR0cFJlcXVlc3QgfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uL2h0dHBcIjtcbmltcG9ydCB7IHNoYXJlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgT1JlcG9ydFNlcnZpY2UgZXh0ZW5kcyBPbnRpbWl6ZUVFU2VydmljZSB7XG4gIHByb3RlY3RlZCBvRXJyb3JEaWFsb2dNYW5hZ2VyOiBPRXJyb3JEaWFsb2dNYW5hZ2VyO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICBzdXBlcihpbmplY3Rvcik7XG4gICAgc3VwZXIuY29uZmlndXJlU2VydmljZSh0aGlzLmdldERlZmF1bHRTZXJ2aWNlQ29uZmlndXJhdGlvbigpKTtcbiAgICB0aGlzLm9FcnJvckRpYWxvZ01hbmFnZXIgPSBpbmplY3Rvci5nZXQ8T0Vycm9yRGlhbG9nTWFuYWdlcj4oT0Vycm9yRGlhbG9nTWFuYWdlcik7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlUmVwb3J0KHJlcG9ydHBhcmFtczogT1JlcG9ydFBhcmFtKTogT2JzZXJ2YWJsZTxhbnk+IHtcblxuICAgIGNvbnN0IGJvZHkgPSBKU09OLnN0cmluZ2lmeShcbiAgICAgIHJlcG9ydHBhcmFtc1xuICAgIClcbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL2R5bmFtaWNqYXNwZXIvcmVwb3J0JztcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIHVybDogdXJsLFxuICAgICAgYm9keTogYm9keVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHNhdmVBc1ByZWZlcmVuY2VzKHByZWZlcmVuY2VzcGFyYW1zPzogb2JqZWN0KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICBwcmVmZXJlbmNlc3BhcmFtc1xuICAgIClcbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL3ByZWZlcmVuY2VzL3NhdmUnO1xuXG4gICAgcmV0dXJuIHRoaXMuZG9SZXF1ZXN0KHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBib2R5XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc2F2ZVByZWZlcmVuY2VzKGlkOiBudW1iZXIsIHByZWZlcmVuY2VzcGFyYW1zPzogb2JqZWN0KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICBwcmVmZXJlbmNlc3BhcmFtc1xuICAgIClcbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL3ByZWZlcmVuY2VzL3VwZGF0ZS8nICsgaWQ7XG5cbiAgICByZXR1cm4gdGhpcy5kb1JlcXVlc3Qoe1xuICAgICAgbWV0aG9kOiAnUFVUJyxcbiAgICAgIHVybDogdXJsLFxuICAgICAgYm9keTogYm9keVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGdldFByZWZlcmVuY2VzKGVudGl0eT86IHN0cmluZywgc2VydmljZT86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG5cbiAgICBjb25zdCB1cmwgPSB0aGlzLnVybEJhc2UgKyAnL3ByZWZlcmVuY2VzL3ByZWZlcmVuY2VzP2VudGl0eT0nICsgZW50aXR5ICsgJyZzZXJ2aWNlPScgKyBzZXJ2aWNlICsgXCImdHlwZT1SRVBPUlRcIjtcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KTtcblxuICB9XG4gIHB1YmxpYyBnZXRGdW5jdGlvbnMoZnVuY3Rpb25wYXJhbXM/OiBvYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuXG4gICAgY29uc3QgYm9keSA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgZnVuY3Rpb25wYXJhbXNcbiAgICApXG4gICAgY29uc3QgdXJsID0gdGhpcy51cmxCYXNlICsgJy9keW5hbWljamFzcGVyL2Z1bmN0aW9uc05hbWUnO1xuXG4gICAgcmV0dXJuIHRoaXMuZG9SZXF1ZXN0KHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBib2R5XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlUHJlZmVyZW5jZXMoaWQ/OiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuXG4gICAgY29uc3QgdXJsID0gdGhpcy51cmxCYXNlICsgJy9wcmVmZXJlbmNlcy9yZW1vdmUvJyArIGlkO1xuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdERUxFVEUnLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KTtcblxuICB9XG5cbiAgLyoqIG92ZXJyaWRkZW4gbWV0aG9kIHRvIGFkZCBlcnJvciBjYWxsYmFjayBmb3IgYWxsIHJlcXVlc3RzICovXG4gIGRvUmVxdWVzdChwYXJhbTogU2VydmljZVJlcXVlc3RQYXJhbSk6IE9ic2VydmFibGU8U2VydmljZVJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIHN1cGVyLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6IHBhcmFtLm1ldGhvZCxcbiAgICAgIHVybDogcGFyYW0udXJsLFxuICAgICAgYm9keTogcGFyYW0uYm9keSxcbiAgICAgIGVycm9yQ2FsbEJhY2s6IHRoaXMuZXJyb3JDYWxsQmFja1xuICAgIH0pO1xuICB9XG5cblxuICBlcnJvckNhbGxCYWNrKGh0dHBFcnJvclJlc3BvbnNlOiBhbnkpIHtcbiAgICBjb25zdCBlcnJvciA9IGh0dHBFcnJvclJlc3BvbnNlLmVycm9yO1xuICAgIGlmIChVdGlsLmlzT2JqZWN0KGVycm9yKSkge1xuICAgICAgaWYgKGVycm9yWydjb2RlJ10gPT09IDEgJiYgVXRpbC5pc0RlZmluZWQoZXJyb3JbJ21lc3NhZ2UnXSkpIHtcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uRXJyb3IoZXJyb3JbJ21lc3NhZ2UnXSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uRXJyb3IoJ01FU1NBR0VTLkVSUk9SX1FVRVJZJyk7XG5cbiAgfVxuXG4gIHNob3dOb3RpZmljYXRpb25FcnJvcihlcnJvcjogc3RyaW5nKSB7XG4gICAgdGhpcy5vRXJyb3JEaWFsb2dNYW5hZ2VyLm9wZW5FcnJvckRpYWxvZyhlcnJvcik7XG4gIH1cblxuICB1cGxvYWQoZmlsZXM6IGFueVtdLCBlbnRpdHk6IHN0cmluZywgZGF0YT86IG9iamVjdCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgZGF0YU9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiB7XG5cbiAgICAgIGxldCB1cmwgPSBgJHt0aGlzLnVybEJhc2V9L3JlcG9ydHN0b3JlLyR7ZW50aXR5fWA7XG5cbiAgICAgIGNvbnN0IHRvVXBsb2FkOiBhbnkgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgIGZpbGVzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGl0ZW0ucHJlcGFyZVRvVXBsb2FkKCk7XG4gICAgICAgIGl0ZW0uaXNVcGxvYWRpbmcgPSB0cnVlO1xuICAgICAgICB0b1VwbG9hZC5hcHBlbmQoJ25hbWUnLCBpdGVtLm5hbWUpO1xuICAgICAgICB0b1VwbG9hZC5hcHBlbmQoJ2ZpbGUnLCBpdGVtLmZpbGUpO1xuICAgICAgfSk7XG5cbiAgICAgIGlmIChkYXRhKSB7XG4gICAgICAgIHRvVXBsb2FkLmFwcGVuZCgnZGF0YScsIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBIdHRwUmVxdWVzdCgnUE9TVCcsIHVybCwgdG9VcGxvYWQsIHtcbiAgICAgICAgaGVhZGVyczogdGhpcy5idWlsZEhlYWRlcnNSZXBvcnQoKSxcbiAgICAgICAgcmVwb3J0UHJvZ3Jlc3M6IHRydWVcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmh0dHBDbGllbnQucmVxdWVzdChyZXF1ZXN0KS5zdWJzY3JpYmUocmVzcCA9PiB7XG4gICAgICAgIGlmIChIdHRwRXZlbnRUeXBlLlVwbG9hZFByb2dyZXNzID09PSByZXNwLnR5cGUpIHtcbiAgICAgICAgICAvLyBVcGxvYWQgcHJvZ3Jlc3MgZXZlbnQgcmVjZWl2ZWRcbiAgICAgICAgICBjb25zdCBwcm9ncmVzc0RhdGEgPSB7XG4gICAgICAgICAgICBsb2FkZWQ6IHJlc3AubG9hZGVkLFxuICAgICAgICAgICAgdG90YWw6IHJlc3AudG90YWxcbiAgICAgICAgICB9O1xuICAgICAgICAgIG9ic2VydmVyLm5leHQocHJvZ3Jlc3NEYXRhKTtcbiAgICAgICAgfSBlbHNlIGlmIChIdHRwRXZlbnRUeXBlLlJlc3BvbnNlID09PSByZXNwLnR5cGUpIHtcbiAgICAgICAgICAvLyBGdWxsIHJlc3BvbnNlIHJlY2VpdmVkXG4gICAgICAgICAgaWYgKHJlc3AuYm9keSkge1xuICAgICAgICAgICAgdGhpcy5ib2R5Q29kZShyZXNwLCBvYnNlcnZlcik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG9ic2VydmVyLm5leHQocmVzcC5ib2R5KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIGlmIChlcnJvci5zdGF0dXMgPT09IDQwMSkge1xuICAgICAgICAgIHRoaXMuYXV0aFNlcnZpY2UubG9nb3V0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgICAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGF0YU9ic2VydmFibGUucGlwZShzaGFyZSgpKTtcbiAgfVxuICBwcm90ZWN0ZWQgYm9keUNvZGUocmVzcCwgb2JzZXJ2ZXIpIHtcbiAgICBpZiAocmVzcC5ib2R5Wydjb2RlJ10gPT09IDMpIHtcbiAgICAgIHRoaXMuYXV0aFNlcnZpY2UubG9nb3V0KCk7XG4gICAgfSBlbHNlIGlmIChyZXNwLmJvZHlbJ2NvZGUnXSA9PT0gMSkge1xuICAgICAgb2JzZXJ2ZXIuZXJyb3IocmVzcC5ib2R5WydtZXNzYWdlJ10pO1xuICAgIH0gZWxzZSBpZiAocmVzcC5ib2R5Wydjb2RlJ10gPT09IDApIHtcbiAgICAgIC8vIFJFU1BPTlNFXG4gICAgICBvYnNlcnZlci5uZXh0KHJlc3AuYm9keSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFVua25vdyBzdGF0ZSAtPiBlcnJvclxuICAgICAgb2JzZXJ2ZXIuZXJyb3IoJ1NlcnZpY2UgdW5hdmFpbGFibGUnKTtcbiAgICB9XG4gIH1cblxuXG4gIHB1YmxpYyBhZHZhbmNlZFF1ZXJ5KF9rdj86IE9iamVjdCwgX2F2PzogQXJyYXk8c3RyaW5nPiwgZW50aXR5Pzogc3RyaW5nLCBfc3FsdHlwZXM/OiBPYmplY3QsIG9mZnNldD86IG51bWJlciwgX3BhZ2VzaXplPzogbnVtYmVyLCBfb3JkZXJieT86IEFycmF5PE9iamVjdD4pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIG9mZnNldCA9IChVdGlsLmlzRGVmaW5lZChvZmZzZXQpKSA/IG9mZnNldCA6IHRoaXMub2Zmc2V0O1xuXG4gICAgLy8gQ2FsY3VsYXRlIHBhZ2VcbiAgICBsZXQgcGFnZSA9IDA7XG4gICAgaWYgKFV0aWwuaXNEZWZpbmVkKG9mZnNldCkpIHtcbiAgICAgIHBhZ2UgPSBNYXRoLnRydW5jKG9mZnNldCAvIDEwKSArIDE7XG4gICAgfVxuXG4gICAgbGV0IHVybCA9IHRoaXMudXJsQmFzZSArICcvcmVwb3J0c3RvcmUvJyArIGVudGl0eSArICcvP2Zvcm1hdD1qc29uJyArICcmcGFnZT0nICsgcGFnZTtcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBxdWVyeShrdj86IE9iamVjdCwgX2F2PzogQXJyYXk8c3RyaW5nPiwgZW50aXR5Pzogc3RyaW5nLCBfc3FsdHlwZXM/OiBPYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBrdlsnVVVJRCddO1xuICAgIGxldCB1cmwgPSAnJztcbiAgICBpZiAoT2JqZWN0LmtleXMoa3YpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdXJsID0gYCR7dGhpcy51cmxCYXNlfS9yZXBvcnRzdG9yZS8ke2VudGl0eX1gO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cmwgPSBgJHt0aGlzLnVybEJhc2V9L3JlcG9ydHN0b3JlLyR7ZW50aXR5fS9gICsgaWRlbnRpZmllcjtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5kb1JlcXVlc3Qoe1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIHVybDogdXJsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZmlsbFJlcG9ydChhdj86IEFycmF5PHN0cmluZz4sIGVudGl0eT86IHN0cmluZywgX3NxbHR5cGVzPzogT2JqZWN0LCBmaWx0ZXI/OiBPYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBhdlswXTtcbiAgICBsZXQgcGFyYW1zID0gJyc7XG5cbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGF2Lmxlbmd0aDsgaSsrKVxuICAgICAgcGFyYW1zID0gcGFyYW1zICsgYXZbaV0udG9TdHJpbmcoKSArICcsJztcbiAgICBsZXQgYm9keSA9IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHBhcmFtczogcGFyYW1zLFxuICAgICAgZmlsdGVyOiBmaWx0ZXJcbiAgICB9KVxuXG4gICAgbGV0IHVybCA9IGAke3RoaXMudXJsQmFzZX0vcmVwb3J0c3RvcmUvJHtlbnRpdHl9L2AgKyBpZGVudGlmaWVyO1xuXG4gICAgcmV0dXJuIHRoaXMuZG9SZXF1ZXN0KHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBib2R5XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZGVsZXRlKGt2PzogT2JqZWN0LCBfZW50aXR5Pzogc3RyaW5nLCBfc3FsdHlwZXM/OiBPYmplY3QpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSBrdi52YWx1ZU9mKClbT2JqZWN0LmtleXMoa3YpWzBdXTtcbiAgICBsZXQgdXJsID0gYCR7dGhpcy51cmxCYXNlfS9yZXBvcnRzdG9yZS9yZW1vdmVSZXBvcnQvYCArIGlkZW50aWZpZXI7XG5cbiAgICByZXR1cm4gdGhpcy5kb1JlcXVlc3Qoe1xuICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgIHVybDogdXJsXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlKGt2PzogT2JqZWN0LCBhdj86IEFycmF5PHN0cmluZz4sIF9lbnRpdHk/OiBzdHJpbmcsIF9zcWx0eXBlcz86IE9iamVjdCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgaWRlbnRpZmllciA9IGt2LnZhbHVlT2YoKVtPYmplY3Qua2V5cyhrdilbMF1dO1xuICAgIGxldCB1cmwgPSBgJHt0aGlzLnVybEJhc2V9L3JlcG9ydHN0b3JlL3VwZGF0ZVJlcG9ydC9gICsgaWRlbnRpZmllcjtcblxuICAgIHJldHVybiB0aGlzLmRvUmVxdWVzdCh7XG4gICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgdXJsOiB1cmwsXG4gICAgICBib2R5OiBhdlxuICAgIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIGJ1aWxkSGVhZGVyc1JlcG9ydCgpOiBIdHRwSGVhZGVycyB7XG4gICAgbGV0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoeyAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonIH0pO1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuYXV0aFNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKS5pZDtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQoc2Vzc2lvbklkKSkge1xuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuYXBwZW5kKCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgc2Vzc2lvbklkKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlcnM7XG4gIH1cblxufVxuIl19