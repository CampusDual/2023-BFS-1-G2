import { Subject } from 'rxjs';
import { Util } from '../../../../util/util';
export class OTableGroupedRow {
    constructor(arg) {
        this.level = 0;
        this.expanded = true;
        this.columnsData = {};
        this.aggregateFunctionChange = new Subject();
        if (Util.isDefined(arg)) {
            this.column = arg.column;
            this.keysAsString = arg.keysAsString;
            this.level = arg.level;
            this.parent = arg.parent;
        }
    }
    get visible() {
        return !this.parent || (this.parent.visible && this.parent.expanded);
    }
    hasColumnData(columnAttr) {
        return Util.isDefined(this.columnsData[columnAttr]);
    }
    hasActiveAggregate(columnAttr) {
        return this.hasColumnData(columnAttr) && Util.isDefined(this.columnsData[columnAttr].activeAggregate);
    }
    getColumnGroupingComponent(columnAttr) {
        return this.hasColumnData(columnAttr) ? this.columnsData[columnAttr].component : null;
    }
    getColumnAggregateValue(columnAttr) {
        return this.columnsData[columnAttr].value;
    }
    setColumnAggregateValue(columnAttr, value) {
        this.columnsData[columnAttr].value = value;
    }
    expandSameLevel(defaultValue) {
        if (!this.hasColumnData(this.column)) {
            return defaultValue;
        }
        const groupingComponent = this.getColumnGroupingComponent(this.column);
        if (Util.isDefined(groupingComponent)) {
            return groupingComponent.expandGroupsSameLevel;
        }
        return defaultValue;
    }
    setColumnAggregateData(columnAttr, value) {
        if (this.hasColumnData(columnAttr)) {
            this.columnsData[columnAttr].data = value;
        }
    }
    getColumnAggregateData(columnAttr) {
        return this.hasColumnData(columnAttr) ? this.columnsData[columnAttr].data : [];
    }
    setColumnActiveAggregateFunction(columnAttr, aggregateFnName, emitEvent = true) {
        if (this.hasColumnData(columnAttr)) {
            this.columnsData[columnAttr].activeAggregate = aggregateFnName;
        }
        else {
            this.columnsData[columnAttr] = {
                component: null,
                activeAggregate: aggregateFnName,
                value: null,
                data: []
            };
        }
        if (emitEvent) {
            let changeAllGroupedRows = true;
            const groupingComponent = this.getColumnGroupingComponent(columnAttr);
            if (Util.isDefined(groupingComponent)) {
                changeAllGroupedRows = groupingComponent.changeAggregateSameLevel;
            }
            this.aggregateFunctionChange.next({
                columnAttr: columnAttr,
                activeAggregate: aggregateFnName,
                changeAllGroupedRows: changeAllGroupedRows,
                row: this
            });
        }
    }
    getColumnActiveAggregateTitle(columnAttr) {
        const conf = this.getActiveColumnAggregateConfiguration(columnAttr);
        if (conf.title) {
            return conf.title;
        }
        return `AGGREGATE_NAME.${conf.aggregateName || conf.aggregate}`;
    }
    initializeColumnAggregate(columnAttr, component) {
        if (!this.columnsData.hasOwnProperty(columnAttr)) {
            this.columnsData[columnAttr] = {
                component: null,
                activeAggregate: 'sum',
                value: null,
                data: []
            };
        }
        if (Util.isDefined(component)) {
            this.columnsData[columnAttr].component = component;
            this.columnsData[columnAttr].activeAggregate = component.aggregate;
        }
    }
    getActiveColumnAggregateConfiguration(columnAttr) {
        if (!this.hasColumnData(columnAttr)) {
            return {
                attr: columnAttr,
                aggregate: 'sum'
            };
        }
        const activeAggregate = this.columnsData[columnAttr].activeAggregate;
        const groupingColumnComponent = this.columnsData[columnAttr].component;
        if (Util.isDefined(groupingColumnComponent) && groupingColumnComponent.aggregate === activeAggregate) {
            return groupingColumnComponent.getAggregateConfiguration();
        }
        return {
            attr: columnAttr,
            aggregate: this.columnsData[columnAttr].activeAggregate
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10YWJsZS1yb3ctZ3JvdXAuY2xhc3MuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvdGFibGUvZXh0ZW5zaW9ucy9yb3cvby10YWJsZS1yb3ctZ3JvdXAuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUcvQixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFtQjdDLE1BQU0sT0FBTyxnQkFBZ0I7SUFlM0IsWUFBWSxHQUFTO1FBWHJCLFVBQUssR0FBRyxDQUFDLENBQUM7UUFHVixhQUFRLEdBQUcsSUFBSSxDQUFDO1FBSVIsZ0JBQVcsR0FBMkMsRUFBRSxDQUFDO1FBRWpFLDRCQUF1QixHQUFnQyxJQUFJLE9BQU8sRUFBc0IsQ0FBQztRQUd2RixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxZQUFZLEdBQUcsR0FBRyxDQUFDLFlBQVksQ0FBQztZQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUM7WUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1NBQzFCO0lBQ0gsQ0FBQztJQWRELElBQUksT0FBTztRQUNULE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBY0QsYUFBYSxDQUFDLFVBQWtCO1FBQzlCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFD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VSxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ3ZFLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLHVCQUF1QixDQUFDLFNBQVMsS0FBSyxlQUFlLEVBQUU7WUFDcEcsT0FBTyx1QkFBdUIsQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1NBQzVEO1FBRUQsT0FBTztZQUNMLElBQUksRUFBRSxVQUFVO1lBQ2hCLFNBQVMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLGVBQWU7U0FDeEQsQ0FBQTtJQUNILENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgR3JvdXBlZENvbHVtbkFnZ3JlZ2F0ZUNvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi8uLi8uLi9pbnRlcmZhY2VzL28tdGFibGUtY29sdW1ucy1ncm91cGluZy1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWwvdXRpbCc7XG5pbXBvcnQge1xuICBPVGFibGVDb2x1bW5zR3JvdXBpbmdDb2x1bW5Db21wb25lbnRcbn0gZnJvbSAnLi4vaGVhZGVyL3RhYmxlLWNvbHVtbnMtZ3JvdXBpbmcvY29sdW1ucy9vLXRhYmxlLWNvbHVtbnMtZ3JvdXBpbmctY29sdW1uLmNvbXBvbmVudCc7XG5cbmV4cG9ydCB0eXBlIEFnZ3JlZ2F0ZUNoYW5nZUFyZyA9IHtcbiAgY29sdW1uQXR0cjogc3RyaW5nO1xuICBhY3RpdmVBZ2dyZWdhdGU6IHN0cmluZztcbiAgY2hhbmdlQWxsR3JvdXBlZFJvd3M6IGJvb2xlYW47XG4gIHJvdzogT1RhYmxlR3JvdXBlZFJvdztcbn1cblxuZXhwb3J0IHR5cGUgQWdncmVnYXRlQ29sdW1uRGF0YSA9IHtcbiAgY29tcG9uZW50OiBPVGFibGVDb2x1bW5zR3JvdXBpbmdDb2x1bW5Db21wb25lbnQ7XG4gIGFjdGl2ZUFnZ3JlZ2F0ZTogc3RyaW5nO1xuICB2YWx1ZTogYW55O1xuICBkYXRhOiBhbnlbXTtcbn1cblxuZXhwb3J0IGNsYXNzIE9UYWJsZUdyb3VwZWRSb3cge1xuICBjb2x1bW46IHN0cmluZztcbiAgdGl0bGU6IHN0cmluZztcbiAgZ3JvdXBEYXRhOiBhbnlbXTtcbiAgbGV2ZWwgPSAwO1xuICBrZXlzQXNTdHJpbmc6IHN0cmluZztcbiAgcGFyZW50OiBPVGFibGVHcm91cGVkUm93O1xuICBleHBhbmRlZCA9IHRydWU7XG4gIGdldCB2aXNpYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5wYXJlbnQgfHwgKHRoaXMucGFyZW50LnZpc2libGUgJiYgdGhpcy5wYXJlbnQuZXhwYW5kZWQpO1xuICB9XG4gIHByaXZhdGUgY29sdW1uc0RhdGE6IHsgW2tleTogc3RyaW5nXTogQWdncmVnYXRlQ29sdW1uRGF0YSB9ID0ge307XG5cbiAgYWdncmVnYXRlRnVuY3Rpb25DaGFuZ2U6IFN1YmplY3Q8QWdncmVnYXRlQ2hhbmdlQXJnPiA9IG5ldyBTdWJqZWN0PEFnZ3JlZ2F0ZUNoYW5nZUFyZz4oKTtcblxuICBjb25zdHJ1Y3Rvcihhcmc/OiBhbnkpIHtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQoYXJnKSkge1xuICAgICAgdGhpcy5jb2x1bW4gPSBhcmcuY29sdW1uO1xuICAgICAgdGhpcy5rZXlzQXNTdHJpbmcgPSBhcmcua2V5c0FzU3RyaW5nO1xuICAgICAgdGhpcy5sZXZlbCA9IGFyZy5sZXZlbDtcbiAgICAgIHRoaXMucGFyZW50ID0gYXJnLnBhcmVudDtcbiAgICB9XG4gIH1cblxuICBoYXNDb2x1bW5EYXRhKGNvbHVtbkF0dHI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBVdGlsLmlzRGVmaW5lZCh0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdKTtcbiAgfVxuXG4gIGhhc0FjdGl2ZUFnZ3JlZ2F0ZShjb2x1bW5BdHRyOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5oYXNDb2x1bW5EYXRhKGNvbHVtbkF0dHIpICYmIFV0aWwuaXNEZWZpbmVkKHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uYWN0aXZlQWdncmVnYXRlKTtcbiAgfVxuXG4gIGdldENvbHVtbkdyb3VwaW5nQ29tcG9uZW50KGNvbHVtbkF0dHI6IHN0cmluZyk6IE9UYWJsZUNvbHVtbnNHcm91cGluZ0NvbHVtbkNvbXBvbmVudCB7XG4gICAgcmV0dXJuIHRoaXMuaGFzQ29sdW1uRGF0YShjb2x1bW5BdHRyKSA/IHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uY29tcG9uZW50IDogbnVsbDtcbiAgfVxuXG4gIGdldENvbHVtbkFnZ3JlZ2F0ZVZhbHVlKGNvbHVtbkF0dHI6IHN0cmluZyk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0udmFsdWU7XG4gIH1cblxuICBzZXRDb2x1bW5BZ2dyZWdhdGVWYWx1ZShjb2x1bW5BdHRyOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICB0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdLnZhbHVlID0gdmFsdWU7XG4gIH1cblxuICBleHBhbmRTYW1lTGV2ZWwoZGVmYXVsdFZhbHVlOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLmhhc0NvbHVtbkRhdGEodGhpcy5jb2x1bW4pKSB7XG4gICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xuICAgIH1cbiAgICBjb25zdCBncm91cGluZ0NvbXBvbmVudCA9IHRoaXMuZ2V0Q29sdW1uR3JvdXBpbmdDb21wb25lbnQodGhpcy5jb2x1bW4pO1xuICAgIGlmIChVdGlsLmlzRGVmaW5lZChncm91cGluZ0NvbXBvbmVudCkpIHtcbiAgICAgIHJldHVybiBncm91cGluZ0NvbXBvbmVudC5leHBhbmRHcm91cHNTYW1lTGV2ZWw7XG4gICAgfVxuICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XG4gIH1cblxuICBzZXRDb2x1bW5BZ2dyZWdhdGVEYXRhKGNvbHVtbkF0dHI6IHN0cmluZywgdmFsdWU6IGFueVtdKSB7XG4gICAgaWYgKHRoaXMuaGFzQ29sdW1uRGF0YShjb2x1bW5BdHRyKSkge1xuICAgICAgdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXS5kYXRhID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q29sdW1uQWdncmVnYXRlRGF0YShjb2x1bW5BdHRyOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5oYXNDb2x1bW5EYXRhKGNvbHVtbkF0dHIpID8gdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXS5kYXRhIDogW107XG4gIH1cblxuICBzZXRDb2x1bW5BY3RpdmVBZ2dyZWdhdGVGdW5jdGlvbihjb2x1bW5BdHRyOiBzdHJpbmcsIGFnZ3JlZ2F0ZUZuTmFtZTogc3RyaW5nLCBlbWl0RXZlbnQ6IGJvb2xlYW4gPSB0cnVlKSB7XG4gICAgaWYgKHRoaXMuaGFzQ29sdW1uRGF0YShjb2x1bW5BdHRyKSkge1xuICAgICAgdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXS5hY3RpdmVBZ2dyZWdhdGUgPSBhZ2dyZWdhdGVGbk5hbWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0gPSB7XG4gICAgICAgIGNvbXBvbmVudDogbnVsbCxcbiAgICAgICAgYWN0aXZlQWdncmVnYXRlOiBhZ2dyZWdhdGVGbk5hbWUsXG4gICAgICAgIHZhbHVlOiBudWxsLFxuICAgICAgICBkYXRhOiBbXVxuICAgICAgfTtcbiAgICB9XG4gICAgaWYgKGVtaXRFdmVudCkge1xuICAgICAgbGV0IGNoYW5nZUFsbEdyb3VwZWRSb3dzID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGdyb3VwaW5nQ29tcG9uZW50ID0gdGhpcy5nZXRDb2x1bW5Hcm91cGluZ0NvbXBvbmVudChjb2x1bW5BdHRyKTtcbiAgICAgIGlmIChVdGlsLmlzRGVmaW5lZChncm91cGluZ0NvbXBvbmVudCkpIHtcbiAgICAgICAgY2hhbmdlQWxsR3JvdXBlZFJvd3MgPSBncm91cGluZ0NvbXBvbmVudC5jaGFuZ2VBZ2dyZWdhdGVTYW1lTGV2ZWw7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYWdncmVnYXRlRnVuY3Rpb25DaGFuZ2UubmV4dCh7XG4gICAgICAgIGNvbHVtbkF0dHI6IGNvbHVtbkF0dHIsXG4gICAgICAgIGFjdGl2ZUFnZ3JlZ2F0ZTogYWdncmVnYXRlRm5OYW1lLFxuICAgICAgICBjaGFuZ2VBbGxHcm91cGVkUm93czogY2hhbmdlQWxsR3JvdXBlZFJvd3MsXG4gICAgICAgIHJvdzogdGhpc1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q29sdW1uQWN0aXZlQWdncmVnYXRlVGl0bGUoY29sdW1uQXR0cjogc3RyaW5nKSB7XG4gICAgY29uc3QgY29uZiA9IHRoaXMuZ2V0QWN0aXZlQ29sdW1uQWdncmVnYXRlQ29uZmlndXJhdGlvbihjb2x1bW5BdHRyKTtcbiAgICBpZiAoY29uZi50aXRsZSkge1xuICAgICAgcmV0dXJuIGNvbmYudGl0bGU7XG4gICAgfVxuICAgIHJldHVybiBgQUdHUkVHQVRFX05BTUUuJHtjb25mLmFnZ3JlZ2F0ZU5hbWUgfHwgY29uZi5hZ2dyZWdhdGV9YDtcbiAgfVxuXG4gIGluaXRpYWxpemVDb2x1bW5BZ2dyZWdhdGUoY29sdW1uQXR0cjogc3RyaW5nLCBjb21wb25lbnQ6IE9UYWJsZUNvbHVtbnNHcm91cGluZ0NvbHVtbkNvbXBvbmVudCkge1xuICAgIGlmICghdGhpcy5jb2x1bW5zRGF0YS5oYXNPd25Qcm9wZXJ0eShjb2x1bW5BdHRyKSkge1xuICAgICAgdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXSA9IHtcbiAgICAgICAgY29tcG9uZW50OiBudWxsLFxuICAgICAgICBhY3RpdmVBZ2dyZWdhdGU6ICdzdW0nLFxuICAgICAgICB2YWx1ZTogbnVsbCxcbiAgICAgICAgZGF0YTogW11cbiAgICAgIH07XG4gICAgfVxuICAgIGlmIChVdGlsLmlzRGVmaW5lZChjb21wb25lbnQpKSB7XG4gICAgICB0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdLmNvbXBvbmVudCA9IGNvbXBvbmVudDtcbiAgICAgIHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uYWN0aXZlQWdncmVnYXRlID0gY29tcG9uZW50LmFnZ3JlZ2F0ZTtcbiAgICB9XG4gIH1cblxuICBnZXRBY3RpdmVDb2x1bW5BZ2dyZWdhdGVDb25maWd1cmF0aW9uKGNvbHVtbkF0dHI6IHN0cmluZyk6IEdyb3VwZWRDb2x1bW5BZ2dyZWdhdGVDb25maWd1cmF0aW9uIHtcbiAgICBpZiAoIXRoaXMuaGFzQ29sdW1uRGF0YShjb2x1bW5BdHRyKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYXR0cjogY29sdW1uQXR0cixcbiAgICAgICAgYWdncmVnYXRlOiAnc3VtJ1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGFjdGl2ZUFnZ3JlZ2F0ZSA9IHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uYWN0aXZlQWdncmVnYXRlO1xuICAgIGNvbnN0IGdyb3VwaW5nQ29sdW1uQ29tcG9uZW50ID0gdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXS5jb21wb25lbnQ7XG4gICAgaWYgKFV0aWwuaXNEZWZpbmVkKGdyb3VwaW5nQ29sdW1uQ29tcG9uZW50KSAmJiBncm91cGluZ0NvbHVtbkNvbXBvbmVudC5hZ2dyZWdhdGUgPT09IGFjdGl2ZUFnZ3JlZ2F0ZSkge1xuICAgICAgcmV0dXJuIGdyb3VwaW5nQ29sdW1uQ29tcG9uZW50LmdldEFnZ3JlZ2F0ZUNvbmZpZ3VyYXRpb24oKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgYXR0cjogY29sdW1uQXR0cixcbiAgICAgIGFnZ3JlZ2F0ZTogdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXS5hY3RpdmVBZ2dyZWdhdGVcbiAgICB9XG4gIH1cblxufVxuIl19