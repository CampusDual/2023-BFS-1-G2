import * as tslib_1 from "tslib";
import { ElementRef, EventEmitter, Inject, Injector, Optional, ViewChild } from '@angular/core';
import { MAT_FORM_FIELD_DEFAULT_OPTIONS, MatExpansionPanel } from '@angular/material';
import { Subscription } from 'rxjs';
import { InputConverter } from '../../decorators/input-converter';
import { DEFAULT_INPUTS_O_CONTAINER, OContainerComponent } from './o-container-component.class';
export const DEFAULT_INPUTS_O_CONTAINER_COLLAPSIBLE = [
    ...DEFAULT_INPUTS_O_CONTAINER,
    'expanded',
    'description',
    'collapsedHeight: collapsed-height',
    'expandedHeight: expanded-height'
];
export const DEFAULT_OUTPUTS_O_CONTAINER_COLLAPSIBLE = [
    'onClosed',
    'onOpened',
    'onAfterCollapse',
    'onAfterExpand'
];
export class OContainerCollapsibleComponent extends OContainerComponent {
    constructor(elRef, injector, matFormDefaultOption) {
        super(elRef, injector, matFormDefaultOption);
        this.elRef = elRef;
        this.injector = injector;
        this.matFormDefaultOption = matFormDefaultOption;
        this.expanded = true;
        this.collapsedHeight = '37px';
        this.expandedHeight = '37px';
        this.onClosed = new EventEmitter();
        this.onOpened = new EventEmitter();
        this.onAfterCollapse = new EventEmitter();
        this.onAfterExpand = new EventEmitter();
        this.expPanelSubscriptions = new Subscription();
    }
    ngAfterViewInit() {
        super.ngAfterViewInit();
        this.updateOutlineGap();
        this.subscribeEventsExpPanel();
    }
    subscribeEventsExpPanel() {
        this.expPanelSubscriptions.add(this.expPanel.afterCollapse.subscribe(() => this.onAfterCollapse.emit()));
        this.expPanelSubscriptions.add(this.expPanel.afterExpand.subscribe(() => this.onAfterExpand.emit()));
        this.expPanelSubscriptions.add(this.expPanel.closed.subscribe(() => this.onClosed.emit()));
        this.expPanelSubscriptions.add(this.expPanel.opened.subscribe(() => this.onOpened.emit()));
    }
    updateOutlineGap() {
        if (this.isAppearanceOutline()) {
            const exPanelHeader = this._titleEl ? this._titleEl._element.nativeElement : null;
            if (!this.oContainerOutline) {
                return;
            }
            const containerOutline = this.oContainerOutline.nativeElement;
            const containerOutlineRect = containerOutline.getBoundingClientRect();
            if (containerOutlineRect.width === 0 && containerOutlineRect.height === 0) {
                return;
            }
            const titleEl = exPanelHeader.querySelector('.o-container-title.mat-expansion-panel-header-title');
            const descrEl = exPanelHeader.querySelector('.mat-expansion-panel-header-description');
            const containerStart = containerOutlineRect.left;
            const descrStart = descrEl.getBoundingClientRect().left;
            let titleWidth = 0;
            if (this.hasHeader()) {
                titleWidth += this.icon ? titleEl.querySelector('mat-icon').offsetWidth : 0;
                titleWidth += this.title ? titleEl.querySelector('span').offsetWidth : 0;
                titleWidth = titleWidth === 0 ? 0 : titleWidth + 4;
            }
            const labelStart = titleEl.getBoundingClientRect().left;
            const startWidth = labelStart - containerStart - 2;
            const empty1Width = descrStart - containerStart - titleWidth - 24;
            const descrWidth = this.description ? descrEl.querySelector('span').offsetWidth + 8 : 0;
            const startEls = containerOutline.querySelectorAll('.o-container-outline-start');
            const gapTitleEls = containerOutline.querySelectorAll('.o-container-outline-gap-title');
            const gapEmpty1Els = containerOutline.querySelectorAll('.o-container-outline-gap-empty1');
            const gapDescrEls = containerOutline.querySelectorAll('.o-container-outline-gap-description');
            startEls[0].style.width = `${startWidth}px`;
            gapTitleEls[0].style.width = `${titleWidth}px`;
            gapEmpty1Els[0].style.width = `${empty1Width}px`;
            gapDescrEls[0].style.width = `${descrWidth}px`;
        }
    }
    registerObserver() {
        if (this._titleEl) {
            this.titleObserver.observe(this._titleEl._element.nativeElement, {
                childList: true,
                characterData: true,
                subtree: true
            });
        }
    }
    updateInnerHeight(height) {
        if (this.containerContent) {
            this.containerContent.nativeElement.style.height = height;
        }
        if (this.oContainerOutline) {
            this.oContainerOutline.nativeElement.style.height = height;
        }
    }
    ngOnDestroy() {
        this.expPanelSubscriptions.unsubscribe();
    }
}
OContainerCollapsibleComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Injector },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [MAT_FORM_FIELD_DEFAULT_OPTIONS,] }] }
];
OContainerCollapsibleComponent.propDecorators = {
    expPanel: [{ type: ViewChild, args: ['expPanel', { static: false },] }],
    containerContent: [{ type: ViewChild, args: ['containerContent', { static: true },] }],
    oContainerOutline: [{ type: ViewChild, args: ['oContainerOutline', { static: false },] }]
};
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Boolean)
], OContainerCollapsibleComponent.prototype, "expanded", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1jb250YWluZXItY29sbGFwc2libGUtY29tcG9uZW50LmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2NvbnRhaW5lci9vLWNvbnRhaW5lci1jb2xsYXBzaWJsZS1jb21wb25lbnQuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBaUIsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFhLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUgsT0FBTyxFQUFFLDhCQUE4QixFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVwQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDbEUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLG1CQUFtQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFaEcsTUFBTSxDQUFDLE1BQU0sc0NBQXNDLEdBQUc7SUFDcEQsR0FBRywwQkFBMEI7SUFDN0IsVUFBVTtJQUNWLGFBQWE7SUFDYixtQ0FBbUM7SUFDbkMsaUNBQWlDO0NBQ2xDLENBQUM7QUFDRixNQUFNLENBQUMsTUFBTSx1Q0FBdUMsR0FBRztJQUVyRCxVQUFVO0lBRVYsVUFBVTtJQUVWLGlCQUFpQjtJQUVqQixlQUFlO0NBQ2hCLENBQUE7QUFFRCxNQUFNLE9BQU8sOEJBQStCLFNBQVEsbUJBQW1CO0lBb0JyRSxZQUNZLEtBQWlCLEVBQ2pCLFFBQWtCLEVBQ2tDLG9CQUFvQjtRQUVsRixLQUFLLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1FBSm5DLFVBQUssR0FBTCxLQUFLLENBQVk7UUFDakIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNrQyx5QkFBb0IsR0FBcEIsb0JBQW9C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O2dFQUNlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbmplY3QsIEluamVjdG9yLCBPbkRlc3Ryb3ksIE9wdGlvbmFsLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE1BVF9GT1JNX0ZJRUxEX0RFRkFVTFRfT1BUSU9OUywgTWF0RXhwYW5zaW9uUGFuZWwgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbCc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgSW5wdXRDb252ZXJ0ZXIgfSBmcm9tICcuLi8uLi9kZWNvcmF0b3JzL2lucHV0LWNvbnZlcnRlcic7XG5pbXBvcnQgeyBERUZBVUxUX0lOUFVUU19PX0NPTlRBSU5FUiwgT0NvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4vby1jb250YWluZXItY29tcG9uZW50LmNsYXNzJztcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfSU5QVVRTX09fQ09OVEFJTkVSX0NPTExBUFNJQkxFID0gW1xuICAuLi5ERUZBVUxUX0lOUFVUU19PX0NPTlRBSU5FUixcbiAgJ2V4cGFuZGVkJyxcbiAgJ2Rlc2NyaXB0aW9uJyxcbiAgJ2NvbGxhcHNlZEhlaWdodDogY29sbGFwc2VkLWhlaWdodCcsXG4gICdleHBhbmRlZEhlaWdodDogZXhwYW5kZWQtaGVpZ2h0J1xuXTtcbmV4cG9ydCBjb25zdCBERUZBVUxUX09VVFBVVFNfT19DT05UQUlORVJfQ09MTEFQU0lCTEUgPSBbXG4gIC8vb25DbG9zZWQ6IEV2ZW50IGVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgY29tcG9uZW50IGNvbGxhcHNpYmxlIGlzIGNsb3NlZC5cbiAgJ29uQ2xvc2VkJyxcbiAgLy9vbk9wZW5lZDogRXZlbnQgZW1pdHRlZCBldmVyeSB0aW1lIHRoZSBjb21wb25lbnQgY29sbGFwc2libGUgaXMgb3BlbmVkLlxuICAnb25PcGVuZWQnLFxuICAvL29uQWZ0ZXJDb2xsYXBzZTogQW4gZXZlbnQgZW1pdHRlZCBhZnRlciB0aGUgYm9keSdzIGNvbGxhcHNlIGFuaW1hdGlvbiBoYXBwZW5zLlxuICAnb25BZnRlckNvbGxhcHNlJyxcbiAgLy9vbkFmdGVyRXhwYW5kOiBBbiBldmVudCBlbWl0dGVkIGFmdGVyIHRoZSBib2R5J3MgZXhwYW5zaW9uIGFuaW1hdGlvbiBoYXBwZW5zLlxuICAnb25BZnRlckV4cGFuZCdcbl1cblxuZXhwb3J0IGNsYXNzIE9Db250YWluZXJDb2xsYXBzaWJsZUNvbXBvbmVudCBleHRlbmRzIE9Db250YWluZXJDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuXG4gIEBJbnB1dENvbnZlcnRlcigpXG4gIHB1YmxpYyBleHBhbmRlZDogYm9vbGVhbiA9IHRydWU7XG4gIHB1YmxpYyBjb2xsYXBzZWRIZWlnaHQgPSAnMzdweCc7XG4gIHB1YmxpYyBleHBhbmRlZEhlaWdodCA9ICczN3B4JztcbiAgcHVibGljIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG5cbiAgb25DbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIG9uT3BlbmVkID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBvbkFmdGVyQ29sbGFwc2UgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIG9uQWZ0ZXJFeHBhbmQgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgQFZpZXdDaGlsZCgnZXhwUGFuZWwnLCB7IHN0YXRpYzogZmFsc2UgfSkgZXhwUGFuZWw6IE1hdEV4cGFuc2lvblBhbmVsOyAvLyBVc2VkIGluIHN1YmNvbXBvbmVudHNcbiAgQFZpZXdDaGlsZCgnY29udGFpbmVyQ29udGVudCcsIHsgc3RhdGljOiB0cnVlIH0pIHByb3RlY3RlZCBjb250YWluZXJDb250ZW50OiBFbGVtZW50UmVmO1xuICBAVmlld0NoaWxkKCdvQ29udGFpbmVyT3V0bGluZScsIHsgc3RhdGljOiBmYWxzZSB9KSBwcm90ZWN0ZWQgb0NvbnRhaW5lck91dGxpbmU6IEVsZW1lbnRSZWY7XG5cblxuICBwcm90ZWN0ZWQgZXhwUGFuZWxTdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGVsUmVmOiBFbGVtZW50UmVmLFxuICAgIHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChNQVRfRk9STV9GSUVMRF9ERUZBVUxUX09QVElPTlMpIHByb3RlY3RlZCBtYXRGb3JtRGVmYXVsdE9wdGlvblxuICApIHtcbiAgICBzdXBlcihlbFJlZiwgaW5qZWN0b3IsIG1hdEZvcm1EZWZhdWx0T3B0aW9uKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBzdXBlci5uZ0FmdGVyVmlld0luaXQoKTtcbiAgICB0aGlzLnVwZGF0ZU91dGxpbmVHYXAoKTtcbiAgICB0aGlzLnN1YnNjcmliZUV2ZW50c0V4cFBhbmVsKCk7XG4gIH1cblxuICBzdWJzY3JpYmVFdmVudHNFeHBQYW5lbCgpIHtcbiAgICB0aGlzLmV4cFBhbmVsU3Vic2NyaXB0aW9ucy5hZGQodGhpcy5leHBQYW5lbC5hZnRlckNvbGxhcHNlLnN1YnNjcmliZSgoKSA9PiB0aGlzLm9uQWZ0ZXJDb2xsYXBzZS5lbWl0KCkpKTtcbiAgICB0aGlzLmV4cFBhbmVsU3Vic2NyaXB0aW9ucy5hZGQodGhpcy5leHBQYW5lbC5hZnRlckV4cGFuZC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5vbkFmdGVyRXhwYW5kLmVtaXQoKSkpO1xuICAgIHRoaXMuZXhwUGFuZWxTdWJzY3JpcHRpb25zLmFkZCh0aGlzLmV4cFBhbmVsLmNsb3NlZC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5vbkNsb3NlZC5lbWl0KCkpKTtcbiAgICB0aGlzLmV4cFBhbmVsU3Vic2NyaXB0aW9ucy5hZGQodGhpcy5leHBQYW5lbC5vcGVuZWQuc3Vic2NyaWJlKCgpID0+IHRoaXMub25PcGVuZWQuZW1pdCgpKSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdXBkYXRlT3V0bGluZUdhcCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc0FwcGVhcmFuY2VPdXRsaW5lKCkpIHtcbiAgICAgIGNvbnN0IGV4UGFuZWxIZWFkZXIgPSB0aGlzLl90aXRsZUVsID8gKHRoaXMuX3RpdGxlRWwgYXMgYW55KS5fZWxlbWVudC5uYXRpdmVFbGVtZW50IDogbnVsbDtcblxuICAgICAgaWYgKCF0aGlzLm9Db250YWluZXJPdXRsaW5lKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGNvbnRhaW5lck91dGxpbmUgPSB0aGlzLm9Db250YWluZXJPdXRsaW5lLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICBjb25zdCBjb250YWluZXJPdXRsaW5lUmVjdCA9IGNvbnRhaW5lck91dGxpbmUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICBpZiAoY29udGFpbmVyT3V0bGluZVJlY3Qud2lkdGggPT09IDAgJiYgY29udGFpbmVyT3V0bGluZVJlY3QuaGVpZ2h0ID09PSAwKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdGl0bGVFbCA9IGV4UGFuZWxIZWFkZXIucXVlcnlTZWxlY3RvcignLm8tY29udGFpbmVyLXRpdGxlLm1hdC1leHBhbnNpb24tcGFuZWwtaGVhZGVyLXRpdGxlJyk7XG4gICAgICBjb25zdCBkZXNjckVsID0gZXhQYW5lbEhlYWRlci5xdWVyeVNlbGVjdG9yKCcubWF0LWV4cGFuc2lvbi1wYW5lbC1oZWFkZXItZGVzY3JpcHRpb24nKTtcblxuICAgICAgY29uc3QgY29udGFpbmVyU3RhcnQgPSBjb250YWluZXJPdXRsaW5lUmVjdC5sZWZ0O1xuICAgICAgY29uc3QgZGVzY3JTdGFydCA9IGRlc2NyRWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdDtcblxuICAgICAgbGV0IHRpdGxlV2lkdGggPSAwO1xuICAgICAgaWYgKHRoaXMuaGFzSGVhZGVyKCkpIHtcbiAgICAgICAgdGl0bGVXaWR0aCArPSB0aGlzLmljb24gPyB0aXRsZUVsLnF1ZXJ5U2VsZWN0b3IoJ21hdC1pY29uJykub2Zmc2V0V2lkdGggOiAwOyAvLyBpY29uXG4gICAgICAgIHRpdGxlV2lkdGggKz0gdGhpcy50aXRsZSA/IHRpdGxlRWwucXVlcnlTZWxlY3Rvcignc3BhbicpLm9mZnNldFdpZHRoIDogMDsgLy8gdGl0bGVcbiAgICAgICAgdGl0bGVXaWR0aCA9IHRpdGxlV2lkdGggPT09IDAgPyAwIDogdGl0bGVXaWR0aCArIDQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGxhYmVsU3RhcnQgPSB0aXRsZUVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7XG4gICAgICBjb25zdCBzdGFydFdpZHRoID0gbGFiZWxTdGFydCAtIGNvbnRhaW5lclN0YXJ0IC0gMjtcbiAgICAgIGNvbnN0IGVtcHR5MVdpZHRoID0gZGVzY3JTdGFydCAtIGNvbnRhaW5lclN0YXJ0IC0gdGl0bGVXaWR0aCAtIDI0O1xuICAgICAgY29uc3QgZGVzY3JXaWR0aCA9IHRoaXMuZGVzY3JpcHRpb24gPyBkZXNjckVsLnF1ZXJ5U2VsZWN0b3IoJ3NwYW4nKS5vZmZzZXRXaWR0aCArIDggOiAwO1xuXG4gICAgICBjb25zdCBzdGFydEVscyA9IGNvbnRhaW5lck91dGxpbmUucXVlcnlTZWxlY3RvckFsbCgnLm8tY29udGFpbmVyLW91dGxpbmUtc3RhcnQnKTtcbiAgICAgIGNvbnN0IGdhcFRpdGxlRWxzID0gY29udGFpbmVyT3V0bGluZS5xdWVyeVNlbGVjdG9yQWxsKCcuby1jb250YWluZXItb3V0bGluZS1nYXAtdGl0bGUnKTtcbiAgICAgIGNvbnN0IGdhcEVtcHR5MUVscyA9IGNvbnRhaW5lck91dGxpbmUucXVlcnlTZWxlY3RvckFsbCgnLm8tY29udGFpbmVyLW91dGxpbmUtZ2FwLWVtcHR5MScpO1xuICAgICAgY29uc3QgZ2FwRGVzY3JFbHMgPSBjb250YWluZXJPdXRsaW5lLnF1ZXJ5U2VsZWN0b3JBbGwoJy5vLWNvbnRhaW5lci1vdXRsaW5lLWdhcC1kZXNjcmlwdGlvbicpO1xuXG4gICAgICBzdGFydEVsc1swXS5zdHlsZS53aWR0aCA9IGAke3N0YXJ0V2lkdGh9cHhgO1xuICAgICAgZ2FwVGl0bGVFbHNbMF0uc3R5bGUud2lkdGggPSBgJHt0aXRsZVdpZHRofXB4YDtcbiAgICAgIGdhcEVtcHR5MUVsc1swXS5zdHlsZS53aWR0aCA9IGAke2VtcHR5MVdpZHRofXB4YDtcbiAgICAgIGdhcERlc2NyRWxzWzBdLnN0eWxlLndpZHRoID0gYCR7ZGVzY3JXaWR0aH1weGA7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHJlZ2lzdGVyT2JzZXJ2ZXIoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3RpdGxlRWwpIHtcbiAgICAgIHRoaXMudGl0bGVPYnNlcnZlci5vYnNlcnZlKCh0aGlzLl90aXRsZUVsIGFzIGFueSkuX2VsZW1lbnQubmF0aXZlRWxlbWVudCwge1xuICAgICAgICBjaGlsZExpc3Q6IHRydWUsXG4gICAgICAgIGNoYXJhY3RlckRhdGE6IHRydWUsXG4gICAgICAgIHN1YnRyZWU6IHRydWVcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZUlubmVySGVpZ2h0KGhlaWdodDogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY29udGFpbmVyQ29udGVudCkge1xuICAgICAgdGhpcy5jb250YWluZXJDb250ZW50Lm5hdGl2ZUVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgIH1cbiAgICBpZiAodGhpcy5vQ29udGFpbmVyT3V0bGluZSkge1xuICAgICAgdGhpcy5vQ29udGFpbmVyT3V0bGluZS5uYXRpdmVFbGVtZW50LnN0eWxlLmhlaWdodCA9IGhlaWdodDtcbiAgICB9XG4gIH1cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5leHBQYW5lbFN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTtcbiAgfVxuXG59XG4iXX0=