import * as tslib_1 from "tslib";
import { Component, ElementRef, forwardRef, Inject, Injector, Optional, ViewEncapsulation } from '@angular/core';
import { InputConverter } from '../../../decorators/input-converter';
import { ORealPipe } from '../../../pipes/o-real.pipe';
import { NumberService } from '../../../services/number.service';
import { Util } from '../../../util/util';
import { OFormComponent } from '../../form/o-form.component';
import { DEFAULT_INPUTS_O_INTEGER_INPUT, DEFAULT_OUTPUTS_O_INTEGER_INPUT, OIntegerInputComponent } from '../integer-input/o-integer-input.component';
export const DEFAULT_INPUTS_O_REAL_INPUT = [
    ...DEFAULT_INPUTS_O_INTEGER_INPUT,
    'minDecimalDigits: min-decimal-digits',
    'maxDecimalDigits: max-decimal-digits',
    'decimalSeparator : decimal-separator',
    'strict'
];
export const DEFAULT_OUTPUTS_O_REAL_INPUT = [
    ...DEFAULT_OUTPUTS_O_INTEGER_INPUT
];
export class ORealInputComponent extends OIntegerInputComponent {
    constructor(form, elRef, injector) {
        super(form, elRef, injector);
        this.minDecimalDigits = 2;
        this.maxDecimalDigits = 2;
        this.step = 0.01;
        this.grouping = true;
        this.strict = false;
        this._defaultSQLTypeKey = 'FLOAT';
        this.numberService = this.injector.get(NumberService);
    }
    setComponentPipe() {
        this.componentPipe = new ORealPipe(this.injector);
    }
    initialize() {
        super.initialize();
        this.getFormControl().getValue = function () {
            if (!isNaN(Number(this.value))) {
                return Number(this.value);
            }
            else {
                return this.value;
            }
        };
    }
    ngOnInit() {
        super.ngOnInit();
        this.pipeArguments.decimalSeparator = this.decimalSeparator;
        this.pipeArguments.minDecimalDigits = this.minDecimalDigits;
        this.pipeArguments.maxDecimalDigits = this.maxDecimalDigits;
        this.pipeArguments.truncate = false;
        if (!this.isEmpty()) {
            this.ensureOFormValue(this.value);
        }
    }
    resolveValidators() {
        const validators = super.resolveValidators();
        if (Util.isDefined(this.maxDecimalDigits)) {
            validators.push(this.maxDecimalDigitsValidator.bind(this));
        }
        return validators;
    }
    ensureOFormValue(arg) {
        super.ensureOFormValue(arg);
        if (!this.isEmpty() && Util.isDefined(this.pipeArguments)) {
            const formattedValue = this.numberService.getRealValue(this.value.value, this.pipeArguments);
            if (!isNaN(Number(formattedValue))) {
                this.value.value = formattedValue;
            }
        }
    }
    maxDecimalDigitsValidator(control) {
        let ctrlValue = control.value;
        if (typeof control.value === 'number') {
            ctrlValue = ctrlValue.toString();
        }
        if (this.strict && ctrlValue && ctrlValue.length) {
            const valArray = ctrlValue.split(this.decimalSeparator ? this.decimalSeparator : '.');
            if (Util.isDefined(this.maxDecimalDigits) && (this.maxDecimalDigits > 0) && Util.isDefined(valArray[1]) && (valArray[1].length > this.maxDecimalDigits)) {
                return {
                    maxDecimaldigits: {
                        requiredMaxDecimaldigits: this.maxDecimalDigits
                    }
                };
            }
        }
        return {};
    }
    initializeStep() {
        if (this.step <= 0) {
            this.step = 1 / Math.pow(10, this.maxDecimalDigits);
            console.warn('`step` attribute must be greater than zero');
        }
    }
}
ORealInputComponent.decorators = [
    { type: Component, args: [{
                selector: 'o-real-input',
                template: "<div [formGroup]=\"getFormGroup()\" [matTooltip]=\"tooltip\" [matTooltipClass]=\"tooltipClass\"\n  [matTooltipPosition]=\"tooltipPosition\" [matTooltipShowDelay]=\"tooltipShowDelay\"\n  [matTooltipHideDelay]=\"tooltipHideDelay\">\n  <mat-form-field [appearance]=\"appearance\" [floatLabel]=\"floatLabel\" [hideRequiredMarker]=\"hideRequiredMarker\"\n    [class.custom-width]=\"hasCustomWidth\" [class.icon-field]=\"showClearButton\" fxFlexFill>\n    <mat-label *ngIf=\"labelVisible\">{{ olabel | oTranslate }}</mat-label>\n    <input matInput [type]=\"inputType\" [id]=\"getAttribute()\" [formControlName]=\"getAttribute()\"\n      [placeholder]=\"placeHolder\" (focus)=\"innerOnFocus($event)\" (blur)=\"innerOnBlur($event)\"\n      (change)=\"onChangeEvent($event)\" [readonly]=\"isReadOnly\" [min]=\"min\" [max]=\"max\" [step]=\"step\"\n      [required]=\"isRequired\">\n    <button type=\"button\" *ngIf=\"showClearButton\" matSuffix mat-icon-button (click)=\"onClickClearValue($event)\">\n      <mat-icon svgIcon=\"ontimize:close\"></mat-icon>\n    </button>\n    <mat-error *oMatError=\"hasError('required')\">\n      {{ 'FORM_VALIDATION.REQUIRED' | oTranslate }}\n    </mat-error>\n    <mat-error *oMatError=\"hasError('min')\">\n      {{ 'FORM_VALIDATION.MIN_VALUE' | oTranslate }}: {{ getErrorValue('min', 'requiredMin') }}\n    </mat-error>\n    <mat-error *oMatError=\"hasError('max')\">\n      {{ 'FORM_VALIDATION.MAX_VALUE' | oTranslate }}: {{ getErrorValue('max', 'requiredMax') }}\n    </mat-error>\n    <mat-error *oMatError=\"hasError('minDecimaldigits')\">\n      {{ 'FORM_VALIDATION.MIN_DECIMAL_DIGITS' | oTranslate }}: {{ getErrorValue('minDecimaldigits', 'requiredMinDecimaldigits') }}\n    </mat-error>\n    <mat-error *oMatError=\"hasError('maxDecimaldigits')\">\n      {{ 'FORM_VALIDATION.MAX_DECIMAL_DIGITS' | oTranslate }}: {{ getErrorValue('maxDecimaldigits', 'requiredMaxDecimaldigits') }}\n    </mat-error>\n    <mat-error *ngFor=\"let oError of getActiveOErrors()\">\n      {{ oError.text | oTranslate }}\n    </mat-error>\n  </mat-form-field>\n</div>",
                inputs: DEFAULT_INPUTS_O_REAL_INPUT,
                outputs: DEFAULT_OUTPUTS_O_REAL_INPUT,
                encapsulation: ViewEncapsulation.None
            }] }
];
ORealInputComponent.ctorParameters = () => [
    { type: OFormComponent, decorators: [{ type: Optional }, { type: Inject, args: [forwardRef(() => OFormComponent),] }] },
    { type: ElementRef },
    { type: Injector }
];
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Number)
], ORealInputComponent.prototype, "minDecimalDigits", void 0);
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Number)
], ORealInputComponent.prototype, "maxDecimalDigits", void 0);
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Number)
], ORealInputComponent.prototype, "step", void 0);
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Boolean)
], ORealInputComponent.prototype, "grouping", void 0);
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Boolean)
], ORealInputComponent.prototype, "strict", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1yZWFsLWlucHV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9pbnB1dC9yZWFsLWlucHV0L28tcmVhbC1pbnB1dC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFVLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUd6SCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDckUsT0FBTyxFQUFxQixTQUFTLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMxRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDakUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsOEJBQThCLEVBQzlCLCtCQUErQixFQUMvQixzQkFBc0IsRUFDdkIsTUFBTSw0Q0FBNEMsQ0FBQztBQUdwRCxNQUFNLENBQUMsTUFBTSwyQkFBMkIsR0FBRztJQUN6QyxHQUFHLDhCQUE4QjtJQUNqQyxzQ0FBc0M7SUFDdEMsc0NBQXNDO0lBQ3RDLHNDQUFzQztJQUN0QyxRQUFRO0NBQ1QsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLDRCQUE0QixHQUFHO0lBQzFDLEdBQUcsK0JBQStCO0NBQ25DLENBQUM7QUFTRixNQUFNLE9BQU8sbUJBQW9CLFNBQVEsc0JBQXNCO0lBcUI3RCxZQUN3RCxJQUFvQixFQUMxRSxLQUFpQixFQUNqQixRQUFrQjtRQUVsQixLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQXZCL0IscUJBQWdCLEdBQVcsQ0FBQyxDQUFD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QzFEO0lBREMsY0FBYyxFQUFFOzs2REFDWTtBQUc3QjtJQURDLGNBQWMsRUFBRTs7NkRBQ1k7QUFHN0I7SUFEQyxjQUFjLEVBQUU7O2lEQUNHO0FBR3BCO0lBREMsY0FBYyxFQUFFOztxREFDUTtBQUd6QjtJQURDLGNBQWMsRUFBRTs7bURBQ08iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIGZvcndhcmRSZWYsIEluamVjdCwgSW5qZWN0b3IsIE9uSW5pdCwgT3B0aW9uYWwsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycywgVmFsaWRhdG9yRm4gfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbmltcG9ydCB7IElucHV0Q29udmVydGVyIH0gZnJvbSAnLi4vLi4vLi4vZGVjb3JhdG9ycy9pbnB1dC1jb252ZXJ0ZXInO1xuaW1wb3J0IHsgSVJlYWxQaXBlQXJndW1lbnQsIE9SZWFsUGlwZSB9IGZyb20gJy4uLy4uLy4uL3BpcGVzL28tcmVhbC5waXBlJztcbmltcG9ydCB7IE51bWJlclNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9udW1iZXIuc2VydmljZSc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vLi4vLi4vdXRpbC91dGlsJztcbmltcG9ydCB7IE9Gb3JtQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZm9ybS9vLWZvcm0uY29tcG9uZW50JztcbmltcG9ydCB7XG4gIERFRkFVTFRfSU5QVVRTX09fSU5URUdFUl9JTlBVVCxcbiAgREVGQVVMVF9PVVRQVVRTX09fSU5URUdFUl9JTlBVVCxcbiAgT0ludGVnZXJJbnB1dENvbXBvbmVudFxufSBmcm9tICcuLi9pbnRlZ2VyLWlucHV0L28taW50ZWdlci1pbnB1dC5jb21wb25lbnQnO1xuaW1wb3J0IHsgT0Zvcm1Db250cm9sIH0gZnJvbSAnLi4vby1mb3JtLWNvbnRyb2wuY2xhc3MnO1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9JTlBVVFNfT19SRUFMX0lOUFVUID0gW1xuICAuLi5ERUZBVUxUX0lOUFVUU19PX0lOVEVHRVJfSU5QVVQsXG4gICdtaW5EZWNpbWFsRGlnaXRzOiBtaW4tZGVjaW1hbC1kaWdpdHMnLFxuICAnbWF4RGVjaW1hbERpZ2l0czogbWF4LWRlY2ltYWwtZGlnaXRzJyxcbiAgJ2RlY2ltYWxTZXBhcmF0b3IgOiBkZWNpbWFsLXNlcGFyYXRvcicsXG4gICdzdHJpY3QnXG5dO1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9PVVRQVVRTX09fUkVBTF9JTlBVVCA9IFtcbiAgLi4uREVGQVVMVF9PVVRQVVRTX09fSU5URUdFUl9JTlBVVFxuXTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnby1yZWFsLWlucHV0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL28tcmVhbC1pbnB1dC5jb21wb25lbnQuaHRtbCcsXG4gIGlucHV0czogREVGQVVMVF9JTlBVVFNfT19SRUFMX0lOUFVULFxuICBvdXRwdXRzOiBERUZBVUxUX09VVFBVVFNfT19SRUFMX0lOUFVULFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lXG59KVxuZXhwb3J0IGNsYXNzIE9SZWFsSW5wdXRDb21wb25lbnQgZXh0ZW5kcyBPSW50ZWdlcklucHV0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICBASW5wdXRDb252ZXJ0ZXIoKVxuICBtaW5EZWNpbWFsRGlnaXRzOiBudW1iZXIgPSAyO1xuXG4gIEBJbnB1dENvbnZlcnRlcigpXG4gIG1heERlY2ltYWxEaWdpdHM6IG51bWJlciA9IDI7XG5cbiAgQElucHV0Q29udmVydGVyKClcbiAgc3RlcDogbnVtYmVyID0gMC4wMTtcblxuICBASW5wdXRDb252ZXJ0ZXIoKVxuICBncm91cGluZzogYm9vbGVhbiA9IHRydWU7XG5cbiAgQElucHV0Q29udmVydGVyKClcbiAgc3RyaWN0OiBib29sZWFuID0gZmFsc2U7XG5cbiAgcHJvdGVjdGVkIGRlY2ltYWxTZXBhcmF0b3I6IHN0cmluZztcbiAgcHJvdGVjdGVkIHBpcGVBcmd1bWVudHM6IElSZWFsUGlwZUFyZ3VtZW50O1xuICBwcm90ZWN0ZWQgbnVtYmVyU2VydmljZTogTnVtYmVyU2VydmljZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gT0Zvcm1Db21wb25lbnQpKSBmb3JtOiBPRm9ybUNvbXBvbmVudCxcbiAgICBlbFJlZjogRWxlbWVudFJlZixcbiAgICBpbmplY3RvcjogSW5qZWN0b3JcbiAgKSB7XG4gICAgc3VwZXIoZm9ybSwgZWxSZWYsIGluamVjdG9yKTtcbiAgICB0aGlzLl9kZWZhdWx0U1FMVHlwZUtleSA9ICdGTE9BVCc7XG4gICAgdGhpcy5udW1iZXJTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoTnVtYmVyU2VydmljZSk7XG4gIH1cblxuICBzZXRDb21wb25lbnRQaXBlKCk6IHZvaWQge1xuICAgIHRoaXMuY29tcG9uZW50UGlwZSA9IG5ldyBPUmVhbFBpcGUodGhpcy5pbmplY3Rvcik7XG4gIH1cblxuICBpbml0aWFsaXplKCkge1xuICAgIHN1cGVyLmluaXRpYWxpemUoKTtcbiAgICAvLyBPdmVycmlkZSBGb3JtQ29udHJvbCBnZXRWYWx1ZSBpbiBvcmRlciB0byByZXR1cm4gdGhlIGFwcHJvcHJpYXRlIGZvcm1hdHRlZCB2YWx1ZVxuICAgICh0aGlzLmdldEZvcm1Db250cm9sKCkgYXMgT0Zvcm1Db250cm9sKS5nZXRWYWx1ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmICghaXNOYU4oTnVtYmVyKHRoaXMudmFsdWUpKSkge1xuICAgICAgICByZXR1cm4gTnVtYmVyKHRoaXMudmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWU7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHN1cGVyLm5nT25Jbml0KCk7XG4gICAgdGhpcy5waXBlQXJndW1lbnRzLmRlY2ltYWxTZXBhcmF0b3IgPSB0aGlzLmRlY2ltYWxTZXBhcmF0b3I7XG4gICAgdGhpcy5waXBlQXJndW1lbnRzLm1pbkRlY2ltYWxEaWdpdHMgPSB0aGlzLm1pbkRlY2ltYWxEaWdpdHM7XG4gICAgdGhpcy5waXBlQXJndW1lbnRzLm1heERlY2ltYWxEaWdpdHMgPSB0aGlzLm1heERlY2ltYWxEaWdpdHM7XG4gICAgdGhpcy5waXBlQXJndW1lbnRzLnRydW5jYXRlID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLmlzRW1wdHkoKSkge1xuICAgICAgdGhpcy5lbnN1cmVPRm9ybVZhbHVlKHRoaXMudmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHJlc29sdmVWYWxpZGF0b3JzKCk6IFZhbGlkYXRvckZuW10ge1xuICAgIGNvbnN0IHZhbGlkYXRvcnM6IFZhbGlkYXRvckZuW10gPSBzdXBlci5yZXNvbHZlVmFsaWRhdG9ycygpO1xuICAgIGlmIChVdGlsLmlzRGVmaW5lZCh0aGlzLm1heERlY2ltYWxEaWdpdHMpKSB7XG4gICAgICB2YWxpZGF0b3JzLnB1c2godGhpcy5tYXhEZWNpbWFsRGlnaXRzVmFsaWRhdG9yLmJpbmQodGhpcykpO1xuICAgIH1cbiAgICByZXR1cm4gdmFsaWRhdG9ycztcbiAgfVxuXG4gIGVuc3VyZU9Gb3JtVmFsdWUoYXJnOiBhbnkpOiB2b2lkIHtcbiAgICBzdXBlci5lbnN1cmVPRm9ybVZhbHVlKGFyZyk7XG4gICAgaWYgKCF0aGlzLmlzRW1wdHkoKSAmJiBVdGlsLmlzRGVmaW5lZCh0aGlzLnBpcGVBcmd1bWVudHMpKSB7XG4gICAgICBjb25zdCBmb3JtYXR0ZWRWYWx1ZSA9IHRoaXMubnVtYmVyU2VydmljZS5nZXRSZWFsVmFsdWUodGhpcy52YWx1ZS52YWx1ZSwgdGhpcy5waXBlQXJndW1lbnRzKTtcbiAgICAgIGlmICghaXNOYU4oTnVtYmVyKGZvcm1hdHRlZFZhbHVlKSkpIHtcbiAgICAgICAgdGhpcy52YWx1ZS52YWx1ZSA9IGZvcm1hdHRlZFZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBtYXhEZWNpbWFsRGlnaXRzVmFsaWRhdG9yKGNvbnRyb2w6IEZvcm1Db250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB7XG4gICAgbGV0IGN0cmxWYWx1ZTogc3RyaW5nID0gY29udHJvbC52YWx1ZTtcbiAgICBpZiAodHlwZW9mIGNvbnRyb2wudmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICBjdHJsVmFsdWUgPSBjdHJsVmFsdWUudG9TdHJpbmcoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3RyaWN0ICYmIGN0cmxWYWx1ZSAmJiBjdHJsVmFsdWUubGVuZ3RoKSB7XG4gICAgICBjb25zdCB2YWxBcnJheSA9IGN0cmxWYWx1ZS5zcGxpdCh0aGlzLmRlY2ltYWxTZXBhcmF0b3IgPyB0aGlzLmRlY2ltYWxTZXBhcmF0b3IgOiAnLicpO1xuICAgICAgaWYgKFV0aWwuaXNEZWZpbmVkKHRoaXMubWF4RGVjaW1hbERpZ2l0cykgJiYgKHRoaXMubWF4RGVjaW1hbERpZ2l0cyA+IDApICYmIFV0aWwuaXNEZWZpbmVkKHZhbEFycmF5WzFdKSAmJiAodmFsQXJyYXlbMV0ubGVuZ3RoID4gdGhpcy5tYXhEZWNpbWFsRGlnaXRzKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG1heERlY2ltYWxkaWdpdHM6IHtcbiAgICAgICAgICAgIHJlcXVpcmVkTWF4RGVjaW1hbGRpZ2l0czogdGhpcy5tYXhEZWNpbWFsRGlnaXRzXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ge307XG4gIH1cblxuICBwcm90ZWN0ZWQgaW5pdGlhbGl6ZVN0ZXAoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuc3RlcCA8PSAwKSB7XG4gICAgICB0aGlzLnN0ZXAgPSAxIC8gTWF0aC5wb3coMTAsIHRoaXMubWF4RGVjaW1hbERpZ2l0cyk7XG4gICAgICBjb25zb2xlLndhcm4oJ2BzdGVwYCBhdHRyaWJ1dGUgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVybycpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=