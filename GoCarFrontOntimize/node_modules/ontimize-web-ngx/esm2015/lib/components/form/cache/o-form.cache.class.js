import { EventEmitter } from '@angular/core';
import { Util } from '../../../util/util';
export class OFormCacheClass {
    constructor(form) {
        this.form = form;
        this.initialDataCache = {};
        this.valueChangesStack = [];
        this._componentsSubscritpions = {};
        this.blockCaching = false;
        this.initializedCache = false;
        this.onCacheStateChanges = new EventEmitter();
        this.changedFormControls = [];
    }
    updateFormDataCache() {
        this.formDataCache = this.form.getRegisteredFieldsValues();
    }
    addChangeToStack(comp) {
        const currentValue = comp.getFormControl().value;
        this.valueChangesStack.push({
            attr: comp.getAttribute(),
            value: currentValue
        });
        this.onCacheStateChanges.emit();
    }
    registerComponentCaching(comp) {
        const attr = comp.getAttribute();
        const listenTo = this.form.detectChangesOnBlur ? comp.onValueChange : comp.onChange;
        if (!Util.isDefined(listenTo)) {
            return;
        }
        this._componentsSubscritpions[attr] = listenTo.subscribe(() => {
            if (this.initializedCache && !this.blockCaching && this.hasComponentChanged(attr, comp)) {
                if (this.changedFormControls.indexOf(attr) === -1) {
                    this.changedFormControls.push(attr);
                }
                this.updateFormDataCache();
                this.addChangeToStack(comp);
            }
        });
    }
    getCachedValue(attr) {
        if (this.formDataCache && this.formDataCache.hasOwnProperty(attr)) {
            return this.formDataCache[attr];
        }
        return undefined;
    }
    destroy() {
        Object.keys(this._componentsSubscritpions).forEach((attr) => {
            const subs = this._componentsSubscritpions[attr];
            subs.unsubscribe();
        });
        this._componentsSubscritpions = {};
        this.formDataCache = undefined;
        this.changedFormControls = [];
    }
    removeUndefinedProperties(arg) {
        Object.keys(arg).forEach((key) => {
            if (arg[key] === undefined) {
                delete arg[key];
            }
        });
        return arg;
    }
    registerCache() {
        const initialCache = this.form.getRegisteredFieldsValues();
        this.removeUndefinedProperties(initialCache);
        this.initializeCache(initialCache);
        this.formDataCache = initialCache;
        const components = this.form.getComponents();
        const self = this;
        Object.keys(components).forEach(attr => {
            const comp = components[attr];
            if (comp.isAutomaticRegistering()) {
                self.registerComponentCaching(comp);
            }
        });
    }
    initializeCache(val) {
        this.initialDataCache = val;
        this.valueChangesStack = [];
        this.onCacheStateChanges.emit();
        this.initializedCache = true;
        this.changedFormControls = [];
    }
    getInitialDataCache() {
        return this.initialDataCache;
    }
    getDataCache() {
        return this.formDataCache;
    }
    restartCache() {
        this.formDataCache = undefined;
        this.initializeCache({});
        this.initializedCache = false;
        this.onCacheStateChanges.emit();
    }
    setCacheSnapshot() {
        this.initializeCache(this.getDataCache());
    }
    undoLastChange() {
        const lastElement = this.valueChangesStack[this.valueChangesStack.length - 1];
        if (lastElement) {
            const lastCacheValue = this.getCacheLastValue(lastElement.attr);
            const lastValue = (lastCacheValue !== null) ? lastCacheValue : this.initialDataCache[lastElement.attr];
            this.undoComponentValue(lastElement.attr, lastValue);
            this.updateFormDataCache();
            this.onCacheStateChanges.emit();
        }
    }
    undoComponentValue(attr, val) {
        this.blockCaching = true;
        const comp = this.form.getFieldReference(attr);
        if (comp) {
            comp.setValue(val);
        }
        this.blockCaching = false;
    }
    hasComponentChanged(attr, comp) {
        const currentValue = comp.getFormControl().value;
        const cache = this.formDataCache || this.initialDataCache;
        return (currentValue !== cache[attr]);
    }
    getCacheLastValue(attr) {
        this.updateChangesStack(attr);
        let result = null;
        for (let i = this.valueChangesStack.length - 1; i >= 0; i--) {
            const current = this.valueChangesStack[i];
            if (current.attr === attr) {
                result = current.value;
                break;
            }
        }
        return result;
    }
    updateChangesStack(attr) {
        let index;
        for (let i = this.valueChangesStack.length - 1; i >= 0; i--) {
            const current = this.valueChangesStack[i];
            if (current.attr === attr) {
                index = i;
                break;
            }
        }
        if (index !== undefined) {
            for (let i = index; i >= 0; i--) {
                const prev = this.valueChangesStack[i - 1];
                const current = this.valueChangesStack[i];
                if (current.attr === attr) {
                    this.valueChangesStack.splice(i, 1);
                    if (!prev || prev.attr === attr) {
                        continue;
                    }
                    else {
                        break;
                    }
                }
            }
        }
        if (this.valueChangesStack.length === 0) {
            this.onCacheStateChanges.emit();
        }
    }
    get isCacheStackEmpty() {
        return (this.valueChangesStack.length === 0);
    }
    isInitialStateChanged(ignoreAttrs = []) {
        const initialCache = Object.assign({}, this.initialDataCache);
        let currentCache;
        if (this.formDataCache) {
            currentCache = Object.assign({}, this.formDataCache);
            this.removeUndefinedProperties(currentCache);
        }
        else {
            return false;
        }
        let initialKeys = Object.keys(initialCache);
        let currentKeys = currentCache ? Object.keys(currentCache) : initialKeys;
        if (ignoreAttrs.length) {
            initialKeys = initialKeys.filter(key => !ignoreAttrs.includes(key));
            currentKeys = currentKeys.filter(key => !ignoreAttrs.includes(key));
            ignoreAttrs.forEach(key => delete initialCache[key]);
        }
        if (currentKeys.length === 0) {
            return false;
        }
        if (initialKeys.length !== currentKeys.length) {
            return true;
        }
        if (ignoreAttrs.length) {
            initialKeys = initialKeys.filter(key => !ignoreAttrs.includes(key));
            ignoreAttrs.forEach(key => delete initialCache[key]);
        }
        let res = false;
        for (let i = 0, len = initialKeys.length; i < len; i++) {
            const key = initialKeys[i];
            res = (initialCache[key] !== currentCache[key]);
            if (res) {
                break;
            }
        }
        return res;
    }
    getChangedFormControlsAttr() {
        return this.changedFormControls;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1mb3JtLmNhY2hlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2Zvcm0vY2FjaGUvby1mb3JtLmNhY2hlLmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFLN0MsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRzFDLE1BQU0sT0FBTyxlQUFlO0lBYTFCLFlBQXNCLElBQW9CO1FBQXBCLFNBQUksR0FBSixJQUFJLENBQWdCO1FBWGhDLHFCQUFnQixHQUFXLEVBQUUsQ0FBQztRQUU5QixzQkFBaUIsR0FBZSxFQUFFLENBQUM7UUFDbkMsNkJBQXdCLEdBQVEsRUFBRSxDQUFDO1FBQ25DLGlCQUFZLEdBQVksS0FBSyxDQUFDO1FBQzlCLHFCQUFnQixHQUFZLEtBQUssQ0FBQztRQUU1Qyx3QkFBbUIsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV2RCx3QkFBbUIsR0FBYSxFQUFFLENBQUM7SUFHN0MsQ0FBQztJQUVTLG1CQUFtQjtRQUMzQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQztJQUM3RCxDQUFDO0lBRVMsZ0JBQWdCLENBQUMsSUFBMkI7UUFDcEQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLEtBQUssQ0FBQztRQUNqRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDO1lBQzFCLElBQUksRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3pCLEtBQUssRUFBRSxZQUFZO1NBQ3BCLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBRVMsd0JBQXdCLENBQUMsSUFBd0I7UUFDekQsTUFBTSxJQUFJ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dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgSUZvcm1Db250cm9sQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vLi4vaW50ZXJmYWNlcy9mb3JtLWNvbnRyb2wtY29tcG9uZW50LmludGVyZmFjZSc7XG5pbXBvcnQgeyBJRm9ybURhdGFDb21wb25lbnQgfSBmcm9tICcuLi8uLi8uLi9pbnRlcmZhY2VzL2Zvcm0tZGF0YS1jb21wb25lbnQuaW50ZXJmYWNlJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi8uLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgT0Zvcm1Db21wb25lbnQgfSBmcm9tICcuLi9vLWZvcm0uY29tcG9uZW50JztcblxuZXhwb3J0IGNsYXNzIE9Gb3JtQ2FjaGVDbGFzcyB7XG5cbiAgcHJvdGVjdGVkIGluaXRpYWxEYXRhQ2FjaGU6IG9iamVjdCA9IHt9O1xuICBwcm90ZWN0ZWQgZm9ybURhdGFDYWNoZTogb2JqZWN0O1xuICBwcm90ZWN0ZWQgdmFsdWVDaGFuZ2VzU3RhY2s6IEFycmF5PGFueT4gPSBbXTtcbiAgcHJvdGVjdGVkIF9jb21wb25lbnRzU3Vic2NyaXRwaW9uczogYW55ID0ge307XG4gIHByb3RlY3RlZCBibG9ja0NhY2hpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJvdGVjdGVkIGluaXRpYWxpemVkQ2FjaGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBvbkNhY2hlU3RhdGVDaGFuZ2VzOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIHByb3RlY3RlZCBjaGFuZ2VkRm9ybUNvbnRyb2xzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBmb3JtOiBPRm9ybUNvbXBvbmVudCkge1xuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZUZvcm1EYXRhQ2FjaGUoKSB7XG4gICAgdGhpcy5mb3JtRGF0YUNhY2hlID0gdGhpcy5mb3JtLmdldFJlZ2lzdGVyZWRGaWVsZHNWYWx1ZXMoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhZGRDaGFuZ2VUb1N0YWNrKGNvbXA6IElGb3JtQ29udHJvbENvbXBvbmVudCkge1xuICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGNvbXAuZ2V0Rm9ybUNvbnRyb2woKS52YWx1ZTtcbiAgICB0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrLnB1c2goe1xuICAgICAgYXR0cjogY29tcC5nZXRBdHRyaWJ1dGUoKSxcbiAgICAgIHZhbHVlOiBjdXJyZW50VmFsdWVcbiAgICB9KTtcbiAgICB0aGlzLm9uQ2FjaGVTdGF0ZUNoYW5nZXMuZW1pdCgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHJlZ2lzdGVyQ29tcG9uZW50Q2FjaGluZyhjb21wOiBJRm9ybURhdGFDb21wb25lbnQpIHtcbiAgICBjb25zdCBhdHRyID0gY29tcC5nZXRBdHRyaWJ1dGUoKTtcbiAgICBjb25zdCBsaXN0ZW5UbyA9IHRoaXMuZm9ybS5kZXRlY3RDaGFuZ2VzT25CbHVyID8gY29tcC5vblZhbHVlQ2hhbmdlIDogY29tcC5vbkNoYW5nZTtcbiAgICBpZiAoIVV0aWwuaXNEZWZpbmVkKGxpc3RlblRvKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9jb21wb25lbnRzU3Vic2NyaXRwaW9uc1thdHRyXSA9IGxpc3RlblRvLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICBpZiAodGhpcy5pbml0aWFsaXplZENhY2hlICYmICF0aGlzLmJsb2NrQ2FjaGluZyAmJiB0aGlzLmhhc0NvbXBvbmVudENoYW5nZWQoYXR0ciwgY29tcCkpIHtcbiAgICAgICAgaWYgKHRoaXMuY2hhbmdlZEZvcm1Db250cm9scy5pbmRleE9mKGF0dHIpID09PSAtMSkge1xuICAgICAgICAgIHRoaXMuY2hhbmdlZEZvcm1Db250cm9scy5wdXNoKGF0dHIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudXBkYXRlRm9ybURhdGFDYWNoZSgpO1xuICAgICAgICB0aGlzLmFkZENoYW5nZVRvU3RhY2soY29tcCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBnZXRDYWNoZWRWYWx1ZShhdHRyOiBzdHJpbmcpOiBhbnkge1xuICAgIGlmICh0aGlzLmZvcm1EYXRhQ2FjaGUgJiYgdGhpcy5mb3JtRGF0YUNhY2hlLmhhc093blByb3BlcnR5KGF0dHIpKSB7XG4gICAgICByZXR1cm4gdGhpcy5mb3JtRGF0YUNhY2hlW2F0dHJdO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICBPYmplY3Qua2V5cyh0aGlzLl9jb21wb25lbnRzU3Vic2NyaXRwaW9ucykuZm9yRWFjaCgoYXR0cikgPT4ge1xuICAgICAgY29uc3Qgc3ViczogU3Vic2NyaXB0aW9uID0gdGhpcy5fY29tcG9uZW50c1N1YnNjcml0cGlvbnNbYXR0cl07XG4gICAgICBzdWJzLnVuc3Vic2NyaWJlKCk7XG4gICAgfSk7XG4gICAgdGhpcy5fY29tcG9uZW50c1N1YnNjcml0cGlvbnMgPSB7fTtcbiAgICB0aGlzLmZvcm1EYXRhQ2FjaGUgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy5jaGFuZ2VkRm9ybUNvbnRyb2xzID0gW107XG4gIH1cblxuICBwcm90ZWN0ZWQgcmVtb3ZlVW5kZWZpbmVkUHJvcGVydGllcyhhcmc6IGFueSk6IGFueSB7XG4gICAgT2JqZWN0LmtleXMoYXJnKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgIGlmIChhcmdba2V5XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIGRlbGV0ZSBhcmdba2V5XTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gYXJnO1xuICB9XG5cbiAgcmVnaXN0ZXJDYWNoZSgpIHtcbiAgICBjb25zdCBpbml0aWFsQ2FjaGUgPSB0aGlzLmZvcm0uZ2V0UmVnaXN0ZXJlZEZpZWxkc1ZhbHVlcygpO1xuICAgIHRoaXMucmVtb3ZlVW5kZWZpbmVkUHJvcGVydGllcyhpbml0aWFsQ2FjaGUpO1xuICAgIHRoaXMuaW5pdGlhbGl6ZUNhY2hlKGluaXRpYWxDYWNoZSk7XG4gICAgdGhpcy5mb3JtRGF0YUNhY2hlID0gaW5pdGlhbENhY2hlO1xuXG4gICAgY29uc3QgY29tcG9uZW50cyA9IHRoaXMuZm9ybS5nZXRDb21wb25lbnRzKCk7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgT2JqZWN0LmtleXMoY29tcG9uZW50cykuZm9yRWFjaChhdHRyID0+IHtcbiAgICAgIGNvbnN0IGNvbXA6IElGb3JtRGF0YUNvbXBvbmVudCA9IGNvbXBvbmVudHNbYXR0cl07XG4gICAgICBpZiAoY29tcC5pc0F1dG9tYXRpY1JlZ2lzdGVyaW5nKCkpIHtcbiAgICAgICAgc2VsZi5yZWdpc3RlckNvbXBvbmVudENhY2hpbmcoY29tcCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBpbml0aWFsaXplQ2FjaGUodmFsOiBhbnkpIHtcbiAgICB0aGlzLmluaXRpYWxEYXRhQ2FjaGUgPSB2YWw7XG4gICAgdGhpcy52YWx1ZUNoYW5nZXNTdGFjayA9IFtdO1xuICAgIHRoaXMub25DYWNoZVN0YXRlQ2hhbmdlcy5lbWl0KCk7XG4gICAgdGhpcy5pbml0aWFsaXplZENhY2hlID0gdHJ1ZTtcbiAgICB0aGlzLmNoYW5nZWRGb3JtQ29udHJvbHMgPSBbXTtcbiAgfVxuXG4gIGdldEluaXRpYWxEYXRhQ2FjaGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW5pdGlhbERhdGFDYWNoZTtcbiAgfVxuXG4gIGdldERhdGFDYWNoZSgpIHtcbiAgICByZXR1cm4gdGhpcy5mb3JtRGF0YUNhY2hlO1xuICB9XG5cbiAgcmVzdGFydENhY2hlKCkge1xuICAgIHRoaXMuZm9ybURhdGFDYWNoZSA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmluaXRpYWxpemVDYWNoZSh7fSk7XG4gICAgdGhpcy5pbml0aWFsaXplZENhY2hlID0gZmFsc2U7XG4gICAgdGhpcy5vbkNhY2hlU3RhdGVDaGFuZ2VzLmVtaXQoKTtcbiAgfVxuXG4gIHNldENhY2hlU25hcHNob3QoKSB7XG4gICAgdGhpcy5pbml0aWFsaXplQ2FjaGUodGhpcy5nZXREYXRhQ2FjaGUoKSk7XG4gIH1cblxuICB1bmRvTGFzdENoYW5nZSgpIHtcbiAgICBjb25zdCBsYXN0RWxlbWVudCA9IHRoaXMudmFsdWVDaGFuZ2VzU3RhY2tbdGhpcy52YWx1ZUNoYW5nZXNTdGFjay5sZW5ndGggLSAxXTtcbiAgICBpZiAobGFzdEVsZW1lbnQpIHtcbiAgICAgIGNvbnN0IGxhc3RDYWNoZVZhbHVlID0gdGhpcy5nZXRDYWNoZUxhc3RWYWx1ZShsYXN0RWxlbWVudC5hdHRyKTtcbiAgICAgIGNvbnN0IGxhc3RWYWx1ZSA9IChsYXN0Q2FjaGVWYWx1ZSAhPT0gbnVsbCkgPyBsYXN0Q2FjaGVWYWx1ZSA6IHRoaXMuaW5pdGlhbERhdGFDYWNoZVtsYXN0RWxlbWVudC5hdHRyXTtcbiAgICAgIHRoaXMudW5kb0NvbXBvbmVudFZhbHVlKGxhc3RFbGVtZW50LmF0dHIsIGxhc3RWYWx1ZSk7XG5cbiAgICAgIHRoaXMudXBkYXRlRm9ybURhdGFDYWNoZSgpO1xuICAgICAgdGhpcy5vbkNhY2hlU3RhdGVDaGFuZ2VzLmVtaXQoKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgdW5kb0NvbXBvbmVudFZhbHVlKGF0dHI6IHN0cmluZywgdmFsOiBhbnkpIHtcbiAgICB0aGlzLmJsb2NrQ2FjaGluZyA9IHRydWU7XG4gICAgY29uc3QgY29tcCA9IHRoaXMuZm9ybS5nZXRGaWVsZFJlZmVyZW5jZShhdHRyKTtcbiAgICBpZiAoY29tcCkge1xuICAgICAgY29tcC5zZXRWYWx1ZSh2YWwpO1xuICAgIH1cbiAgICB0aGlzLmJsb2NrQ2FjaGluZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGhhc0NvbXBvbmVudENoYW5nZWQoYXR0cjogc3RyaW5nLCBjb21wOiBJRm9ybUNvbnRyb2xDb21wb25lbnQpOiBib29sZWFuIHtcbiAgICBjb25zdCBjdXJyZW50VmFsdWUgPSBjb21wLmdldEZvcm1Db250cm9sKCkudmFsdWU7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmZvcm1EYXRhQ2FjaGUgfHwgdGhpcy5pbml0aWFsRGF0YUNhY2hlO1xuICAgIHJldHVybiAoY3VycmVudFZhbHVlICE9PSBjYWNoZVthdHRyXSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0Q2FjaGVMYXN0VmFsdWUoYXR0cjogc3RyaW5nKTogYW55IHtcbiAgICB0aGlzLnVwZGF0ZUNoYW5nZXNTdGFjayhhdHRyKTtcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcbiAgICBmb3IgKGxldCBpID0gdGhpcy52YWx1ZUNoYW5nZXNTdGFjay5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmFsdWVDaGFuZ2VzU3RhY2tbaV07XG4gICAgICBpZiAoY3VycmVudC5hdHRyID09PSBhdHRyKSB7XG4gICAgICAgIHJlc3VsdCA9IGN1cnJlbnQudmFsdWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZUNoYW5nZXNTdGFjayhhdHRyOiBzdHJpbmcpIHtcbiAgICBsZXQgaW5kZXg6IG51bWJlcjtcbiAgICBmb3IgKGxldCBpID0gdGhpcy52YWx1ZUNoYW5nZXNTdGFjay5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmFsdWVDaGFuZ2VzU3RhY2tbaV07XG4gICAgICBpZiAoY3VycmVudC5hdHRyID09PSBhdHRyKSB7XG4gICAgICAgIGluZGV4ID0gaTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChpbmRleCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBmb3IgKGxldCBpID0gaW5kZXg7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIGNvbnN0IHByZXYgPSB0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrW2kgLSAxXTtcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmFsdWVDaGFuZ2VzU3RhY2tbaV07XG4gICAgICAgIGlmIChjdXJyZW50LmF0dHIgPT09IGF0dHIpIHtcbiAgICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrLnNwbGljZShpLCAxKTtcbiAgICAgICAgICBpZiAoIXByZXYgfHwgcHJldi5hdHRyID09PSBhdHRyKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5vbkNhY2hlU3RhdGVDaGFuZ2VzLmVtaXQoKTtcbiAgICB9XG4gIH1cblxuICBnZXQgaXNDYWNoZVN0YWNrRW1wdHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICh0aGlzLnZhbHVlQ2hhbmdlc1N0YWNrLmxlbmd0aCA9PT0gMCk7XG4gIH1cblxuICBpc0luaXRpYWxTdGF0ZUNoYW5nZWQoaWdub3JlQXR0cnM6IHN0cmluZ1tdID0gW10pOiBib29sZWFuIHtcbiAgICBjb25zdCBpbml0aWFsQ2FjaGUgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmluaXRpYWxEYXRhQ2FjaGUpO1xuICAgIGxldCBjdXJyZW50Q2FjaGU6IG9iamVjdDtcbiAgICBpZiAodGhpcy5mb3JtRGF0YUNhY2hlKSB7XG4gICAgICBjdXJyZW50Q2FjaGUgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmZvcm1EYXRhQ2FjaGUpO1xuICAgICAgdGhpcy5yZW1vdmVVbmRlZmluZWRQcm9wZXJ0aWVzKGN1cnJlbnRDYWNoZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgaW5pdGlhbEtleXMgPSBPYmplY3Qua2V5cyhpbml0aWFsQ2FjaGUpO1xuICAgIGxldCBjdXJyZW50S2V5cyA9IGN1cnJlbnRDYWNoZSA/IE9iamVjdC5rZXlzKGN1cnJlbnRDYWNoZSkgOiBpbml0aWFsS2V5cztcblxuICAgIC8vIFJlbW92ZSBpZ25vcmVkIGZpZWxkcyBmcm9tIHRlbXBvcmFyeSBpbml0aWFsIGNhY2hlIGRhdGFcbiAgICBpZiAoaWdub3JlQXR0cnMubGVuZ3RoKSB7XG4gICAgICBpbml0aWFsS2V5cyA9IGluaXRpYWxLZXlzLmZpbHRlcihrZXkgPT4gIWlnbm9yZUF0dHJzLmluY2x1ZGVzKGtleSkpO1xuICAgICAgY3VycmVudEtleXMgPSBjdXJyZW50S2V5cy5maWx0ZXIoa2V5ID0+ICFpZ25vcmVBdHRycy5pbmNsdWRlcyhrZXkpKTtcbiAgICAgIGlnbm9yZUF0dHJzLmZvckVhY2goa2V5ID0+IGRlbGV0ZSBpbml0aWFsQ2FjaGVba2V5XSk7XG4gICAgfVxuXG4gICAgaWYgKGN1cnJlbnRLZXlzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChpbml0aWFsS2V5cy5sZW5ndGggIT09IGN1cnJlbnRLZXlzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIC8vIFJlbW92ZSBpZ25vcmVkIGZpZWxkcyBmcm9tIHRlbXBvcmFyeSBpbml0aWFsIGNhY2hlIGRhdGFcbiAgICBpZiAoaWdub3JlQXR0cnMubGVuZ3RoKSB7XG4gICAgICBpbml0aWFsS2V5cyA9IGluaXRpYWxLZXlzLmZpbHRlcihrZXkgPT4gIWlnbm9yZUF0dHJzLmluY2x1ZGVzKGtleSkpO1xuICAgICAgaWdub3JlQXR0cnMuZm9yRWFjaChrZXkgPT4gZGVsZXRlIGluaXRpYWxDYWNoZVtrZXldKTtcbiAgICB9XG5cbiAgICBsZXQgcmVzID0gZmFsc2U7XG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGluaXRpYWxLZXlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBjb25zdCBrZXkgPSBpbml0aWFsS2V5c1tpXTtcbiAgICAgIC8vIFRPRE8gYmUgY2FyZWZ1bCB3aXRoIHR5cGVzIGNvbXBhcmlzaW9uc1xuICAgICAgcmVzID0gKGluaXRpYWxDYWNoZVtrZXldICE9PSBjdXJyZW50Q2FjaGVba2V5XSk7XG4gICAgICBpZiAocmVzKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgZ2V0Q2hhbmdlZEZvcm1Db250cm9sc0F0dHIoKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLmNoYW5nZWRGb3JtQ29udHJvbHM7XG4gIH1cbn1cbiJdfQ==