import * as tslib_1 from "tslib";
import { Component, EventEmitter, forwardRef, Inject, Injector } from '@angular/core';
import { ActivatedRoute, Router } from '@angular/router';
import { Subscription } from 'rxjs';
import { debounceTime } from 'rxjs/operators';
import { OFormComponent } from '../../components/form/o-form.component';
import { InputConverter } from '../../decorators/input-converter';
import { LocalStorageService } from '../../services/local-storage.service';
import { OFilterBuilderComponentStateService } from '../../services/state/o-filter-builder-component-state.service';
import { Codes } from '../../util/codes';
import { FilterExpressionUtils } from '../../util/filter-expression.utils';
import { Util } from '../../util/util';
export const DEFAULT_INPUTS_O_FILTER_BUILDER = [
    'filters',
    'targetCmp: target',
    'expressionBuilder: expression-builder',
    'queryOnChange: query-on-change',
    'queryOnChangeDelay: query-on-change-delay',
    'queryOnChangeEventType: query-on-change-event-type',
    'oattr: attr',
];
export const DEFAULT_OUTPUTS_O_FILTER_BUILDER = [
    'onFilter',
    'onClear'
];
export class OFilterBuilderComponent {
    constructor(injector, form) {
        this.injector = injector;
        this.form = form;
        this.onFilter = new EventEmitter();
        this.onClear = new EventEmitter();
        this.queryOnChange = false;
        this.queryOnChangeDelay = 0;
        this.queryOnChangeEventType = Codes.DEFAULT_CHANGE_EVENT;
        this.filterComponents = [];
        this.subscriptions = new Subscription();
        this.localStorageService = this.injector.get(LocalStorageService);
        this.componentStateService = this.injector.get(OFilterBuilderComponentStateService);
        this.router = this.injector.get(Router);
        this.actRoute = this.injector.get(ActivatedRoute);
    }
    ngOnInit() {
        this.initialize();
    }
    ngAfterViewInit() {
        this.initializeListeners();
    }
    ngOnDestroy() {
        if (this.subscriptions) {
            this.subscriptions.unsubscribe();
        }
    }
    initialize() {
        this.componentStateService.initialize(this);
        if (this.filters) {
            const filterArray = Util.parseArray(this.filters);
            filterArray.forEach(filter => {
                const filterElms = filter.split(Codes.COLUMNS_ALIAS_SEPARATOR);
                this.filterComponents.push({
                    targetAttr: filterElms[0],
                    formComponentAttr: filterElms[1] ? filterElms[1] : filterElms[0]
                });
            });
        }
        if (Util.isDefined(this.targetCmp)) {
            this.targetCmp.setFilterBuilder(this);
        }
    }
    initializeListeners() {
        if (this.queryOnChange) {
            this.filterComponents.forEach((filterComponent) => {
                const formComponent = this.form.getComponents()[filterComponent.formComponentAttr];
                if (formComponent) {
                    this.subscriptions.add(this.getEventFromFormComponent(formComponent)
                        .pipe(debounceTime(this.queryOnChangeDelay))
                        .subscribe(() => this.triggerReload()));
                }
            });
        }
    }
    getEventFromFormComponent(formComponent) {
        return this.queryOnChangeEventType === Codes.DEFAULT_CHANGE_EVENT ?
            formComponent.onValueChange :
            formComponent.getFormControl().valueChanges;
    }
    getExpression() {
        const formComponents = this.form.getComponents();
        const params = [];
        this.filterComponents.forEach((filterComponent) => {
            const formComponent = formComponents[filterComponent.formComponentAttr];
            if (formComponent) {
                const value = formComponent.getValue();
                params.push({
                    attr: filterComponent.targetAttr,
                    value: value
                });
            }
        });
        if (this.expressionBuilder) {
            return this.expressionBuilder(params);
        }
        const expressions = [];
        params.forEach(elem => {
            if (Util.isDefined(elem.value)) {
                expressions.push(FilterExpressionUtils.buildExpressionEquals(elem.attr, elem.value));
            }
        });
        return expressions.length ? expressions.reduce((fe1, fe2) => FilterExpressionUtils.buildComplexExpression(fe1, fe2, FilterExpressionUtils.OP_OR)) : undefined;
    }
    getBasicExpression() {
        return FilterExpressionUtils.buildBasicExpression(this.getExpression());
    }
    getTargetComponent() {
        return this.targetCmp;
    }
    triggerReload() {
        if (!this.targetCmp) {
            return;
        }
        if (this.targetCmp.pageable) {
            this.targetCmp.reloadPaginatedDataFromStart();
        }
        else {
            this.targetCmp.reloadData();
        }
        this.onFilter.emit();
    }
    clearFilter() {
        const formComponents = this.form.getComponents();
        this.getFilterAttrs().forEach((attr) => {
            formComponents[attr].clearValue();
        });
        this.onClear.emit();
    }
    getFilterValues() {
        const result = [];
        this.filterComponents.
            forEach((filterComponent) => {
            if (Util.isDefined(this.form.getComponents()[filterComponent.formComponentAttr])) {
                result.push({ attr: filterComponent.formComponentAttr, value: this.form.getComponents()[filterComponent.formComponentAttr].getValue() });
            }
        });
        return result;
    }
    setFilterValues(filterBuilderValues) {
        filterBuilderValues.forEach((filterBuilderValue) => {
            if (this.form.getComponents()[filterBuilderValue.attr]) {
                this.form.getComponents()[filterBuilderValue.attr].setValue(filterBuilderValue.value);
            }
            else {
                console.warn('The filter with attr ' + filterBuilderValue.attr + ' cannot be set ' + filterBuilderValue.value + ' because it does not exist .');
            }
        });
    }
    getFilterAttrs() {
        return this.filterComponents.map((elem) => elem.formComponentAttr);
    }
    get state() {
        return this.componentStateService.state;
    }
    getDataToStore() {
        return this.componentStateService.state;
    }
    getComponentKey() {
        if (!Util.isDefined(this.oattr)) {
            console.error('Your o-filter-builder component must have an \'attr\'. Otherwise, your filter builder state will not set in localstorage.');
            return 'OFilterBuilderComponent_';
        }
        return 'OFilterBuilderComponent_' + this.oattr;
    }
    storeFilterInState(arg) {
        this.componentStateService.storeFilter(arg);
        this.updateStateStorage();
    }
    updateStateStorage() {
        if (this.localStorageService) {
            this.localStorageService.updateComponentStorage(this, this.getRouteKey());
        }
    }
    getRouteKey() {
        let route = this.router.url;
        this.actRoute.params.subscribe(params => {
            Object.keys(params).forEach(key => {
                route = route.replace(params[key], key);
            });
        });
        return route;
    }
}
OFilterBuilderComponent.decorators = [
    { type: Component, args: [{
                selector: 'o-filter-builder',
                template: "",
                inputs: DEFAULT_INPUTS_O_FILTER_BUILDER,
                outputs: DEFAULT_OUTPUTS_O_FILTER_BUILDER
            }] }
];
OFilterBuilderComponent.ctorParameters = () => [
    { type: Injector },
    { type: OFormComponent, decorators: [{ type: Inject, args: [forwardRef(() => OFormComponent),] }] }
];
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Boolean)
], OFilterBuilderComponent.prototype, "queryOnChange", void 0);
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", Number)
], OFilterBuilderComponent.prototype, "queryOnChangeDelay", void 0);
tslib_1.__decorate([
    InputConverter(),
    tslib_1.__metadata("design:type", String)
], OFilterBuilderComponent.prototype, "queryOnChangeEventType", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1maWx0ZXItYnVpbGRlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvZmlsdGVyLWJ1aWxkZXIvby1maWx0ZXItYnVpbGRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDeEgsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6RCxPQUFPLEVBQWMsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDeEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBSWxFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBRTNFLE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxNQUFNLCtEQUErRCxDQUFDO0FBS3BILE9BQU8sRUFBaUIsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDM0UsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXZDLE1BQU0sQ0FBQyxNQUFNLCtCQUErQixHQUFHO0lBRTdDLFNBQVM7SUFHVCxtQkFBbUI7SUFHbkIsdUNBQXVDO0lBR3ZDLGdDQUFnQztJQUdoQywyQ0FBMkM7SUFHM0Msb0RBQW9EO0lBR3BELGFBQWE7Q0FDZCxDQUFBO0FBRUQsTUFBTSxDQUFDLE1BQU0sZ0NBQWdDLEdBQUc7SUFFOUMsVUFBVTtJQUdWLFNBQVM7Q0FD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LEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQzs7O1lBalFGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsa0JBQWtCO2dCQUM1QixZQUFnRDtnQkFDaEQsTUFBTSxFQUFFLCtCQUErQjtnQkFDdkMsT0FBTyxFQUFFLGdDQUFnQzthQUMxQzs7O1lBekRvRSxRQUFRO1lBS3BFLGNBQWMsdUJBbUZsQixNQUFNLFNBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLGNBQWMsQ0FBQzs7QUFoQjFDO0lBREMsY0FBYyxFQUFFOzs4REFDcUI7QUFFdEM7SUFEQyxjQUFjLEVBQUU7O21FQUNxQjtBQUV0QztJQURDLGNBQWMsRUFBRTs7dUVBQ3lEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIGZvcndhcmRSZWYsIEluamVjdCwgSW5qZWN0b3IsIE9uRGVzdHJveSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBPRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvZm9ybS9vLWZvcm0uY29tcG9uZW50JztcbmltcG9ydCB7IElucHV0Q29udmVydGVyIH0gZnJvbSAnLi4vLi4vZGVjb3JhdG9ycy9pbnB1dC1jb252ZXJ0ZXInO1xuaW1wb3J0IHsgSUZpbHRlckJ1aWxkZXJDbXBUYXJnZXQgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL2ZpbHRlci1idWlsZGVyLWNvbXBvbmVudC10YXJnZXQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElGb3JtRGF0YUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvZm9ybS1kYXRhLWNvbXBvbmVudC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSVNlcnZpY2VEYXRhQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9zZXJ2aWNlLWRhdGEtY29tcG9uZW50LmludGVyZmFjZSc7XG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvbG9jYWwtc3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IE9GaWx0ZXJCdWlsZGVyQ29tcG9uZW50U3RhdGVDbGFzcyB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3N0YXRlL28tZmlsdGVyLWJ1aWxkZXItY29tcG9uZW50LXN0YXRlLmNsYXNzJztcbmltcG9ydCB7IE9GaWx0ZXJCdWlsZGVyQ29tcG9uZW50U3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvc3RhdGUvby1maWx0ZXItYnVpbGRlci1jb21wb25lbnQtc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBPRmlsdGVyRGVmaW5pdGlvbiB9IGZyb20gJy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IEJhc2ljRXhwcmVzc2lvbiB9IGZyb20gJy4uLy4uL3R5cGVzL2Jhc2ljLWV4cHJlc3Npb24udHlwZSc7XG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi4vLi4vdHlwZXMvZXhwcmVzc2lvbi50eXBlJztcbmltcG9ydCB7IE9GaWx0ZXJCdWlsZGVyVmFsdWVzIH0gZnJvbSAnLi4vLi4vdHlwZXMvby1maWx0ZXItYnVpbGRlci12YWx1ZXMudHlwZSc7XG5pbXBvcnQgeyBDSEFOR0VfRVZFTlRTLCBDb2RlcyB9IGZyb20gJy4uLy4uL3V0aWwvY29kZXMnO1xuaW1wb3J0IHsgRmlsdGVyRXhwcmVzc2lvblV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbC9maWx0ZXItZXhwcmVzc2lvbi51dGlscyc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbC91dGlsJztcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfSU5QVVRTX09fRklMVEVSX0JVSUxERVIgPSBbXG4gIC8vIGZpbHRlcnM6IFtzdHJpbmddIExpc3Qgb2YgcGFpcnMgb2YgZm9ybSBjb21wb25lbnQgYXR0cmlidXRlcyBhbmQgdGFyZ2V0IGNvbXBvbmVudCBjb2x1bXMgKHRhcmdldENvbHVtbjE6Y29tcG9uZW50QXR0cjE7dGFyZ2V0Q29sdW1uMjpjb21wb25lbnRBdHRyMjsuLi4pLiBTZXBhcmF0ZWQgYnkgJzsnLlxuICAnZmlsdGVycycsXG5cbiAgLy8gdGFyZ2V0IFtgT1NlcnZpY2VDb21wb25lbnRgIGluc3RhbmNlXTogQ29tcG9uZW50IHdob3NlIGRhdGEgd2lsbCBiZSBmaWx0ZXJlZC5cbiAgJ3RhcmdldENtcDogdGFyZ2V0JyxcblxuICAvLyBleHByZXNzaW9uLWJ1aWxkZXIgW2Z1bnRpb25dOiBGdW50aW9uIGNhbGxlZCBmb3IgY3JlYXRpbmcgdGhlIGV4cHJlc3Npb24uXG4gICdleHByZXNzaW9uQnVpbGRlcjogZXhwcmVzc2lvbi1idWlsZGVyJyxcblxuICAvLyBxdWVyeS1vbi1jaGFuZ2UgW3llc3xub3x0cnVlfGZhbHNlXTogSW5kaWNhdGVzIHdoZXRoZXIgb3Igbm90IHRvIHRyaWdnZXIgdGhlIHRhcmdldCBjb21wb25lbnQgcmVmcmVzaCB3aGVuIGEgZmlsdGVyIGNvbXBvbmVudCBgb25DaGFuZ2VgIGV2ZW50IGlzIGZpcmVkLiBEZWZhdWx0OiBuby5cbiAgJ3F1ZXJ5T25DaGFuZ2U6IHF1ZXJ5LW9uLWNoYW5nZScsXG5cbiAgLy8gcXVlcnktb24tY2hhbmdlLWRlbGF5IFtudW1iZXJdOiBEZWxheSB0aW1lIGluIG1pbGxpc2Vjb25kcyBgcXVlcnktb24tY2hhbmdlYCBtZXRob2QgaXMgdHJpZ2dlcmVkLiBEZWZhdWx0OiAwLlxuICAncXVlcnlPbkNoYW5nZURlbGF5OiBxdWVyeS1vbi1jaGFuZ2UtZGVsYXknLFxuXG4gIC8vcXVlcnktb24tY2hhbmdlLWV2ZW50OiBbY2hhbmdlfCBvblZhbHVlQ2hhbmdlXSBUeXBlIG9mIGV2ZW50IHRoYXQgZW1pdCB3aGVuIHF1ZXJ5LW9uLWNoYW5nZT1geWVzYFxuICAncXVlcnlPbkNoYW5nZUV2ZW50VHlwZTogcXVlcnktb24tY2hhbmdlLWV2ZW50LXR5cGUnLFxuXG4gIC8vIGF0dHIgW3N0cmluZ106IGZpbHRlciBidWlsZGVyIGlkZW50aWZpZXIuIEl0IGlzIG1hbmRhdG9yeSBpZiBkYXRhIGFyZSBwcm92aWRlZCB0aHJvdWdoIHRoZSBkYXRhIGF0dHJpYnV0ZS4gRGVmYXVsdDogdGFyZ2V0IChpZiBzZXQpLlxuICAnb2F0dHI6IGF0dHInLFxuXVxuXG5leHBvcnQgY29uc3QgREVGQVVMVF9PVVRQVVRTX09fRklMVEVSX0JVSUxERVIgPSBbXG4gIC8vIEV2ZW50IHRyaWdnZXJlZCB3aGVuIHRoZSBmaWx0ZXIgYWN0aW9uIGlzIGV4ZWN1dGVkLlxuICAnb25GaWx0ZXInLFxuXG4gIC8vIEV2ZW50IHRyaWdnZXJlZCB3aGVuIHRoZSBjbGVhciBhY3Rpb24gaXMgZXhjdXRlZC5cbiAgJ29uQ2xlYXInXG5dO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdvLWZpbHRlci1idWlsZGVyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL28tZmlsdGVyLWJ1aWxkZXIuY29tcG9uZW50Lmh0bWwnLFxuICBpbnB1dHM6IERFRkFVTFRfSU5QVVRTX09fRklMVEVSX0JVSUxERVIsXG4gIG91dHB1dHM6IERFRkFVTFRfT1VUUFVUU19PX0ZJTFRFUl9CVUlMREVSXG59KVxuXG4vKipcbiAqIFRoZSBPRmlsdGVyQnVpbGRlckNvbXBvbmVudC5cbiAqL1xuXG5leHBvcnQgY2xhc3MgT0ZpbHRlckJ1aWxkZXJDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uSW5pdCB7XG5cbiAgcHVibGljIG9uRmlsdGVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBwdWJsaWMgb25DbGVhcjogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBwdWJsaWMgZmlsdGVyczogc3RyaW5nO1xuICBwdWJsaWMgdGFyZ2V0Q21wOiBJU2VydmljZURhdGFDb21wb25lbnQ7XG4gIHB1YmxpYyBleHByZXNzaW9uQnVpbGRlcjogKHZhbHVlczogQXJyYXk8eyBhdHRyLCB2YWx1ZSB9PikgPT4gRXhwcmVzc2lvbjtcbiAgQElucHV0Q29udmVydGVyKClcbiAgcHVibGljIHF1ZXJ5T25DaGFuZ2U6IGJvb2xlYW4gPSBmYWxzZTtcbiAgQElucHV0Q29udmVydGVyKClcbiAgcHVibGljIHF1ZXJ5T25DaGFuZ2VEZWxheTogbnVtYmVyID0gMDtcbiAgQElucHV0Q29udmVydGVyKClcbiAgcHVibGljIHF1ZXJ5T25DaGFuZ2VFdmVudFR5cGU6IENIQU5HRV9FVkVOVFMgPSBDb2Rlcy5ERUZBVUxUX0NIQU5HRV9FVkVOVDtcblxuICBwcm90ZWN0ZWQgZmlsdGVyQ29tcG9uZW50czogQXJyYXk8SUZpbHRlckJ1aWxkZXJDbXBUYXJnZXQ+ID0gW107XG5cbiAgcHJvdGVjdGVkIHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgcHVibGljIG9hdHRyOiBzdHJpbmc7XG4gIHByb3RlY3RlZCBjb21wb25lbnRTdGF0ZVNlcnZpY2U6IE9GaWx0ZXJCdWlsZGVyQ29tcG9uZW50U3RhdGVTZXJ2aWNlO1xuICBwcm90ZWN0ZWQgbG9jYWxTdG9yYWdlU2VydmljZTogTG9jYWxTdG9yYWdlU2VydmljZTtcbiAgcHJvdGVjdGVkIHJvdXRlcjogUm91dGVyO1xuICBwcm90ZWN0ZWQgYWN0Um91dGU6IEFjdGl2YXRlZFJvdXRlO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIEBJbmplY3QoZm9yd2FyZFJlZigoKSA9PiBPRm9ybUNvbXBvbmVudCkpIHB1YmxpYyBmb3JtOiBPRm9ybUNvbXBvbmVudFxuICApIHtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbFN0b3JhZ2VTZXJ2aWNlKTtcbiAgICB0aGlzLmNvbXBvbmVudFN0YXRlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0PE9GaWx0ZXJCdWlsZGVyQ29tcG9uZW50U3RhdGVTZXJ2aWNlPihPRmlsdGVyQnVpbGRlckNvbXBvbmVudFN0YXRlU2VydmljZSk7XG4gICAgdGhpcy5yb3V0ZXIgPSB0aGlzLmluamVjdG9yLmdldDxSb3V0ZXI+KFJvdXRlcik7XG4gICAgdGhpcy5hY3RSb3V0ZSA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFjdGl2YXRlZFJvdXRlPihBY3RpdmF0ZWRSb3V0ZSk7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmluaXRpYWxpemUoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmluaXRpYWxpemVMaXN0ZW5lcnMoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIGluaXRpYWxpemUoKTogdm9pZCB7XG4gICAgdGhpcy5jb21wb25lbnRTdGF0ZVNlcnZpY2UuaW5pdGlhbGl6ZSh0aGlzKTtcbiAgICAvLyBQYXJzZSBmaWx0ZXJzXG4gICAgaWYgKHRoaXMuZmlsdGVycykge1xuICAgICAgY29uc3QgZmlsdGVyQXJyYXk6IEFycmF5PHN0cmluZz4gPSBVdGlsLnBhcnNlQXJyYXkodGhpcy5maWx0ZXJzKTtcbiAgICAgIGZpbHRlckFycmF5LmZvckVhY2goZmlsdGVyID0+IHtcbiAgICAgICAgY29uc3QgZmlsdGVyRWxtcyA9IGZpbHRlci5zcGxpdChDb2Rlcy5DT0xVTU5TX0FMSUFTX1NFUEFSQVRPUik7XG4gICAgICAgIHRoaXMuZmlsdGVyQ29tcG9uZW50cy5wdXNoKHtcbiAgICAgICAgICB0YXJnZXRBdHRyOiBmaWx0ZXJFbG1zWzBdLFxuICAgICAgICAgIGZvcm1Db21wb25lbnRBdHRyOiBmaWx0ZXJFbG1zWzFdID8gZmlsdGVyRWxtc1sxXSA6IGZpbHRlckVsbXNbMF1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoVXRpbC5pc0RlZmluZWQodGhpcy50YXJnZXRDbXApKSB7XG4gICAgICB0aGlzLnRhcmdldENtcC5zZXRGaWx0ZXJCdWlsZGVyKHRoaXMpO1xuICAgIH1cbiAgfVxuXG4gIGluaXRpYWxpemVMaXN0ZW5lcnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMucXVlcnlPbkNoYW5nZSkge1xuICAgICAgdGhpcy5maWx0ZXJDb21wb25lbnRzLmZvckVhY2goKGZpbHRlckNvbXBvbmVudDogSUZpbHRlckJ1aWxkZXJDbXBUYXJnZXQpID0+IHtcbiAgICAgICAgY29uc3QgZm9ybUNvbXBvbmVudDogSUZvcm1EYXRhQ29tcG9uZW50ID0gdGhpcy5mb3JtLmdldENvbXBvbmVudHMoKVtmaWx0ZXJDb21wb25lbnQuZm9ybUNvbXBvbmVudEF0dHJdO1xuICAgICAgICBpZiAoZm9ybUNvbXBvbmVudCkge1xuICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICAgICAgICB0aGlzLmdldEV2ZW50RnJvbUZvcm1Db21wb25lbnQoZm9ybUNvbXBvbmVudClcbiAgICAgICAgICAgICAgLnBpcGUoZGVib3VuY2VUaW1lKHRoaXMucXVlcnlPbkNoYW5nZURlbGF5KSlcbiAgICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnRyaWdnZXJSZWxvYWQoKSkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEV2ZW50RnJvbUZvcm1Db21wb25lbnQoZm9ybUNvbXBvbmVudDogYW55KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5xdWVyeU9uQ2hhbmdlRXZlbnRUeXBlID09PSBDb2Rlcy5ERUZBVUxUX0NIQU5HRV9FVkVOVCA/XG4gICAgICBmb3JtQ29tcG9uZW50Lm9uVmFsdWVDaGFuZ2UgOlxuICAgICAgZm9ybUNvbXBvbmVudC5nZXRGb3JtQ29udHJvbCgpLnZhbHVlQ2hhbmdlcztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGBFeHByZXNzaW9uYCBvYmplY3Qgd2l0aCB0aGUgZmlsdGVyLlxuICAgKiBAcmV0dXJucyB0aGUgYEV4cHJlc3Npb25gIG9iamVjdCB3aXRoIHRoZSBmaWx0ZXIuXG4gICAqL1xuICBnZXRFeHByZXNzaW9uKCk6IEV4cHJlc3Npb24ge1xuICAgIC8vIFByZXBhcmUgZm9ybSBmaWx0ZXIgdmFsdWVzIFsuLi4geyBhdHRyLCB2YWx1ZSB9XVxuICAgIGNvbnN0IGZvcm1Db21wb25lbnRzID0gdGhpcy5mb3JtLmdldENvbXBvbmVudHMoKTtcbiAgICBjb25zdCBwYXJhbXM6IEFycmF5PHsgYXR0ciwgdmFsdWUgfT4gPSBbXTtcbiAgICB0aGlzLmZpbHRlckNvbXBvbmVudHMuZm9yRWFjaCgoZmlsdGVyQ29tcG9uZW50OiBJRmlsdGVyQnVpbGRlckNtcFRhcmdldCkgPT4ge1xuICAgICAgY29uc3QgZm9ybUNvbXBvbmVudDogSUZvcm1EYXRhQ29tcG9uZW50ID0gZm9ybUNvbXBvbmVudHNbZmlsdGVyQ29tcG9uZW50LmZvcm1Db21wb25lbnRBdHRyXTtcbiAgICAgIGlmIChmb3JtQ29tcG9uZW50KSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gZm9ybUNvbXBvbmVudC5nZXRWYWx1ZSgpO1xuICAgICAgICBwYXJhbXMucHVzaCh7XG4gICAgICAgICAgYXR0cjogZmlsdGVyQ29tcG9uZW50LnRhcmdldEF0dHIsXG4gICAgICAgICAgdmFsdWU6IHZhbHVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gVHJpZ2dlciB0aGUgZnVuY3Rpb24gcHJvdmlkZWQgYnkgdGhlIHVzZXJcbiAgICBpZiAodGhpcy5leHByZXNzaW9uQnVpbGRlcikge1xuICAgICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbkJ1aWxkZXIocGFyYW1zKTtcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSBkZXNmYXVsdCBleHByZXNzaW9uXG4gICAgY29uc3QgZXhwcmVzc2lvbnM6IEFycmF5PEV4cHJlc3Npb24+ID0gW107XG4gICAgcGFyYW1zLmZvckVhY2goZWxlbSA9PiB7XG4gICAgICBpZiAoVXRpbC5pc0RlZmluZWQoZWxlbS52YWx1ZSkpIHtcbiAgICAgICAgZXhwcmVzc2lvbnMucHVzaChGaWx0ZXJFeHByZXNzaW9uVXRpbHMuYnVpbGRFeHByZXNzaW9uRXF1YWxzKGVsZW0uYXR0ciwgZWxlbS52YWx1ZSkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGV4cHJlc3Npb25zLmxlbmd0aCA/IGV4cHJlc3Npb25zLnJlZHVjZSgoZmUxLCBmZTIpID0+IEZpbHRlckV4cHJlc3Npb25VdGlscy5idWlsZENvbXBsZXhFeHByZXNzaW9uKGZlMSwgZmUyLCBGaWx0ZXJFeHByZXNzaW9uVXRpbHMuT1BfT1IpKSA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGBCYXNpY0V4cHJlc3Npb25gIG9iamVjdCB3aXRoIHRoZSBmaWx0ZXIuXG4gICAqIEByZXR1cm5zIHRoZSBgQmFzaWNFeHByZXNzaW9uYCBvYmplY3Qgd2l0aCB0aGUgZmlsdGVyLlxuICAgKi9cbiAgZ2V0QmFzaWNFeHByZXNzaW9uKCk6IEJhc2ljRXhwcmVzc2lvbiB7XG4gICAgcmV0dXJuIEZpbHRlckV4cHJlc3Npb25VdGlscy5idWlsZEJhc2ljRXhwcmVzc2lvbih0aGlzLmdldEV4cHJlc3Npb24oKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZmlsdGVyIGJ1aWxkZXIgdGFyZ2V0IGNvbXBvbmVudC5cbiAgICogQHJldHVybnMgdGhlIHRhcmdldCBjb21wb25lbnQuXG4gICAqL1xuICBnZXRUYXJnZXRDb21wb25lbnQoKTogSVNlcnZpY2VEYXRhQ29tcG9uZW50IHtcbiAgICByZXR1cm4gdGhpcy50YXJnZXRDbXA7XG4gIH1cblxuICAvKipcbiAgICogVHJpZ2dlciB0aGUgYHJlbG9hZERhdGFgIG1ldGhvZCBmcm9tIHRoZSB0YXJnZXQgY29tcG9uZW50LlxuICAgKi9cbiAgdHJpZ2dlclJlbG9hZCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMudGFyZ2V0Q21wKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLnRhcmdldENtcC5wYWdlYWJsZSkge1xuICAgICAgdGhpcy50YXJnZXRDbXAucmVsb2FkUGFnaW5hdGVkRGF0YUZyb21TdGFydCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRhcmdldENtcC5yZWxvYWREYXRhKCk7XG4gICAgfVxuICAgIHRoaXMub25GaWx0ZXIuZW1pdCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIHRoZSBmb3JtIGNvbXBvbmVudHMgdXNlZCBmb3IgdGhlIGZpbHRlci5cbiAgICovXG4gIGNsZWFyRmlsdGVyKCk6IHZvaWQge1xuICAgIGNvbnN0IGZvcm1Db21wb25lbnRzID0gdGhpcy5mb3JtLmdldENvbXBvbmVudHMoKTtcbiAgICB0aGlzLmdldEZpbHRlckF0dHJzKCkuZm9yRWFjaCgoYXR0cjogc3RyaW5nKSA9PiB7XG4gICAgICBmb3JtQ29tcG9uZW50c1thdHRyXS5jbGVhclZhbHVlKCk7XG4gICAgfSk7XG4gICAgdGhpcy5vbkNsZWFyLmVtaXQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGZpbHRlciB2YWx1ZXNcbiAgICogQHJldHVybnMgZmlsdGVyIHZhbHVlc1xuICAgKi9cbiAgZ2V0RmlsdGVyVmFsdWVzKCk6IE9GaWx0ZXJCdWlsZGVyVmFsdWVzW10ge1xuICAgIGNvbnN0IHJlc3VsdDogT0ZpbHRlckJ1aWxkZXJWYWx1ZXNbXSA9IFtdO1xuXG4gICAgdGhpcy5maWx0ZXJDb21wb25lbnRzLlxuICAgICAgZm9yRWFjaCgoZmlsdGVyQ29tcG9uZW50OiBJRmlsdGVyQnVpbGRlckNtcFRhcmdldCkgPT4ge1xuICAgICAgICBpZiAoVXRpbC5pc0RlZmluZWQodGhpcy5mb3JtLmdldENvbXBvbmVudHMoKVtmaWx0ZXJDb21wb25lbnQuZm9ybUNvbXBvbmVudEF0dHJdKSkge1xuICAgICAgICAgIHJlc3VsdC5wdXNoKHsgYXR0cjogZmlsdGVyQ29tcG9uZW50LmZvcm1Db21wb25lbnRBdHRyLCB2YWx1ZTogdGhpcy5mb3JtLmdldENvbXBvbmVudHMoKVtmaWx0ZXJDb21wb25lbnQuZm9ybUNvbXBvbmVudEF0dHJdLmdldFZhbHVlKCkgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG5cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIGZpbHRlciB2YWx1ZXNcbiAgICogQHBhcmFtIGZpbHRlckJ1aWxkZXJWYWx1ZXNcbiAgICovXG4gIHNldEZpbHRlclZhbHVlcyhmaWx0ZXJCdWlsZGVyVmFsdWVzOiBPRmlsdGVyQnVpbGRlclZhbHVlc1tdKSB7XG4gICAgZmlsdGVyQnVpbGRlclZhbHVlcy5mb3JFYWNoKChmaWx0ZXJCdWlsZGVyVmFsdWU6IE9GaWx0ZXJCdWlsZGVyVmFsdWVzKSA9PiB7XG4gICAgICBpZiAodGhpcy5mb3JtLmdldENvbXBvbmVudHMoKVtmaWx0ZXJCdWlsZGVyVmFsdWUuYXR0cl0pIHtcbiAgICAgICAgdGhpcy5mb3JtLmdldENvbXBvbmVudHMoKVtmaWx0ZXJCdWlsZGVyVmFsdWUuYXR0cl0uc2V0VmFsdWUoZmlsdGVyQnVpbGRlclZhbHVlLnZhbHVlKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdUaGUgZmlsdGVyIHdpdGggYXR0ciAnICsgZmlsdGVyQnVpbGRlclZhbHVlLmF0dHIgKyAnIGNhbm5vdCBiZSBzZXQgJyArIGZpbHRlckJ1aWxkZXJWYWx1ZS52YWx1ZSArICcgYmVjYXVzZSBpdCBkb2VzIG5vdCBleGlzdCAuJyk7XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGFycmF5IHdpdGggdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIGZpbHRlcmFibGUgY29tcG9uZW50c1xuICAgKi9cbiAgcHJvdGVjdGVkIGdldEZpbHRlckF0dHJzKCk6IEFycmF5PHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmZpbHRlckNvbXBvbmVudHMubWFwKChlbGVtOiBJRmlsdGVyQnVpbGRlckNtcFRhcmdldCkgPT4gZWxlbS5mb3JtQ29tcG9uZW50QXR0cik7XG4gIH1cbiAgLyoqXG4gICAqIEdldHMgc3RhdGVcbiAgICovXG4gIGdldCBzdGF0ZSgpOiBPRmlsdGVyQnVpbGRlckNvbXBvbmVudFN0YXRlQ2xhc3Mge1xuICAgIHJldHVybiB0aGlzLmNvbXBvbmVudFN0YXRlU2VydmljZS5zdGF0ZTtcbiAgfVxuXG5cbiAgZ2V0RGF0YVRvU3RvcmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29tcG9uZW50U3RhdGVTZXJ2aWNlLnN0YXRlO1xuICB9XG5cbiAgZ2V0Q29tcG9uZW50S2V5KCk6IHN0cmluZyB7XG4gICAgaWYgKCFVdGlsLmlzRGVmaW5lZCh0aGlzLm9hdHRyKSkge1xuICAgICAgY29uc29sZS5lcnJvcignWW91ciBvLWZpbHRlci1idWlsZGVyIGNvbXBvbmVudCBtdXN0IGhhdmUgYW4gXFwnYXR0clxcJy4gT3RoZXJ3aXNlLCB5b3VyIGZpbHRlciBidWlsZGVyIHN0YXRlIHdpbGwgbm90IHNldCBpbiBsb2NhbHN0b3JhZ2UuJyk7XG4gICAgICByZXR1cm4gJ09GaWx0ZXJCdWlsZGVyQ29tcG9uZW50Xyc7XG4gICAgfVxuXG4gICAgcmV0dXJuICdPRmlsdGVyQnVpbGRlckNvbXBvbmVudF8nICsgdGhpcy5vYXR0cjtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9yZXMgZmlsdGVyIGluIHN0YXRlXG4gICAqIEBwYXJhbSBhcmdcbiAgICovXG4gIHN0b3JlRmlsdGVySW5TdGF0ZShhcmc6IE9GaWx0ZXJEZWZpbml0aW9uKSB7XG4gICAgdGhpcy5jb21wb25lbnRTdGF0ZVNlcnZpY2Uuc3RvcmVGaWx0ZXIoYXJnKTtcbiAgICB0aGlzLnVwZGF0ZVN0YXRlU3RvcmFnZSgpO1xuICB9XG4gIC8qKlxuICAgKiBNZXRob2QgdXBkYXRlIHN0b3JlIGxvY2Fsc3RvcmFnZSwgY2FsbCBvZiB0aGUgSUxvY2FsU3RvcmFnZVxuICAgKi9cbiAgcHJvdGVjdGVkIHVwZGF0ZVN0YXRlU3RvcmFnZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UudXBkYXRlQ29tcG9uZW50U3RvcmFnZSh0aGlzLCB0aGlzLmdldFJvdXRlS2V5KCkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRSb3V0ZUtleSgpOiBzdHJpbmcge1xuICAgIGxldCByb3V0ZSA9IHRoaXMucm91dGVyLnVybDtcbiAgICB0aGlzLmFjdFJvdXRlLnBhcmFtcy5zdWJzY3JpYmUocGFyYW1zID0+IHtcbiAgICAgIE9iamVjdC5rZXlzKHBhcmFtcykuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UocGFyYW1zW2tleV0sIGtleSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gcm91dGU7XG4gIH1cbn1cbiJdfQ==