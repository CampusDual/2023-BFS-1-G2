import { Injectable, Injector } from '@angular/core';
import { Router } from '@angular/router';
import { combineLatest, from, Observable } from 'rxjs';
import { AppConfig } from '../config/app-config';
import { Codes } from '../util/codes';
import { AuthService } from './auth.service';
import { LoginStorageService } from './login-storage.service';
import { OntimizeService } from './ontimize/ontimize.service';
import { PermissionsService } from './permissions/permissions.service';
import { ORemoteConfigurationService } from './remote-config.service';
export class OntimizeAuthService extends AuthService {
    constructor(injector) {
        super(injector);
        this.injector = injector;
        this._config = this.injector.get(AppConfig).getConfiguration();
        this.router = this.injector.get(Router);
        this.loginStorageService = this.injector.get(LoginStorageService);
        const sessionInfo = this.loginStorageService.getSessionInfo();
        if (sessionInfo && sessionInfo.id && sessionInfo.user && sessionInfo.user.length > 0) {
            this._user = sessionInfo.user;
        }
    }
    get user() {
        return this._user;
    }
    get localStorageKey() {
        return this.loginStorageService._localStorageKey;
    }
    configureOntimizeAuthService(config) {
        this.ontService = this.injector.get(OntimizeService);
        const servConf = {};
        servConf[Codes.SESSION_KEY] = this.loginStorageService.getSessionInfo();
        this.ontService.configureService(servConf);
    }
    retrieveAuthService() {
        return new Promise(resolve => {
            if (this.ontService !== undefined) {
                resolve(this.ontService);
            }
            else {
                this.configureOntimizeAuthService(this._config);
                resolve(this.ontService);
            }
        });
    }
    login(user, password) {
        this._user = user;
        const dataObservable = new Observable(observer => {
            this.retrieveAuthService().then(service => {
                service.startsession(user, password).subscribe(resp => {
                    this.onLoginSuccess(resp);
                    const permissionsService = this.injector.get(PermissionsService);
                    const remoteConfigService = this.injector.get(ORemoteConfigurationService);
                    const pendingArray = [];
                    pendingArray.push(permissionsService.getUserPermissionsAsPromise());
                    pendingArray.push(remoteConfigService.initialize());
                    combineLatest(pendingArray).subscribe(() => {
                        observer.next();
                        observer.complete();
                    });
                }, error => {
                    this.onLoginError(error);
                    observer.error(error);
                });
            });
        });
        return from(dataObservable.toPromise());
    }
    onLoginSuccess(sessionId) {
        const session = {
            user: this._user,
            id: sessionId
        };
        this.loginStorageService.storeSessionInfo(session);
        this.onLogin.next(session);
    }
    onLoginError(error) {
        this.dialogService.alert('ERROR', 'MESSAGES.ERROR_LOGIN');
    }
    logout() {
        this.onLogout.next(null);
        const sessionInfo = this.loginStorageService.getSessionInfo();
        const dataObservable = new Observable(innerObserver => {
            this.retrieveAuthService().then(service => {
                service.endsession(sessionInfo.user, sessionInfo.id).subscribe(resp => {
                    const remoteConfigService = this.injector.get(ORemoteConfigurationService);
                    remoteConfigService.finalize().subscribe(() => {
                        this.onLogoutSuccess(resp);
                        innerObserver.next();
                        innerObserver.complete();
                    });
                }, error => {
                    this.onLogoutError(error);
                    innerObserver.error(error);
                });
            });
        });
        return from(dataObservable.toPromise());
    }
    onLogoutSuccess(sessionId) {
        if (sessionId === 0) {
            this.clearSessionData();
            this.redirectLogin(false);
        }
    }
    onLogoutError(error) {
        console.error('Error on logout');
        this.clearSessionData();
        this.redirectLogin(false);
    }
    clearSessionData() {
        this.loginStorageService.sessionExpired();
    }
    isLoggedIn() {
        return this.loginStorageService.isLoggedIn();
    }
    getSessionInfo() {
        return this.loginStorageService.getSessionInfo();
    }
    storeSessionInfo(info) {
        this.loginStorageService.storeSessionInfo(info);
    }
    redirectLogin(sessionExpired = false) {
        const arg = {};
        arg[Codes.SESSION_EXPIRED_KEY] = sessionExpired;
        const extras = {};
        extras[Codes.QUERY_PARAMS] = arg;
        this.router.navigate([Codes.LOGIN_ROUTE], extras);
    }
}
OntimizeAuthService.decorators = [
    { type: Injectable }
];
OntimizeAuthService.ctorParameters = () => [
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1hdXRoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL28tYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBSWpELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN2RSxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUd0RSxNQUFNLE9BQU8sbUJBQW9CLFNBQVEsV0FBVztJQVFsRCxZQUFzQixRQUFrQjtRQUN0QyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7UUFESSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBRXRDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUMvRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJ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QUM7SUFDbEQsQ0FBQztJQUVELGFBQWEsQ0FBQyxpQkFBMEIsS0FBSztRQUMzQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZixHQUFHLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsY0FBYyxDQUFDO1FBQ2hELE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNsQixNQUFNLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUNqQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNwRCxDQUFDOzs7WUE1SUYsVUFBVTs7O1lBZlUsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgZnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBBcHBDb25maWcgfSBmcm9tICcuLi9jb25maWcvYXBwLWNvbmZpZyc7XG5pbXBvcnQgeyBJQXV0aFNlcnZpY2UgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2F1dGgtc2VydmljZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSAnLi4vdHlwZXMvY29uZmlnLnR5cGUnO1xuaW1wb3J0IHsgU2Vzc2lvbkluZm8gfSBmcm9tICcuLi90eXBlcy9zZXNzaW9uLWluZm8udHlwZSc7XG5pbXBvcnQgeyBDb2RlcyB9IGZyb20gJy4uL3V0aWwvY29kZXMnO1xuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBMb2dpblN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sb2dpbi1zdG9yYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgT250aW1pemVTZXJ2aWNlIH0gZnJvbSAnLi9vbnRpbWl6ZS9vbnRpbWl6ZS5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcm1pc3Npb25zU2VydmljZSB9IGZyb20gJy4vcGVybWlzc2lvbnMvcGVybWlzc2lvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBPUmVtb3RlQ29uZmlndXJhdGlvblNlcnZpY2UgfSBmcm9tICcuL3JlbW90ZS1jb25maWcuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBPbnRpbWl6ZUF1dGhTZXJ2aWNlIGV4dGVuZHMgQXV0aFNlcnZpY2Uge1xuXG4gIHByaXZhdGUgX3VzZXI6IHN0cmluZztcbiAgcHJpdmF0ZSBfY29uZmlnOiBDb25maWc7XG4gIHByaXZhdGUgcm91dGVyOiBSb3V0ZXI7XG4gIHByaXZhdGUgb250U2VydmljZTogT250aW1pemVTZXJ2aWNlO1xuICBwcml2YXRlIGxvZ2luU3RvcmFnZVNlcnZpY2U6IExvZ2luU3RvcmFnZVNlcnZpY2U7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIHN1cGVyKGluamVjdG9yKTtcbiAgICB0aGlzLl9jb25maWcgPSB0aGlzLmluamVjdG9yLmdldChBcHBDb25maWcpLmdldENvbmZpZ3VyYXRpb24oKTtcbiAgICB0aGlzLnJvdXRlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJvdXRlcik7XG4gICAgdGhpcy5sb2dpblN0b3JhZ2VTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoTG9naW5TdG9yYWdlU2VydmljZSk7XG4gICAgY29uc3Qgc2Vzc2lvbkluZm8gPSB0aGlzLmxvZ2luU3RvcmFnZVNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKTtcbiAgICBpZiAoc2Vzc2lvbkluZm8gJiYgc2Vzc2lvbkluZm8uaWQgJiYgc2Vzc2lvbkluZm8udXNlciAmJiBzZXNzaW9uSW5mby51c2VyLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuX3VzZXIgPSBzZXNzaW9uSW5mby51c2VyO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXQgdXNlcigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl91c2VyO1xuICB9XG5cbiAgcHVibGljIGdldCBsb2NhbFN0b3JhZ2VLZXkoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5sb2dpblN0b3JhZ2VTZXJ2aWNlLl9sb2NhbFN0b3JhZ2VLZXk7XG4gIH1cblxuICBwdWJsaWMgY29uZmlndXJlT250aW1pemVBdXRoU2VydmljZShjb25maWc6IG9iamVjdCk6IHZvaWQge1xuICAgIHRoaXMub250U2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KE9udGltaXplU2VydmljZSk7XG4gICAgY29uc3Qgc2VydkNvbmYgPSB7fTtcbiAgICBzZXJ2Q29uZltDb2Rlcy5TRVNTSU9OX0tFWV0gPSB0aGlzLmxvZ2luU3RvcmFnZVNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKTtcbiAgICB0aGlzLm9udFNlcnZpY2UuY29uZmlndXJlU2VydmljZShzZXJ2Q29uZik7XG4gIH1cblxuICBwdWJsaWMgcmV0cmlldmVBdXRoU2VydmljZSgpOiBQcm9taXNlPElBdXRoU2VydmljZT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxJQXV0aFNlcnZpY2U+KHJlc29sdmUgPT4ge1xuICAgICAgaWYgKHRoaXMub250U2VydmljZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlc29sdmUodGhpcy5vbnRTZXJ2aWNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJlT250aW1pemVBdXRoU2VydmljZSh0aGlzLl9jb25maWcpO1xuICAgICAgICByZXNvbHZlKHRoaXMub250U2VydmljZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgbG9naW4odXNlcjogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICB0aGlzLl91c2VyID0gdXNlcjtcbiAgICBjb25zdCBkYXRhT2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxhbnk+ID0gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT4ge1xuICAgICAgdGhpcy5yZXRyaWV2ZUF1dGhTZXJ2aWNlKCkudGhlbihzZXJ2aWNlID0+IHtcbiAgICAgICAgc2VydmljZS5zdGFydHNlc3Npb24odXNlciwgcGFzc3dvcmQpLnN1YnNjcmliZShyZXNwID0+IHtcbiAgICAgICAgICB0aGlzLm9uTG9naW5TdWNjZXNzKHJlc3ApO1xuICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25zU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFBlcm1pc3Npb25zU2VydmljZSk7XG4gICAgICAgICAgY29uc3QgcmVtb3RlQ29uZmlnU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KE9SZW1vdGVDb25maWd1cmF0aW9uU2VydmljZSk7XG4gICAgICAgICAgY29uc3QgcGVuZGluZ0FycmF5ID0gW107XG4gICAgICAgICAgcGVuZGluZ0FycmF5LnB1c2gocGVybWlzc2lvbnNTZXJ2aWNlLmdldFVzZXJQZXJtaXNzaW9uc0FzUHJvbWlzZSgpKTtcbiAgICAgICAgICBwZW5kaW5nQXJyYXkucHVzaChyZW1vdGVDb25maWdTZXJ2aWNlLmluaXRpYWxpemUoKSk7XG4gICAgICAgICAgY29tYmluZUxhdGVzdChwZW5kaW5nQXJyYXkpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KCk7XG4gICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5vbkxvZ2luRXJyb3IoZXJyb3IpO1xuICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gZnJvbShkYXRhT2JzZXJ2YWJsZS50b1Byb21pc2UoKSk7XG4gIH1cblxuICBwdWJsaWMgb25Mb2dpblN1Y2Nlc3Moc2Vzc2lvbklkOiBzdHJpbmcgfCBudW1iZXIpOiB2b2lkIHtcbiAgICAvLyBzYXZlIHVzZXIgYW5kIHNlc3Npb25pZCBpbnRvIGxvY2FsIHN0b3JhZ2VcbiAgICBjb25zdCBzZXNzaW9uID0ge1xuICAgICAgdXNlcjogdGhpcy5fdXNlcixcbiAgICAgIGlkOiBzZXNzaW9uSWRcbiAgICB9O1xuICAgIHRoaXMubG9naW5TdG9yYWdlU2VydmljZS5zdG9yZVNlc3Npb25JbmZvKHNlc3Npb24pO1xuICAgIHRoaXMub25Mb2dpbi5uZXh0KHNlc3Npb24pO1xuICB9XG5cbiAgcHVibGljIG9uTG9naW5FcnJvcihlcnJvcjogYW55KTogdm9pZCB7XG4gICAgdGhpcy5kaWFsb2dTZXJ2aWNlLmFsZXJ0KCdFUlJPUicsICdNRVNTQUdFUy5FUlJPUl9MT0dJTicpO1xuICB9XG5cbiAgcHVibGljIGxvZ291dCgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHRoaXMub25Mb2dvdXQubmV4dChudWxsKTtcbiAgICBjb25zdCBzZXNzaW9uSW5mbyA9IHRoaXMubG9naW5TdG9yYWdlU2VydmljZS5nZXRTZXNzaW9uSW5mbygpO1xuICAgIGNvbnN0IGRhdGFPYnNlcnZhYmxlOiBPYnNlcnZhYmxlPGFueT4gPSBuZXcgT2JzZXJ2YWJsZShpbm5lck9ic2VydmVyID0+IHtcbiAgICAgIHRoaXMucmV0cmlldmVBdXRoU2VydmljZSgpLnRoZW4oc2VydmljZSA9PiB7XG4gICAgICAgIHNlcnZpY2UuZW5kc2Vzc2lvbihzZXNzaW9uSW5mby51c2VyLCBzZXNzaW9uSW5mby5pZCkuc3Vic2NyaWJlKHJlc3AgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlbW90ZUNvbmZpZ1NlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChPUmVtb3RlQ29uZmlndXJhdGlvblNlcnZpY2UpO1xuICAgICAgICAgIHJlbW90ZUNvbmZpZ1NlcnZpY2UuZmluYWxpemUoKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vbkxvZ291dFN1Y2Nlc3MocmVzcCk7XG4gICAgICAgICAgICBpbm5lck9ic2VydmVyLm5leHQoKTtcbiAgICAgICAgICAgIGlubmVyT2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAgIHRoaXMub25Mb2dvdXRFcnJvcihlcnJvcik7XG4gICAgICAgICAgaW5uZXJPYnNlcnZlci5lcnJvcihlcnJvcik7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGZyb20oZGF0YU9ic2VydmFibGUudG9Qcm9taXNlKCkpO1xuICB9XG5cbiAgcHVibGljIG9uTG9nb3V0U3VjY2VzcyhzZXNzaW9uSWQ6IG51bWJlcik6IHZvaWQge1xuICAgIGlmIChzZXNzaW9uSWQgPT09IDApIHtcbiAgICAgIHRoaXMuY2xlYXJTZXNzaW9uRGF0YSgpO1xuICAgICAgdGhpcy5yZWRpcmVjdExvZ2luKGZhbHNlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb25Mb2dvdXRFcnJvcihlcnJvcjogYW55KTogdm9pZCB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3Igb24gbG9nb3V0Jyk7XG4gICAgdGhpcy5jbGVhclNlc3Npb25EYXRhKCk7XG4gICAgdGhpcy5yZWRpcmVjdExvZ2luKGZhbHNlKTtcbiAgfVxuXG4gIHB1YmxpYyBjbGVhclNlc3Npb25EYXRhKCk6IHZvaWQge1xuICAgIHRoaXMubG9naW5TdG9yYWdlU2VydmljZS5zZXNzaW9uRXhwaXJlZCgpO1xuICB9XG5cbiAgcHVibGljIGlzTG9nZ2VkSW4oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMubG9naW5TdG9yYWdlU2VydmljZS5pc0xvZ2dlZEluKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2Vzc2lvbkluZm8oKTogU2Vzc2lvbkluZm8ge1xuICAgIHJldHVybiB0aGlzLmxvZ2luU3RvcmFnZVNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKTtcbiAgfVxuXG4gIHB1YmxpYyBzdG9yZVNlc3Npb25JbmZvKGluZm86IFNlc3Npb25JbmZvKTogdm9pZCB7XG4gICAgdGhpcy5sb2dpblN0b3JhZ2VTZXJ2aWNlLnN0b3JlU2Vzc2lvbkluZm8oaW5mbyk7XG4gIH1cblxuICByZWRpcmVjdExvZ2luKHNlc3Npb25FeHBpcmVkOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICBjb25zdCBhcmcgPSB7fTtcbiAgICBhcmdbQ29kZXMuU0VTU0lPTl9FWFBJUkVEX0tFWV0gPSBzZXNzaW9uRXhwaXJlZDtcbiAgICBjb25zdCBleHRyYXMgPSB7fTtcbiAgICBleHRyYXNbQ29kZXMuUVVFUllfUEFSQU1TXSA9IGFyZztcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbQ29kZXMuTE9HSU5fUk9VVEVdLCBleHRyYXMpO1xuICB9XG5cbn1cbiJdfQ==