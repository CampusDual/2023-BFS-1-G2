import { HttpClient, HttpHeaders } from '@angular/common/http';
import { HostListener, Injectable, Injector } from '@angular/core';
import { Observable, timer } from 'rxjs';
import { AppConfig } from '../config/app-config';
import { Codes } from '../util/codes';
import { Util } from '../util/util';
import { AuthService } from './auth.service';
import { LocalStorageService } from './local-storage.service';
import * as i0 from "@angular/core";
export class ORemoteConfigurationService {
    constructor(injector) {
        this.injector = injector;
        this._columns = {
            user: ORemoteConfigurationService.DEFAULT_COLUMN_USER,
            appId: ORemoteConfigurationService.DEFAULT_COLUMN_APPID,
            configuration: ORemoteConfigurationService.DEFAULT_COLUMN_CONFIG
        };
        this.httpClient = this.injector.get(HttpClient);
        this._appConfig = this.injector.get(AppConfig);
        this.authService = this.injector.get(AuthService);
        this.localStorageService = this.injector.get(LocalStorageService);
        this.httpClient = this.injector.get(HttpClient);
        this._uuid = this._appConfig.getConfiguration().uuid;
        if (this._appConfig.useRemoteConfiguration()) {
            this._url = this._appConfig.getRemoteConfigurationEndpoint();
            const remoteConfig = this._appConfig.getRemoteConfigurationConfig();
            this._columns = (remoteConfig && remoteConfig.columns) ? Object.assign(this._columns, remoteConfig.columns) : this._columns;
            this._timeout = (remoteConfig && remoteConfig.timeout) ? remoteConfig.timeout : ORemoteConfigurationService.DEFAULT_STORAGE_TIMEOUT;
            const self = this;
            this.localStorageService.onSetLocalStorage.subscribe(() => {
                if (self.storeSubscription) {
                    self.storeSubscription.unsubscribe();
                }
            });
        }
    }
    beforeunloadHandler() {
        this.finalize().subscribe(() => {
        });
    }
    getUserConfiguration() {
        const self = this;
        const observable = new Observable((observer) => {
            const sessionInfo = self.authService.getSessionInfo();
            if (!self.hasSession(sessionInfo)) {
                observer.error();
                return;
            }
            const url = self._url + '/search';
            const body = {};
            body[self._columns.user] = sessionInfo.user;
            body[self._columns.appId] = self._uuid;
            const options = {
                headers: self.buildHeaders()
            };
            self.httpClient.post(url, body, options).subscribe((resp) => {
                if (resp && resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE && Util.isDefined(resp.data)) {
                    observer.next(resp);
                }
                else {
                    observer.error();
                }
            }, (error) => observer.error(error), () => observer.complete());
        });
        return observable;
    }
    storeUserConfiguration() {
        const self = this;
        if (self.storeSubscription) {
            self.storeSubscription.unsubscribe();
        }
        const observable = new Observable((observer) => {
            const sessionInfo = self.authService.getSessionInfo();
            if (!self._appConfig.useRemoteConfiguration() || !self.hasSession(sessionInfo)) {
                observer.next();
                observer.complete();
                return;
            }
            const url = self._url;
            const body = { filter: {}, data: {} };
            body.filter[self._columns.user] = sessionInfo.user;
            body.filter[self._columns.appId] = self._uuid;
            let userData = self.localStorageService.getSessionUserComponentsData() || '';
            try {
                userData = btoa(JSON.stringify(userData));
            }
            catch (e) {
                userData = '';
            }
            body.data[self._columns.configuration] = userData;
            const options = {
                headers: self.buildHeaders()
            };
            self.httpClient.put(url, body, options).subscribe((resp) => {
                if (resp && resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE) {
                    observer.next(resp);
                }
                else {
                    observer.error();
                }
            }, (error) => observer.error(error), () => observer.complete());
        });
        return observable;
    }
    initialize() {
        const self = this;
        return new Observable(observer => {
            if (self._appConfig.useRemoteConfiguration()) {
                self.timerSubscription = timer(self._timeout, self._timeout).subscribe(() => {
                    self.storeSubscription = self.storeUserConfiguration().subscribe(() => {
                    });
                });
                self.getUserConfiguration().subscribe((resp) => {
                    let storedConf;
                    if (Util.isArray(resp.data)) {
                        storedConf = resp.data[0][self._columns.configuration];
                    }
                    else {
                        storedConf = resp.data;
                    }
                    if (Util.isDefined(storedConf)) {
                        let componentsData;
                        try {
                            const decoded = atob(storedConf);
                            componentsData = JSON.parse(decoded);
                        }
                        catch (e) {
                            componentsData = {};
                        }
                        self.localStorageService.storeSessionUserComponentsData(componentsData);
                    }
                    observer.next();
                }, () => {
                    observer.next();
                });
            }
            else {
                observer.next();
            }
        });
    }
    finalize() {
        if (this.timerSubscription) {
            this.timerSubscription.unsubscribe();
        }
        return this.storeUserConfiguration();
    }
    hasSession(sessionInfo) {
        return Util.isDefined(sessionInfo) && Util.isDefined(sessionInfo.user) && Util.isDefined(sessionInfo.id);
    }
    buildHeaders() {
        const sessionInfo = this.authService.getSessionInfo();
        return new HttpHeaders({
            'Access-Control-Allow-Origin': '*',
            'Content-Type': 'application/json;charset=UTF-8',
            Authorization: 'Bearer ' + sessionInfo.id
        });
    }
}
ORemoteConfigurationService.DEFAULT_COLUMN_USER = 'USER_';
ORemoteConfigurationService.DEFAULT_COLUMN_APPID = 'APP_UUID';
ORemoteConfigurationService.DEFAULT_COLUMN_CONFIG = 'CONFIGURATION';
ORemoteConfigurationService.DEFAULT_STORAGE_TIMEOUT = 60000;
ORemoteConfigurationService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
ORemoteConfigurationService.ctorParameters = () => [
    { type: Injector }
];
ORemoteConfigurationService.propDecorators = {
    beforeunloadHandler: [{ type: HostListener, args: ['window:beforeunload', [],] }]
};
ORemoteConfigurationService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function ORemoteConfigurationService_Factory() { return new ORemoteConfigurationService(i0.ɵɵinject(i0.INJECTOR)); }, token: ORemoteConfigurationService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVtb3RlLWNvbmZpZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9yZW1vdGUtY29uZmlnLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQVEsTUFBTSxlQUFlLENBQUM7QUFDekUsT0FBTyxFQUFFLFVBQVUsRUFBNEIsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRW5FLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUlqRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDOztBQUs5RCxNQUFNLE9BQU8sMkJBQTJCO0lBOEJ0QyxZQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBYjlCLGFBQVEsR0FBZ0M7WUFDaEQsSUFBSSxFQUFFLDJCQUEyQixDQUFDLG1CQUFtQjtZQUNyRCxLQUFLLEVBQUUsMkJBQTJCLENBQUMsb0JBQW9CO1lBQ3ZELGFBQWEsRUFBRSwyQkFBMkIsQ0FBQyxxQkFBcUI7U0FDakUsQ0FBQztRQVVBLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBOEIsQ0FBQyxDQUFDO1FBQ2hGLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQVksU0FBNEIsQ0FBQyxDQUFDO1FBQzdFLElBQUksQ0FBQyxX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aW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBIb3N0TGlzdGVuZXIsIEluamVjdGFibGUsIEluamVjdG9yLCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpYmVyLCBTdWJzY3JpcHRpb24sIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IEFwcENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9hcHAtY29uZmlnJztcbmltcG9ydCB7IFNlcnZpY2VSZXNwb25zZSB9IGZyb20gJy4uL2ludGVyZmFjZXMvc2VydmljZS1yZXNwb25zZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgT1JlbW90ZUNvbmZpZ3VyYXRpb24sIE9SZW1vdGVDb25maWd1cmF0aW9uQ29sdW1ucyB9IGZyb20gJy4uL3R5cGVzL3JlbW90ZS1jb25maWd1cmF0aW9uLnR5cGUnO1xuaW1wb3J0IHsgU2Vzc2lvbkluZm8gfSBmcm9tICcuLi90eXBlcy9zZXNzaW9uLWluZm8udHlwZSc7XG5pbXBvcnQgeyBDb2RlcyB9IGZyb20gJy4uL3V0aWwvY29kZXMnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uL3V0aWwvdXRpbCc7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4vYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB7IExvY2FsU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL2xvY2FsLXN0b3JhZ2Uuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIE9SZW1vdGVDb25maWd1cmF0aW9uU2VydmljZSB7XG5cbiAgcHVibGljIHN0YXRpYyBERUZBVUxUX0NPTFVNTl9VU0VSID0gJ1VTRVJfJztcbiAgcHVibGljIHN0YXRpYyBERUZBVUxUX0NPTFVNTl9BUFBJRCA9ICdBUFBfVVVJRCc7XG4gIHB1YmxpYyBzdGF0aWMgREVGQVVMVF9DT0xVTU5fQ09ORklHID0gJ0NPTkZJR1VSQVRJT04nO1xuICBwdWJsaWMgc3RhdGljIERFRkFVTFRfU1RPUkFHRV9USU1FT1VUID0gNjAwMDA7XG5cbiAgcHJvdGVjdGVkIGxvY2FsU3RvcmFnZVNlcnZpY2U6IExvY2FsU3RvcmFnZVNlcnZpY2U7XG4gIHByb3RlY3RlZCBhdXRoU2VydmljZTogQXV0aFNlcnZpY2U7XG4gIHByb3RlY3RlZCBodHRwQ2xpZW50OiBIdHRwQ2xpZW50O1xuICBwcm90ZWN0ZWQgX2FwcENvbmZpZzogQXBwQ29uZmlnO1xuICBwcm90ZWN0ZWQgX3VybDogc3RyaW5nO1xuICBwcm90ZWN0ZWQgX3V1aWQ6IHN0cmluZztcbiAgcHJvdGVjdGVkIF90aW1lb3V0OiBudW1iZXI7XG4gIHByb3RlY3RlZCB0aW1lclN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcm90ZWN0ZWQgc3RvcmVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBwcm90ZWN0ZWQgX2NvbHVtbnM6IE9SZW1vdGVDb25maWd1cmF0aW9uQ29sdW1ucyA9IHtcbiAgICB1c2VyOiBPUmVtb3RlQ29uZmlndXJhdGlvblNlcnZpY2UuREVGQVVMVF9DT0xVTU5fVVNFUixcbiAgICBhcHBJZDogT1JlbW90ZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLkRFRkFVTFRfQ09MVU1OX0FQUElELFxuICAgIGNvbmZpZ3VyYXRpb246IE9SZW1vdGVDb25maWd1cmF0aW9uU2VydmljZS5ERUZBVUxUX0NPTFVNTl9DT05GSUdcbiAgfTtcblxuICBASG9zdExpc3RlbmVyKCd3aW5kb3c6YmVmb3JldW5sb2FkJywgW10pXG4gIGJlZm9yZXVubG9hZEhhbmRsZXIoKSB7XG4gICAgdGhpcy5maW5hbGl6ZSgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAvL1xuICAgIH0pO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIHRoaXMuaHR0cENsaWVudCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEh0dHBDbGllbnQ+KEh0dHBDbGllbnQgYXMgVHlwZTxIdHRwQ2xpZW50Pik7XG4gICAgdGhpcy5fYXBwQ29uZmlnID0gdGhpcy5pbmplY3Rvci5nZXQ8QXBwQ29uZmlnPihBcHBDb25maWcgYXMgVHlwZTxBcHBDb25maWc+KTtcbiAgICB0aGlzLmF1dGhTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQ8QXV0aFNlcnZpY2U+KEF1dGhTZXJ2aWNlIGFzIFR5cGU8QXV0aFNlcnZpY2U+KTtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldDxMb2NhbFN0b3JhZ2VTZXJ2aWNlPihMb2NhbFN0b3JhZ2VTZXJ2aWNlIGFzIFR5cGU8TG9jYWxTdG9yYWdlU2VydmljZT4pO1xuXG4gICAgdGhpcy5odHRwQ2xpZW50ID0gdGhpcy5pbmplY3Rvci5nZXQ8SHR0cENsaWVudD4oSHR0cENsaWVudCBhcyBUeXBlPEh0dHBDbGllbnQ+KTtcbiAgICB0aGlzLl91dWlkID0gdGhpcy5fYXBwQ29uZmlnLmdldENvbmZpZ3VyYXRpb24oKS51dWlkO1xuXG4gICAgaWYgKHRoaXMuX2FwcENvbmZpZy51c2VSZW1vdGVDb25maWd1cmF0aW9uKCkpIHtcbiAgICAgIHRoaXMuX3VybCA9IHRoaXMuX2FwcENvbmZpZy5nZXRSZW1vdGVDb25maWd1cmF0aW9uRW5kcG9pbnQoKTtcblxuICAgICAgY29uc3QgcmVtb3RlQ29uZmlnOiBPUmVtb3RlQ29uZmlndXJhdGlvbiA9IHRoaXMuX2FwcENvbmZpZy5nZXRSZW1vdGVDb25maWd1cmF0aW9uQ29uZmlnKCk7XG4gICAgICB0aGlzLl9jb2x1bW5zID0gKHJlbW90ZUNvbmZpZyAmJiByZW1vdGVDb25maWcuY29sdW1ucykgPyBPYmplY3QuYXNzaWduKHRoaXMuX2NvbHVtbnMsIHJlbW90ZUNvbmZpZy5jb2x1bW5zKSA6IHRoaXMuX2NvbHVtbnM7XG5cbiAgICAgIHRoaXMuX3RpbWVvdXQgPSAocmVtb3RlQ29uZmlnICYmIHJlbW90ZUNvbmZpZy50aW1lb3V0KSA/IHJlbW90ZUNvbmZpZy50aW1lb3V0IDogT1JlbW90ZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLkRFRkFVTFRfU1RPUkFHRV9USU1FT1VUO1xuICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uub25TZXRMb2NhbFN0b3JhZ2Uuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgaWYgKHNlbGYuc3RvcmVTdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICBzZWxmLnN0b3JlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRVc2VyQ29uZmlndXJhdGlvbigpOiBPYnNlcnZhYmxlPFNlcnZpY2VSZXNwb25zZT4ge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIGNvbnN0IG9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbkluZm8gPSBzZWxmLmF1dGhTZXJ2aWNlLmdldFNlc3Npb25JbmZvKCk7XG4gICAgICBpZiAoIXNlbGYuaGFzU2Vzc2lvbihzZXNzaW9uSW5mbykpIHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgdXJsID0gc2VsZi5fdXJsICsgJy9zZWFyY2gnO1xuICAgICAgY29uc3QgYm9keTogYW55ID0ge307XG4gICAgICBib2R5W3NlbGYuX2NvbHVtbnMudXNlcl0gPSBzZXNzaW9uSW5mby51c2VyO1xuICAgICAgYm9keVtzZWxmLl9jb2x1bW5zLmFwcElkXSA9IHNlbGYuX3V1aWQ7XG4gICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICBoZWFkZXJzOiBzZWxmLmJ1aWxkSGVhZGVycygpXG4gICAgICB9O1xuICAgICAgc2VsZi5odHRwQ2xpZW50LnBvc3QodXJsLCBib2R5LCBvcHRpb25zKS5zdWJzY3JpYmUoKHJlc3A6IFNlcnZpY2VSZXNwb25zZSkgPT4ge1xuICAgICAgICBpZiAocmVzcCAmJiByZXNwLmNvZGUgPT09IENvZGVzLk9OVElNSVpFX1NVQ0NFU1NGVUxfQ09ERSAmJiBVdGlsLmlzRGVmaW5lZChyZXNwLmRhdGEpKSB7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZXNwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvYnNlcnZlci5lcnJvcigpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgICAoZXJyb3IpID0+IG9ic2VydmVyLmVycm9yKGVycm9yKSxcbiAgICAgICAgKCkgPT4gb2JzZXJ2ZXIuY29tcGxldGUoKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIG9ic2VydmFibGU7XG4gIH1cblxuICBwdWJsaWMgc3RvcmVVc2VyQ29uZmlndXJhdGlvbigpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIGlmIChzZWxmLnN0b3JlU3Vic2NyaXB0aW9uKSB7XG4gICAgICBzZWxmLnN0b3JlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICAgIGNvbnN0IG9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikgPT4ge1xuICAgICAgY29uc3Qgc2Vzc2lvbkluZm8gPSBzZWxmLmF1dGhTZXJ2aWNlLmdldFNlc3Npb25JbmZvKCk7XG4gICAgICBpZiAoIXNlbGYuX2FwcENvbmZpZy51c2VSZW1vdGVDb25maWd1cmF0aW9uKCkgfHwgIXNlbGYuaGFzU2Vzc2lvbihzZXNzaW9uSW5mbykpIHtcbiAgICAgICAgb2JzZXJ2ZXIubmV4dCgpO1xuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB1cmwgPSBzZWxmLl91cmw7XG4gICAgICBjb25zdCBib2R5OiBhbnkgPSB7IGZpbHRlcjoge30sIGRhdGE6IHt9IH07XG4gICAgICBib2R5LmZpbHRlcltzZWxmLl9jb2x1bW5zLnVzZXJdID0gc2Vzc2lvbkluZm8udXNlcjtcbiAgICAgIGJvZHkuZmlsdGVyW3NlbGYuX2NvbHVtbnMuYXBwSWRdID0gc2VsZi5fdXVpZDtcbiAgICAgIGxldCB1c2VyRGF0YSA9IHNlbGYubG9jYWxTdG9yYWdlU2VydmljZS5nZXRTZXNzaW9uVXNlckNvbXBvbmVudHNEYXRhKCkgfHwgJyc7XG4gICAgICB0cnkge1xuICAgICAgICB1c2VyRGF0YSA9IGJ0b2EoSlNPTi5zdHJpbmdpZnkodXNlckRhdGEpKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgdXNlckRhdGEgPSAnJztcbiAgICAgIH1cbiAgICAgIGJvZHkuZGF0YVtzZWxmLl9jb2x1bW5zLmNvbmZpZ3VyYXRpb25dID0gdXNlckRhdGE7XG4gICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICBoZWFkZXJzOiBzZWxmLmJ1aWxkSGVhZGVycygpXG4gICAgICB9O1xuICAgICAgc2VsZi5odHRwQ2xpZW50LnB1dCh1cmwsIGJvZHksIG9wdGlvbnMpLnN1YnNjcmliZSgocmVzcDogU2VydmljZVJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGlmIChyZXNwICYmIHJlc3AuY29kZSA9PT0gQ29kZXMuT05USU1JWkVfU1VDQ0VTU0ZVTF9DT0RFKSB7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZXNwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBvYnNlcnZlci5lcnJvcigpO1xuICAgICAgICB9XG4gICAgICB9LCAoZXJyb3IpID0+IG9ic2VydmVyLmVycm9yKGVycm9yKSxcbiAgICAgICAgKCkgPT4gb2JzZXJ2ZXIuY29tcGxldGUoKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIG9ic2VydmFibGU7XG4gIH1cblxuICBwdWJsaWMgaW5pdGlhbGl6ZSgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiB7XG4gICAgICBpZiAoc2VsZi5fYXBwQ29uZmlnLnVzZVJlbW90ZUNvbmZpZ3VyYXRpb24oKSkge1xuICAgICAgICBzZWxmLnRpbWVyU3Vic2NyaXB0aW9uID0gdGltZXIoc2VsZi5fdGltZW91dCwgc2VsZi5fdGltZW91dCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICBzZWxmLnN0b3JlU3Vic2NyaXB0aW9uID0gc2VsZi5zdG9yZVVzZXJDb25maWd1cmF0aW9uKCkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBzZWxmLmdldFVzZXJDb25maWd1cmF0aW9uKCkuc3Vic2NyaWJlKChyZXNwOiBTZXJ2aWNlUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICBsZXQgc3RvcmVkQ29uZjtcbiAgICAgICAgICBpZiAoVXRpbC5pc0FycmF5KHJlc3AuZGF0YSkpIHtcbiAgICAgICAgICAgIHN0b3JlZENvbmYgPSByZXNwLmRhdGFbMF1bc2VsZi5fY29sdW1ucy5jb25maWd1cmF0aW9uXTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RvcmVkQ29uZiA9IHJlc3AuZGF0YTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKFV0aWwuaXNEZWZpbmVkKHN0b3JlZENvbmYpKSB7XG4gICAgICAgICAgICBsZXQgY29tcG9uZW50c0RhdGE7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBjb25zdCBkZWNvZGVkID0gYXRvYihzdG9yZWRDb25mKTtcbiAgICAgICAgICAgICAgY29tcG9uZW50c0RhdGEgPSBKU09OLnBhcnNlKGRlY29kZWQpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICBjb21wb25lbnRzRGF0YSA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VsZi5sb2NhbFN0b3JhZ2VTZXJ2aWNlLnN0b3JlU2Vzc2lvblVzZXJDb21wb25lbnRzRGF0YShjb21wb25lbnRzRGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIG9ic2VydmVyLm5leHQoKTtcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgIG9ic2VydmVyLm5leHQoKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvYnNlcnZlci5uZXh0KCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZmluYWxpemUoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy50aW1lclN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy50aW1lclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5zdG9yZVVzZXJDb25maWd1cmF0aW9uKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgaGFzU2Vzc2lvbihzZXNzaW9uSW5mbzogU2Vzc2lvbkluZm8pOiBib29sZWFuIHtcbiAgICByZXR1cm4gVXRpbC5pc0RlZmluZWQoc2Vzc2lvbkluZm8pICYmIFV0aWwuaXNEZWZpbmVkKHNlc3Npb25JbmZvLnVzZXIpICYmIFV0aWwuaXNEZWZpbmVkKHNlc3Npb25JbmZvLmlkKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBidWlsZEhlYWRlcnMoKTogSHR0cEhlYWRlcnMge1xuICAgIGNvbnN0IHNlc3Npb25JbmZvID0gdGhpcy5hdXRoU2VydmljZS5nZXRTZXNzaW9uSW5mbygpO1xuICAgIHJldHVybiBuZXcgSHR0cEhlYWRlcnMoe1xuICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PVVURi04JyxcbiAgICAgIEF1dGhvcml6YXRpb246ICdCZWFyZXIgJyArIHNlc3Npb25JbmZvLmlkXG4gICAgfSk7XG4gIH1cblxufVxuIl19