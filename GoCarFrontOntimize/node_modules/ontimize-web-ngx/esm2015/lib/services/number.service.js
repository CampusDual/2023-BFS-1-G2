import { Injectable, Injector } from '@angular/core';
import { Util } from '../util/util';
import { OTranslateService } from './translate/o-translate.service';
import * as i0 from "@angular/core";
export class NumberService {
    constructor(injector) {
        this.injector = injector;
        this.translateService = this.injector.get(OTranslateService);
        this.minDecimalDigits = NumberService.DEFAULT_DECIMAL_DIGITS;
        this.maxDecimalDigits = NumberService.DEFAULT_DECIMAL_DIGITS;
        this.locale = this.translateService.getCurrentLang();
        this.translateService.onLanguageChanged.subscribe(() => this.locale = this.translateService.getCurrentLang());
    }
    getIntegerValue(value, args) {
        const grouping = args ? args.grouping : undefined;
        if (!Util.isDefined(value)) {
            return value;
        }
        const thousandSeparator = args ? args.thousandSeparator : undefined;
        const locale = args ? args.locale : undefined;
        const intValue = parseInt(value, 10);
        if (isNaN(intValue)) {
            return void 0;
        }
        let formattedIntValue;
        if (Util.isDefined(locale) || !Util.isDefined(thousandSeparator)) {
            formattedIntValue = new Intl.NumberFormat(Util.isDefined(locale) ? locale : this.locale).format(intValue);
        }
        else {
            formattedIntValue = String(intValue).toString().replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);
        }
        return formattedIntValue;
    }
    getRealValue(value, args) {
        if (!Util.isDefined(value)) {
            return value;
        }
        const locale = args ? args.locale : undefined;
        const thousandSeparator = args ? args.thousandSeparator : undefined;
        const decimalSeparator = args ? args.decimalSeparator : undefined;
        const grouping = args ? args.grouping : false;
        const minDecimalDigits = args ? args.minDecimalDigits : this.minDecimalDigits;
        const maxDecimalDigits = args ? args.maxDecimalDigits : this.maxDecimalDigits;
        let formattedRealValue = value;
        const useIntlNumberFormat = Util.isDefined(locale) || (!Util.isDefined(thousandSeparator) || !Util.isDefined(decimalSeparator));
        if (useIntlNumberFormat) {
            formattedRealValue = args.truncate ? this.truncate(value, maxDecimalDigits) : null;
            if (!Util.isDefined(formattedRealValue)) {
                let formatterArgs = {
                    minimumFractionDigits: minDecimalDigits,
                    maximumFractionDigits: maxDecimalDigits,
                    useGrouping: grouping
                };
                formattedRealValue = new Intl.NumberFormat(Util.isDefined(locale) ? locale : this.locale, formatterArgs).format(value);
            }
        }
        else {
            formattedRealValue = this.parseRealValue(value, maxDecimalDigits, thousandSeparator, decimalSeparator, grouping);
        }
        return formattedRealValue;
    }
    getPercentValue(value, args) {
        const valueBase = args ? args.valueBase : undefined;
        let parsedValue = value;
        switch (valueBase) {
            case 100:
                break;
            case 1:
            default:
                parsedValue = parsedValue * 100;
                break;
        }
        const formattedPercentValue = this.getRealValue(parsedValue, args) + ' %';
        return formattedPercentValue;
    }
    truncate(value, maxDecimals) {
        const stringValue = String(value);
        const splittedValue = stringValue.split('.');
        const decimalsLength = Util.isDefined(splittedValue[1]) ? splittedValue[1].length : null;
        if (decimalsLength > maxDecimals) {
            return stringValue.slice(0, splittedValue[0].length + 1 + maxDecimals);
        }
        return null;
    }
    parseRealValue(value, maxDecimalDigits, thousandSeparator, decimalSeparator, grouping) {
        let result = value;
        const realValue = parseFloat(value);
        if (!isNaN(realValue)) {
            result = String(realValue);
            let tmpStr = realValue.toFixed(maxDecimalDigits);
            tmpStr = tmpStr.replace('.', decimalSeparator);
            if (grouping) {
                const parts = tmpStr.split(decimalSeparator);
                if (parts.length > 0) {
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);
                    result = parts.join(decimalSeparator);
                }
            }
            else {
                result = tmpStr;
            }
        }
        return result;
    }
}
NumberService.DEFAULT_DECIMAL_DIGITS = 2;
NumberService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
NumberService.ctorParameters = () => [
    { type: Injector }
];
NumberService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function NumberService_Factory() { return new NumberService(i0.ɵɵinject(i0.INJECTOR)); }, token: NumberService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnVtYmVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL251bWJlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3JELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDcEMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUNBQWlDLENBQUM7O0FBS3BFLE1BQU0sT0FBTyxhQUFhO0lBVXhCLFlBQXNCLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFFdEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFN0QsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGFBQWEsQ0FBQyxzQkFBc0IsQ0FBQztRQUM3RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsYUFBYSxDQUFDLHNCQUFzQixDQUFDO1FBRTdELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxDQUFBO1FBQ3BELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQ3JELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxDQUNyRCxDQUFDO0lBQ0osQ0FBQztJQUVELGVBQWUsQ0FBQyxLQUFVLEVBQUUsSUFBUztRQUNuQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNsRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUMxQixPQUFPLEtB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QkFBTTtnQkFDTCxNQUFNLEdBQUcsTUFBTSxDQUFDO2FBQ2pCO1NBQ0Y7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDOztBQXJIYSxvQ0FBc0IsR0FBRyxDQUFDLENBQUM7O1lBTDFDLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBUm9CLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBJUmVhbFBpcGVBcmd1bWVudCB9IGZyb20gJy4uL3BpcGVzJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgT1RyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICcuL3RyYW5zbGF0ZS9vLXRyYW5zbGF0ZS5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgTnVtYmVyU2VydmljZSB7XG5cbiAgcHVibGljIHN0YXRpYyBERUZBVUxUX0RFQ0lNQUxfRElHSVRTID0gMjtcblxuICBwcm90ZWN0ZWQgbWluRGVjaW1hbERpZ2l0czogbnVtYmVyO1xuICBwcm90ZWN0ZWQgbWF4RGVjaW1hbERpZ2l0czogbnVtYmVyO1xuICBwcm90ZWN0ZWQgbG9jYWxlOiBzdHJpbmc7XG5cbiAgcHJvdGVjdGVkIHRyYW5zbGF0ZVNlcnZpY2U6IE9UcmFuc2xhdGVTZXJ2aWNlO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcblxuICAgIHRoaXMudHJhbnNsYXRlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KE9UcmFuc2xhdGVTZXJ2aWNlKTtcbiAgICAvLyBUT0RPOiBpbml0aWFsaXplIGZyb20gY29uZmlnXG4gICAgdGhpcy5taW5EZWNpbWFsRGlnaXRzID0gTnVtYmVyU2VydmljZS5ERUZBVUxUX0RFQ0lNQUxfRElHSVRTO1xuICAgIHRoaXMubWF4RGVjaW1hbERpZ2l0cyA9IE51bWJlclNlcnZpY2UuREVGQVVMVF9ERUNJTUFMX0RJR0lUUztcblxuICAgIHRoaXMubG9jYWxlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmdldEN1cnJlbnRMYW5nKClcbiAgICB0aGlzLnRyYW5zbGF0ZVNlcnZpY2Uub25MYW5ndWFnZUNoYW5nZWQuc3Vic2NyaWJlKCgpID0+XG4gICAgICB0aGlzLmxvY2FsZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5nZXRDdXJyZW50TGFuZygpXG4gICAgKTtcbiAgfVxuXG4gIGdldEludGVnZXJWYWx1ZSh2YWx1ZTogYW55LCBhcmdzOiBhbnkpIHtcbiAgICBjb25zdCBncm91cGluZyA9IGFyZ3MgPyBhcmdzLmdyb3VwaW5nIDogdW5kZWZpbmVkO1xuICAgIGlmICghVXRpbC5pc0RlZmluZWQodmFsdWUpKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IHRob3VzYW5kU2VwYXJhdG9yID0gYXJncyA/IGFyZ3MudGhvdXNhbmRTZXBhcmF0b3IgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgbG9jYWxlID0gYXJncyA/IGFyZ3MubG9jYWxlIDogdW5kZWZpbmVkO1xuICAgIC8vIEVuc3VyZSB2YWx1ZSBpcyBhbiBpbnRlZ2VyXG4gICAgY29uc3QgaW50VmFsdWU6IGFueSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7XG4gICAgaWYgKGlzTmFOKGludFZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZvaWQgMDtcbiAgICB9XG4gICAgLy8gRm9ybWF0IHZhbHVlXG4gICAgbGV0IGZvcm1hdHRlZEludFZhbHVlO1xuICAgIGlmIChVdGlsLmlzRGVmaW5lZChsb2NhbGUpIHx8ICFVdGlsLmlzRGVmaW5lZCh0aG91c2FuZFNlcGFyYXRvcikpIHtcbiAgICAgIGZvcm1hdHRlZEludFZhbHVlID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KFV0aWwuaXNEZWZpbmVkKGxvY2FsZSkgPyBsb2NhbGUgOiB0aGlzLmxvY2FsZSkuZm9ybWF0KGludFZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZm9ybWF0dGVkSW50VmFsdWUgPSBTdHJpbmcoaW50VmFsdWUpLnRvU3RyaW5nKCkucmVwbGFjZSgvXFxCKD89KFxcZHszfSkrKD8hXFxkKSkvZywgdGhvdXNhbmRTZXBhcmF0b3IpO1xuICAgIH1cbiAgICByZXR1cm4gZm9ybWF0dGVkSW50VmFsdWU7XG4gIH1cblxuICBnZXRSZWFsVmFsdWUodmFsdWU6IGFueSwgYXJnczogSVJlYWxQaXBlQXJndW1lbnQpIHtcbiAgICBpZiAoIVV0aWwuaXNEZWZpbmVkKHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIGNvbnN0IGxvY2FsZSA9IGFyZ3MgPyBhcmdzLmxvY2FsZSA6IHVuZGVmaW5lZDtcbiAgICBjb25zdCB0aG91c2FuZFNlcGFyYXRvciA9IGFyZ3MgPyBhcmdzLnRob3VzYW5kU2VwYXJhdG9yIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IGRlY2ltYWxTZXBhcmF0b3IgPSBhcmdzID8gYXJncy5kZWNpbWFsU2VwYXJhdG9yIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IGdyb3VwaW5nID0gYXJncyA/IGFyZ3MuZ3JvdXBpbmcgOiBmYWxzZTtcblxuICAgIGNvbnN0IG1pbkRlY2ltYWxEaWdpdHMgPSBhcmdzID8gYXJncy5taW5EZWNpbWFsRGlnaXRzIDogdGhpcy5taW5EZWNpbWFsRGlnaXRzO1xuICAgIGNvbnN0IG1heERlY2ltYWxEaWdpdHMgPSBhcmdzID8gYXJncy5tYXhEZWNpbWFsRGlnaXRzIDogdGhpcy5tYXhEZWNpbWFsRGlnaXRzO1xuXG4gICAgbGV0IGZvcm1hdHRlZFJlYWxWYWx1ZSA9IHZhbHVlO1xuICAgIGNvbnN0IHVzZUludGxOdW1iZXJGb3JtYXQ6IGJvb2xlYW4gPSBVdGlsLmlzRGVmaW5lZChsb2NhbGUpIHx8ICghVXRpbC5pc0RlZmluZWQodGhvdXNhbmRTZXBhcmF0b3IpIHx8ICFVdGlsLmlzRGVmaW5lZChkZWNpbWFsU2VwYXJhdG9yKSk7XG4gICAgaWYgKHVzZUludGxOdW1iZXJGb3JtYXQpIHtcbiAgICAgIGZvcm1hdHRlZFJlYWxWYWx1ZSA9IGFyZ3MudHJ1bmNhdGUgPyB0aGlzLnRydW5jYXRlKHZhbHVlLCBtYXhEZWNpbWFsRGlnaXRzKSA6IG51bGw7XG4gICAgICBpZiAoIVV0aWwuaXNEZWZpbmVkKGZvcm1hdHRlZFJlYWxWYWx1ZSkpIHtcbiAgICAgICAgbGV0IGZvcm1hdHRlckFyZ3M6IGFueSA9IHtcbiAgICAgICAgICBtaW5pbXVtRnJhY3Rpb25EaWdpdHM6IG1pbkRlY2ltYWxEaWdpdHMsXG4gICAgICAgICAgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiBtYXhEZWNpbWFsRGlnaXRzLFxuICAgICAgICAgIHVzZUdyb3VwaW5nOiBncm91cGluZ1xuICAgICAgICB9O1xuICAgICAgICBmb3JtYXR0ZWRSZWFsVmFsdWUgPSBuZXcgSW50bC5OdW1iZXJGb3JtYXQoVXRpbC5pc0RlZmluZWQobG9jYWxlKSA/IGxvY2FsZSA6IHRoaXMubG9jYWxlLCBmb3JtYXR0ZXJBcmdzKS5mb3JtYXQodmFsdWUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBmb3JtYXR0ZWRSZWFsVmFsdWUgPSB0aGlzLnBhcnNlUmVhbFZhbHVlKHZhbHVlLCBtYXhEZWNpbWFsRGlnaXRzLCB0aG91c2FuZFNlcGFyYXRvciwgZGVjaW1hbFNlcGFyYXRvciwgZ3JvdXBpbmcpO1xuICAgIH1cbiAgICByZXR1cm4gZm9ybWF0dGVkUmVhbFZhbHVlO1xuICB9XG5cbiAgZ2V0UGVyY2VudFZhbHVlKHZhbHVlOiBhbnksIGFyZ3M6IGFueSkge1xuICAgIGNvbnN0IHZhbHVlQmFzZSA9IGFyZ3MgPyBhcmdzLnZhbHVlQmFzZSA6IHVuZGVmaW5lZDtcbiAgICBsZXQgcGFyc2VkVmFsdWUgPSB2YWx1ZTtcbiAgICBzd2l0Y2ggKHZhbHVlQmFzZSkge1xuICAgICAgY2FzZSAxMDA6XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAxOlxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcGFyc2VkVmFsdWUgPSBwYXJzZWRWYWx1ZSAqIDEwMDtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNvbnN0IGZvcm1hdHRlZFBlcmNlbnRWYWx1ZSA9IHRoaXMuZ2V0UmVhbFZhbHVlKHBhcnNlZFZhbHVlLCBhcmdzKSArICcgJSc7XG4gICAgcmV0dXJuIGZvcm1hdHRlZFBlcmNlbnRWYWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgdHJ1bmNhdGUodmFsdWU6IG51bWJlciwgbWF4RGVjaW1hbHM6IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3Qgc3RyaW5nVmFsdWUgPSBTdHJpbmcodmFsdWUpO1xuICAgIGNvbnN0IHNwbGl0dGVkVmFsdWUgPSBzdHJpbmdWYWx1ZS5zcGxpdCgnLicpO1xuICAgIGNvbnN0IGRlY2ltYWxzTGVuZ3RoID0gVXRpbC5pc0RlZmluZWQoc3BsaXR0ZWRWYWx1ZVsxXSkgPyBzcGxpdHRlZFZhbHVlWzFdLmxlbmd0aCA6IG51bGw7XG4gICAgaWYgKGRlY2ltYWxzTGVuZ3RoID4gbWF4RGVjaW1hbHMpIHtcbiAgICAgIHJldHVybiBzdHJpbmdWYWx1ZS5zbGljZSgwLCBzcGxpdHRlZFZhbHVlWzBdLmxlbmd0aCArIDEgKyBtYXhEZWNpbWFscyk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZVJlYWxWYWx1ZSh2YWx1ZTogYW55LCBtYXhEZWNpbWFsRGlnaXRzOiBudW1iZXIsIHRob3VzYW5kU2VwYXJhdG9yOiBzdHJpbmcsIGRlY2ltYWxTZXBhcmF0b3I6IHN0cmluZywgZ3JvdXBpbmc6IGJvb2xlYW4pOiBzdHJpbmcge1xuICAgIGxldCByZXN1bHQgPSB2YWx1ZTtcbiAgICBjb25zdCByZWFsVmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICBpZiAoIWlzTmFOKHJlYWxWYWx1ZSkpIHtcbiAgICAgIHJlc3VsdCA9IFN0cmluZyhyZWFsVmFsdWUpO1xuICAgICAgbGV0IHRtcFN0ciA9IHJlYWxWYWx1ZS50b0ZpeGVkKG1heERlY2ltYWxEaWdpdHMpO1xuICAgICAgdG1wU3RyID0gdG1wU3RyLnJlcGxhY2UoJy4nLCBkZWNpbWFsU2VwYXJhdG9yKTtcbiAgICAgIGlmIChncm91cGluZykge1xuICAgICAgICBjb25zdCBwYXJ0cyA9IHRtcFN0ci5zcGxpdChkZWNpbWFsU2VwYXJhdG9yKTtcbiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBwYXJ0c1swXSA9IHBhcnRzWzBdLnJlcGxhY2UoL1xcQig/PShcXGR7M30pKyg/IVxcZCkpL2csIHRob3VzYW5kU2VwYXJhdG9yKTtcbiAgICAgICAgICByZXN1bHQgPSBwYXJ0cy5qb2luKGRlY2ltYWxTZXBhcmF0b3IpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQgPSB0bXBTdHI7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn1cbiJdfQ==