import { TranslateHttpLoader } from '@ngx-translate/http-loader';
import { combineLatest, Observable, of } from 'rxjs';
import { catchError, map, share } from 'rxjs/operators';
import { AppConfig } from '../../config/app-config';
import { Codes } from '../../util/codes';
import { OTranslateService } from './o-translate.service';
export class OTranslateHttpLoader extends TranslateHttpLoader {
    constructor(httpClient, prefix = OTranslateService.ASSETS_PATH, suffix = OTranslateService.ASSETS_EXTENSION, injector) {
        super(httpClient, prefix, suffix);
        this.injector = injector;
        this.appConfig = this.injector.get(AppConfig);
        this.httpClient = httpClient;
    }
    getAssetsPath() {
        return this.prefix;
    }
    getAssetsExtension() {
        return this.suffix;
    }
    getLocalTranslation(lang) {
        let innerObserver;
        const dataObservable = new Observable(observer => innerObserver = observer).pipe(share());
        super.getTranslation(lang)
            .subscribe((res) => {
            innerObserver.next(res);
            innerObserver.complete();
        }, error => {
            innerObserver.next(undefined);
        }, () => innerObserver.complete());
        return dataObservable;
    }
    getTranslation(lang) {
        const translationOrigins = [];
        translationOrigins.push(this.getLocalTranslation(lang));
        if (this.appConfig.useRemoteBundle()) {
            translationOrigins.push(this.getRemoteBundle(lang));
        }
        let innerObserver;
        const dataObservable = new Observable(observer => innerObserver = observer).pipe(share());
        combineLatest(translationOrigins).subscribe((res) => {
            const staticBundle = res[0] || {};
            const remoteBundle = res[1] || {};
            const allBundles = Object.assign(staticBundle, remoteBundle);
            innerObserver.next(allBundles);
        });
        return dataObservable;
    }
    getRemoteBundle(lang) {
        const bundleEndpoint = this.appConfig.getBundleEndpoint();
        if (!bundleEndpoint) {
            return of([]);
        }
        const url = bundleEndpoint + '?lang=' + lang;
        return this.httpClient.get(url).pipe(map((resp) => {
            if (resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE) {
                return this.parseBundleResponse(resp.data);
            }
            return resp;
        }), catchError(err => {
            console.log('Remote Bundle service is not available', err);
            return of([]);
        }));
    }
    parseBundleResponse(data) {
        const result = {};
        if (data) {
            data.forEach((item) => {
                result[item[OTranslateHttpLoader.BUNDLE_KEY]] = item[OTranslateHttpLoader.BUNDLE_VALUE];
            });
        }
        return result;
    }
}
OTranslateHttpLoader.BUNDLE_KEY = 'key';
OTranslateHttpLoader.BUNDLE_VALUE = 'value';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10cmFuc2xhdGUtaHR0cC1sb2FkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3RyYW5zbGF0ZS9vLXRyYW5zbGF0ZS1odHRwLWxvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFeEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN6QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUUxRCxNQUFNLE9BQU8sb0JBQXFCLFNBQVEsbUJBQW1CO0lBUTNELFlBQ0UsVUFBc0IsRUFDdEIsU0FBaUIsaUJBQWlCLENBQUMsV0FBVyxFQUM5QyxTQUFpQixpQkFBaUIsQ0FBQyxnQkFBZ0IsRUFDekMsUUFBa0I7UUFFNUIsS0FBSyxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFGeEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUc1QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzlDLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBQy9CLENBQUM7SUFFRCxhQUFhO1FBQ1gsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFF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LE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDbEIsSUFBSSxJQUFJLEVBQUU7WUFDUixJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDMUYsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7O0FBekZNLCtCQUFVLEdBQUcsS0FBSyxDQUFDO0FBQ25CLGlDQUFZLEdBQUcsT0FBTyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVIdHRwTG9hZGVyIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvaHR0cC1sb2FkZXInO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCwgc2hhcmUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEFwcENvbmZpZyB9IGZyb20gJy4uLy4uL2NvbmZpZy9hcHAtY29uZmlnJztcbmltcG9ydCB7IENvZGVzIH0gZnJvbSAnLi4vLi4vdXRpbC9jb2Rlcyc7XG5pbXBvcnQgeyBPVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJy4vby10cmFuc2xhdGUuc2VydmljZSc7XG5cbmV4cG9ydCBjbGFzcyBPVHJhbnNsYXRlSHR0cExvYWRlciBleHRlbmRzIFRyYW5zbGF0ZUh0dHBMb2FkZXIge1xuXG4gIHN0YXRpYyBCVU5ETEVfS0VZID0gJ2tleSc7XG4gIHN0YXRpYyBCVU5ETEVfVkFMVUUgPSAndmFsdWUnO1xuXG4gIHByb3RlY3RlZCBhcHBDb25maWc6IEFwcENvbmZpZztcbiAgcHJvdGVjdGVkIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgaHR0cENsaWVudDogSHR0cENsaWVudCxcbiAgICBwcmVmaXg6IHN0cmluZyA9IE9UcmFuc2xhdGVTZXJ2aWNlLkFTU0VUU19QQVRILFxuICAgIHN1ZmZpeDogc3RyaW5nID0gT1RyYW5zbGF0ZVNlcnZpY2UuQVNTRVRTX0VYVEVOU0lPTixcbiAgICBwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yXG4gICkge1xuICAgIHN1cGVyKGh0dHBDbGllbnQsIHByZWZpeCwgc3VmZml4KTtcbiAgICB0aGlzLmFwcENvbmZpZyA9IHRoaXMuaW5qZWN0b3IuZ2V0KEFwcENvbmZpZyk7XG4gICAgdGhpcy5odHRwQ2xpZW50ID0gaHR0cENsaWVudDtcbiAgfVxuXG4gIGdldEFzc2V0c1BhdGgoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wcmVmaXg7XG4gIH1cblxuICBnZXRBc3NldHNFeHRlbnNpb24oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zdWZmaXg7XG4gIH1cblxuICBnZXRMb2NhbFRyYW5zbGF0aW9uKGxhbmc6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgbGV0IGlubmVyT2JzZXJ2ZXI6IGFueTtcbiAgICBjb25zdCBkYXRhT2JzZXJ2YWJsZSA9IG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IGlubmVyT2JzZXJ2ZXIgPSBvYnNlcnZlcikucGlwZShzaGFyZSgpKTtcbiAgICBzdXBlci5nZXRUcmFuc2xhdGlvbihsYW5nKVxuICAgICAgLnN1YnNjcmliZSgocmVzKSA9PiB7XG4gICAgICAgIGlubmVyT2JzZXJ2ZXIubmV4dChyZXMpO1xuICAgICAgICBpbm5lck9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgIGlubmVyT2JzZXJ2ZXIubmV4dCh1bmRlZmluZWQpO1xuICAgICAgfSxcbiAgICAgICAgKCkgPT4gaW5uZXJPYnNlcnZlci5jb21wbGV0ZSgpKTtcbiAgICByZXR1cm4gZGF0YU9ic2VydmFibGU7XG4gIH1cblxuICBnZXRUcmFuc2xhdGlvbihsYW5nOiBzdHJpbmcpOiBhbnkge1xuICAgIGNvbnN0IHRyYW5zbGF0aW9uT3JpZ2luczogYW55W10gPSBbXTtcblxuICAgIHRyYW5zbGF0aW9uT3JpZ2lucy5wdXNoKHRoaXMuZ2V0TG9jYWxUcmFuc2xhdGlvbihsYW5nKSk7XG5cbiAgICBpZiAodGhpcy5hcHBDb25maWcudXNlUmVtb3RlQnVuZGxlKCkpIHtcbiAgICAgIHRyYW5zbGF0aW9uT3JpZ2lucy5wdXNoKHRoaXMuZ2V0UmVtb3RlQnVuZGxlKGxhbmcpKTtcbiAgICB9XG5cbiAgICBsZXQgaW5uZXJPYnNlcnZlcjogYW55O1xuICAgIGNvbnN0IGRhdGFPYnNlcnZhYmxlID0gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT4gaW5uZXJPYnNlcnZlciA9IG9ic2VydmVyKS5waXBlKHNoYXJlKCkpO1xuXG4gICAgY29tYmluZUxhdGVzdCh0cmFuc2xhdGlvbk9yaWdpbnMpLnN1YnNjcmliZSgocmVzOiBhbnlbXSkgPT4ge1xuICAgICAgY29uc3Qgc3RhdGljQnVuZGxlID0gcmVzWzBdIHx8IHt9O1xuICAgICAgY29uc3QgcmVtb3RlQnVuZGxlID0gcmVzWzFdIHx8IHt9O1xuICAgICAgY29uc3QgYWxsQnVuZGxlcyA9IE9iamVjdC5hc3NpZ24oc3RhdGljQnVuZGxlLCByZW1vdGVCdW5kbGUpO1xuICAgICAgaW5uZXJPYnNlcnZlci5uZXh0KGFsbEJ1bmRsZXMpO1xuICAgIH0pO1xuICAgIHJldHVybiBkYXRhT2JzZXJ2YWJsZTtcbiAgfVxuXG4gIGdldFJlbW90ZUJ1bmRsZShsYW5nOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGJ1bmRsZUVuZHBvaW50ID0gdGhpcy5hcHBDb25maWcuZ2V0QnVuZGxlRW5kcG9pbnQoKTtcbiAgICBpZiAoIWJ1bmRsZUVuZHBvaW50KSB7XG4gICAgICByZXR1cm4gb2YoW10pO1xuICAgIH1cbiAgICBjb25zdCB1cmwgPSBidW5kbGVFbmRwb2ludCArICc/bGFuZz0nICsgbGFuZztcblxuICAgIHJldHVybiB0aGlzLmh0dHBDbGllbnQuZ2V0KHVybCkucGlwZShcbiAgICAgIG1hcCgocmVzcDogYW55KSA9PiB7XG4gICAgICAgIGlmIChyZXNwLmNvZGUgPT09IENvZGVzLk9OVElNSVpFX1NVQ0NFU1NGVUxfQ09ERSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLnBhcnNlQnVuZGxlUmVzcG9uc2UocmVzcC5kYXRhKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzcDtcbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcihlcnIgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygnUmVtb3RlIEJ1bmRsZSBzZXJ2aWNlIGlzIG5vdCBhdmFpbGFibGUnLCBlcnIpO1xuICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlQnVuZGxlUmVzcG9uc2UoZGF0YTogYW55W10pOiBhbnkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBkYXRhLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgcmVzdWx0W2l0ZW1bT1RyYW5zbGF0ZUh0dHBMb2FkZXIuQlVORExFX0tFWV1dID0gaXRlbVtPVHJhbnNsYXRlSHR0cExvYWRlci5CVU5ETEVfVkFMVUVdO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxufVxuIl19