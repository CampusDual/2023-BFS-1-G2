import { EventEmitter, Injectable, Injector } from '@angular/core';
import { NavigationStart, Router } from '@angular/router';
import { AppConfig } from '../config/app-config';
import { ObservableWrapper } from '../util/async';
import { Util } from '../util/util';
import { AuthService } from './auth.service';
import * as i0 from "@angular/core";
export class LocalStorageService {
    constructor(injector) {
        this.injector = injector;
        this.onRouteChange = new EventEmitter();
        this.onSetLocalStorage = new EventEmitter();
        this._config = this.injector.get(AppConfig).getConfiguration();
        this._router = this.injector.get(Router);
        this.authService = this.injector.get(AuthService);
        const self = this;
        this._router.events.subscribe(event => {
            if (event instanceof NavigationStart) {
                ObservableWrapper.callEmit(self.onRouteChange, {});
            }
        });
    }
    getComponentStorage(comp, routeKey) {
        const componentKey = comp.getComponentKey();
        let completeKey = componentKey;
        if (routeKey) {
            completeKey += '_' + routeKey;
        }
        return this.getAppComponentData(completeKey) || {};
    }
    updateComponentStorage(comp, routeKey) {
        const dataToStore = comp.getDataToStore();
        const componentKey = comp.getComponentKey();
        if (!Util.isDefined(componentKey)) {
            return;
        }
        let completeKey = componentKey;
        if (routeKey) {
            completeKey += '_' + routeKey;
        }
        const storedObject = {};
        for (const prop in dataToStore) {
            if (dataToStore.hasOwnProperty(prop)) {
                storedObject[prop] = dataToStore[prop];
            }
        }
        this.updateAppComponentStorage(completeKey, storedObject);
    }
    getAppComponentData(key) {
        let componentData;
        const storedComponents = this.getSessionUserComponentsData() || {};
        if (storedComponents[key]) {
            const decoded = atob(storedComponents[key]);
            try {
                componentData = JSON.parse(decoded);
            }
            catch (e) {
                componentData = undefined;
            }
        }
        return componentData;
    }
    updateAppComponentStorage(componentKey, componentData) {
        let componentDataB64;
        try {
            componentDataB64 = btoa(JSON.stringify(componentData));
        }
        catch (e) {
            componentDataB64 = undefined;
        }
        this.storeComponentInSessionUser(componentKey, componentDataB64);
    }
    getSessionUserComponentsData() {
        let storedComponentsByUser = {};
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        const users = appData[LocalStorageService.USERS_STORAGE_KEY] || {};
        storedComponentsByUser = (users[session.user] || {})[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};
        return storedComponentsByUser;
    }
    storeSessionUserComponentsData(componentsData) {
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        if (!Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY])) {
            appData[LocalStorageService.USERS_STORAGE_KEY] = {};
        }
        const userData = appData[LocalStorageService.USERS_STORAGE_KEY][session.user] || {};
        userData[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsData;
        appData[LocalStorageService.USERS_STORAGE_KEY][session.user] = userData;
        this.setLocalStorage(appData);
    }
    storeComponentInSessionUser(componentKey, componentDataB64) {
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY] || {};
        if (!Util.isDefined(session) || !Util.isDefined(session.user)) {
            return;
        }
        const users = appData[LocalStorageService.USERS_STORAGE_KEY] || {};
        const idUser = session.user || this.authService.getSessionInfo().user;
        const user = users[idUser] || {};
        let componentsData = {};
        if (users[idUser]) {
            componentsData = users[idUser][LocalStorageService.COMPONENTS_STORAGE_KEY] || {};
        }
        componentsData[componentKey] = componentDataB64 || {};
        user[LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsData;
        users[idUser] = user;
        appData[LocalStorageService.USERS_STORAGE_KEY] = users;
        this.setLocalStorage(appData);
    }
    getStoredData() {
        let appData = {};
        const appStoredData = localStorage.getItem(this._config.uuid);
        if (appStoredData) {
            try {
                appData = JSON.parse(appStoredData);
            }
            catch (e) {
                appData = {};
            }
        }
        return appData;
    }
    setBackwardCompatibility() {
        const appData = this.getStoredData();
        const session = appData[LocalStorageService.SESSION_STORAGE_KEY];
        if (!Util.isDefined(session) || !Util.isDefined(session.user)) {
            return;
        }
        const componentsInfo = appData[LocalStorageService.COMPONENTS_STORAGE_KEY] || {};
        let usersObject = {};
        const existsUsersTag = Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY]);
        let createUserInfo = existsUsersTag;
        if (existsUsersTag) {
            usersObject = appData[LocalStorageService.USERS_STORAGE_KEY];
            createUserInfo = !Util.isDefined(appData[LocalStorageService.USERS_STORAGE_KEY][session.user]);
        }
        if (createUserInfo) {
            usersObject[session.user] = {};
            usersObject[session.user][LocalStorageService.COMPONENTS_STORAGE_KEY] = componentsInfo;
            appData[LocalStorageService.USERS_STORAGE_KEY] = usersObject;
            try {
                localStorage.setItem(this._config.uuid, JSON.stringify(appData));
            }
            catch (e) {
                console.error("Cannot set new item in localStorage. Error: " + e);
            }
        }
    }
    setLocalStorage(appData) {
        this.onSetLocalStorage.emit();
        try {
            localStorage.setItem(this._config.uuid, JSON.stringify(appData));
        }
        catch (e) {
            console.error("Cannot set new item in localStorage. Error: " + e);
        }
    }
}
LocalStorageService.COMPONENTS_STORAGE_KEY = 'components';
LocalStorageService.USERS_STORAGE_KEY = 'users';
LocalStorageService.SESSION_STORAGE_KEY = 'session';
LocalStorageService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
LocalStorageService.ctorParameters = () => [
    { type: Injector }
];
LocalStorageService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function LocalStorageService_Factory() { return new LocalStorageService(i0.ɵɵinject(i0.INJECTOR)); }, token: LocalStorageService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWwtc3RvcmFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9sb2NhbC1zdG9yYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFRLE1BQU0sZUFBZSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFMUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBSWpELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFLN0MsTUFBTSxPQUFPLG1CQUFtQjtJQVk5QixZQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBUGpDLGtCQUFhLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdEQsc0JBQWlCLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFPL0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBWSxTQUE0QixDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUM3RixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFTLE1BQXNCLENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFjLFdBQWdDLENBQUMsQ0FBQztRQUVwRixNQUFNLElBQUksR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3BDLElBQUksS0FBSyxZQUFZLGVBQWUsRUFBRTtnQkFDcEMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDcEQ7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxJQUE0QixFQUFFLFFBQWlCO1FBQ2pFLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUM1QyxJQUFJLFdBQVcsR0FBRyxZQUFZLENBQUM7UUFDL0IsSUFBSSxRQUFRLEVBQUU7WUFDWixXQUFXLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQztTQUMvQjtRQUNELE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNyRCxDQUFDO0lBRUQsc0JBQXNCLENBQUMsSUFBNEIsRUFBRSxRQUFpQjtRQUNwRSxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDMUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzVDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQ2pDLE9BQU87U0FDUjtRQUNELElBQUksV0FBVyxHQUFHLFlBQVksQ0FBQztRQUMvQixJQUFJLFFBQVEsRUFBRTtZQUNaLFdBQVcsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDO1NBQy9CO1FBQ0QsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLEtBQUssTUFBTSxJQUFJLElBQUksV0FBVyxFQUFFO1lBQzlCLElBQUksV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDcEMsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN4QztTQUNGO1FBQ0QsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRU8sbUJBQW1CLENBQUMsR0FBVztRQUNyQyxJQUFJLGFBQWEsQ0FBQztRQUNsQixNQUFNLGdCQUFnQixHQUFXLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUMzRSxJQUFJLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3pCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzVDLElBQUk7Z0JBQ0YsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDckM7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixhQUFhLEdBQUcsU0FBUyxDQUFDO2FBQzNCO1NBQ0Y7UUFDRCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRUQseUJBQXlCLENBQUMsWUFBb0IsRUFBRSxhQUFxQjtRQUNuRSxJQUFJLGdCQUFnQixDQUFDO1FBQ3JCLElBQUk7WUFDRixnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1NBQ3hEO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixnQkFBZ0IsR0FBRyxTQUFTLENBQUM7U0FDOUI7UUFDRCxJQUFJLENBQUMsMkJBQTJCLENBQUMsWUFBWSxFQUFFLGdCQUFnQixDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUVNLDRCQUE0QjtRQUNqQyxJQUFJLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztRQUNoQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckMsTUFBTSxPQUFPLEdBQWdCLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwRixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkUsc0JBQXNCLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3ZHLE9BQU8sc0JBQXNCLENBQUM7SUFDaEMsQ0FBQztJQUVNLDhCQUE4QixDQUFDLGNBQXNCO1FBQzFELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQyxNQUFNLE9BQU8sR0FBZ0IsT0FBTyxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3BGLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQUU7WUFDbkUsT0FBTyxDQUFDLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRSxDQUFDO1NBQ3JEO1FBQ0QsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNwRixRQUFRLENBQUMsbUJBQW1CLENBQUMsc0JBQXNCLENBQUMsR0FBRyxjQUFjLENBQUM7UUFDdEUsT0FBTyxDQUFDLG1CQUFtQixDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUN4RSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFTywyQkFBMkIsQ0FBQyxZQUFZLEVBQUUsZ0JBQWdCO1FBQ2hFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkUsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUM3RCxPQUFPO1NBQ1I7UUFDRCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkUsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsRUFBRSxDQUFDLElBQUksQ0FBQztRQUN0RSxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWpDLElBQUksY0FBYyxHQUFHLEVBQUUsQ0FBQztRQUN4QixJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNqQixjQUFjLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLG1CQUFtQixDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2xGO1FBQ0QsY0FBYyxDQUFDLFlBQVksQ0FBQyxHQUFHLGdCQUFnQixJQUFJLEVBQUUsQ0FBQztRQUV0RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsc0JBQXNCLENBQUMsR0FBRyxjQUFjLENBQUM7UUFDbEUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNyQixPQUFPLENBQUMsbUJBQW1CLENBQUMsaUJBQWlCLENBQUMsR0FBRyxLQUFLLENBQUM7UUFFdkQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU0sYUFBYTtRQUNsQixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7UUFDakIsTUFBTSxhQUFhLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlELElBQUksYUFBYSxFQUFFO1lBQ2pCLElBQUk7Z0JBQ0YsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7YUFDckM7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDVixPQUFPLEdBQUcsRUFBRSxDQUFDO2FBQ2Q7U0FDRjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFTSx3QkFBd0I7UUFDN0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDN0QsT0FBTztTQUNSO1FBQ0QsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pGLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUNyQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7UUFDdEYsSUFBSSxjQUFjLEdBQUcsY0FBYyxDQUFDO1FBQ3BDLElBQUksY0FBYyxFQUFFO1lBQ2xCLFdBQVcsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUM3RCxjQUFjLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1NBQ2hHO1FBQ0QsSUFBSSxjQUFjLEVBQUU7WUFDbEIsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDL0IsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLGNBQWMsQ0FBQztZQUV2RixPQUFPLENBQUMsbUJBQW1CLENBQUMsaUJBQWlCLENBQUMsR0FBRyxXQUFXLENBQUM7WUFDN0QsSUFBSTtnQkFDRixZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzthQUNsRTtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsOENBQThDLEdBQUcsQ0FBQyxDQUFDLENBQUM7YUFDbkU7U0FDRjtJQUNILENBQUM7SUFFUyxlQUFlLENBQUMsT0FBWTtRQUNwQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDOUIsSUFBSTtZQUNGLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQ2xFO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLENBQUMsS0FBSyxDQUFDLDhDQUE4QyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ25FO0lBQ0gsQ0FBQzs7QUF2S00sMENBQXNCLEdBQVcsWUFBWSxDQUFDO0FBQzlDLHFDQUFpQixHQUFXLE9BQU8sQ0FBQztBQUNwQyx1Q0FBbUIsR0FBVyxTQUFTLENBQUM7O1lBTmhELFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBYmtDLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdGFibGUsIEluamVjdG9yLCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uU3RhcnQsIFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IEFwcENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9hcHAtY29uZmlnJztcbmltcG9ydCB7IElMb2NhbFN0b3JhZ2VDb21wb25lbnQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2xvY2FsLXN0b3JhZ2UtY29tcG9uZW50LmludGVyZmFjZSc7XG5pbXBvcnQgeyBDb25maWcgfSBmcm9tICcuLi90eXBlcy9jb25maWcudHlwZSc7XG5pbXBvcnQgeyBTZXNzaW9uSW5mbyB9IGZyb20gJy4uL3R5cGVzL3Nlc3Npb24taW5mby50eXBlJztcbmltcG9ydCB7IE9ic2VydmFibGVXcmFwcGVyIH0gZnJvbSAnLi4vdXRpbC9hc3luYyc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vdXRpbC91dGlsJztcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi9hdXRoLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBMb2NhbFN0b3JhZ2VTZXJ2aWNlIHtcbiAgc3RhdGljIENPTVBPTkVOVFNfU1RPUkFHRV9LRVk6IHN0cmluZyA9ICdjb21wb25lbnRzJztcbiAgc3RhdGljIFVTRVJTX1NUT1JBR0VfS0VZOiBzdHJpbmcgPSAndXNlcnMnO1xuICBzdGF0aWMgU0VTU0lPTl9TVE9SQUdFX0tFWTogc3RyaW5nID0gJ3Nlc3Npb24nO1xuXG4gIHB1YmxpYyBvblJvdXRlQ2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgcHVibGljIG9uU2V0TG9jYWxTdG9yYWdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICBwcml2YXRlIF9jb25maWc6IENvbmZpZztcbiAgcHJpdmF0ZSBfcm91dGVyOiBSb3V0ZXI7XG4gIHByaXZhdGUgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICB0aGlzLl9jb25maWcgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb25maWc+KEFwcENvbmZpZyBhcyBUeXBlPEFwcENvbmZpZz4pLmdldENvbmZpZ3VyYXRpb24oKTtcbiAgICB0aGlzLl9yb3V0ZXIgPSB0aGlzLmluamVjdG9yLmdldDxSb3V0ZXI+KFJvdXRlciBhcyBUeXBlPFJvdXRlcj4pO1xuICAgIHRoaXMuYXV0aFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldDxBdXRoU2VydmljZT4oQXV0aFNlcnZpY2UgYXMgVHlwZTxBdXRoU2VydmljZT4pO1xuXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgdGhpcy5fcm91dGVyLmV2ZW50cy5zdWJzY3JpYmUoZXZlbnQgPT4ge1xuICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvblN0YXJ0KSB7XG4gICAgICAgIE9ic2VydmFibGVXcmFwcGVyLmNhbGxFbWl0KHNlbGYub25Sb3V0ZUNoYW5nZSwge30pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0Q29tcG9uZW50U3RvcmFnZShjb21wOiBJTG9jYWxTdG9yYWdlQ29tcG9uZW50LCByb3V0ZUtleT86IHN0cmluZyk6IGFueSB7XG4gICAgY29uc3QgY29tcG9uZW50S2V5ID0gY29tcC5nZXRDb21wb25lbnRLZXkoKTtcbiAgICBsZXQgY29tcGxldGVLZXkgPSBjb21wb25lbnRLZXk7XG4gICAgaWYgKHJvdXRlS2V5KSB7XG4gICAgICBjb21wbGV0ZUtleSArPSAnXycgKyByb3V0ZUtleTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0QXBwQ29tcG9uZW50RGF0YShjb21wbGV0ZUtleSkgfHwge307XG4gIH1cblxuICB1cGRhdGVDb21wb25lbnRTdG9yYWdlKGNvbXA6IElMb2NhbFN0b3JhZ2VDb21wb25lbnQsIHJvdXRlS2V5Pzogc3RyaW5nKSB7XG4gICAgY29uc3QgZGF0YVRvU3RvcmUgPSBjb21wLmdldERhdGFUb1N0b3JlKCk7XG4gICAgY29uc3QgY29tcG9uZW50S2V5ID0gY29tcC5nZXRDb21wb25lbnRLZXkoKTtcbiAgICBpZiAoIVV0aWwuaXNEZWZpbmVkKGNvbXBvbmVudEtleSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IGNvbXBsZXRlS2V5ID0gY29tcG9uZW50S2V5O1xuICAgIGlmIChyb3V0ZUtleSkge1xuICAgICAgY29tcGxldGVLZXkgKz0gJ18nICsgcm91dGVLZXk7XG4gICAgfVxuICAgIGNvbnN0IHN0b3JlZE9iamVjdCA9IHt9O1xuICAgIGZvciAoY29uc3QgcHJvcCBpbiBkYXRhVG9TdG9yZSkge1xuICAgICAgaWYgKGRhdGFUb1N0b3JlLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgIHN0b3JlZE9iamVjdFtwcm9wXSA9IGRhdGFUb1N0b3JlW3Byb3BdO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUFwcENvbXBvbmVudFN0b3JhZ2UoY29tcGxldGVLZXksIHN0b3JlZE9iamVjdCk7XG4gIH1cblxuICBwcml2YXRlIGdldEFwcENvbXBvbmVudERhdGEoa2V5OiBzdHJpbmcpOiBvYmplY3Qge1xuICAgIGxldCBjb21wb25lbnREYXRhO1xuICAgIGNvbnN0IHN0b3JlZENvbXBvbmVudHM6IG9iamVjdCA9IHRoaXMuZ2V0U2Vzc2lvblVzZXJDb21wb25lbnRzRGF0YSgpIHx8IHt9O1xuICAgIGlmIChzdG9yZWRDb21wb25lbnRzW2tleV0pIHtcbiAgICAgIGNvbnN0IGRlY29kZWQgPSBhdG9iKHN0b3JlZENvbXBvbmVudHNba2V5XSk7XG4gICAgICB0cnkge1xuICAgICAgICBjb21wb25lbnREYXRhID0gSlNPTi5wYXJzZShkZWNvZGVkKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgY29tcG9uZW50RGF0YSA9IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGNvbXBvbmVudERhdGE7XG4gIH1cblxuICB1cGRhdGVBcHBDb21wb25lbnRTdG9yYWdlKGNvbXBvbmVudEtleTogc3RyaW5nLCBjb21wb25lbnREYXRhOiBvYmplY3QpIHtcbiAgICBsZXQgY29tcG9uZW50RGF0YUI2NDtcbiAgICB0cnkge1xuICAgICAgY29tcG9uZW50RGF0YUI2NCA9IGJ0b2EoSlNPTi5zdHJpbmdpZnkoY29tcG9uZW50RGF0YSkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbXBvbmVudERhdGFCNjQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICAgIHRoaXMuc3RvcmVDb21wb25lbnRJblNlc3Npb25Vc2VyKGNvbXBvbmVudEtleSwgY29tcG9uZW50RGF0YUI2NCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2Vzc2lvblVzZXJDb21wb25lbnRzRGF0YSgpOiBvYmplY3Qge1xuICAgIGxldCBzdG9yZWRDb21wb25lbnRzQnlVc2VyID0ge307XG4gICAgY29uc3QgYXBwRGF0YSA9IHRoaXMuZ2V0U3RvcmVkRGF0YSgpO1xuICAgIGNvbnN0IHNlc3Npb246IFNlc3Npb25JbmZvID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlNFU1NJT05fU1RPUkFHRV9LRVldIHx8IHt9O1xuICAgIGNvbnN0IHVzZXJzID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXSB8fCB7fTtcbiAgICBzdG9yZWRDb21wb25lbnRzQnlVc2VyID0gKHVzZXJzW3Nlc3Npb24udXNlcl0gfHwge30pW0xvY2FsU3RvcmFnZVNlcnZpY2UuQ09NUE9ORU5UU19TVE9SQUdFX0tFWV0gfHwge307XG4gICAgcmV0dXJuIHN0b3JlZENvbXBvbmVudHNCeVVzZXI7XG4gIH1cblxuICBwdWJsaWMgc3RvcmVTZXNzaW9uVXNlckNvbXBvbmVudHNEYXRhKGNvbXBvbmVudHNEYXRhOiBvYmplY3QpIHtcbiAgICBjb25zdCBhcHBEYXRhID0gdGhpcy5nZXRTdG9yZWREYXRhKCk7XG4gICAgY29uc3Qgc2Vzc2lvbjogU2Vzc2lvbkluZm8gPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuU0VTU0lPTl9TVE9SQUdFX0tFWV0gfHwge307XG4gICAgaWYgKCFVdGlsLmlzRGVmaW5lZChhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldKSkge1xuICAgICAgYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXSA9IHt9O1xuICAgIH1cbiAgICBjb25zdCB1c2VyRGF0YSA9IGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV1bc2Vzc2lvbi51c2VyXSB8fCB7fTtcbiAgICB1c2VyRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLkNPTVBPTkVOVFNfU1RPUkFHRV9LRVldID0gY29tcG9uZW50c0RhdGE7XG4gICAgYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXVtzZXNzaW9uLnVzZXJdID0gdXNlckRhdGE7XG4gICAgdGhpcy5zZXRMb2NhbFN0b3JhZ2UoYXBwRGF0YSk7XG4gIH1cblxuICBwcml2YXRlIHN0b3JlQ29tcG9uZW50SW5TZXNzaW9uVXNlcihjb21wb25lbnRLZXksIGNvbXBvbmVudERhdGFCNjQpIHtcbiAgICBjb25zdCBhcHBEYXRhID0gdGhpcy5nZXRTdG9yZWREYXRhKCk7XG4gICAgY29uc3Qgc2Vzc2lvbiA9IGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5TRVNTSU9OX1NUT1JBR0VfS0VZXSB8fCB7fTsgLy8gdXVpZCAtPiBzZXNzaW9uXG4gICAgaWYgKCFVdGlsLmlzRGVmaW5lZChzZXNzaW9uKSB8fCAhVXRpbC5pc0RlZmluZWQoc2Vzc2lvbi51c2VyKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB1c2VycyA9IGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV0gfHwge307IC8vIHV1aWQgLT4gdXNlcnNcbiAgICBjb25zdCBpZFVzZXIgPSBzZXNzaW9uLnVzZXIgfHwgdGhpcy5hdXRoU2VydmljZS5nZXRTZXNzaW9uSW5mbygpLnVzZXI7XG4gICAgY29uc3QgdXNlciA9IHVzZXJzW2lkVXNlcl0gfHwge307IC8vIHV1aWQgLT4gdXNlcnMtPiB1c2VyXG5cbiAgICBsZXQgY29tcG9uZW50c0RhdGEgPSB7fTtcbiAgICBpZiAodXNlcnNbaWRVc2VyXSkge1xuICAgICAgY29tcG9uZW50c0RhdGEgPSB1c2Vyc1tpZFVzZXJdW0xvY2FsU3RvcmFnZVNlcnZpY2UuQ09NUE9ORU5UU19TVE9SQUdFX0tFWV0gfHwge307XG4gICAgfVxuICAgIGNvbXBvbmVudHNEYXRhW2NvbXBvbmVudEtleV0gPSBjb21wb25lbnREYXRhQjY0IHx8IHt9O1xuXG4gICAgdXNlcltMb2NhbFN0b3JhZ2VTZXJ2aWNlLkNPTVBPTkVOVFNfU1RPUkFHRV9LRVldID0gY29tcG9uZW50c0RhdGE7XG4gICAgdXNlcnNbaWRVc2VyXSA9IHVzZXI7XG4gICAgYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXSA9IHVzZXJzO1xuXG4gICAgdGhpcy5zZXRMb2NhbFN0b3JhZ2UoYXBwRGF0YSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0U3RvcmVkRGF0YSgpOiBvYmplY3Qge1xuICAgIGxldCBhcHBEYXRhID0ge307XG4gICAgY29uc3QgYXBwU3RvcmVkRGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuX2NvbmZpZy51dWlkKTtcbiAgICBpZiAoYXBwU3RvcmVkRGF0YSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXBwRGF0YSA9IEpTT04ucGFyc2UoYXBwU3RvcmVkRGF0YSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGFwcERhdGEgPSB7fTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFwcERhdGE7XG4gIH1cblxuICBwdWJsaWMgc2V0QmFja3dhcmRDb21wYXRpYmlsaXR5KCkge1xuICAgIGNvbnN0IGFwcERhdGEgPSB0aGlzLmdldFN0b3JlZERhdGEoKTtcbiAgICBjb25zdCBzZXNzaW9uID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlNFU1NJT05fU1RPUkFHRV9LRVldO1xuICAgIGlmICghVXRpbC5pc0RlZmluZWQoc2Vzc2lvbikgfHwgIVV0aWwuaXNEZWZpbmVkKHNlc3Npb24udXNlcikpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgY29tcG9uZW50c0luZm8gPSBhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuQ09NUE9ORU5UU19TVE9SQUdFX0tFWV0gfHwge307XG4gICAgbGV0IHVzZXJzT2JqZWN0ID0ge307XG4gICAgY29uc3QgZXhpc3RzVXNlcnNUYWcgPSBVdGlsLmlzRGVmaW5lZChhcHBEYXRhW0xvY2FsU3RvcmFnZVNlcnZpY2UuVVNFUlNfU1RPUkFHRV9LRVldKTtcbiAgICBsZXQgY3JlYXRlVXNlckluZm8gPSBleGlzdHNVc2Vyc1RhZztcbiAgICBpZiAoZXhpc3RzVXNlcnNUYWcpIHtcbiAgICAgIHVzZXJzT2JqZWN0ID0gYXBwRGF0YVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLlVTRVJTX1NUT1JBR0VfS0VZXTtcbiAgICAgIGNyZWF0ZVVzZXJJbmZvID0gIVV0aWwuaXNEZWZpbmVkKGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV1bc2Vzc2lvbi51c2VyXSk7XG4gICAgfVxuICAgIGlmIChjcmVhdGVVc2VySW5mbykge1xuICAgICAgdXNlcnNPYmplY3Rbc2Vzc2lvbi51c2VyXSA9IHt9O1xuICAgICAgdXNlcnNPYmplY3Rbc2Vzc2lvbi51c2VyXVtMb2NhbFN0b3JhZ2VTZXJ2aWNlLkNPTVBPTkVOVFNfU1RPUkFHRV9LRVldID0gY29tcG9uZW50c0luZm87XG5cbiAgICAgIGFwcERhdGFbTG9jYWxTdG9yYWdlU2VydmljZS5VU0VSU19TVE9SQUdFX0tFWV0gPSB1c2Vyc09iamVjdDtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuX2NvbmZpZy51dWlkLCBKU09OLnN0cmluZ2lmeShhcHBEYXRhKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJDYW5ub3Qgc2V0IG5ldyBpdGVtIGluIGxvY2FsU3RvcmFnZS4gRXJyb3I6IFwiICsgZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHNldExvY2FsU3RvcmFnZShhcHBEYXRhOiBhbnkpIHtcbiAgICB0aGlzLm9uU2V0TG9jYWxTdG9yYWdlLmVtaXQoKTtcbiAgICB0cnkge1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5fY29uZmlnLnV1aWQsIEpTT04uc3RyaW5naWZ5KGFwcERhdGEpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiQ2Fubm90IHNldCBuZXcgaXRlbSBpbiBsb2NhbFN0b3JhZ2UuIEVycm9yOiBcIiArIGUpO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=