import { OFormValue } from '../components/form/o-form-value';
import { Codes } from './codes';
import { SQLTypes } from './sqltypes';
import { Util } from './util';
export class ServiceUtils {
    static getParentKeysFromExpandableContainer(parentKeysObject, expandableContainer, route, checkRouteParamsRecursive = true) {
        const result = {};
        const ownKeys = Object.keys(parentKeysObject || {});
        const dataComponent = expandableContainer ? expandableContainer.data : {};
        const existsData = Object.keys(dataComponent).length > 0;
        const routeParams = route ? ServiceUtils.getRouteParams(route.snapshot, checkRouteParamsRecursive) : {};
        const existsRouteParams = Object.keys(routeParams).length > 0;
        if (existsData || existsRouteParams) {
            ownKeys.forEach(ownKey => {
                const keyValue = parentKeysObject[ownKey];
                let value;
                if (dataComponent.hasOwnProperty(keyValue)) {
                    value = dataComponent[keyValue];
                }
                else if (routeParams.hasOwnProperty(keyValue)) {
                    value = routeParams[keyValue];
                }
                if (Util.isDefined(value)) {
                    switch (typeof (value)) {
                        case 'string':
                            if (value.trim().length > 0) {
                                result[ownKey] = value.trim();
                            }
                            break;
                        case 'number':
                            if (!isNaN(value)) {
                                result[ownKey] = value;
                            }
                            break;
                    }
                }
            });
        }
        return result;
    }
    static getParentKeysFromForm(parentKeysObject, form, route, checkRouteParamsRecursive = true) {
        const result = {};
        const ownKeys = Object.keys(parentKeysObject || {});
        const formComponents = form ? form.getComponents() : {};
        const existsComponents = Object.keys(formComponents).length > 0;
        const formDataProperties = form ? form.getDataValues() : {};
        const existsProperties = Object.keys(formDataProperties).length > 0;
        const urlData = form ? form.getFormNavigation().getFilterFromUrlParams() : {};
        const existsUrlData = Object.keys(urlData).length > 0;
        if (existsUrlData) {
            form.keysArray.forEach((key, i) => {
                if (urlData.hasOwnProperty(key)) {
                    urlData[key] = SQLTypes.parseUsingSQLType(urlData[key], form.keysSqlTypesArray[i]);
                }
            });
        }
        const routeParams = route ? ServiceUtils.getRouteParams(route.snapshot, checkRouteParamsRecursive) : {};
        const existsRouteParams = Object.keys(routeParams).length > 0;
        if (existsComponents || existsProperties || existsUrlData || existsRouteParams) {
            ownKeys.forEach(ownKey => {
                const keyValue = parentKeysObject[ownKey];
                const isEquivObject = Util.isObject(keyValue);
                const formFieldAttr = isEquivObject ? Object.keys(keyValue)[0] : keyValue;
                let currentData;
                if (formComponents.hasOwnProperty(formFieldAttr)) {
                    const component = formComponents[formFieldAttr];
                    if ('getSelectedRecord' in component && isEquivObject) {
                        currentData = (component.getSelectedRecord() || {})[keyValue[formFieldAttr]];
                    }
                    else {
                        currentData = component.getValue();
                    }
                }
                else if (formDataProperties.hasOwnProperty(formFieldAttr)) {
                    const formPropValue = formDataProperties[formFieldAttr];
                    currentData = formPropValue instanceof OFormValue ? formPropValue.value : formPropValue;
                }
                else if (urlData.hasOwnProperty(formFieldAttr)) {
                    currentData = urlData[formFieldAttr];
                }
                else if (routeParams.hasOwnProperty(formFieldAttr)) {
                    currentData = routeParams[formFieldAttr];
                }
                if (Util.isDefined(currentData)) {
                    switch (typeof (currentData)) {
                        case 'string':
                            if (currentData.trim().length > 0) {
                                result[ownKey] = currentData.trim();
                            }
                            break;
                        case 'number':
                            if (!isNaN(currentData)) {
                                result[ownKey] = currentData;
                            }
                            break;
                    }
                }
            });
        }
        return result;
    }
    static filterContainsAllParentKeys(parentKeysFilter, parentKeys) {
        const pkKeys = Object.keys(parentKeys);
        if ((pkKeys.length > 0) && Util.isDefined(parentKeysFilter)) {
            const parentKeysFilterKeys = Object.keys(parentKeysFilter);
            return pkKeys.every(a => parentKeysFilterKeys.indexOf(a) !== -1);
        }
        return true;
    }
    static getFilterUsingParentKeys(parentItem, parentKeysObject) {
        const filter = {};
        const ownKeys = Object.keys(parentKeysObject);
        if (ownKeys.length > 0 && Util.isDefined(parentItem)) {
            ownKeys.forEach(ownKey => {
                const parentKey = parentKeysObject[ownKey];
                if (parentItem.hasOwnProperty(parentKey)) {
                    let currentData = parentItem[parentKey];
                    if (currentData instanceof OFormValue) {
                        currentData = currentData.value;
                    }
                    filter[ownKey] = currentData;
                }
            });
        }
        return filter;
    }
    static getArrayProperties(array, properties) {
        const result = array.map(item => {
            return ServiceUtils.getObjectProperties(item, properties);
        });
        return result;
    }
    static getObjectProperties(object, properties) {
        const objectProperties = {};
        properties.forEach(key => {
            objectProperties[key] = object[key];
        });
        return objectProperties;
    }
    static parseSortColumns(sortColumns) {
        const sortColArray = [];
        if (sortColumns) {
            const cols = Util.parseArray(sortColumns);
            cols.forEach(col => {
                const colDef = col.split(Codes.TYPE_SEPARATOR);
                if (colDef.length > 0) {
                    const colName = colDef[0];
                    const colSort = colDef[1] || Codes.ASC_SORT;
                    sortColArray.push({
                        columnName: colName,
                        ascendent: colSort === Codes.ASC_SORT
                    });
                }
            });
        }
        return sortColArray;
    }
    static getRouteParams(route, recursive) {
        let params = Object.assign({}, route.params);
        if (recursive && route.parent) {
            params = Object.assign({}, this.getRouteParams(route.parent, recursive), params);
        }
        return params;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmljZS51dGlscy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvdXRpbC9zZXJ2aWNlLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUc3RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUU5QixNQUFNLE9BQU8sWUFBWTtJQUV2QixNQUFNLENBQUMsb0NBQW9DLENBQUMsZ0JBQXdCLEVBQUUsbUJBQWtELEVBQUUsS0FBc0IsRUFBRSw0QkFBcUMsSUFBSTtRQUN6TCxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDbEIsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUVwRCxNQUFNLGFBQWEsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDMUUsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBRXpELE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUN4RyxNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUU5RCxJQUFJLFVBQVUsSUFBSSxpQkFBaUIsRUFBRTtZQUNuQyxPQUFP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SyxDQUFDLE1BQU0sRUFBRTtZQUM3QixNQUFNLHFCQUFRLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsRUFBSyxNQUFNLENBQUUsQ0FBQztTQUN6RTtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgT0V4cGFuZGFibGVDb250YWluZXJDb21wb25lbnQgfSBmcm9tICcuLi9jb21wb25lbnRzL2V4cGFuZGFibGUtY29udGFpbmVyL28tZXhwYW5kYWJsZS1jb250YWluZXIuY29tcG9uZW50JztcbmltcG9ydCB7IE9Gb3JtVmFsdWUgfSBmcm9tICcuLi9jb21wb25lbnRzL2Zvcm0vby1mb3JtLXZhbHVlJztcbmltcG9ydCB7IE9Gb3JtQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cy9mb3JtL28tZm9ybS5jb21wb25lbnQnO1xuaW1wb3J0IHsgU1FMT3JkZXIgfSBmcm9tICcuLi90eXBlcy9zcWwtb3JkZXIudHlwZSc7XG5pbXBvcnQgeyBDb2RlcyB9IGZyb20gJy4vY29kZXMnO1xuaW1wb3J0IHsgU1FMVHlwZXMgfSBmcm9tICcuL3NxbHR5cGVzJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuL3V0aWwnO1xuXG5leHBvcnQgY2xhc3MgU2VydmljZVV0aWxzIHtcblxuICBzdGF0aWMgZ2V0UGFyZW50S2V5c0Zyb21FeHBhbmRhYmxlQ29udGFpbmVyKHBhcmVudEtleXNPYmplY3Q6IG9iamVjdCwgZXhwYW5kYWJsZUNvbnRhaW5lcjogT0V4cGFuZGFibGVDb250YWluZXJDb21wb25lbnQsIHJvdXRlPzogQWN0aXZhdGVkUm91dGUsIGNoZWNrUm91dGVQYXJhbXNSZWN1cnNpdmU6IGJvb2xlYW4gPSB0cnVlKToge30ge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGNvbnN0IG93bktleXMgPSBPYmplY3Qua2V5cyhwYXJlbnRLZXlzT2JqZWN0IHx8IHt9KTtcblxuICAgIGNvbnN0IGRhdGFDb21wb25lbnQgPSBleHBhbmRhYmxlQ29udGFpbmVyID8gZXhwYW5kYWJsZUNvbnRhaW5lci5kYXRhIDoge307XG4gICAgY29uc3QgZXhpc3RzRGF0YSA9IE9iamVjdC5rZXlzKGRhdGFDb21wb25lbnQpLmxlbmd0aCA+IDA7XG5cbiAgICBjb25zdCByb3V0ZVBhcmFtcyA9IHJvdXRlID8gU2VydmljZVV0aWxzLmdldFJvdXRlUGFyYW1zKHJvdXRlLnNuYXBzaG90LCBjaGVja1JvdXRlUGFyYW1zUmVjdXJzaXZlKSA6IHt9O1xuICAgIGNvbnN0IGV4aXN0c1JvdXRlUGFyYW1zID0gT2JqZWN0LmtleXMocm91dGVQYXJhbXMpLmxlbmd0aCA+IDA7XG5cbiAgICBpZiAoZXhpc3RzRGF0YSB8fCBleGlzdHNSb3V0ZVBhcmFtcykge1xuICAgICAgb3duS2V5cy5mb3JFYWNoKG93bktleSA9PiB7XG4gICAgICAgIGNvbnN0IGtleVZhbHVlID0gcGFyZW50S2V5c09iamVjdFtvd25LZXldO1xuICAgICAgICBsZXQgdmFsdWU7XG4gICAgICAgIGlmIChkYXRhQ29tcG9uZW50Lmhhc093blByb3BlcnR5KGtleVZhbHVlKSkge1xuICAgICAgICAgIHZhbHVlID0gZGF0YUNvbXBvbmVudFtrZXlWYWx1ZV07XG4gICAgICAgIH0gZWxzZSBpZiAocm91dGVQYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5VmFsdWUpKSB7XG4gICAgICAgICAgdmFsdWUgPSByb3V0ZVBhcmFtc1trZXlWYWx1ZV07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFV0aWwuaXNEZWZpbmVkKHZhbHVlKSkge1xuICAgICAgICAgIHN3aXRjaCAodHlwZW9mICh2YWx1ZSkpIHtcbiAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgICAgICAgICAgIGlmICh2YWx1ZS50cmltKCkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdFtvd25LZXldID0gdmFsdWUudHJpbSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICAgICAgaWYgKCFpc05hTih2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICByZXN1bHRbb3duS2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBzdGF0aWMgZ2V0UGFyZW50S2V5c0Zyb21Gb3JtKHBhcmVudEtleXNPYmplY3Q6IG9iamVjdCwgZm9ybTogT0Zvcm1Db21wb25lbnQsIHJvdXRlPzogQWN0aXZhdGVkUm91dGUsIGNoZWNrUm91dGVQYXJhbXNSZWN1cnNpdmU6IGJvb2xlYW4gPSB0cnVlKSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgY29uc3Qgb3duS2V5cyA9IE9iamVjdC5rZXlzKHBhcmVudEtleXNPYmplY3QgfHwge30pO1xuXG4gICAgY29uc3QgZm9ybUNvbXBvbmVudHMgPSBmb3JtID8gZm9ybS5nZXRDb21wb25lbnRzKCkgOiB7fTtcbiAgICBjb25zdCBleGlzdHNDb21wb25lbnRzID0gT2JqZWN0LmtleXMoZm9ybUNvbXBvbmVudHMpLmxlbmd0aCA+IDA7XG5cbiAgICBjb25zdCBmb3JtRGF0YVByb3BlcnRpZXMgPSBmb3JtID8gZm9ybS5nZXREYXRhVmFsdWVzKCkgOiB7fTtcbiAgICBjb25zdCBleGlzdHNQcm9wZXJ0aWVzID0gT2JqZWN0LmtleXMoZm9ybURhdGFQcm9wZXJ0aWVzKS5sZW5ndGggPiAwO1xuXG4gICAgY29uc3QgdXJsRGF0YSA9IGZvcm0gPyBmb3JtLmdldEZvcm1OYXZpZ2F0aW9uKCkuZ2V0RmlsdGVyRnJvbVVybFBhcmFtcygpIDoge307XG4gICAgY29uc3QgZXhpc3RzVXJsRGF0YSA9IE9iamVjdC5rZXlzKHVybERhdGEpLmxlbmd0aCA+IDA7XG4gICAgaWYgKGV4aXN0c1VybERhdGEpIHtcbiAgICAgIGZvcm0ua2V5c0FycmF5LmZvckVhY2goKGtleTogc3RyaW5nLCBpOiBudW1iZXIpID0+IHtcbiAgICAgICAgaWYgKHVybERhdGEuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIHVybERhdGFba2V5XSA9IFNRTFR5cGVzLnBhcnNlVXNpbmdTUUxUeXBlKHVybERhdGFba2V5XSwgZm9ybS5rZXlzU3FsVHlwZXNBcnJheVtpXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IHJvdXRlUGFyYW1zID0gcm91dGUgPyBTZXJ2aWNlVXRpbHMuZ2V0Um91dGVQYXJhbXMocm91dGUuc25hcHNob3QsIGNoZWNrUm91dGVQYXJhbXNSZWN1cnNpdmUpIDoge307XG4gICAgY29uc3QgZXhpc3RzUm91dGVQYXJhbXMgPSBPYmplY3Qua2V5cyhyb3V0ZVBhcmFtcykubGVuZ3RoID4gMDtcblxuICAgIGlmIChleGlzdHNDb21wb25lbnRzIHx8IGV4aXN0c1Byb3BlcnRpZXMgfHwgZXhpc3RzVXJsRGF0YSB8fCBleGlzdHNSb3V0ZVBhcmFtcykge1xuICAgICAgb3duS2V5cy5mb3JFYWNoKG93bktleSA9PiB7XG4gICAgICAgIGNvbnN0IGtleVZhbHVlID0gcGFyZW50S2V5c09iamVjdFtvd25LZXldO1xuICAgICAgICAvLyBQYXJlbnQga2V5IGVxdWl2YWxlbmNlIG1heSBiZSBhbiBvYmplY3RcbiAgICAgICAgY29uc3QgaXNFcXVpdk9iamVjdCA9IFV0aWwuaXNPYmplY3Qoa2V5VmFsdWUpO1xuICAgICAgICBjb25zdCBmb3JtRmllbGRBdHRyID0gaXNFcXVpdk9iamVjdCA/IE9iamVjdC5rZXlzKGtleVZhbHVlKVswXSA6IGtleVZhbHVlO1xuICAgICAgICBsZXQgY3VycmVudERhdGE7XG4gICAgICAgIGlmIChmb3JtQ29tcG9uZW50cy5oYXNPd25Qcm9wZXJ0eShmb3JtRmllbGRBdHRyKSkge1xuICAgICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IGZvcm1Db21wb25lbnRzW2Zvcm1GaWVsZEF0dHJdO1xuICAgICAgICAgIC8vIElzIHNlcnZpY2UgY29tcG9uZW50IChjb21ibywgbGlzdHBpY2tlciwgcmFkaW8pXG4gICAgICAgICAgaWYgKCdnZXRTZWxlY3RlZFJlY29yZCcgaW4gY29tcG9uZW50ICYmIGlzRXF1aXZPYmplY3QpIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gKChjb21wb25lbnQgYXMgYW55KS5nZXRTZWxlY3RlZFJlY29yZCgpIHx8IHt9KVtrZXlWYWx1ZVtmb3JtRmllbGRBdHRyXV07XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnREYXRhID0gY29tcG9uZW50LmdldFZhbHVlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGZvcm1EYXRhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShmb3JtRmllbGRBdHRyKSkge1xuICAgICAgICAgIGNvbnN0IGZvcm1Qcm9wVmFsdWUgPSBmb3JtRGF0YVByb3BlcnRpZXNbZm9ybUZpZWxkQXR0cl07XG4gICAgICAgICAgY3VycmVudERhdGEgPSBmb3JtUHJvcFZhbHVlIGluc3RhbmNlb2YgT0Zvcm1WYWx1ZSA/IGZvcm1Qcm9wVmFsdWUudmFsdWUgOiBmb3JtUHJvcFZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKHVybERhdGEuaGFzT3duUHJvcGVydHkoZm9ybUZpZWxkQXR0cikpIHtcbiAgICAgICAgICBjdXJyZW50RGF0YSA9IHVybERhdGFbZm9ybUZpZWxkQXR0cl07XG4gICAgICAgIH0gZWxzZSBpZiAocm91dGVQYXJhbXMuaGFzT3duUHJvcGVydHkoZm9ybUZpZWxkQXR0cikpIHtcbiAgICAgICAgICBjdXJyZW50RGF0YSA9IHJvdXRlUGFyYW1zW2Zvcm1GaWVsZEF0dHJdO1xuICAgICAgICB9XG4gICAgICAgIGlmIChVdGlsLmlzRGVmaW5lZChjdXJyZW50RGF0YSkpIHtcbiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiAoY3VycmVudERhdGEpKSB7XG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICBpZiAoY3VycmVudERhdGEudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXN1bHRbb3duS2V5XSA9IGN1cnJlbnREYXRhLnRyaW0oKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ251bWJlcic6XG4gICAgICAgICAgICAgIGlmICghaXNOYU4oY3VycmVudERhdGEpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0W293bktleV0gPSBjdXJyZW50RGF0YTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgc3RhdGljIGZpbHRlckNvbnRhaW5zQWxsUGFyZW50S2V5cyhwYXJlbnRLZXlzRmlsdGVyLCBwYXJlbnRLZXlzKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcGtLZXlzID0gT2JqZWN0LmtleXMocGFyZW50S2V5cyk7XG4gICAgaWYgKChwa0tleXMubGVuZ3RoID4gMCkgJiYgVXRpbC5pc0RlZmluZWQocGFyZW50S2V5c0ZpbHRlcikpIHtcbiAgICAgIGNvbnN0IHBhcmVudEtleXNGaWx0ZXJLZXlzID0gT2JqZWN0LmtleXMocGFyZW50S2V5c0ZpbHRlcik7XG4gICAgICByZXR1cm4gcGtLZXlzLmV2ZXJ5KGEgPT4gcGFyZW50S2V5c0ZpbHRlcktleXMuaW5kZXhPZihhKSAhPT0gLTEpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHN0YXRpYyBnZXRGaWx0ZXJVc2luZ1BhcmVudEtleXMocGFyZW50SXRlbTogYW55LCBwYXJlbnRLZXlzT2JqZWN0OiBvYmplY3QpIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7fTtcbiAgICBjb25zdCBvd25LZXlzID0gT2JqZWN0LmtleXMocGFyZW50S2V5c09iamVjdCk7XG4gICAgaWYgKG93bktleXMubGVuZ3RoID4gMCAmJiBVdGlsLmlzRGVmaW5lZChwYXJlbnRJdGVtKSkge1xuICAgICAgb3duS2V5cy5mb3JFYWNoKG93bktleSA9PiB7XG4gICAgICAgIGNvbnN0IHBhcmVudEtleSA9IHBhcmVudEtleXNPYmplY3Rbb3duS2V5XTtcbiAgICAgICAgaWYgKHBhcmVudEl0ZW0uaGFzT3duUHJvcGVydHkocGFyZW50S2V5KSkge1xuICAgICAgICAgIGxldCBjdXJyZW50RGF0YSA9IHBhcmVudEl0ZW1bcGFyZW50S2V5XTtcbiAgICAgICAgICBpZiAoY3VycmVudERhdGEgaW5zdGFuY2VvZiBPRm9ybVZhbHVlKSB7XG4gICAgICAgICAgICBjdXJyZW50RGF0YSA9IGN1cnJlbnREYXRhLnZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBmaWx0ZXJbb3duS2V5XSA9IGN1cnJlbnREYXRhO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGZpbHRlcjtcbiAgfVxuXG4gIHN0YXRpYyBnZXRBcnJheVByb3BlcnRpZXMoYXJyYXk6IGFueVtdLCBwcm9wZXJ0aWVzOiBhbnlbXSk6IGFueVtdIHtcbiAgICBjb25zdCByZXN1bHQgPSBhcnJheS5tYXAoaXRlbSA9PiB7XG4gICAgICByZXR1cm4gU2VydmljZVV0aWxzLmdldE9iamVjdFByb3BlcnRpZXMoaXRlbSwgcHJvcGVydGllcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHN0YXRpYyBnZXRPYmplY3RQcm9wZXJ0aWVzKG9iamVjdDogYW55LCBwcm9wZXJ0aWVzOiBhbnlbXSk6IGFueSB7XG4gICAgY29uc3Qgb2JqZWN0UHJvcGVydGllcyA9IHt9O1xuICAgIHByb3BlcnRpZXMuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgb2JqZWN0UHJvcGVydGllc1trZXldID0gb2JqZWN0W2tleV07XG4gICAgfSk7XG4gICAgcmV0dXJuIG9iamVjdFByb3BlcnRpZXM7XG4gIH1cblxuICBzdGF0aWMgcGFyc2VTb3J0Q29sdW1ucyhzb3J0Q29sdW1uczogc3RyaW5nKTogQXJyYXk8U1FMT3JkZXI+IHtcbiAgICBjb25zdCBzb3J0Q29sQXJyYXkgPSBbXTtcbiAgICBpZiAoc29ydENvbHVtbnMpIHtcbiAgICAgIGNvbnN0IGNvbHMgPSBVdGlsLnBhcnNlQXJyYXkoc29ydENvbHVtbnMpO1xuICAgICAgY29scy5mb3JFYWNoKGNvbCA9PiB7XG4gICAgICAgIGNvbnN0IGNvbERlZiA9IGNvbC5zcGxpdChDb2Rlcy5UWVBFX1NFUEFSQVRPUik7XG4gICAgICAgIGlmIChjb2xEZWYubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IGNvbE5hbWUgPSBjb2xEZWZbMF07XG4gICAgICAgICAgY29uc3QgY29sU29ydCA9IGNvbERlZlsxXSB8fCBDb2Rlcy5BU0NfU09SVDtcbiAgICAgICAgICBzb3J0Q29sQXJyYXkucHVzaCh7XG4gICAgICAgICAgICBjb2x1bW5OYW1lOiBjb2xOYW1lLFxuICAgICAgICAgICAgYXNjZW5kZW50OiBjb2xTb3J0ID09PSBDb2Rlcy5BU0NfU09SVFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHNvcnRDb2xBcnJheTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdGhlIHBhcmFtcyBvZiB0aGUgcHJvdmlkZWQgcm91dGUuXG4gICAqIFBhcmFtcyBmcm9tIHBhcmVudCByb3V0ZXMgYXJlIHJlcGxhY2VkIGJ5IGNoaWxkIHJvdXRlIHBhcmFtIHZhbHVlcyBpZiByZXBlYXRlZC5cbiAgICogQHBhcmFtIHJvdXRlIHRoZSByb3V0ZVxuICAgKiBAcGFyYW0gcmVjdXJzaXZlIGluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCB0byByZXR1cm4gcm91dGUgcGFyYW1zIGZyb20gcm91dGUgYW5jZXN0b3JzLlxuICAgKiBAcmV0dXJucyBwYXJhbXMgY29udGFpbmluZyBhbGwgdGhlIHJvdXRlIHBhcmFtZXRlcnNcbiAgICovXG4gIHN0YXRpYyBnZXRSb3V0ZVBhcmFtcyhyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgcmVjdXJzaXZlOiBib29sZWFuKTogb2JqZWN0IHtcbiAgICBsZXQgcGFyYW1zID0geyAuLi5yb3V0ZS5wYXJhbXMgfTtcbiAgICBpZiAocmVjdXJzaXZlICYmIHJvdXRlLnBhcmVudCkge1xuICAgICAgcGFyYW1zID0geyAuLi50aGlzLmdldFJvdXRlUGFyYW1zKHJvdXRlLnBhcmVudCwgcmVjdXJzaXZlKSwgLi4ucGFyYW1zIH07XG4gICAgfVxuICAgIHJldHVybiBwYXJhbXM7XG4gIH1cblxufVxuIl19