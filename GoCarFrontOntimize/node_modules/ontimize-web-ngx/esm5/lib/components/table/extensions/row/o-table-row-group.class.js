import { Subject } from 'rxjs';
import { Util } from '../../../../util/util';
var OTableGroupedRow = (function () {
    function OTableGroupedRow(arg) {
        this.level = 0;
        this.expanded = true;
        this.columnsData = {};
        this.aggregateFunctionChange = new Subject();
        if (Util.isDefined(arg)) {
            this.column = arg.column;
            this.keysAsString = arg.keysAsString;
            this.level = arg.level;
            this.parent = arg.parent;
        }
    }
    Object.defineProperty(OTableGroupedRow.prototype, "visible", {
        get: function () {
            return !this.parent || (this.parent.visible && this.parent.expanded);
        },
        enumerable: true,
        configurable: true
    });
    OTableGroupedRow.prototype.hasColumnData = function (columnAttr) {
        return Util.isDefined(this.columnsData[columnAttr]);
    };
    OTableGroupedRow.prototype.hasActiveAggregate = function (columnAttr) {
        return this.hasColumnData(columnAttr) && Util.isDefined(this.columnsData[columnAttr].activeAggregate);
    };
    OTableGroupedRow.prototype.getColumnGroupingComponent = function (columnAttr) {
        return this.hasColumnData(columnAttr) ? this.columnsData[columnAttr].component : null;
    };
    OTableGroupedRow.prototype.getColumnAggregateValue = function (columnAttr) {
        return this.columnsData[columnAttr].value;
    };
    OTableGroupedRow.prototype.setColumnAggregateValue = function (columnAttr, value) {
        this.columnsData[columnAttr].value = value;
    };
    OTableGroupedRow.prototype.expandSameLevel = function (defaultValue) {
        if (!this.hasColumnData(this.column)) {
            return defaultValue;
        }
        var groupingComponent = this.getColumnGroupingComponent(this.column);
        if (Util.isDefined(groupingComponent)) {
            return groupingComponent.expandGroupsSameLevel;
        }
        return defaultValue;
    };
    OTableGroupedRow.prototype.setColumnAggregateData = function (columnAttr, value) {
        if (this.hasColumnData(columnAttr)) {
            this.columnsData[columnAttr].data = value;
        }
    };
    OTableGroupedRow.prototype.getColumnAggregateData = function (columnAttr) {
        return this.hasColumnData(columnAttr) ? this.columnsData[columnAttr].data : [];
    };
    OTableGroupedRow.prototype.setColumnActiveAggregateFunction = function (columnAttr, aggregateFnName, emitEvent) {
        if (emitEvent === void 0) { emitEvent = true; }
        if (this.hasColumnData(columnAttr)) {
            this.columnsData[columnAttr].activeAggregate = aggregateFnName;
        }
        else {
            this.columnsData[columnAttr] = {
                component: null,
                activeAggregate: aggregateFnName,
                value: null,
                data: []
            };
        }
        if (emitEvent) {
            var changeAllGroupedRows = true;
            var groupingComponent = this.getColumnGroupingComponent(columnAttr);
            if (Util.isDefined(groupingComponent)) {
                changeAllGroupedRows = groupingComponent.changeAggregateSameLevel;
            }
            this.aggregateFunctionChange.next({
                columnAttr: columnAttr,
                activeAggregate: aggregateFnName,
                changeAllGroupedRows: changeAllGroupedRows,
                row: this
            });
        }
    };
    OTableGroupedRow.prototype.getColumnActiveAggregateTitle = function (columnAttr) {
        var conf = this.getActiveColumnAggregateConfiguration(columnAttr);
        if (conf.title) {
            return conf.title;
        }
        return "AGGREGATE_NAME." + (conf.aggregateName || conf.aggregate);
    };
    OTableGroupedRow.prototype.initializeColumnAggregate = function (columnAttr, component) {
        if (!this.columnsData.hasOwnProperty(columnAttr)) {
            this.columnsData[columnAttr] = {
                component: null,
                activeAggregate: 'sum',
                value: null,
                data: []
            };
        }
        if (Util.isDefined(component)) {
            this.columnsData[columnAttr].component = component;
            this.columnsData[columnAttr].activeAggregate = component.aggregate;
        }
    };
    OTableGroupedRow.prototype.getActiveColumnAggregateConfiguration = function (columnAttr) {
        if (!this.hasColumnData(columnAttr)) {
            return {
                attr: columnAttr,
                aggregate: 'sum'
            };
        }
        var activeAggregate = this.columnsData[columnAttr].activeAggregate;
        var groupingColumnComponent = this.columnsData[columnAttr].component;
        if (Util.isDefined(groupingColumnComponent) && groupingColumnComponent.aggregate === activeAggregate) {
            return groupingColumnComponent.getAggregateConfiguration();
        }
        return {
            attr: columnAttr,
            aggregate: this.columnsData[columnAttr].activeAggregate
        };
    };
    return OTableGroupedRow;
}());
export { OTableGroupedRow };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10YWJsZS1yb3ctZ3JvdXAuY2xhc3MuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvdGFibGUvZXh0ZW5zaW9ucy9yb3cvby10YWJsZS1yb3ctZ3JvdXAuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUcvQixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFtQjdDO0lBZUUsMEJBQVksR0FBUztRQVhyQixVQUFLLEdBQUcsQ0FBQyxDQUFDO1FBR1YsYUFBUSxHQUFHLElBQUksQ0FBQztRQUlSLGdCQUFXLEdBQTJDLEVBQUUsQ0FBQztRQUVqRSw0QkFBdUIsR0FBZ0MsSUFBSSxPQUFPLEVBQXNCLENBQUM7UUFHdkYsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztZQUN6QixJQUFJLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUM7WUFDckMsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztTQUMxQjtJQUNILENBQUM7SUFkRCxzQkFBSSxxQ0FBTzthQUFYO1lBQ0UsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZFLENBQUM7OztPQUFBO0lBY0Qsd0NBQWEsR0FBYixVQUFjLFVBQWtCO1FBQzlCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7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QWUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLGVBQWUsQ0FBQztRQUNyRSxJQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ3ZFLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLHVCQUF1QixDQUFDLFNBQVMsS0FBSyxlQUFlLEVBQUU7WUFDcEcsT0FBTyx1QkFBdUIsQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1NBQzVEO1FBRUQsT0FBTztZQUNMLElBQUksRUFBRSxVQUFVO1lBQ2hCLFNBQVMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLGVBQWU7U0FDeEQsQ0FBQTtJQUNILENBQUM7SUFFSCx1QkFBQztBQUFELENBQUMsQUF2SUQsSUF1SUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IEdyb3VwZWRDb2x1bW5BZ2dyZWdhdGVDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vLi4vLi4vLi4vaW50ZXJmYWNlcy9vLXRhYmxlLWNvbHVtbnMtZ3JvdXBpbmctaW50ZXJmYWNlJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlsL3V0aWwnO1xuaW1wb3J0IHtcbiAgT1RhYmxlQ29sdW1uc0dyb3VwaW5nQ29sdW1uQ29tcG9uZW50XG59IGZyb20gJy4uL2hlYWRlci90YWJsZS1jb2x1bW5zLWdyb3VwaW5nL2NvbHVtbnMvby10YWJsZS1jb2x1bW5zLWdyb3VwaW5nLWNvbHVtbi5jb21wb25lbnQnO1xuXG5leHBvcnQgdHlwZSBBZ2dyZWdhdGVDaGFuZ2VBcmcgPSB7XG4gIGNvbHVtbkF0dHI6IHN0cmluZztcbiAgYWN0aXZlQWdncmVnYXRlOiBzdHJpbmc7XG4gIGNoYW5nZUFsbEdyb3VwZWRSb3dzOiBib29sZWFuO1xuICByb3c6IE9UYWJsZUdyb3VwZWRSb3c7XG59XG5cbmV4cG9ydCB0eXBlIEFnZ3JlZ2F0ZUNvbHVtbkRhdGEgPSB7XG4gIGNvbXBvbmVudDogT1RhYmxlQ29sdW1uc0dyb3VwaW5nQ29sdW1uQ29tcG9uZW50O1xuICBhY3RpdmVBZ2dyZWdhdGU6IHN0cmluZztcbiAgdmFsdWU6IGFueTtcbiAgZGF0YTogYW55W107XG59XG5cbmV4cG9ydCBjbGFzcyBPVGFibGVHcm91cGVkUm93IHtcbiAgY29sdW1uOiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIGdyb3VwRGF0YTogYW55W107XG4gIGxldmVsID0gMDtcbiAga2V5c0FzU3RyaW5nOiBzdHJpbmc7XG4gIHBhcmVudDogT1RhYmxlR3JvdXBlZFJvdztcbiAgZXhwYW5kZWQgPSB0cnVlO1xuICBnZXQgdmlzaWJsZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMucGFyZW50IHx8ICh0aGlzLnBhcmVudC52aXNpYmxlICYmIHRoaXMucGFyZW50LmV4cGFuZGVkKTtcbiAgfVxuICBwcml2YXRlIGNvbHVtbnNEYXRhOiB7IFtrZXk6IHN0cmluZ106IEFnZ3JlZ2F0ZUNvbHVtbkRhdGEgfSA9IHt9O1xuXG4gIGFnZ3JlZ2F0ZUZ1bmN0aW9uQ2hhbmdlOiBTdWJqZWN0PEFnZ3JlZ2F0ZUNoYW5nZUFyZz4gPSBuZXcgU3ViamVjdDxBZ2dyZWdhdGVDaGFuZ2VBcmc+KCk7XG5cbiAgY29uc3RydWN0b3IoYXJnPzogYW55KSB7XG4gICAgaWYgKFV0aWwuaXNEZWZpbmVkKGFyZykpIHtcbiAgICAgIHRoaXMuY29sdW1uID0gYXJnLmNvbHVtbjtcbiAgICAgIHRoaXMua2V5c0FzU3RyaW5nID0gYXJnLmtleXNBc1N0cmluZztcbiAgICAgIHRoaXMubGV2ZWwgPSBhcmcubGV2ZWw7XG4gICAgICB0aGlzLnBhcmVudCA9IGFyZy5wYXJlbnQ7XG4gICAgfVxuICB9XG5cbiAgaGFzQ29sdW1uRGF0YShjb2x1bW5BdHRyOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4gVXRpbC5pc0RlZmluZWQodGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXSk7XG4gIH1cblxuICBoYXNBY3RpdmVBZ2dyZWdhdGUoY29sdW1uQXR0cjogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaGFzQ29sdW1uRGF0YShjb2x1bW5BdHRyKSAmJiBVdGlsLmlzRGVmaW5lZCh0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdLmFjdGl2ZUFnZ3JlZ2F0ZSk7XG4gIH1cblxuICBnZXRDb2x1bW5Hcm91cGluZ0NvbXBvbmVudChjb2x1bW5BdHRyOiBzdHJpbmcpOiBPVGFibGVDb2x1bW5zR3JvdXBpbmdDb2x1bW5Db21wb25lbnQge1xuICAgIHJldHVybiB0aGlzLmhhc0NvbHVtbkRhdGEoY29sdW1uQXR0cikgPyB0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdLmNvbXBvbmVudCA6IG51bGw7XG4gIH1cblxuICBnZXRDb2x1bW5BZ2dyZWdhdGVWYWx1ZShjb2x1bW5BdHRyOiBzdHJpbmcpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdLnZhbHVlO1xuICB9XG5cbiAgc2V0Q29sdW1uQWdncmVnYXRlVmFsdWUoY29sdW1uQXR0cjogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXS52YWx1ZSA9IHZhbHVlO1xuICB9XG5cbiAgZXhwYW5kU2FtZUxldmVsKGRlZmF1bHRWYWx1ZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5oYXNDb2x1bW5EYXRhKHRoaXMuY29sdW1uKSkge1xuICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICB9XG4gICAgY29uc3QgZ3JvdXBpbmdDb21wb25lbnQgPSB0aGlzLmdldENvbHVtbkdyb3VwaW5nQ29tcG9uZW50KHRoaXMuY29sdW1uKTtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQoZ3JvdXBpbmdDb21wb25lbnQpKSB7XG4gICAgICByZXR1cm4gZ3JvdXBpbmdDb21wb25lbnQuZXhwYW5kR3JvdXBzU2FtZUxldmVsO1xuICAgIH1cbiAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xuICB9XG5cbiAgc2V0Q29sdW1uQWdncmVnYXRlRGF0YShjb2x1bW5BdHRyOiBzdHJpbmcsIHZhbHVlOiBhbnlbXSkge1xuICAgIGlmICh0aGlzLmhhc0NvbHVtbkRhdGEoY29sdW1uQXR0cikpIHtcbiAgICAgIHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uZGF0YSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIGdldENvbHVtbkFnZ3JlZ2F0ZURhdGEoY29sdW1uQXR0cjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuaGFzQ29sdW1uRGF0YShjb2x1bW5BdHRyKSA/IHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uZGF0YSA6IFtdO1xuICB9XG5cbiAgc2V0Q29sdW1uQWN0aXZlQWdncmVnYXRlRnVuY3Rpb24oY29sdW1uQXR0cjogc3RyaW5nLCBhZ2dyZWdhdGVGbk5hbWU6IHN0cmluZywgZW1pdEV2ZW50OiBib29sZWFuID0gdHJ1ZSkge1xuICAgIGlmICh0aGlzLmhhc0NvbHVtbkRhdGEoY29sdW1uQXR0cikpIHtcbiAgICAgIHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uYWN0aXZlQWdncmVnYXRlID0gYWdncmVnYXRlRm5OYW1lO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdID0ge1xuICAgICAgICBjb21wb25lbnQ6IG51bGwsXG4gICAgICAgIGFjdGl2ZUFnZ3JlZ2F0ZTogYWdncmVnYXRlRm5OYW1lLFxuICAgICAgICB2YWx1ZTogbnVsbCxcbiAgICAgICAgZGF0YTogW11cbiAgICAgIH07XG4gICAgfVxuICAgIGlmIChlbWl0RXZlbnQpIHtcbiAgICAgIGxldCBjaGFuZ2VBbGxHcm91cGVkUm93cyA9IHRydWU7XG4gICAgICBjb25zdCBncm91cGluZ0NvbXBvbmVudCA9IHRoaXMuZ2V0Q29sdW1uR3JvdXBpbmdDb21wb25lbnQoY29sdW1uQXR0cik7XG4gICAgICBpZiAoVXRpbC5pc0RlZmluZWQoZ3JvdXBpbmdDb21wb25lbnQpKSB7XG4gICAgICAgIGNoYW5nZUFsbEdyb3VwZWRSb3dzID0gZ3JvdXBpbmdDb21wb25lbnQuY2hhbmdlQWdncmVnYXRlU2FtZUxldmVsO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmFnZ3JlZ2F0ZUZ1bmN0aW9uQ2hhbmdlLm5leHQoe1xuICAgICAgICBjb2x1bW5BdHRyOiBjb2x1bW5BdHRyLFxuICAgICAgICBhY3RpdmVBZ2dyZWdhdGU6IGFnZ3JlZ2F0ZUZuTmFtZSxcbiAgICAgICAgY2hhbmdlQWxsR3JvdXBlZFJvd3M6IGNoYW5nZUFsbEdyb3VwZWRSb3dzLFxuICAgICAgICByb3c6IHRoaXNcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGdldENvbHVtbkFjdGl2ZUFnZ3JlZ2F0ZVRpdGxlKGNvbHVtbkF0dHI6IHN0cmluZykge1xuICAgIGNvbnN0IGNvbmYgPSB0aGlzLmdldEFjdGl2ZUNvbHVtbkFnZ3JlZ2F0ZUNvbmZpZ3VyYXRpb24oY29sdW1uQXR0cik7XG4gICAgaWYgKGNvbmYudGl0bGUpIHtcbiAgICAgIHJldHVybiBjb25mLnRpdGxlO1xuICAgIH1cbiAgICByZXR1cm4gYEFHR1JFR0FURV9OQU1FLiR7Y29uZi5hZ2dyZWdhdGVOYW1lIHx8IGNvbmYuYWdncmVnYXRlfWA7XG4gIH1cblxuICBpbml0aWFsaXplQ29sdW1uQWdncmVnYXRlKGNvbHVtbkF0dHI6IHN0cmluZywgY29tcG9uZW50OiBPVGFibGVDb2x1bW5zR3JvdXBpbmdDb2x1bW5Db21wb25lbnQpIHtcbiAgICBpZiAoIXRoaXMuY29sdW1uc0RhdGEuaGFzT3duUHJvcGVydHkoY29sdW1uQXR0cikpIHtcbiAgICAgIHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0gPSB7XG4gICAgICAgIGNvbXBvbmVudDogbnVsbCxcbiAgICAgICAgYWN0aXZlQWdncmVnYXRlOiAnc3VtJyxcbiAgICAgICAgdmFsdWU6IG51bGwsXG4gICAgICAgIGRhdGE6IFtdXG4gICAgICB9O1xuICAgIH1cbiAgICBpZiAoVXRpbC5pc0RlZmluZWQoY29tcG9uZW50KSkge1xuICAgICAgdGhpcy5jb2x1bW5zRGF0YVtjb2x1bW5BdHRyXS5jb21wb25lbnQgPSBjb21wb25lbnQ7XG4gICAgICB0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdLmFjdGl2ZUFnZ3JlZ2F0ZSA9IGNvbXBvbmVudC5hZ2dyZWdhdGU7XG4gICAgfVxuICB9XG5cbiAgZ2V0QWN0aXZlQ29sdW1uQWdncmVnYXRlQ29uZmlndXJhdGlvbihjb2x1bW5BdHRyOiBzdHJpbmcpOiBHcm91cGVkQ29sdW1uQWdncmVnYXRlQ29uZmlndXJhdGlvbiB7XG4gICAgaWYgKCF0aGlzLmhhc0NvbHVtbkRhdGEoY29sdW1uQXR0cikpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGF0dHI6IGNvbHVtbkF0dHIsXG4gICAgICAgIGFnZ3JlZ2F0ZTogJ3N1bSdcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBhY3RpdmVBZ2dyZWdhdGUgPSB0aGlzLmNvbHVtbnNEYXRhW2NvbHVtbkF0dHJdLmFjdGl2ZUFnZ3JlZ2F0ZTtcbiAgICBjb25zdCBncm91cGluZ0NvbHVtbkNvbXBvbmVudCA9IHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uY29tcG9uZW50O1xuICAgIGlmIChVdGlsLmlzRGVmaW5lZChncm91cGluZ0NvbHVtbkNvbXBvbmVudCkgJiYgZ3JvdXBpbmdDb2x1bW5Db21wb25lbnQuYWdncmVnYXRlID09PSBhY3RpdmVBZ2dyZWdhdGUpIHtcbiAgICAgIHJldHVybiBncm91cGluZ0NvbHVtbkNvbXBvbmVudC5nZXRBZ2dyZWdhdGVDb25maWd1cmF0aW9uKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGF0dHI6IGNvbHVtbkF0dHIsXG4gICAgICBhZ2dyZWdhdGU6IHRoaXMuY29sdW1uc0RhdGFbY29sdW1uQXR0cl0uYWN0aXZlQWdncmVnYXRlXG4gICAgfVxuICB9XG5cbn1cbiJdfQ==