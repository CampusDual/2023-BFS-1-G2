import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, forwardRef, Inject, Injector, Input, Optional, Output, ViewChild, ViewEncapsulation } from '@angular/core';
import * as lpn from 'google-libphonenumber';
import { Codes } from '../../../util/codes';
import { Util } from '../../../util/util';
import { OValidators } from '../../../validators/o-validators';
import { OFormValue } from '../../form/o-form-value';
import { OFormComponent } from '../../form/o-form.component';
import { DEFAULT_INPUTS_O_FORM_DATA_COMPONENT, DEFAULT_OUTPUTS_O_FORM_DATA_COMPONENT, OFormDataComponent } from '../../o-form-data-component.class';
import { CountryCode } from './data/country-code';
import { CountryISO } from './enums/country-iso.enum';
import { PhoneNumberFormat } from './enums/phone-number-format.enum';
export var DEFAULT_INPUTS_O_PHONE_INPUT = tslib_1.__spread(DEFAULT_INPUTS_O_FORM_DATA_COMPONENT, [
    'gap'
]);
export var DEFAULT_OUTPUTS_O_PHONE_INPUT = tslib_1.__spread(DEFAULT_OUTPUTS_O_FORM_DATA_COMPONENT);
var PHONE_PREFIX = '+';
var OPhoneInputComponent = (function (_super) {
    tslib_1.__extends(OPhoneInputComponent, _super);
    function OPhoneInputComponent(countryCodeData, form, elRef, injector) {
        var _this = _super.call(this, form, elRef, injector) || this;
        _this.countryCodeData = countryCodeData;
        _this.countries = [];
        _this.countryChange = new EventEmitter();
        _this.onPhoneDataChange = new EventEmitter();
        _this.gap = '14px';
        _this._selectedCountry = {
            areaCodes: undefined,
            dialCode: '',
            htmlId: '',
            flagClass: '',
            iso2: '',
            name: '',
            placeHolder: '',
            priority: 0,
        };
        _this.allCountries = [];
        _this.states = CountryISO;
        _this.selectedStates = _this.states;
        _this.phoneUtil = lpn.PhoneNumberUtil.getInstance();
        _this.separateDialCode = true;
        _this.numberFormat = PhoneNumberFormat.International;
        _this.fetchCountryData();
        return _this;
    }
    Object.defineProperty(OPhoneInputComponent.prototype, "selectedCountry", {
        get: function () {
            return this._selectedCountry;
        },
        set: function (value) {
            this._selectedCountry = value;
            this.placeHolder = this.resolvePlaceholder();
        },
        enumerable: true,
        configurable: true
    });
    OPhoneInputComponent.prototype.initialize = function () {
        this.initializeCountryData();
        _super.prototype.initialize.call(this);
        var formControl = this.getFormControl();
        if (formControl) {
            var self_1 = this;
            formControl.getValue = function () {
                if (this.value && this.value.length > 0 && self_1.selectedCountry && self_1.selectedCountry.dialCode) {
                    return "+" + self_1.selectedCountry.dialCode + " " + this.value;
                }
                return undefined;
            };
        }
    };
    OPhoneInputComponent.prototype.ngAfterViewInit = function () {
        _super.prototype.ngAfterViewInit.call(this);
        if (this.oInputsOptions.iconColor === Codes.O_INPUTS_OPTIONS_COLOR_ACCENT) {
            var matFormFieldEL = this.elRef.nativeElement.getElementsByTagName('mat-form-field')[1];
            if (Util.isDefined(matFormFieldEL)) {
                matFormFieldEL.classList.add('accent');
            }
        }
    };
    OPhoneInputComponent.prototype.addOntimizeCustomAppearanceClass = function () {
        try {
            if (this.elRef) {
                var matFormFieldEl = this.elRef.nativeElement.querySelectorAll('mat-form-field');
                matFormFieldEl.forEach(function (matForm) {
                    matForm.classList.add('mat-form-field-appearance-ontimize');
                });
            }
        }
        catch (e) {
        }
    };
    OPhoneInputComponent.prototype.getValue = function () {
        var formControl = this.getFormControl();
        if (formControl) {
            return formControl.getValue();
        }
        return _super.prototype.getValue.call(this);
    };
    OPhoneInputComponent.prototype.resolveValidators = function () {
        var _this = this;
        var validators = _super.prototype.resolveValidators.call(this);
        var createPhoneValidator = (function () {
            return OValidators.phoneValidator(_this.getFormControl(), _this.getSelectedCountryIso2());
        });
        validators.push(createPhoneValidator);
        return validators;
    };
    OPhoneInputComponent.prototype.onFormControlChange = function (value) {
        if (!this.value) {
            this.value = new OFormValue();
        }
        this.ensureOFormValue(value);
        this.ensurePhoneValue(value);
        this.onChange.emit(value);
    };
    OPhoneInputComponent.prototype.setFormValue = function (val, options, setDirty) {
        if (setDirty === void 0) { setDirty = false; }
        var _a = this.getSeparatedValues(val), countryDialCode = _a.countryDialCode, number = _a.number;
        var country = this.getCountryByDialCode(countryDialCode);
        var parsed = this.getParsedNumber(number, country ? country.iso2 : undefined);
        if (!Util.isDefined(parsed)) {
            number = undefined;
            country = undefined;
        }
        this.selectedCountry = country;
        this.ensureOFormValue(number);
        if (this._fControl) {
            this._fControl.setValue(this.value.value, options);
            if (setDirty) {
                this._fControl.markAsDirty();
            }
            if (this._fControl.invalid && !this.form.isInInsertMode()) {
                this._fControl.markAsTouched();
            }
        }
        this.oldValue = this.value.value;
    };
    OPhoneInputComponent.prototype.onCountrySelect = function (value) {
        var _this = this;
        var country = value.value;
        this.countryChange.emit(country);
        this.setValue(undefined);
        this.selectedCountry = country;
        if (this.matInputRef && this.matInputRef.nativeElement) {
            setTimeout(function () {
                _this.matInputRef.nativeElement.focus();
            }, 0);
        }
    };
    OPhoneInputComponent.prototype.innerOnBlur = function (event) {
        _super.prototype.innerOnBlur.call(this, event);
        if (this._fControl) {
            this._fControl.updateValueAndValidity({ emitEvent: false });
        }
    };
    OPhoneInputComponent.prototype.getSelectedCountryIso2 = function () {
        return this.selectedCountry ? this.selectedCountry.iso2 : undefined;
    };
    OPhoneInputComponent.prototype.initializeCountryData = function () {
        var _this = this;
        if (this.countries.length) {
            this.allCountries = this.allCountries.filter(function (c) { return _this.countries.includes(c.iso2); });
        }
    };
    OPhoneInputComponent.prototype.ensurePhoneValue = function (value) {
        var number = this.getParsedNumber(value, this.getSelectedCountryIso2());
        if (number) {
            var intlNo = number
                ? this.phoneUtil.format(number, lpn.PhoneNumberFormat.INTERNATIONAL)
                : '';
            if (intlNo) {
                this.value.value = this.removeDialCode(intlNo);
                this.emitPhoneInputData(intlNo, number);
            }
        }
    };
    OPhoneInputComponent.prototype.getCountryByDialCode = function (countryDialCode) {
        if (countryDialCode) {
            return this.sortCountries().find(function (c) { return c.dialCode === countryDialCode; });
        }
        return undefined;
    };
    OPhoneInputComponent.prototype.sortCountries = function () {
        return this.allCountries
            .sort(function (a, b) {
            return a.priority - b.priority;
        });
    };
    OPhoneInputComponent.prototype.getSeparatedValues = function (value) {
        var countryDialCode = '';
        var number = (value instanceof OFormValue ? value.value : value) || undefined;
        if (Util.isDefined(number) && number.startsWith(PHONE_PREFIX)) {
            countryDialCode = number.substr(1, number.indexOf(' ') - 1);
            number = number.substr(countryDialCode.length + 2);
        }
        return { countryDialCode: countryDialCode, number: number };
    };
    OPhoneInputComponent.prototype.emitPhoneInputData = function (intlNo, number) {
        var phoneInputData = undefined;
        var iso2 = this.getSelectedCountryIso2();
        if (intlNo && number && iso2) {
            phoneInputData = {
                number: this.value.value,
                internationalNumber: intlNo,
                nationalNumber: number
                    ? this.phoneUtil.format(number, lpn.PhoneNumberFormat.NATIONAL)
                    : '',
                e164Number: number
                    ? this.phoneUtil.format(number, lpn.PhoneNumberFormat.E164)
                    : '',
                countryCode: iso2.toUpperCase(),
                dialCode: PHONE_PREFIX + this.selectedCountry.dialCode,
            };
        }
        this.onPhoneDataChange.emit(phoneInputData);
    };
    OPhoneInputComponent.prototype.getParsedNumber = function (phoneNumber, countryCode) {
        var number;
        try {
            number = this.phoneUtil.parse(phoneNumber, countryCode.toUpperCase());
        }
        catch (e) { }
        return number;
    };
    OPhoneInputComponent.prototype.removeDialCode = function (phoneNumber) {
        var number = this.getParsedNumber(phoneNumber, this.getSelectedCountryIso2());
        phoneNumber = this.phoneUtil.format(number, lpn.PhoneNumberFormat[this.numberFormat]);
        if (phoneNumber.startsWith(PHONE_PREFIX) && this.separateDialCode) {
            phoneNumber = phoneNumber.substring(phoneNumber.indexOf(' ') + 1);
        }
        return phoneNumber;
    };
    OPhoneInputComponent.prototype.getCountryIsoCode = function (countryCode, number) {
        var rawNumber = number['values_']['2'].toString();
        var countries = this.allCountries.filter(function (c) { return c.dialCode === countryCode.toString(); });
        var mainCountry = countries.find(function (c) { return c.areaCodes === undefined; });
        var secondaryCountries = countries.filter(function (c) { return c.areaCodes !== undefined; });
        var matchedCountry = mainCountry ? mainCountry.iso2 : undefined;
        secondaryCountries.forEach(function (country) {
            country.areaCodes.forEach(function (areaCode) {
                if (rawNumber.startsWith(areaCode)) {
                    matchedCountry = country.iso2;
                }
            });
        });
        return matchedCountry;
    };
    OPhoneInputComponent.prototype.getPhoneNumberPlaceHolder = function (countryCode) {
        try {
            return this.phoneUtil.format(this.phoneUtil.getExampleNumber(countryCode), lpn.PhoneNumberFormat[this.numberFormat]);
        }
        catch (e) {
            return e;
        }
    };
    OPhoneInputComponent.prototype.fetchCountryData = function () {
        var _this = this;
        this.allCountries = [];
        this.countryCodeData.allCountries.forEach(function (c) {
            var country = {
                name: c[0].toString(),
                iso2: c[1].toString(),
                dialCode: c[2].toString(),
                priority: +c[3] || 0,
                areaCodes: c[4] || undefined,
                htmlId: "iti-0__item-" + c[1].toString(),
                flagClass: "iti__" + c[1].toString().toLocaleLowerCase(),
                placeHolder: '',
            };
            if (!_this.oplaceholder) {
                country.placeHolder = _this.getPhoneNumberPlaceHolder(country.iso2.toUpperCase());
            }
            _this.allCountries.push(country);
        });
    };
    OPhoneInputComponent.prototype.resolvePlaceholder = function () {
        var placeholder = '';
        if (this.selectedCountry && this.selectedCountry.placeHolder && this.selectedCountry.placeHolder.length > 0) {
            placeholder = this.selectedCountry.placeHolder;
            if (this.separateDialCode) {
                placeholder = this.removeDialCode(placeholder);
            }
        }
        return placeholder;
    };
    OPhoneInputComponent.decorators = [
        { type: Component, args: [{
                    selector: 'o-phone-input',
                    template: "<div [formGroup]=\"getFormGroup()\" fxLayout=\"row wrap\" [fxLayoutGap]=\"gap +' grid'\">\n  <mat-form-field class=\"mat-form-phone\" [floatLabel]=\"floatLabel\" [appearance]=\"appearance\" [class.read-only]=\"isReadOnly\" fxFlex.xs>\n    <mat-label *ngIf=\"labelVisible\">{{ olabel | oTranslate }}</mat-label>\n    <mat-select [value]=\"selectedCountry\" (selectionChange)=\"onCountrySelect($event)\" [disabled]=\"!enabled\">\n      <mat-option *ngFor=\"let country of allCountries\" [value]=\"country\"> {{country.name}} +{{country.dialCode}}</mat-option>\n    </mat-select>\n  </mat-form-field>\n  <mat-form-field [hideRequiredMarker]=\"hideRequiredMarker\" [class.custom-width]=\"hasCustomWidth\" class=\"icon-field\" [appearance]=\"appearance\"\n    fxFlex>\n    <input #matInputRef matInput type=\"tel\" [id]=\"getAttribute()\" [formControlName]=\"getAttribute()\" [placeholder]=\"placeHolder\"\n      (focus)=\"innerOnFocus($event)\" (blur)=\"innerOnBlur($event)\" [readonly]=\"isReadOnly\" (change)=\"onChangeEvent($event)\" [required]=\"isRequired\">\n    <button type=\"button\" *ngIf=\"showClearButton\" matSuffix mat-icon-button (click)=\"onClickClearValue($event)\">\n      <mat-icon svgIcon=\"ontimize:close\"></mat-icon>\n    </button>\n    <mat-icon matSuffix [class.mat-disabled]=\"!enabled\" class=\"svg-icon\" svgIcon=\"ontimize:phone_outline\"></mat-icon>\n    <mat-error *oMatError=\"hasError('required')\">\n      {{ 'FORM_VALIDATION.REQUIRED' | oTranslate }}\n    </mat-error>\n    <mat-error *oMatError=\"hasError('validatePhoneNumber')\">\n      {{ 'FORM_VALIDATION.PHONE_FORMAT' | oTranslate }}\n    </mat-error>\n    <mat-error *ngFor=\"let oError of getActiveOErrors()\">\n      {{ oError.text | oTranslate }}\n    </mat-error>\n  </mat-form-field>\n</div>",
                    inputs: DEFAULT_INPUTS_O_PHONE_INPUT,
                    outputs: DEFAULT_OUTPUTS_O_PHONE_INPUT,
                    encapsulation: ViewEncapsulation.None,
                    providers: [CountryCode],
                    host: {
                        '[class.o-phone-input]': 'true'
                    },
                    styles: [".o-phone-input{overflow:hidden}.o-phone-input .read-only{pointer-events:none}.o-phone-input .read-only .mat-select-arrow-wrapper{visibility:hidden}.o-phone-input .read-only .mat-form-field-underline{background-image:none}.o-phone-input .mat-form-field.icon-field{height:100%}"]
                }] }
    ];
    OPhoneInputComponent.ctorParameters = function () { return [
        { type: CountryCode },
        { type: OFormComponent, decorators: [{ type: Optional }, { type: Inject, args: [forwardRef(function () { return OFormComponent; }),] }] },
        { type: ElementRef },
        { type: Injector }
    ]; };
    OPhoneInputComponent.propDecorators = {
        countries: [{ type: Input }],
        countryChange: [{ type: Output }],
        onPhoneDataChange: [{ type: Output }],
        countryList: [{ type: ViewChild, args: ['countryList', { static: false },] }],
        matInputRef: [{ type: ViewChild, args: ['matInputRef', { read: ElementRef, static: true },] }]
    };
    return OPhoneInputComponent;
}(OFormDataComponent));
export { OPhoneInputComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby1waG9uZS1pbnB1dC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvaW5wdXQvcGhvbmUtaW5wdXQvby1waG9uZS1pbnB1dC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixVQUFVLEVBQ1YsTUFBTSxFQUNOLFFBQVEsRUFDUixLQUFLLEVBRUwsUUFBUSxFQUNSLE1BQU0sRUFDTixTQUFTLEVBQ1QsaUJBQWlCLEVBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBR3ZCLE9BQU8sS0FBSyxHQUFHLE1BQU0sdUJBQXVCLENBQUM7QUFHN0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsb0NBQW9DLEVBQ3BDLHFDQUFxQyxFQUNyQyxrQkFBa0IsRUFDbkIsTUFBTSxtQ0FBbUMsQ0FBQztBQUUzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBSXJFLE1BQU0sQ0FBQyxJQUFNLDRCQUE0QixvQkFDcEMsb0NBQW9DO0lBRXZDLEtBQUs7RUFDTixDQUFDO0FBRUYsTUFBTSxDQUFDLElBQU0sNkJBQTZCLG9CQUNyQyxxQ0FBcUMsQ0FDekMsQ0FBQztBQUVGLElBQU0sWUFBWSxHQUFHLEdBQUcsQ0FBQTtBQUV4QjtJQVkwQyxnREFBa0I7SUF1QzFELDhCQUNVLGVBQTRCLEVBQ2tCLElBQW9CLEVBQzFFLEtBQWlCLEVBQ2pCLFFBQWtCO1FBSnBCLFlBTUUsa0JBQU0sSUFBSSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsU0FFN0I7UUFQUyxxQkFBZSxHQUFmLGVBQWUsQ0FBYTtRQXZDN0IsZUFBUyxHQUFrQixFQUFFLENBQUM7UUFDcEIsbUJBQWEsR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO1FBQzVDLHVCQUFpQixHQUFHLElBQUksWUFBWSxFQUFtQixDQUFDO1FBSXBFLFNBQUcsR0FBRyxNQUFNLENBQUM7UUFFcEIsc0JBQWdCLEdBQVk7WUFDMUIsU0FBUyxFQUFFLFNBQVM7WUFDcEIsUUFBUSxFQUFFLEVBQUU7WUFDWixNQUFNLEVBQUUsRUFBRTtZQUNWLFNBQVMsRUFBRSxFQUFFO1lBQ2IsSUFBSSxFQUFFLEVBQUU7WUFDUixJQUFJLEVBQUUsRUFBRTtZQUNSLFdBQVcsRUFBRSxFQUFFO1lBQ2YsUUFBUSxFQUFFLENBQUM7U0FDWixDQUFDO1FBV0Ysa0JBQVksR0FBbUIsRUFBRSxDQUFDO1FBRWxDLFlBQU0sR0FBRyxVQUFVLENBQUM7UUFDcEIsb0JBQWMsR0FBRyxLQUFJLENBQUMsTUFBTSxDQUFDO1FBR25CLGVBQVMsR0FBUSxHQUFHLENBQUMsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25ELHNCQUFnQixHQUFHLElBQUksQ0FBQztRQUN4QixrQkFBWSxHQUFzQixpQkFBaUIsQ0FBQyxhQUFhLENBQUM7UUFTMUUsS0FBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7O0lBQzFCLENBQUM7SUEzQkQsc0JBQUksaURBQWU7YUFLbkI7WUFDRSxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUMvQixDQUFDO2FBUEQsVUFBb0IsS0FBYztZQUNoQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO1lBQzlCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDL0MsQ0FBQzs7O09BQUE7SUEwQkQseUNBQVUsR0FBVjtRQUNFLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzdCLGlCQUFNLFVBQVUsV0FBRSxDQUFDO1FBQ25CLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLEVBQWtCLENBQUM7UUFDMUQsSUFBSSxXQUFXLEVBQUU7WUFDZixJQUFNLE1BQUksR0FBRyxJQUFJLENBQUM7WUFDbEIsV0FBVyxDQUFDLFFBQVEsR0FBRztnQkFDckIsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxNQUFJLENBQUMsZUFBZSxJQUFJLE1BQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFO29CQUNoRyxPQUFPLE1BQUksTUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLFNBQUksSUFBSSxDQUFDLEtBQU8sQ0FBQztpQkFDMUQ7Z0JBQ0QsT0FBTyxTQUFTLENBQUM7WUFDbkIsQ0FBQyxDQUFDO1NBQ0g7SUFDSCxDQUFDO0lBRU0sOENBQWUsR0FBdEI7UUFDRSxpQkFBTSxlQUFlLFdBQUUsQ0FBQztRQUN4QixJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxLQUFLLEtBQUssQ0FBQyw2QkFBNkIsRUFBRTtZQUN6RSxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFGLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsRUFBRTtnQkFDbEMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDeEM7U0FDRjtJQUNILENBQUM7SUFFUywrREFBZ0MsR0FBMUM7UUFDRSxJQUFJO1lBQ0YsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO2dCQUNkLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixDQUFDLENBQUM7Z0JBQ25GLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBQSxPQUFPO29CQUM1QixPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO2dCQUM5RCxDQUFDLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFBQyxPQUFPLENBQUMsRUFBRTtTQUVYO0lBQ0gsQ0FBQztJQUVNLHVDQUFRLEdBQWY7UUFDRSxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFrQixDQUFDO1FBQzFELElBQUksV0FBVyxFQUFFO1lBQ2YsT0FBTyxXQUFXLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDL0I7UUFDRCxPQUFPLGlCQUFNLFFBQVEsV0FBRSxDQUFDO0lBQzFCLENBQUM7SUFFRCxnREFBaUIsR0FBakI7UUFBQSxpQkFPQztRQU5DLElBQU0sVUFBVSxHQUFrQixpQkFBTSxpQkFBaUIsV0FBRSxDQUFDO1FBQzVELElBQU0sb0JBQW9CLEdBQUcsQ0FBQztZQUM1QixPQUFPLFdBQVcsQ0FBQyxjQUFjLENBQUMsS0FBSSxDQUFDLGNBQWMsRUFBRSxFQUFFLEtBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUM7UUFDMUYsQ0FBQyxDQUFDLENBQUM7UUFDSCxVQUFVLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDdEMsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVELGtEQUFtQixHQUFuQixVQUFvQixLQUFVO1FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2YsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO1NBQy9CO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBRVMsMkNBQVksR0FBdEIsVUFBdUIsR0FBUSxFQUFFLE9BQTBCLEVBQUUsUUFBeUI7UUFBekIseUJBQUEsRUFBQSxnQkFBeUI7UUFDaEYsSUFBQSxpQ0FBMEQsRUFBeEQsb0NBQWUsRUFBRSxrQkFBdUMsQ0FBQztRQUMvRCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDekQsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNoRixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUMzQixNQUFNLEdBQUcsU0FBUyxDQUFDO1lBQ25CLE9BQU8sR0FBRyxTQUFTLENBQUM7U0FDckI7UUFDRCxJQUFJLENBQUMsZUFBZSxHQUFHLE9BQU8sQ0FBQztRQUMvQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUIsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ25ELElBQUksUUFBUSxFQUFFO2dCQUNaLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDOUI7WUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRTtnQkFDekQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUNoQztTQUNGO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztJQUNuQyxDQUFDO0lBRUQsOENBQWUsR0FBZixVQUFnQixLQUFzQjtRQUF0QyxpQkFVQztRQVRDLElBQU0sT0FBTyxHQUFZLEtBQUssQ0FBQyxLQUFLLENBQUE7UUFDcEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsZUFBZSxHQUFHLE9BQU8sQ0FBQztRQUMvQixJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUU7WUFDdEQsVUFBVSxDQUFDO2dCQUNULEtBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3pDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtTQUNOO0lBQ0gsQ0FBQztJQUVNLDBDQUFXLEdBQWxCLFVBQW1CLEtBQVU7UUFDM0IsaUJBQU0sV0FBVyxZQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pCLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLHNCQUFzQixDQUFDLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDN0Q7SUFDSCxDQUFDO0lBRVMscURBQXNCLEdBQWhDO1FBQ0UsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ3RFLENBQUM7SUFFUyxvREFBcUIsR0FBL0I7UUFBQSxpQkFJQztRQUhDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDekIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxVQUFDLENBQUMsSUFBSyxPQUFBLEtBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBL0IsQ0FBK0IsQ0FBQyxDQUFDO1NBQ3RGO0lBQ0gsQ0FBQztJQUVTLCtDQUFnQixHQUExQixVQUEyQixLQUFVO1FBQ25DLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUM7UUFDMUUsSUFBSSxNQUFNLEVBQUU7WUFDVixJQUFNLE1BQU0sR0FBRyxNQUFNO2dCQUNuQixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUM7Z0JBQ3BFLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDUCxJQUFJLE1BQU0sRUFBRTtnQkFDVixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUMvQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2FBQ3pDO1NBQ0Y7SUFDSCxDQUFDO0lBRVMsbURBQW9CLEdBQTlCLFVBQStCLGVBQW9CO1FBQ2pELElBQUksZUFBZSxFQUFFO1lBQ25CLE9BQU8sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUMsSUFBSyxPQUFBLENBQUMsQ0FBQyxRQUFRLEtBQUssZUFBZSxFQUE5QixDQUE4QixDQUFDLENBQUM7U0FDekU7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBQ1MsNENBQWEsR0FBdkI7UUFDRSxPQUFPLElBQUksQ0FBQyxZQUFZO2FBQ3JCLElBQUksQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDO1lBQ1QsT0FBTyxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUM7UUFDakMsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBQ1MsaURBQWtCLEdBQTVCLFVBQTZCLEtBQVU7UUFDckMsSUFBSSxlQUFlLEdBQUcsRUFBRSxDQUFBO1FBQ3hCLElBQUksTUFBTSxHQUFHLENBQUMsS0FBSyxZQUFZLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksU0FBUyxDQUFBO1FBQzdFLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQzdELGVBQWUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzVELE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDcEQ7UUFDRCxPQUFPLEVBQUUsZUFBZSxpQkFBQSxFQUFFLE1BQU0sUUFBQSxFQUFFLENBQUE7SUFDcEMsQ0FBQztJQUVTLGlEQUFrQixHQUE1QixVQUE2QixNQUFlLEVBQUUsTUFBZTtRQUMzRCxJQUFJLGNBQWMsR0FBb0IsU0FBUyxDQUFDO1FBQ2hELElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQzNDLElBQUksTUFBTSxJQUFJLE1BQU0sSUFBSSxJQUFJLEVBQUU7WUFDNUIsY0FBYyxHQUFHO2dCQUNmLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUs7Z0JBQ3hCLG1CQUFtQixFQUFFLE1BQU07Z0JBQzNCLGNBQWMsRUFBRSxNQUFNO29CQUNwQixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUM7b0JBQy9ELENBQUMsQ0FBQyxFQUFFO2dCQUNOLFVBQVUsRUFBRSxNQUFNO29CQUNoQixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUM7b0JBQzNELENBQUMsQ0FBQyxFQUFFO2dCQUNOLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFO2dCQUMvQixRQUFRLEVBQUUsWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUTthQUN2RCxDQUFBO1NBQ0Y7UUFDRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFRTyw4Q0FBZSxHQUF2QixVQUNFLFdBQW1CLEVBQ25CLFdBQW1CO1FBRW5CLElBQUksTUFBdUIsQ0FBQztRQUM1QixJQUFJO1lBQ0YsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztTQUN2RTtRQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUc7UUFDZixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBTU8sNkNBQWMsR0FBdEIsVUFBdUIsV0FBbUI7UUFDeEMsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUMsQ0FBQztRQUNoRixXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQ2pDLE1BQU0sRUFDTixHQUFHLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUN6QyxDQUFDO1FBQ0YsSUFBSSxXQUFXLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtZQUNqRSxXQUFXLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ25FO1FBQ0QsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQVFPLGdEQUFpQixHQUF6QixVQUNFLFdBQW1CLEVBQ25CLE1BQXVCO1FBR3ZCLElBQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUVwRCxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FDeEMsVUFBQyxDQUFDLElBQUssT0FBQSxDQUFDLENBQUMsUUFBUSxLQUFLLFdBQVcsQ0FBQyxRQUFRLEVBQUUsRUFBckMsQ0FBcUMsQ0FDN0MsQ0FBQztRQUVGLElBQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLElBQUssT0FBQSxDQUFDLENBQUMsU0FBUyxLQUFLLFNBQVMsRUFBekIsQ0FBeUIsQ0FBQyxDQUFDO1FBRXJFLElBQU0sa0JBQWtCLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFDLENBQUMsSUFBSyxPQUFBLENBQUMsQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUF6QixDQUF5QixDQUFDLENBQUM7UUFDOUUsSUFBSSxjQUFjLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFNaEUsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFVBQUMsT0FBTztZQUNqQyxPQUFPLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQVE7Z0JBQ2pDLElBQUksU0FBUyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRTtvQkFDbEMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7aUJBQy9CO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFNUyx3REFBeUIsR0FBbkMsVUFBb0MsV0FBbUI7UUFDckQsSUFBSTtZQUNGLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQzFCLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLEVBQzVDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQ3pDLENBQUM7U0FDSDtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsT0FBTyxDQUFDLENBQUM7U0FDVjtJQUNILENBQUM7SUFLUywrQ0FBZ0IsR0FBMUI7UUFBQSxpQkFxQkM7UUFwQkMsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7UUFFdkIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQUMsQ0FBQztZQUMxQyxJQUFNLE9BQU8sR0FBWTtnQkFDdkIsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUU7Z0JBQ3JCLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO2dCQUNyQixRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRTtnQkFDekIsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ3BCLFNBQVMsRUFBRyxDQUFDLENBQUMsQ0FBQyxDQUFjLElBQUksU0FBUztnQkFDMUMsTUFBTSxFQUFFLGlCQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUk7Z0JBQ3hDLFNBQVMsRUFBRSxVQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxpQkFBaUIsRUFBSTtnQkFDeEQsV0FBVyxFQUFFLEVBQUU7YUFDaEIsQ0FBQztZQUNGLElBQUksQ0FBQyxLQUFJLENBQUMsWUFBWSxFQUFFO2dCQUN0QixPQUFPLENBQUMsV0FBVyxHQUFHLEtBQUksQ0FBQyx5QkFBeUIsQ0FDbEQsT0FBTyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FDM0IsQ0FBQzthQUNIO1lBQ0QsS0FBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8saURBQWtCLEdBQTFCO1FBRUUsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzNHLFdBQVcsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQztZQUMvQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDekIsV0FBVyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDaEQ7U0FDRjtRQUNELE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7O2dCQWhXRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLGVBQWU7b0JBQ3pCLG93REFBNkM7b0JBRTdDLE1BQU0sRUFBRSw0QkFBNEI7b0JBQ3BDLE9BQU8sRUFBRSw2QkFBNkI7b0JBQ3RDLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJO29CQUNyQyxTQUFTLEVBQUUsQ0FBQyxXQUFXLENBQUM7b0JBQ3hCLElBQUksRUFBRTt3QkFDSix1QkFBdUIsRUFBRSxNQUFNO3FCQUNoQzs7aUJBQ0Y7OztnQkE3QlEsV0FBVztnQkFQWCxjQUFjLHVCQThFbEIsUUFBUSxZQUFJLE1BQU0sU0FBQyxVQUFVLENBQUMsY0FBTSxPQUFBLGNBQWMsRUFBZCxDQUFjLENBQUM7Z0JBbkd0RCxVQUFVO2dCQUlWLFFBQVE7Ozs0QkF1RFAsS0FBSztnQ0FDTCxNQUFNO29DQUNOLE1BQU07OEJBRU4sU0FBUyxTQUFDLGFBQWEsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7OEJBQzFDLFNBQVMsU0FBQyxhQUFhLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7O0lBK1U5RCwyQkFBQztDQUFBLEFBaldELENBWTBDLGtCQUFrQixHQXFWM0Q7U0FyVlksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIGZvcndhcmRSZWYsXG4gIEluamVjdCxcbiAgSW5qZWN0b3IsXG4gIElucHV0LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBPdXRwdXQsXG4gIFZpZXdDaGlsZCxcbiAgVmlld0VuY2Fwc3VsYXRpb25cbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBWYWxpZGF0b3JGbiB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IE1hdFNlbGVjdENoYW5nZSB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcbmltcG9ydCAqIGFzIGxwbiBmcm9tICdnb29nbGUtbGlicGhvbmVudW1iZXInO1xuXG5pbXBvcnQgeyBGb3JtVmFsdWVPcHRpb25zIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMvZm9ybS12YWx1ZS1vcHRpb25zLnR5cGUnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuLi8uLi8uLi91dGlsL2NvZGVzJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi8uLi91dGlsL3V0aWwnO1xuaW1wb3J0IHsgT1ZhbGlkYXRvcnMgfSBmcm9tICcuLi8uLi8uLi92YWxpZGF0b3JzL28tdmFsaWRhdG9ycyc7XG5pbXBvcnQgeyBPRm9ybVZhbHVlIH0gZnJvbSAnLi4vLi4vZm9ybS9vLWZvcm0tdmFsdWUnO1xuaW1wb3J0IHsgT0Zvcm1Db21wb25lbnQgfSBmcm9tICcuLi8uLi9mb3JtL28tZm9ybS5jb21wb25lbnQnO1xuaW1wb3J0IHtcbiAgREVGQVVMVF9JTlBVVFNfT19GT1JNX0RBVEFfQ09NUE9ORU5ULFxuICBERUZBVUxUX09VVFBVVFNfT19GT1JNX0RBVEFfQ09NUE9ORU5ULFxuICBPRm9ybURhdGFDb21wb25lbnRcbn0gZnJvbSAnLi4vLi4vby1mb3JtLWRhdGEtY29tcG9uZW50LmNsYXNzJztcbmltcG9ydCB7IE9Gb3JtQ29udHJvbCB9IGZyb20gJy4uL28tZm9ybS1jb250cm9sLmNsYXNzJztcbmltcG9ydCB7IENvdW50cnlDb2RlIH0gZnJvbSAnLi9kYXRhL2NvdW50cnktY29kZSc7XG5pbXBvcnQgeyBDb3VudHJ5SVNPIH0gZnJvbSAnLi9lbnVtcy9jb3VudHJ5LWlzby5lbnVtJztcbmltcG9ydCB7IFBob25lTnVtYmVyRm9ybWF0IH0gZnJvbSAnLi9lbnVtcy9waG9uZS1udW1iZXItZm9ybWF0LmVudW0nO1xuaW1wb3J0IHsgT1Bob25lSW5wdXREYXRhIH0gZnJvbSAnLi9pbnRlcmZhY2VzL2NoYW5nZS1kYXRhJztcbmltcG9ydCB7IENvdW50cnkgfSBmcm9tICcuL21vZGVsL2NvdW50cnkubW9kZWwnO1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9JTlBVVFNfT19QSE9ORV9JTlBVVCA9IFtcbiAgLi4uREVGQVVMVF9JTlBVVFNfT19GT1JNX0RBVEFfQ09NUE9ORU5ULFxuICAvL2dhcDogU3BlY2lmeSBnYXAgYmV0d2VlbiBmaWVsZHMgaW4gcHhcbiAgJ2dhcCdcbl07XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX09VVFBVVFNfT19QSE9ORV9JTlBVVCA9IFtcbiAgLi4uREVGQVVMVF9PVVRQVVRTX09fRk9STV9EQVRBX0NPTVBPTkVOVFxuXTtcblxuY29uc3QgUEhPTkVfUFJFRklYID0gJysnXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ28tcGhvbmUtaW5wdXQnLFxuICB0ZW1wbGF0ZVVybDogJy4vby1waG9uZS1pbnB1dC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL28tcGhvbmUtaW5wdXQuY29tcG9uZW50LnNjc3MnXSxcbiAgaW5wdXRzOiBERUZBVUxUX0lOUFVUU19PX1BIT05FX0lOUFVULFxuICBvdXRwdXRzOiBERUZBVUxUX09VVFBVVFNfT19QSE9ORV9JTlBVVCxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbiAgcHJvdmlkZXJzOiBbQ291bnRyeUNvZGVdLFxuICBob3N0OiB7XG4gICAgJ1tjbGFzcy5vLXBob25lLWlucHV0XSc6ICd0cnVlJ1xuICB9XG59KVxuZXhwb3J0IGNsYXNzIE9QaG9uZUlucHV0Q29tcG9uZW50IGV4dGVuZHMgT0Zvcm1EYXRhQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcbiAgQElucHV0KCkgY291bnRyaWVzOiBBcnJheTxzdHJpbmc+ID0gW107XG4gIEBPdXRwdXQoKSByZWFkb25seSBjb3VudHJ5Q2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxDb3VudHJ5PigpO1xuICBAT3V0cHV0KCkgcmVhZG9ubHkgb25QaG9uZURhdGFDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPE9QaG9uZUlucHV0RGF0YT4oKTtcblxuICBAVmlld0NoaWxkKCdjb3VudHJ5TGlzdCcsIHsgc3RhdGljOiBmYWxzZSB9KSBjb3VudHJ5TGlzdDogRWxlbWVudFJlZjtcbiAgQFZpZXdDaGlsZCgnbWF0SW5wdXRSZWYnLCB7IHJlYWQ6IEVsZW1lbnRSZWYsIHN0YXRpYzogdHJ1ZSB9KSBwcml2YXRlIG1hdElucHV0UmVmITogRWxlbWVudFJlZjtcbiAgcHVibGljIGdhcCA9ICcxNHB4JztcblxuICBfc2VsZWN0ZWRDb3VudHJ5OiBDb3VudHJ5ID0ge1xuICAgIGFyZWFDb2RlczogdW5kZWZpbmVkLFxuICAgIGRpYWxDb2RlOiAnJyxcbiAgICBodG1sSWQ6ICcnLFxuICAgIGZsYWdDbGFzczogJycsXG4gICAgaXNvMjogJycsXG4gICAgbmFtZTogJycsXG4gICAgcGxhY2VIb2xkZXI6ICcnLFxuICAgIHByaW9yaXR5OiAwLFxuICB9O1xuXG4gIHNldCBzZWxlY3RlZENvdW50cnkodmFsdWU6IENvdW50cnkpIHtcbiAgICB0aGlzLl9zZWxlY3RlZENvdW50cnkgPSB2YWx1ZTtcbiAgICB0aGlzLnBsYWNlSG9sZGVyID0gdGhpcy5yZXNvbHZlUGxhY2Vob2xkZXIoKTtcbiAgfVxuXG4gIGdldCBzZWxlY3RlZENvdW50cnkoKTogQ291bnRyeSB7XG4gICAgcmV0dXJuIHRoaXMuX3NlbGVjdGVkQ291bnRyeTtcbiAgfVxuXG4gIGFsbENvdW50cmllczogQXJyYXk8Q291bnRyeT4gPSBbXTtcblxuICBzdGF0ZXMgPSBDb3VudHJ5SVNPO1xuICBzZWxlY3RlZFN0YXRlcyA9IHRoaXMuc3RhdGVzO1xuXG4gIC8vIEhhcyB0byBiZSAnYW55JyB0byBwcmV2ZW50IGEgbmVlZCB0byBpbnN0YWxsIEB0eXBlcy9nb29nbGUtbGlicGhvbmVudW1iZXIgYnkgdGhlIHBhY2thZ2UgdXNlci4uLlxuICBwcm90ZWN0ZWQgcGhvbmVVdGlsOiBhbnkgPSBscG4uUGhvbmVOdW1iZXJVdGlsLmdldEluc3RhbmNlKCk7XG4gIHByb3RlY3RlZCBzZXBhcmF0ZURpYWxDb2RlID0gdHJ1ZTtcbiAgcHJvdGVjdGVkIG51bWJlckZvcm1hdDogUGhvbmVOdW1iZXJGb3JtYXQgPSBQaG9uZU51bWJlckZvcm1hdC5JbnRlcm5hdGlvbmFsO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY291bnRyeUNvZGVEYXRhOiBDb3VudHJ5Q29kZSxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KGZvcndhcmRSZWYoKCkgPT4gT0Zvcm1Db21wb25lbnQpKSBmb3JtOiBPRm9ybUNvbXBvbmVudCxcbiAgICBlbFJlZjogRWxlbWVudFJlZixcbiAgICBpbmplY3RvcjogSW5qZWN0b3JcbiAgKSB7XG4gICAgc3VwZXIoZm9ybSwgZWxSZWYsIGluamVjdG9yKTtcbiAgICB0aGlzLmZldGNoQ291bnRyeURhdGEoKTtcbiAgfVxuXG4gIGluaXRpYWxpemUoKTogdm9pZCB7XG4gICAgdGhpcy5pbml0aWFsaXplQ291bnRyeURhdGEoKTtcbiAgICBzdXBlci5pbml0aWFsaXplKCk7XG4gICAgY29uc3QgZm9ybUNvbnRyb2wgPSB0aGlzLmdldEZvcm1Db250cm9sKCkgYXMgT0Zvcm1Db250cm9sO1xuICAgIGlmIChmb3JtQ29udHJvbCkge1xuICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICBmb3JtQ29udHJvbC5nZXRWYWx1ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5sZW5ndGggPiAwICYmIHNlbGYuc2VsZWN0ZWRDb3VudHJ5ICYmIHNlbGYuc2VsZWN0ZWRDb3VudHJ5LmRpYWxDb2RlKSB7XG4gICAgICAgICAgcmV0dXJuIGArJHtzZWxmLnNlbGVjdGVkQ291bnRyeS5kaWFsQ29kZX0gJHt0aGlzLnZhbHVlfWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgcHVibGljIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBzdXBlci5uZ0FmdGVyVmlld0luaXQoKTtcbiAgICBpZiAodGhpcy5vSW5wdXRzT3B0aW9ucy5pY29uQ29sb3IgPT09IENvZGVzLk9fSU5QVVRTX09QVElPTlNfQ09MT1JfQUNDRU5UKSB7XG4gICAgICBjb25zdCBtYXRGb3JtRmllbGRFTCA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbWF0LWZvcm0tZmllbGQnKVsxXTtcbiAgICAgIGlmIChVdGlsLmlzRGVmaW5lZChtYXRGb3JtRmllbGRFTCkpIHtcbiAgICAgICAgbWF0Rm9ybUZpZWxkRUwuY2xhc3NMaXN0LmFkZCgnYWNjZW50Jyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGFkZE9udGltaXplQ3VzdG9tQXBwZWFyYW5jZUNsYXNzKCk6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICBpZiAodGhpcy5lbFJlZikge1xuICAgICAgICBjb25zdCBtYXRGb3JtRmllbGRFbCA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdtYXQtZm9ybS1maWVsZCcpO1xuICAgICAgICBtYXRGb3JtRmllbGRFbC5mb3JFYWNoKG1hdEZvcm0gPT4ge1xuICAgICAgICAgIG1hdEZvcm0uY2xhc3NMaXN0LmFkZCgnbWF0LWZvcm0tZmllbGQtYXBwZWFyYW5jZS1vbnRpbWl6ZScpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvL1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRWYWx1ZSgpOiBhbnkge1xuICAgIGNvbnN0IGZvcm1Db250cm9sID0gdGhpcy5nZXRGb3JtQ29udHJvbCgpIGFzIE9Gb3JtQ29udHJvbDtcbiAgICBpZiAoZm9ybUNvbnRyb2wpIHtcbiAgICAgIHJldHVybiBmb3JtQ29udHJvbC5nZXRWYWx1ZSgpO1xuICAgIH1cbiAgICByZXR1cm4gc3VwZXIuZ2V0VmFsdWUoKTtcbiAgfVxuXG4gIHJlc29sdmVWYWxpZGF0b3JzKCk6IFZhbGlkYXRvckZuW10ge1xuICAgIGNvbnN0IHZhbGlkYXRvcnM6IFZhbGlkYXRvckZuW10gPSBzdXBlci5yZXNvbHZlVmFsaWRhdG9ycygpO1xuICAgIGNvbnN0IGNyZWF0ZVBob25lVmFsaWRhdG9yID0gKCgpID0+IHtcbiAgICAgIHJldHVybiBPVmFsaWRhdG9ycy5waG9uZVZhbGlkYXRvcih0aGlzLmdldEZvcm1Db250cm9sKCksIHRoaXMuZ2V0U2VsZWN0ZWRDb3VudHJ5SXNvMigpKTtcbiAgICB9KTtcbiAgICB2YWxpZGF0b3JzLnB1c2goY3JlYXRlUGhvbmVWYWxpZGF0b3IpO1xuICAgIHJldHVybiB2YWxpZGF0b3JzO1xuICB9XG5cbiAgb25Gb3JtQ29udHJvbENoYW5nZSh2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnZhbHVlKSB7XG4gICAgICB0aGlzLnZhbHVlID0gbmV3IE9Gb3JtVmFsdWUoKTtcbiAgICB9XG4gICAgdGhpcy5lbnN1cmVPRm9ybVZhbHVlKHZhbHVlKTtcbiAgICB0aGlzLmVuc3VyZVBob25lVmFsdWUodmFsdWUpO1xuICAgIHRoaXMub25DaGFuZ2UuZW1pdCh2YWx1ZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2V0Rm9ybVZhbHVlKHZhbDogYW55LCBvcHRpb25zPzogRm9ybVZhbHVlT3B0aW9ucywgc2V0RGlydHk6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xuICAgIGxldCB7IGNvdW50cnlEaWFsQ29kZSwgbnVtYmVyIH0gPSB0aGlzLmdldFNlcGFyYXRlZFZhbHVlcyh2YWwpO1xuICAgIGxldCBjb3VudHJ5ID0gdGhpcy5nZXRDb3VudHJ5QnlEaWFsQ29kZShjb3VudHJ5RGlhbENvZGUpO1xuICAgIGNvbnN0IHBhcnNlZCA9IHRoaXMuZ2V0UGFyc2VkTnVtYmVyKG51bWJlciwgY291bnRyeSA/IGNvdW50cnkuaXNvMiA6IHVuZGVmaW5lZCk7XG4gICAgaWYgKCFVdGlsLmlzRGVmaW5lZChwYXJzZWQpKSB7XG4gICAgICBudW1iZXIgPSB1bmRlZmluZWQ7XG4gICAgICBjb3VudHJ5ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgICB0aGlzLnNlbGVjdGVkQ291bnRyeSA9IGNvdW50cnk7XG4gICAgdGhpcy5lbnN1cmVPRm9ybVZhbHVlKG51bWJlcik7XG4gICAgaWYgKHRoaXMuX2ZDb250cm9sKSB7XG4gICAgICB0aGlzLl9mQ29udHJvbC5zZXRWYWx1ZSh0aGlzLnZhbHVlLnZhbHVlLCBvcHRpb25zKTtcbiAgICAgIGlmIChzZXREaXJ0eSkge1xuICAgICAgICB0aGlzLl9mQ29udHJvbC5tYXJrQXNEaXJ0eSgpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuX2ZDb250cm9sLmludmFsaWQgJiYgIXRoaXMuZm9ybS5pc0luSW5zZXJ0TW9kZSgpKSB7XG4gICAgICAgIHRoaXMuX2ZDb250cm9sLm1hcmtBc1RvdWNoZWQoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5vbGRWYWx1ZSA9IHRoaXMudmFsdWUudmFsdWU7XG4gIH1cblxuICBvbkNvdW50cnlTZWxlY3QodmFsdWU6IE1hdFNlbGVjdENoYW5nZSkge1xuICAgIGNvbnN0IGNvdW50cnk6IENvdW50cnkgPSB2YWx1ZS52YWx1ZVxuICAgIHRoaXMuY291bnRyeUNoYW5nZS5lbWl0KGNvdW50cnkpO1xuICAgIHRoaXMuc2V0VmFsdWUodW5kZWZpbmVkKTtcbiAgICB0aGlzLnNlbGVjdGVkQ291bnRyeSA9IGNvdW50cnk7XG4gICAgaWYgKHRoaXMubWF0SW5wdXRSZWYgJiYgdGhpcy5tYXRJbnB1dFJlZi5uYXRpdmVFbGVtZW50KSB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5tYXRJbnB1dFJlZi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICB9LCAwKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpbm5lck9uQmx1cihldmVudDogYW55KTogdm9pZCB7XG4gICAgc3VwZXIuaW5uZXJPbkJsdXIoZXZlbnQpO1xuICAgIGlmICh0aGlzLl9mQ29udHJvbCkge1xuICAgICAgdGhpcy5fZkNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSh7IGVtaXRFdmVudDogZmFsc2UgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGdldFNlbGVjdGVkQ291bnRyeUlzbzIoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3RlZENvdW50cnkgPyB0aGlzLnNlbGVjdGVkQ291bnRyeS5pc28yIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluaXRpYWxpemVDb3VudHJ5RGF0YSgpIHtcbiAgICBpZiAodGhpcy5jb3VudHJpZXMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmFsbENvdW50cmllcyA9IHRoaXMuYWxsQ291bnRyaWVzLmZpbHRlcigoYykgPT4gdGhpcy5jb3VudHJpZXMuaW5jbHVkZXMoYy5pc28yKSk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGVuc3VyZVBob25lVmFsdWUodmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IG51bWJlciA9IHRoaXMuZ2V0UGFyc2VkTnVtYmVyKHZhbHVlLCB0aGlzLmdldFNlbGVjdGVkQ291bnRyeUlzbzIoKSk7XG4gICAgaWYgKG51bWJlcikge1xuICAgICAgY29uc3QgaW50bE5vID0gbnVtYmVyXG4gICAgICAgID8gdGhpcy5waG9uZVV0aWwuZm9ybWF0KG51bWJlciwgbHBuLlBob25lTnVtYmVyRm9ybWF0LklOVEVSTkFUSU9OQUwpXG4gICAgICAgIDogJyc7XG4gICAgICBpZiAoaW50bE5vKSB7XG4gICAgICAgIHRoaXMudmFsdWUudmFsdWUgPSB0aGlzLnJlbW92ZURpYWxDb2RlKGludGxObyk7XG4gICAgICAgIHRoaXMuZW1pdFBob25lSW5wdXREYXRhKGludGxObywgbnVtYmVyKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0Q291bnRyeUJ5RGlhbENvZGUoY291bnRyeURpYWxDb2RlOiBhbnkpOiBDb3VudHJ5IHtcbiAgICBpZiAoY291bnRyeURpYWxDb2RlKSB7XG4gICAgICByZXR1cm4gdGhpcy5zb3J0Q291bnRyaWVzKCkuZmluZCgoYykgPT4gYy5kaWFsQ29kZSA9PT0gY291bnRyeURpYWxDb2RlKTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBwcm90ZWN0ZWQgc29ydENvdW50cmllcygpOiBDb3VudHJ5W10ge1xuICAgIHJldHVybiB0aGlzLmFsbENvdW50cmllc1xuICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgcmV0dXJuIGEucHJpb3JpdHkgLSBiLnByaW9yaXR5O1xuICAgICAgfSlcbiAgfVxuICBwcm90ZWN0ZWQgZ2V0U2VwYXJhdGVkVmFsdWVzKHZhbHVlOiBhbnkpOiB7IGNvdW50cnlEaWFsQ29kZTogc3RyaW5nLCBudW1iZXI6IHN0cmluZyB9IHtcbiAgICBsZXQgY291bnRyeURpYWxDb2RlID0gJydcbiAgICBsZXQgbnVtYmVyID0gKHZhbHVlIGluc3RhbmNlb2YgT0Zvcm1WYWx1ZSA/IHZhbHVlLnZhbHVlIDogdmFsdWUpIHx8IHVuZGVmaW5lZFxuICAgIGlmIChVdGlsLmlzRGVmaW5lZChudW1iZXIpICYmIG51bWJlci5zdGFydHNXaXRoKFBIT05FX1BSRUZJWCkpIHtcbiAgICAgIGNvdW50cnlEaWFsQ29kZSA9IG51bWJlci5zdWJzdHIoMSwgbnVtYmVyLmluZGV4T2YoJyAnKSAtIDEpO1xuICAgICAgbnVtYmVyID0gbnVtYmVyLnN1YnN0cihjb3VudHJ5RGlhbENvZGUubGVuZ3RoICsgMik7XG4gICAgfVxuICAgIHJldHVybiB7IGNvdW50cnlEaWFsQ29kZSwgbnVtYmVyIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBlbWl0UGhvbmVJbnB1dERhdGEoaW50bE5vPzogc3RyaW5nLCBudW1iZXI/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBsZXQgcGhvbmVJbnB1dERhdGE6IE9QaG9uZUlucHV0RGF0YSA9IHVuZGVmaW5lZDtcbiAgICBjb25zdCBpc28yID0gdGhpcy5nZXRTZWxlY3RlZENvdW50cnlJc28yKCk7XG4gICAgaWYgKGludGxObyAmJiBudW1iZXIgJiYgaXNvMikge1xuICAgICAgcGhvbmVJbnB1dERhdGEgPSB7XG4gICAgICAgIG51bWJlcjogdGhpcy52YWx1ZS52YWx1ZSxcbiAgICAgICAgaW50ZXJuYXRpb25hbE51bWJlcjogaW50bE5vLFxuICAgICAgICBuYXRpb25hbE51bWJlcjogbnVtYmVyXG4gICAgICAgICAgPyB0aGlzLnBob25lVXRpbC5mb3JtYXQobnVtYmVyLCBscG4uUGhvbmVOdW1iZXJGb3JtYXQuTkFUSU9OQUwpXG4gICAgICAgICAgOiAnJyxcbiAgICAgICAgZTE2NE51bWJlcjogbnVtYmVyXG4gICAgICAgICAgPyB0aGlzLnBob25lVXRpbC5mb3JtYXQobnVtYmVyLCBscG4uUGhvbmVOdW1iZXJGb3JtYXQuRTE2NClcbiAgICAgICAgICA6ICcnLFxuICAgICAgICBjb3VudHJ5Q29kZTogaXNvMi50b1VwcGVyQ2FzZSgpLFxuICAgICAgICBkaWFsQ29kZTogUEhPTkVfUFJFRklYICsgdGhpcy5zZWxlY3RlZENvdW50cnkuZGlhbENvZGUsXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMub25QaG9uZURhdGFDaGFuZ2UuZW1pdChwaG9uZUlucHV0RGF0YSk7XG4gIH1cblxuICAvKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gSGVscGVycyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqL1xuICAvKipcbiAgICogUmV0dXJucyBwYXJzZSBQaG9uZU51bWJlciBvYmplY3QuXG4gICAqIEBwYXJhbSBwaG9uZU51bWJlciBzdHJpbmdcbiAgICogQHBhcmFtIGNvdW50cnlDb2RlIHN0cmluZ1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRQYXJzZWROdW1iZXIoXG4gICAgcGhvbmVOdW1iZXI6IHN0cmluZyxcbiAgICBjb3VudHJ5Q29kZTogc3RyaW5nXG4gICk6IGxwbi5QaG9uZU51bWJlciB7XG4gICAgbGV0IG51bWJlcjogbHBuLlBob25lTnVtYmVyO1xuICAgIHRyeSB7XG4gICAgICBudW1iZXIgPSB0aGlzLnBob25lVXRpbC5wYXJzZShwaG9uZU51bWJlciwgY291bnRyeUNvZGUudG9VcHBlckNhc2UoKSk7XG4gICAgfSBjYXRjaCAoZSkgeyB9XG4gICAgcmV0dXJuIG51bWJlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbnMgZGlhbGNvZGUgZnJvbSBwaG9uZSBudW1iZXIgc3RyaW5nLlxuICAgKiBAcGFyYW0gcGhvbmVOdW1iZXIgc3RyaW5nXG4gICAqL1xuICBwcml2YXRlIHJlbW92ZURpYWxDb2RlKHBob25lTnVtYmVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IG51bWJlciA9IHRoaXMuZ2V0UGFyc2VkTnVtYmVyKHBob25lTnVtYmVyLCB0aGlzLmdldFNlbGVjdGVkQ291bnRyeUlzbzIoKSk7XG4gICAgcGhvbmVOdW1iZXIgPSB0aGlzLnBob25lVXRpbC5mb3JtYXQoXG4gICAgICBudW1iZXIsXG4gICAgICBscG4uUGhvbmVOdW1iZXJGb3JtYXRbdGhpcy5udW1iZXJGb3JtYXRdXG4gICAgKTtcbiAgICBpZiAocGhvbmVOdW1iZXIuc3RhcnRzV2l0aChQSE9ORV9QUkVGSVgpICYmIHRoaXMuc2VwYXJhdGVEaWFsQ29kZSkge1xuICAgICAgcGhvbmVOdW1iZXIgPSBwaG9uZU51bWJlci5zdWJzdHJpbmcocGhvbmVOdW1iZXIuaW5kZXhPZignICcpICsgMSk7XG4gICAgfVxuICAgIHJldHVybiBwaG9uZU51bWJlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaWZ0cyB0aHJvdWdoIGFsbCBjb3VudHJpZXMgYW5kIHJldHVybnMgaXNvIGNvZGUgb2YgdGhlIHByaW1hcnkgY291bnRyeVxuICAgKiBiYXNlZCBvbiB0aGUgbnVtYmVyIHByb3ZpZGVkLlxuICAgKiBAcGFyYW0gY291bnRyeUNvZGUgY291bnRyeSBjb2RlIGluIG51bWJlciBmb3JtYXRcbiAgICogQHBhcmFtIG51bWJlciBQaG9uZU51bWJlciBvYmplY3RcbiAgICovXG4gIHByaXZhdGUgZ2V0Q291bnRyeUlzb0NvZGUoXG4gICAgY291bnRyeUNvZGU6IG51bWJlcixcbiAgICBudW1iZXI6IGxwbi5QaG9uZU51bWJlclxuICApOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIC8vIFdpbGwgdXNlIHRoaXMgdG8gbWF0Y2ggYXJlYSBjb2RlIGZyb20gdGhlIGZpcnN0IG51bWJlcnNcbiAgICBjb25zdCByYXdOdW1iZXIgPSBudW1iZXJbJ3ZhbHVlc18nXVsnMiddLnRvU3RyaW5nKCk7XG4gICAgLy8gTGlzdCBvZiBhbGwgY291bnRyaWVzIHdpdGggY291bnRyeUNvZGUgKGNhbiBiZSBtb3JlIHRoYW4gb25lLiBlLnguIFVTLCBDQSwgRE8sIFBSIGFsbCBoYXZlICsxIGNvdW50cnlDb2RlKVxuICAgIGNvbnN0IGNvdW50cmllcyA9IHRoaXMuYWxsQ291bnRyaWVzLmZpbHRlcihcbiAgICAgIChjKSA9PiBjLmRpYWxDb2RlID09PSBjb3VudHJ5Q29kZS50b1N0cmluZygpXG4gICAgKTtcbiAgICAvLyBNYWluIGNvdW50cnkgaXMgdGhlIGNvdW50cnksIHdoaWNoIGhhcyBubyBhcmVhQ29kZXMgc3BlY2lmaWVkIGluIGNvdW50cnktY29kZS50cyBmaWxlLlxuICAgIGNvbnN0IG1haW5Db3VudHJ5ID0gY291bnRyaWVzLmZpbmQoKGMpID0+IGMuYXJlYUNvZGVzID09PSB1bmRlZmluZWQpO1xuICAgIC8vIFNlY29uZGFyeSBjb3VudHJpZXMgYXJlIGFsbCBjb3VudHJpZXMsIHdoaWNoIGhhdmUgYXJlYUNvZGVzIHNwZWNpZmllZCBpbiBjb3VudHJ5LWNvZGUudHMgZmlsZS5cbiAgICBjb25zdCBzZWNvbmRhcnlDb3VudHJpZXMgPSBjb3VudHJpZXMuZmlsdGVyKChjKSA9PiBjLmFyZWFDb2RlcyAhPT0gdW5kZWZpbmVkKTtcbiAgICBsZXQgbWF0Y2hlZENvdW50cnkgPSBtYWluQ291bnRyeSA/IG1haW5Db3VudHJ5LmlzbzIgOiB1bmRlZmluZWQ7XG5cbiAgICAvKlxuICAgICAgSXRlcmF0ZSBvdmVyIGVhY2ggc2Vjb25kYXJ5IGNvdW50cnkgYW5kIGNoZWNrIGlmIG5hdGlvbmFsTnVtYmVyIHN0YXJ0cyB3aXRoIGFueSBvZiBhcmVhQ29kZXMgYXZhaWxhYmxlLlxuICAgICAgSWYgbm8gbWF0Y2hlcyBmb3VuZCwgZmFsbGJhY2sgdG8gdGhlIG1haW4gY291bnRyeS5cbiAgICAqL1xuICAgIHNlY29uZGFyeUNvdW50cmllcy5mb3JFYWNoKChjb3VudHJ5KSA9PiB7XG4gICAgICBjb3VudHJ5LmFyZWFDb2Rlcy5mb3JFYWNoKChhcmVhQ29kZSkgPT4ge1xuICAgICAgICBpZiAocmF3TnVtYmVyLnN0YXJ0c1dpdGgoYXJlYUNvZGUpKSB7XG4gICAgICAgICAgbWF0Y2hlZENvdW50cnkgPSBjb3VudHJ5LmlzbzI7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG1hdGNoZWRDb3VudHJ5O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgZm9ybWF0dGVkIGV4YW1wbGUgcGhvbmUgbnVtYmVyIGZyb20gcGhvbmVVdGlsLlxuICAgKiBAcGFyYW0gY291bnRyeUNvZGUgc3RyaW5nXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0UGhvbmVOdW1iZXJQbGFjZUhvbGRlcihjb3VudHJ5Q29kZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHRoaXMucGhvbmVVdGlsLmZvcm1hdChcbiAgICAgICAgdGhpcy5waG9uZVV0aWwuZ2V0RXhhbXBsZU51bWJlcihjb3VudHJ5Q29kZSksXG4gICAgICAgIGxwbi5QaG9uZU51bWJlckZvcm1hdFt0aGlzLm51bWJlckZvcm1hdF1cbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuIGU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyaW5nIHRoZSBsaXN0IHRvIGF2b2lkIGR1cGxpY2F0ZXMgKGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJjYXQxMjM0NS9uZ3gtaW50bC10ZWwtaW5wdXQvaXNzdWVzLzI0OClcbiAgICovXG4gIHByb3RlY3RlZCBmZXRjaENvdW50cnlEYXRhKCk6IHZvaWQge1xuICAgIHRoaXMuYWxsQ291bnRyaWVzID0gW107XG5cbiAgICB0aGlzLmNvdW50cnlDb2RlRGF0YS5hbGxDb3VudHJpZXMuZm9yRWFjaCgoYykgPT4ge1xuICAgICAgY29uc3QgY291bnRyeTogQ291bnRyeSA9IHtcbiAgICAgICAgbmFtZTogY1swXS50b1N0cmluZygpLFxuICAgICAgICBpc28yOiBjWzFdLnRvU3RyaW5nKCksXG4gICAgICAgIGRpYWxDb2RlOiBjWzJdLnRvU3RyaW5nKCksXG4gICAgICAgIHByaW9yaXR5OiArY1szXSB8fCAwLFxuICAgICAgICBhcmVhQ29kZXM6IChjWzRdIGFzIHN0cmluZ1tdKSB8fCB1bmRlZmluZWQsXG4gICAgICAgIGh0bWxJZDogYGl0aS0wX19pdGVtLSR7Y1sxXS50b1N0cmluZygpfWAsXG4gICAgICAgIGZsYWdDbGFzczogYGl0aV9fJHtjWzFdLnRvU3RyaW5nKCkudG9Mb2NhbGVMb3dlckNhc2UoKX1gLFxuICAgICAgICBwbGFjZUhvbGRlcjogJycsXG4gICAgICB9O1xuICAgICAgaWYgKCF0aGlzLm9wbGFjZWhvbGRlcikge1xuICAgICAgICBjb3VudHJ5LnBsYWNlSG9sZGVyID0gdGhpcy5nZXRQaG9uZU51bWJlclBsYWNlSG9sZGVyKFxuICAgICAgICAgIGNvdW50cnkuaXNvMi50b1VwcGVyQ2FzZSgpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICB0aGlzLmFsbENvdW50cmllcy5wdXNoKGNvdW50cnkpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZXNvbHZlUGxhY2Vob2xkZXIoKTogc3RyaW5nIHtcbiAgICAvLyBJZiB0aGUgdXNlciBkZWZpbmVkIGl0cyBvd24gcGxhY2Vob2xkZXIgdXNpbmcgdGhhdCBpbnB1dCBpdCB3aWxsIG92ZXJyaWRlIGFueSBjb3VudHJ5IHBsYWNlaG9sZGVyXG4gICAgbGV0IHBsYWNlaG9sZGVyID0gJyc7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRDb3VudHJ5ICYmIHRoaXMuc2VsZWN0ZWRDb3VudHJ5LnBsYWNlSG9sZGVyICYmIHRoaXMuc2VsZWN0ZWRDb3VudHJ5LnBsYWNlSG9sZGVyLmxlbmd0aCA+IDApIHtcbiAgICAgIHBsYWNlaG9sZGVyID0gdGhpcy5zZWxlY3RlZENvdW50cnkucGxhY2VIb2xkZXI7XG4gICAgICBpZiAodGhpcy5zZXBhcmF0ZURpYWxDb2RlKSB7XG4gICAgICAgIHBsYWNlaG9sZGVyID0gdGhpcy5yZW1vdmVEaWFsQ29kZShwbGFjZWhvbGRlcik7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwbGFjZWhvbGRlcjtcbiAgfVxufVxuIl19