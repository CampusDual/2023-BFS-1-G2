import { Injectable, Injector } from '@angular/core';
import { NavigationEnd, Router } from '@angular/router';
import { Subject } from 'rxjs';
import { AppConfig } from '../config/app-config';
import { Codes } from '../util/codes';
import { Util } from '../util/util';
import * as i0 from "@angular/core";
var AppMenuService = (function () {
    function AppMenuService(injector) {
        var _this = this;
        this.injector = injector;
        this.onClick = new Subject();
        this._config = this.injector.get(AppConfig);
        this.MENU_ROOTS = this._config.getMenuConfiguration();
        this.router = this.injector.get(Router);
        this.router.events.subscribe(function (event) {
            if (event instanceof NavigationEnd) {
                _this.setActiveItem();
            }
        });
        this.ALL_MENU_ITEMS = [];
        for (var i = 0, len = this.MENU_ROOTS.length; i < len; i++) {
            var item = this.MENU_ROOTS[i];
            this.ALL_MENU_ITEMS = this.ALL_MENU_ITEMS.concat(this.getMenuItems(item));
        }
    }
    AppMenuService.prototype.getMenuRoots = function () {
        return this.MENU_ROOTS;
    };
    AppMenuService.prototype.getMenuRootById = function (id) {
        return this.MENU_ROOTS.find(function (c) { return c.id === id; });
    };
    AppMenuService.prototype.getAllMenuItems = function () {
        return this.ALL_MENU_ITEMS;
    };
    AppMenuService.prototype.getMenuItemById = function (id) {
        return this.ALL_MENU_ITEMS.find(function (i) { return i.id === id; });
    };
    AppMenuService.prototype.getMenuItemType = function (item) {
        var type;
        switch (true) {
            case (item.route === Codes.LOGIN_ROUTE):
                type = 'logout';
                break;
            case (item.action !== undefined):
                type = 'action';
                break;
            case (item.locale !== undefined):
                type = 'locale';
                break;
            case (item.user !== undefined):
                type = 'user-info';
                break;
            case (item.items !== undefined):
                type = 'group';
                break;
            default:
                type = 'default';
                break;
        }
        return type;
    };
    AppMenuService.prototype.isMenuGroup = function (item) {
        return this.getMenuItemType(item) === 'group';
    };
    AppMenuService.prototype.isMenuGroupRoute = function (item) {
        return this.getMenuItemType(item) === 'group' && item.hasOwnProperty('route');
    };
    AppMenuService.prototype.isItemActive = function (item) {
        return this.activeItem && this.activeItem.route === item.route;
    };
    AppMenuService.prototype.isRouteItem = function (item) {
        return Util.isDefined(item.route);
    };
    AppMenuService.prototype.getMenuItems = function (item) {
        var menuGroup = item;
        var items = menuGroup.items;
        if (items !== undefined) {
            if (this.isMenuGroupRoute(menuGroup)) {
                return [item].concat(items);
            }
            return items;
        }
        return [item];
    };
    AppMenuService.prototype.setActiveItem = function () {
        var _this = this;
        var activeItem;
        var routeItems = this.ALL_MENU_ITEMS.filter(function (item) { return _this.isRouteItem(item); });
        var pathMatchFullItems = routeItems.filter(function (item) { return item.pathMatch === 'full'; });
        if (pathMatchFullItems.length > 0) {
            activeItem = pathMatchFullItems.find(function (item) { return item.route === _this.router.url; });
        }
        if (!activeItem) {
            activeItem = routeItems.find(function (item) { return _this.router.url.startsWith(item.route); });
        }
        this.activeItem = activeItem;
    };
    AppMenuService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    AppMenuService.ctorParameters = function () { return [
        { type: Injector }
    ]; };
    AppMenuService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AppMenuService_Factory() { return new AppMenuService(i0.ɵɵinject(i0.INJECTOR)); }, token: AppMenuService, providedIn: "root" });
    return AppMenuService;
}());
export { AppMenuService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLW1lbnUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvYXBwLW1lbnUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBV2pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGNBQWMsQ0FBQzs7QUFFcEM7SUFhRSx3QkFBc0IsUUFBa0I7UUFBeEMsaUJBZUM7UUFmcUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUZqQyxZQUFPLEdBQWlCLElBQUksT0FBTyxFQUFFLENBQUM7UUFHM0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUN0RCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFDLEtBQUs7WUFDakMsSUFBSSxLQUFLLFlBQVksYUFBYSxFQUFFO2dCQUNsQyxLQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7YUFDdEI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxD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VSxTQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjs7O2dCQXBCb0IsUUFBUTs7O3lCQUE3QjtDQWtJQyxBQWhIRCxJQWdIQztTQTdHWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5hdmlnYXRpb25FbmQsIFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IEFwcENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9hcHAtY29uZmlnJztcbmltcG9ydCB7XG4gIE1lbnVHcm91cCxcbiAgTWVudUl0ZW0sXG4gIE1lbnVJdGVtQWN0aW9uLFxuICBNZW51SXRlbUxvY2FsZSxcbiAgTWVudUl0ZW1Mb2dvdXQsXG4gIE1lbnVJdGVtUm91dGUsXG4gIE1lbnVJdGVtVXNlckluZm9cbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9hcHAtbWVudS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgTWVudVJvb3RJdGVtIH0gZnJvbSAnLi4vdHlwZXMvbWVudS1yb290LWl0ZW0udHlwZSc7XG5pbXBvcnQgeyBDb2RlcyB9IGZyb20gJy4uL3V0aWwvY29kZXMnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uL3V0aWwvdXRpbCc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEFwcE1lbnVTZXJ2aWNlIHtcblxuICBwcm90ZWN0ZWQgcm91dGVyOiBSb3V0ZXI7XG4gIHByb3RlY3RlZCBfY29uZmlnOiBBcHBDb25maWc7XG4gIHByb3RlY3RlZCBNRU5VX1JPT1RTOiBNZW51Um9vdEl0ZW1bXTtcbiAgcHJvdGVjdGVkIEFMTF9NRU5VX0lURU1TOiBNZW51Um9vdEl0ZW1bXTtcbiAgcHJvdGVjdGVkIGFjdGl2ZUl0ZW06IE1lbnVJdGVtUm91dGU7XG5cbiAgcHVibGljIG9uQ2xpY2s6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIHRoaXMuX2NvbmZpZyA9IHRoaXMuaW5qZWN0b3IuZ2V0KEFwcENvbmZpZyk7XG4gICAgdGhpcy5NRU5VX1JPT1RTID0gdGhpcy5fY29uZmlnLmdldE1lbnVDb25maWd1cmF0aW9uKCk7XG4gICAgdGhpcy5yb3V0ZXIgPSB0aGlzLmluamVjdG9yLmdldChSb3V0ZXIpO1xuICAgIHRoaXMucm91dGVyLmV2ZW50cy5zdWJzY3JpYmUoKGV2ZW50KSA9PiB7XG4gICAgICBpZiAoZXZlbnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRW5kKSB7XG4gICAgICAgIHRoaXMuc2V0QWN0aXZlSXRlbSgpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5BTExfTUVOVV9JVEVNUyA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB0aGlzLk1FTlVfUk9PVFMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGNvbnN0IGl0ZW06IE1lbnVSb290SXRlbSA9IHRoaXMuTUVOVV9ST09UU1tpXTtcbiAgICAgIHRoaXMuQUxMX01FTlVfSVRFTVMgPSB0aGlzLkFMTF9NRU5VX0lURU1TLmNvbmNhdCh0aGlzLmdldE1lbnVJdGVtcyhpdGVtKSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TWVudVJvb3RzKCk6IE1lbnVSb290SXRlbVtdIHtcbiAgICByZXR1cm4gdGhpcy5NRU5VX1JPT1RTO1xuICB9XG5cbiAgZ2V0TWVudVJvb3RCeUlkKGlkOiBzdHJpbmcpOiBNZW51Um9vdEl0ZW0ge1xuICAgIHJldHVybiB0aGlzLk1FTlVfUk9PVFMuZmluZChjID0+IGMuaWQgPT09IGlkKTtcbiAgfVxuXG4gIGdldEFsbE1lbnVJdGVtcygpOiBNZW51Um9vdEl0ZW1bXSB7XG4gICAgcmV0dXJuIHRoaXMuQUxMX01FTlVfSVRFTVM7XG4gIH1cblxuICBnZXRNZW51SXRlbUJ5SWQoaWQ6IHN0cmluZyk6IE1lbnVJdGVtIHwgTWVudUdyb3VwIHtcbiAgICByZXR1cm4gdGhpcy5BTExfTUVOVV9JVEVNUy5maW5kKGkgPT4gaS5pZCA9PT0gaWQpO1xuICB9XG5cbiAgZ2V0TWVudUl0ZW1UeXBlKGl0ZW06IE1lbnVSb290SXRlbSk6IHN0cmluZyB7XG4gICAgbGV0IHR5cGU6IHN0cmluZztcbiAgICBzd2l0Y2ggKHRydWUpIHtcbiAgICAgIGNhc2UgKChpdGVtIGFzIE1lbnVJdGVtTG9nb3V0KS5yb3V0ZSA9PT0gQ29kZXMuTE9HSU5fUk9VVEUpOlxuICAgICAgICB0eXBlID0gJ2xvZ291dCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAoKGl0ZW0gYXMgTWVudUl0ZW1BY3Rpb24pLmFjdGlvbiAhPT0gdW5kZWZpbmVkKTpcbiAgICAgICAgdHlwZSA9ICdhY3Rpb24nO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgKChpdGVtIGFzIE1lbnVJdGVtTG9jYWxlKS5sb2NhbGUgIT09IHVuZGVmaW5lZCk6XG4gICAgICAgIHR5cGUgPSAnbG9jYWxlJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICgoaXRlbSBhcyBNZW51SXRlbVVzZXJJbmZvKS51c2VyICE9PSB1bmRlZmluZWQpOlxuICAgICAgICB0eXBlID0gJ3VzZXItaW5mbyc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAoKGl0ZW0gYXMgTWVudUdyb3VwKS5pdGVtcyAhPT0gdW5kZWZpbmVkKTpcbiAgICAgICAgdHlwZSA9ICdncm91cCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdHlwZSA9ICdkZWZhdWx0JztcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIHJldHVybiB0eXBlO1xuICB9XG5cbiAgaXNNZW51R3JvdXAoaXRlbTogTWVudVJvb3RJdGVtKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0TWVudUl0ZW1UeXBlKGl0ZW0pID09PSAnZ3JvdXAnO1xuICB9XG5cbiAgaXNNZW51R3JvdXBSb3V0ZShpdGVtOiBNZW51Um9vdEl0ZW0pOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5nZXRNZW51SXRlbVR5cGUoaXRlbSkgPT09ICdncm91cCcgJiYgaXRlbS5oYXNPd25Qcm9wZXJ0eSgncm91dGUnKTtcbiAgfVxuXG4gIGlzSXRlbUFjdGl2ZShpdGVtOiBNZW51SXRlbVJvdXRlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuYWN0aXZlSXRlbSAmJiB0aGlzLmFjdGl2ZUl0ZW0ucm91dGUgPT09IGl0ZW0ucm91dGU7XG4gIH1cblxuICBpc1JvdXRlSXRlbShpdGVtOiBNZW51SXRlbVJvdXRlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIFV0aWwuaXNEZWZpbmVkKGl0ZW0ucm91dGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRNZW51SXRlbXMoaXRlbTogTWVudVJvb3RJdGVtKTogTWVudVJvb3RJdGVtW10ge1xuICAgIGNvbnN0IG1lbnVHcm91cCA9IGl0ZW0gYXMgTWVudUdyb3VwO1xuICAgIGNvbnN0IGl0ZW1zID0gbWVudUdyb3VwLml0ZW1zO1xuICAgIGlmIChpdGVtcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAodGhpcy5pc01lbnVHcm91cFJvdXRlKG1lbnVHcm91cCkpIHtcbiAgICAgICAgcmV0dXJuIFtpdGVtXS5jb25jYXQoaXRlbXMpXG4gICAgICB9XG4gICAgICByZXR1cm4gaXRlbXM7XG4gICAgfVxuICAgIHJldHVybiBbaXRlbV07XG4gIH1cblxuICBwcml2YXRlIHNldEFjdGl2ZUl0ZW0oKTogdm9pZCB7XG4gICAgbGV0IGFjdGl2ZUl0ZW06IE1lbnVJdGVtUm91dGU7XG4gICAgY29uc3Qgcm91dGVJdGVtczogTWVudUl0ZW1Sb3V0ZVtdID0gdGhpcy5BTExfTUVOVV9JVEVNUy5maWx0ZXIoaXRlbSA9PiB0aGlzLmlzUm91dGVJdGVtKGl0ZW0pKSBhcyBNZW51SXRlbVJvdXRlW107XG4gICAgY29uc3QgcGF0aE1hdGNoRnVsbEl0ZW1zID0gcm91dGVJdGVtcy5maWx0ZXIoaXRlbSA9PiBpdGVtLnBhdGhNYXRjaCA9PT0gJ2Z1bGwnKTtcbiAgICBpZiAocGF0aE1hdGNoRnVsbEl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgIGFjdGl2ZUl0ZW0gPSBwYXRoTWF0Y2hGdWxsSXRlbXMuZmluZChpdGVtID0+IGl0ZW0ucm91dGUgPT09IHRoaXMucm91dGVyLnVybCk7XG4gICAgfVxuICAgIGlmICghYWN0aXZlSXRlbSkge1xuICAgICAgYWN0aXZlSXRlbSA9IHJvdXRlSXRlbXMuZmluZChpdGVtID0+IHRoaXMucm91dGVyLnVybC5zdGFydHNXaXRoKGl0ZW0ucm91dGUpKTtcbiAgICB9XG4gICAgdGhpcy5hY3RpdmVJdGVtID0gYWN0aXZlSXRlbTtcbiAgfVxuXG59XG4iXX0=