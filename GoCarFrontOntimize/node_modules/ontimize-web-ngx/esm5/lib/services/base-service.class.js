import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Router } from '@angular/router';
import { Observable } from 'rxjs';
import { map, share } from 'rxjs/operators';
import { AppConfig } from '../config/app-config';
import { Util } from '../util';
import { Codes } from '../util/codes';
import { AuthService } from './auth.service';
import { LoginStorageService } from './login-storage.service';
import { OntimizeServiceResponseAdapter } from './ontimize/ontimize-service-response.adapter';
import { OntimizeServiceResponseParser } from './parser/o-service-response.parser';
var BaseService = (function () {
    function BaseService(injector) {
        this.injector = injector;
        this.httpClient = this.injector.get(HttpClient);
        this.router = this.injector.get(Router);
        this._config = this.injector.get(AppConfig);
        this._appConfig = this._config.getConfiguration();
        this.responseParser = this.injector.get(OntimizeServiceResponseParser);
        this.authService = this.injector.get(AuthService);
        this.loginStorageService = this.injector.get(LoginStorageService);
        this.configureAdapter();
    }
    BaseService.prototype.configureAdapter = function () {
        this.adapter = this.injector.get(OntimizeServiceResponseAdapter);
    };
    BaseService.prototype.configureService = function (config) {
        this._urlBase = config.urlBase ? config.urlBase : this._appConfig.apiEndpoint;
    };
    BaseService.prototype.getDefaultServiceConfiguration = function (serviceName) {
        var configuration = this._config.getServiceConfiguration();
        var servConfig = {};
        if (serviceName && configuration.hasOwnProperty(serviceName)) {
            servConfig = configuration[serviceName];
        }
        servConfig[Codes.SESSION_KEY] = this.authService.getSessionInfo();
        return servConfig;
    };
    Object.defineProperty(BaseService.prototype, "urlBase", {
        get: function () {
            return this._urlBase;
        },
        set: function (value) {
            this._urlBase = value;
        },
        enumerable: true,
        configurable: true
    });
    BaseService.prototype.doRequest = function (param) {
        var _this = this;
        var dataObservable = new Observable(function (observer) {
            var options = param.options || {
                headers: _this.buildHeaders()
            };
            options.observe = 'response';
            var requestObs;
            switch (param.method) {
                case 'GET':
                    requestObs = _this.httpClient.get(param.url, options);
                    break;
                case 'PUT':
                    requestObs = _this.httpClient.put(param.url, param.body, options);
                    break;
                case 'DELETE':
                    var deleteOptions = {
                        headers: options.headers,
                        body: param.body
                    };
                    deleteOptions.observe = 'response';
                    requestObs = _this.httpClient.delete(param.url, deleteOptions);
                    break;
                case 'POST':
                default:
                    requestObs = _this.httpClient.post(param.url, param.body, options);
                    break;
            }
            requestObs.pipe(map(function (data) {
                _this.refreshAuthToken(data);
                return _this.adapter.adapt(data);
            })).subscribe(function (resp) {
                (param.successCallback || _this.parseSuccessfulResponse).bind(_this)(resp, observer);
            }, function (error) {
                (param.errorCallBack || _this.parseUnsuccessfulResponse).bind(_this)(error, observer);
            }, function () { return observer.complete(); });
        });
        return dataObservable.pipe(share());
    };
    BaseService.prototype.buildHeaders = function () {
        return new HttpHeaders({
            'Access-Control-Allow-Origin': '*',
            'Content-Type': 'application/json;charset=UTF-8'
        });
    };
    BaseService.prototype.clientErrorFallback = function (errorCode) {
    };
    BaseService.prototype.serverErrorFallback = function (errorCode) {
    };
    BaseService.prototype.parseSuccessfulResponse = function (resp, observer) {
        this.responseParser.parseSuccessfulResponse(resp, observer, this);
    };
    BaseService.prototype.parseSuccessfulQueryResponse = function (resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseSuccessfulAdvancedQueryResponse = function (resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseSuccessfulInsertResponse = function (resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseSuccessfulUpdateResponse = function (resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseSuccessfulDeleteResponse = function (resp, observer) {
        this.parseSuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseUnsuccessfulResponse = function (error, observer) {
        this.responseParser.parseUnsuccessfulResponse(error, observer, this);
    };
    BaseService.prototype.parseUnsuccessfulQueryResponse = function (resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseUnsuccessfulAdvancedQueryResponse = function (resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseUnsuccessfulInsertResponse = function (resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseUnsuccessfulUpdateResponse = function (resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    };
    BaseService.prototype.parseUnsuccessfulDeleteResponse = function (resp, observer) {
        this.parseUnsuccessfulResponse(resp, observer);
    };
    BaseService.prototype.refreshAuthToken = function (res) {
        var authToken = res.headers.get('X-Auth-Token');
        if (Util.isDefined(authToken)) {
            this.loginStorageService.updateSessionId(authToken);
        }
    };
    return BaseService;
}());
export { BaseService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1zZXJ2aWNlLmNsYXNzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vb250aW1pemUtd2ViLW5neC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9iYXNlLXNlcnZpY2UuY2xhc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQWdCLE1BQU0sc0JBQXNCLENBQUM7QUFFN0UsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxVQUFVLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU1QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFNakQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUMvQixPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUM5RixPQUFPLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUVuRjtJQWFFLHFCQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ3RDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBOEIsQ0FBQyxDQUFDO1FBQ2hGLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQVMsTUFBc0IsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQVksU0FB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QUMsQ0FBQztJQUNqRCxDQUFDO0lBRVMsNERBQXNDLEdBQWhELFVBQWlELElBQXFCLEVBQUUsUUFBcUM7UUFDM0csSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRVMscURBQStCLEdBQXpDLFVBQTBDLElBQXFCLEVBQUUsUUFBcUM7UUFDcEcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRVMscURBQStCLEdBQXpDLFVBQTBDLElBQXFCLEVBQUUsUUFBcUM7UUFDcEcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRVMscURBQStCLEdBQXpDLFVBQTBDLElBQXFCLEVBQUUsUUFBcUM7UUFDcEcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRVMsc0NBQWdCLEdBQTFCLFVBQTJCLEdBQXNCO1FBQy9DLElBQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ2xELElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUM3QixJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ3JEO0lBQ0gsQ0FBQztJQUVILGtCQUFDO0FBQUQsQ0FBQyxBQTNLRCxJQTJLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBIZWFkZXJzLCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RvciwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmliZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc2hhcmUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEFwcENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZy9hcHAtY29uZmlnJztcbmltcG9ydCB7IFNlcnZpY2VSZXNwb25zZUFkYXB0ZXIgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3NlcnZpY2UtcmVzcG9uc2UtYWRhcHRlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU2VydmljZVJlc3BvbnNlIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zZXJ2aWNlLXJlc3BvbnNlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBIdHRwUmVxdWVzdE9wdGlvbnMgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBDb25maWcgfSBmcm9tICcuLi90eXBlcy9jb25maWcudHlwZSc7XG5pbXBvcnQgeyBTZXJ2aWNlUmVxdWVzdFBhcmFtIH0gZnJvbSAnLi4vdHlwZXMvc2VydmljZS1yZXF1ZXN0LXBhcmFtLnR5cGUnO1xuaW1wb3J0IHsgVXRpbCB9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuLi91dGlsL2NvZGVzJztcbmltcG9ydCB7IEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgQmFzZVNlcnZpY2VSZXNwb25zZSB9IGZyb20gJy4vYmFzZS1zZXJ2aWNlLXJlc3BvbnNlLmNsYXNzJztcbmltcG9ydCB7IExvZ2luU3RvcmFnZVNlcnZpY2UgfSBmcm9tICcuL2xvZ2luLXN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBPbnRpbWl6ZVNlcnZpY2VSZXNwb25zZUFkYXB0ZXIgfSBmcm9tICcuL29udGltaXplL29udGltaXplLXNlcnZpY2UtcmVzcG9uc2UuYWRhcHRlcic7XG5pbXBvcnQgeyBPbnRpbWl6ZVNlcnZpY2VSZXNwb25zZVBhcnNlciB9IGZyb20gJy4vcGFyc2VyL28tc2VydmljZS1yZXNwb25zZS5wYXJzZXInO1xuXG5leHBvcnQgY2xhc3MgQmFzZVNlcnZpY2Uge1xuXG4gIHByb3RlY3RlZCBodHRwQ2xpZW50OiBIdHRwQ2xpZW50O1xuICBwcm90ZWN0ZWQgcm91dGVyOiBSb3V0ZXI7XG5cbiAgcHJvdGVjdGVkIF91cmxCYXNlOiBzdHJpbmc7XG4gIHByb3RlY3RlZCBfYXBwQ29uZmlnOiBDb25maWc7XG4gIHByb3RlY3RlZCBfY29uZmlnOiBBcHBDb25maWc7XG4gIHByb3RlY3RlZCByZXNwb25zZVBhcnNlcjogT250aW1pemVTZXJ2aWNlUmVzcG9uc2VQYXJzZXI7XG4gIHByb3RlY3RlZCBhdXRoU2VydmljZTogQXV0aFNlcnZpY2U7XG4gIHByb3RlY3RlZCBhZGFwdGVyOiBTZXJ2aWNlUmVzcG9uc2VBZGFwdGVyPEJhc2VTZXJ2aWNlUmVzcG9uc2U+O1xuICBwcm90ZWN0ZWQgbG9naW5TdG9yYWdlU2VydmljZTogTG9naW5TdG9yYWdlU2VydmljZTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yKSB7XG4gICAgdGhpcy5odHRwQ2xpZW50ID0gdGhpcy5pbmplY3Rvci5nZXQ8SHR0cENsaWVudD4oSHR0cENsaWVudCBhcyBUeXBlPEh0dHBDbGllbnQ+KTtcbiAgICB0aGlzLnJvdXRlciA9IHRoaXMuaW5qZWN0b3IuZ2V0PFJvdXRlcj4oUm91dGVyIGFzIFR5cGU8Um91dGVyPik7XG4gICAgdGhpcy5fY29uZmlnID0gdGhpcy5pbmplY3Rvci5nZXQ8QXBwQ29uZmlnPihBcHBDb25maWcgYXMgVHlwZTxBcHBDb25maWc+KTtcbiAgICB0aGlzLl9hcHBDb25maWcgPSB0aGlzLl9jb25maWcuZ2V0Q29uZmlndXJhdGlvbigpO1xuICAgIHRoaXMucmVzcG9uc2VQYXJzZXIgPSB0aGlzLmluamVjdG9yLmdldDxPbnRpbWl6ZVNlcnZpY2VSZXNwb25zZVBhcnNlcj4oT250aW1pemVTZXJ2aWNlUmVzcG9uc2VQYXJzZXIgYXMgVHlwZTxPbnRpbWl6ZVNlcnZpY2VSZXNwb25zZVBhcnNlcj4pO1xuICAgIHRoaXMuYXV0aFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldDxBdXRoU2VydmljZT4oQXV0aFNlcnZpY2UgYXMgVHlwZTxBdXRoU2VydmljZT4pO1xuICAgIHRoaXMubG9naW5TdG9yYWdlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0PExvZ2luU3RvcmFnZVNlcnZpY2U+KExvZ2luU3RvcmFnZVNlcnZpY2UpXG4gICAgdGhpcy5jb25maWd1cmVBZGFwdGVyKCk7XG4gIH1cblxuICBwdWJsaWMgY29uZmlndXJlQWRhcHRlcigpIHtcbiAgICB0aGlzLmFkYXB0ZXIgPSB0aGlzLmluamVjdG9yLmdldChPbnRpbWl6ZVNlcnZpY2VSZXNwb25zZUFkYXB0ZXIpO1xuICB9XG5cbiAgcHVibGljIGNvbmZpZ3VyZVNlcnZpY2UoY29uZmlnOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLl91cmxCYXNlID0gY29uZmlnLnVybEJhc2UgPyBjb25maWcudXJsQmFzZSA6IHRoaXMuX2FwcENvbmZpZy5hcGlFbmRwb2ludDtcbiAgfVxuXG4gIHB1YmxpYyBnZXREZWZhdWx0U2VydmljZUNvbmZpZ3VyYXRpb24oc2VydmljZU5hbWU/OiBzdHJpbmcpOiBhbnkge1xuICAgIGNvbnN0IGNvbmZpZ3VyYXRpb24gPSB0aGlzLl9jb25maWcuZ2V0U2VydmljZUNvbmZpZ3VyYXRpb24oKTtcbiAgICBsZXQgc2VydkNvbmZpZyA9IHt9O1xuICAgIGlmIChzZXJ2aWNlTmFtZSAmJiBjb25maWd1cmF0aW9uLmhhc093blByb3BlcnR5KHNlcnZpY2VOYW1lKSkge1xuICAgICAgc2VydkNvbmZpZyA9IGNvbmZpZ3VyYXRpb25bc2VydmljZU5hbWVdO1xuICAgIH1cbiAgICBzZXJ2Q29uZmlnW0NvZGVzLlNFU1NJT05fS0VZXSA9IHRoaXMuYXV0aFNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKTtcbiAgICByZXR1cm4gc2VydkNvbmZpZztcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdXJsQmFzZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl91cmxCYXNlO1xuICB9XG5cbiAgcHVibGljIHNldCB1cmxCYXNlKHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl91cmxCYXNlID0gdmFsdWU7XG4gIH1cblxuICBwdWJsaWMgZG9SZXF1ZXN0KHBhcmFtOiBTZXJ2aWNlUmVxdWVzdFBhcmFtKTogT2JzZXJ2YWJsZTxTZXJ2aWNlUmVzcG9uc2U+IHtcblxuICAgIGNvbnN0IGRhdGFPYnNlcnZhYmxlOiBPYnNlcnZhYmxlPFNlcnZpY2VSZXNwb25zZT4gPSBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikgPT4ge1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHBhcmFtLm9wdGlvbnMgfHwge1xuICAgICAgICBoZWFkZXJzOiB0aGlzLmJ1aWxkSGVhZGVycygpXG4gICAgICB9O1xuICAgICAgb3B0aW9ucy5vYnNlcnZlID0gJ3Jlc3BvbnNlJztcbiAgICAgIGxldCByZXF1ZXN0T2JzOiBPYnNlcnZhYmxlPFNlcnZpY2VSZXNwb25zZT47XG4gICAgICBzd2l0Y2ggKHBhcmFtLm1ldGhvZCkge1xuICAgICAgICBjYXNlICdHRVQnOlxuICAgICAgICAgIHJlcXVlc3RPYnMgPSB0aGlzLmh0dHBDbGllbnQuZ2V0PFNlcnZpY2VSZXNwb25zZT4ocGFyYW0udXJsLCBvcHRpb25zKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnUFVUJzpcbiAgICAgICAgICByZXF1ZXN0T2JzID0gdGhpcy5odHRwQ2xpZW50LnB1dDxTZXJ2aWNlUmVzcG9uc2U+KHBhcmFtLnVybCwgcGFyYW0uYm9keSwgb3B0aW9ucyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ0RFTEVURSc6XG4gICAgICAgICAgY29uc3QgZGVsZXRlT3B0aW9uczogSHR0cFJlcXVlc3RPcHRpb25zID0ge1xuICAgICAgICAgICAgaGVhZGVyczogb3B0aW9ucy5oZWFkZXJzLFxuICAgICAgICAgICAgYm9keTogcGFyYW0uYm9keVxuICAgICAgICAgIH07XG4gICAgICAgICAgZGVsZXRlT3B0aW9ucy5vYnNlcnZlID0gJ3Jlc3BvbnNlJztcbiAgICAgICAgICByZXF1ZXN0T2JzID0gdGhpcy5odHRwQ2xpZW50LmRlbGV0ZTxTZXJ2aWNlUmVzcG9uc2U+KHBhcmFtLnVybCwgZGVsZXRlT3B0aW9ucyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ1BPU1QnOlxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHJlcXVlc3RPYnMgPSB0aGlzLmh0dHBDbGllbnQucG9zdDxTZXJ2aWNlUmVzcG9uc2U+KHBhcmFtLnVybCwgcGFyYW0uYm9keSwgb3B0aW9ucyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHJlcXVlc3RPYnMucGlwZShcbiAgICAgICAgbWFwKChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLnJlZnJlc2hBdXRoVG9rZW4oZGF0YSk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYWRhcHRlci5hZGFwdChkYXRhKTtcbiAgICAgICAgfSlcbiAgICAgICkuc3Vic2NyaWJlKHJlc3AgPT4ge1xuICAgICAgICAocGFyYW0uc3VjY2Vzc0NhbGxiYWNrIHx8IHRoaXMucGFyc2VTdWNjZXNzZnVsUmVzcG9uc2UpLmJpbmQodGhpcykocmVzcCwgb2JzZXJ2ZXIpO1xuICAgICAgfSwgZXJyb3IgPT4ge1xuICAgICAgICAocGFyYW0uZXJyb3JDYWxsQmFjayB8fCB0aGlzLnBhcnNlVW5zdWNjZXNzZnVsUmVzcG9uc2UpLmJpbmQodGhpcykoZXJyb3IsIG9ic2VydmVyKTtcbiAgICAgIH0sICgpID0+IG9ic2VydmVyLmNvbXBsZXRlKCkpO1xuICAgIH0pO1xuICAgIHJldHVybiBkYXRhT2JzZXJ2YWJsZS5waXBlKHNoYXJlKCkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGJ1aWxkSGVhZGVycygpOiBIdHRwSGVhZGVycyB7XG4gICAgcmV0dXJuIG5ldyBIdHRwSGVhZGVycyh7XG4gICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9VVRGLTgnXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgY2xpZW50RXJyb3JGYWxsYmFjayhlcnJvckNvZGU6IG51bWJlcikge1xuXG4gIH1cblxuICBwdWJsaWMgc2VydmVyRXJyb3JGYWxsYmFjayhlcnJvckNvZGU6IG51bWJlcikge1xuXG4gIH1cblxuICAvKlxuICAgKiBTdWNjZXNzZnVsIHJlc3BvbnNlIHBhcnNlcnMsIHRoZXJlIGlzIG9uZSBwYXJzZXIgZm9yIGVhY2ggQ1JVRCBtZXRob2Qgd2hpY2ggY2FsbHMgdG8gdGhlIGNvbW1vbiBwYXJzZXIuXG4gICAqIFVzZXIgY2FuIG92ZXJ3cml0ZSB0aGUgY2hvc2VuIG1ldGhvZHMgcGFyc2VycyBvciB0aGUgY29tbW9uIHBhcnNlclxuICAgKi9cbiAgcHJvdGVjdGVkIHBhcnNlU3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucmVzcG9uc2VQYXJzZXIucGFyc2VTdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIsIHRoaXMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlU3VjY2Vzc2Z1bFF1ZXJ5UmVzcG9uc2UocmVzcDogU2VydmljZVJlc3BvbnNlLCBvYnNlcnZlcjogU3Vic2NyaWJlcjxTZXJ2aWNlUmVzcG9uc2U+KSB7XG4gICAgdGhpcy5wYXJzZVN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCBvYnNlcnZlcik7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2VTdWNjZXNzZnVsQWR2YW5jZWRRdWVyeVJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VTdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlU3VjY2Vzc2Z1bEluc2VydFJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VTdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlU3VjY2Vzc2Z1bFVwZGF0ZVJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VTdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlU3VjY2Vzc2Z1bERlbGV0ZVJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VTdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgLypcbiAgICogVW5zdWNjZXNzZnVsIHJlc3BvbnNlIHBhcnNlcnMsIHRoZXJlIGlzIG9uZSBwYXJzZXIgZm9yIGVhY2ggQ1JVRCBtZXRob2Qgd2hpY2ggY2FsbHMgdG8gdGhlIGNvbW1vbiBwYXJzZXIuXG4gICAqIFVzZXIgY2FuIG92ZXJ3cml0ZSB0aGUgY2hvc2VuIG1ldGhvZHMgcGFyc2VycyBvciB0aGUgY29tbW9uIHBhcnNlclxuICAgKi9cbiAgcHJvdGVjdGVkIHBhcnNlVW5zdWNjZXNzZnVsUmVzcG9uc2UoZXJyb3I6IGFueSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucmVzcG9uc2VQYXJzZXIucGFyc2VVbnN1Y2Nlc3NmdWxSZXNwb25zZShlcnJvciwgb2JzZXJ2ZXIsIHRoaXMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlVW5zdWNjZXNzZnVsUXVlcnlSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlVW5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlVW5zdWNjZXNzZnVsQWR2YW5jZWRRdWVyeVJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VVbnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCBvYnNlcnZlcik7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2VVbnN1Y2Nlc3NmdWxJbnNlcnRSZXNwb25zZShyZXNwOiBTZXJ2aWNlUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPFNlcnZpY2VSZXNwb25zZT4pIHtcbiAgICB0aGlzLnBhcnNlVW5zdWNjZXNzZnVsUmVzcG9uc2UocmVzcCwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlVW5zdWNjZXNzZnVsVXBkYXRlUmVzcG9uc2UocmVzcDogU2VydmljZVJlc3BvbnNlLCBvYnNlcnZlcjogU3Vic2NyaWJlcjxTZXJ2aWNlUmVzcG9uc2U+KSB7XG4gICAgdGhpcy5wYXJzZVVuc3VjY2Vzc2Z1bFJlc3BvbnNlKHJlc3AsIG9ic2VydmVyKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVVuc3VjY2Vzc2Z1bERlbGV0ZVJlc3BvbnNlKHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8U2VydmljZVJlc3BvbnNlPikge1xuICAgIHRoaXMucGFyc2VVbnN1Y2Nlc3NmdWxSZXNwb25zZShyZXNwLCBvYnNlcnZlcik7XG4gIH1cblxuICBwcm90ZWN0ZWQgcmVmcmVzaEF1dGhUb2tlbihyZXM6IEh0dHBSZXNwb25zZTxhbnk+KSB7XG4gICAgY29uc3QgYXV0aFRva2VuID0gcmVzLmhlYWRlcnMuZ2V0KCdYLUF1dGgtVG9rZW4nKTtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQoYXV0aFRva2VuKSkge1xuICAgICAgdGhpcy5sb2dpblN0b3JhZ2VTZXJ2aWNlLnVwZGF0ZVNlc3Npb25JZChhdXRoVG9rZW4pO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=