import * as tslib_1 from "tslib";
import { HttpHeaders } from '@angular/common/http';
import { Injectable, Injector } from '@angular/core';
import { Observable } from 'rxjs';
import { map, share } from 'rxjs/operators';
import { Util } from '../../util';
import { OntimizeExportDataProviderService } from '../ontimize-export-data-provider.service';
import { OntimizeBaseService } from './ontimize-base-service.class';
var OntimizeExportService = (function (_super) {
    tslib_1.__extends(OntimizeExportService, _super);
    function OntimizeExportService(injector) {
        var _this = _super.call(this, injector) || this;
        _this.injector = injector;
        _this.exportDataProvider = _this.injector.get(OntimizeExportDataProviderService);
        return _this;
    }
    OntimizeExportService.prototype.configureService = function (config) {
        _super.prototype.configureService.call(this, config);
        if (config.exportPath) {
            this.exportPath = config.exportPath;
        }
        if (config.downloadPath) {
            this.downloadPath = config.downloadPath;
        }
        if (config.path) {
            this.servicePath = config.path;
        }
    };
    OntimizeExportService.prototype.buildHeaders = function () {
        var headers = new HttpHeaders({ 'Access-Control-Allow-Origin': '*' });
        var sessionId = this.authService.getSessionInfo().id;
        if (Util.isDefined(sessionId)) {
            headers = headers.append('Authorization', 'Bearer ' + sessionId);
        }
        return headers;
    };
    OntimizeExportService.prototype.exportData = function (format) {
        var _this = this;
        var entity = this.exportDataProvider.entity;
        var url = "" + this.urlBase + (this.exportPath ? this.exportPath : '') + this.servicePath + "/" + entity + "/" + format;
        var options = {
            headers: this.buildHeaders().append('Content-Type', 'application/json;charset=UTF-8'),
            observe: 'response'
        };
        var exportData = this.exportDataProvider.getExportConfiguration();
        var body = JSON.stringify(exportData);
        var dataObservable = new Observable(function (observer) {
            _this.httpClient.post(url, body, options).pipe(map(function (resData) { return _this.adapter.adapt(resData); })).subscribe(function (resp) {
                _this.parseSuccessfulExportDataResponse(format, resp, observer);
            }, function (error) {
                _this.parseUnsuccessfulResponse(error, observer);
            });
        });
        return dataObservable.pipe(share());
    };
    OntimizeExportService.prototype.parseSuccessfulExportDataResponse = function (format, resp, subscriber) {
        if (resp && resp.isUnauthorized()) {
            this.clientErrorFallback(401);
        }
        else if (resp && resp.isFailed()) {
            subscriber.error(resp.message);
        }
        else if (resp && resp.isSuccessful()) {
            this.downloadFile(resp.data[0][format + 'Id'], format)
                .subscribe(function (r) { return subscriber.next(r); }, function (e) { return subscriber.error(e); }, function () { return subscriber.complete(); });
        }
        else {
            subscriber.error('Service unavailable');
        }
    };
    OntimizeExportService.prototype.downloadFile = function (fileId, fileExtension) {
        var _this = this;
        var url = "" + this.urlBase + (this.downloadPath ? this.downloadPath : '') + this.servicePath + "/" + fileExtension + "/" + fileId;
        var options = {
            headers: this.buildHeaders(),
            observe: 'response',
            responseType: 'blob'
        };
        var dataObservable = new Observable(function (observer) {
            _this.httpClient.get(url, options).subscribe(function (resp) {
                var fileData = resp.body;
                var fileURL = URL.createObjectURL(fileData);
                var a = document.createElement('a');
                document.body.appendChild(a);
                a.href = fileURL;
                a.download = fileId + '.' + fileExtension;
                a.click();
                document.body.removeChild(a);
                observer.next(fileData);
                URL.revokeObjectURL(fileURL);
            }, function (error) { return observer.error(error); }, function () { return observer.complete(); });
        });
        return dataObservable.pipe(share());
    };
    OntimizeExportService.decorators = [
        { type: Injectable }
    ];
    OntimizeExportService.ctorParameters = function () { return [
        { type: Injector }
    ]; };
    return OntimizeExportService;
}(OntimizeBaseService));
export { OntimizeExportService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib250aW1pemUtZXhwb3J0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL29udGltaXplL29udGltaXplLWV4cG9ydC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTTVDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDbEMsT0FBTyxFQUFFLGlDQUFpQyxFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDN0YsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFFcEU7SUFDMkMsaURBQW1CO0lBTzVELCtCQUFzQixRQUFrQjtRQUF4QyxZQUNFLGtCQUFNLFFBQVEsQ0FBQyxTQUVoQjtRQUhxQixjQUFRLEdBQVIsUUFBUSxDQUFVO1FBRXRDLEtBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBb0MsaUNBQWlDLENBQUMsQ0FBQzs7SUFDcEgsQ0FBQztJQUVNLGdEQUFnQixHQUF2QixVQUF3QixNQUFXO1FBQ2pDLGlCQUFNLGdCQUFnQixZQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9CLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRTtZQUNyQixJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7U0FDckM7UUFDRCxJQUFJLE1BQU0sQ0FBQyxZQUFZLEVBQUU7WUFDdkIsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsWUFBWSxD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Q0FBQyxDQUFDO2dCQUM3QixDQUFDLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztnQkFDakIsQ0FBQyxDQUFDLFFBQVEsR0FBRyxNQUFNLEdBQUcsR0FBRyxHQUFHLGFBQWEsQ0FBQztnQkFDMUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNWLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN4QixHQUFHLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQy9CLENBQUMsRUFBRSxVQUFBLEtBQUssSUFBSSxPQUFBLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQXJCLENBQXFCLEVBQ2pDLGNBQU0sT0FBQSxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQW5CLENBQW1CLENBQzFCLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7O2dCQTFHRixVQUFVOzs7Z0JBWlUsUUFBUTs7SUF1SDdCLDRCQUFDO0NBQUEsQUEzR0QsQ0FDMkMsbUJBQW1CLEdBMEc3RDtTQTFHWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpYmVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHNoYXJlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSUV4cG9ydERhdGFQcm92aWRlciB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvZXhwb3J0LWRhdGEtcHJvdmlkZXIuaW50ZXJmYWNlJztcblxuaW1wb3J0IHsgSUV4cG9ydFNlcnZpY2UgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL2V4cG9ydC1zZXJ2aWNlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBTZXJ2aWNlUmVzcG9uc2UgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3NlcnZpY2UtcmVzcG9uc2UuaW50ZXJmYWNlJztcbmltcG9ydCB7IEh0dHBSZXF1ZXN0T3B0aW9ucyB9IGZyb20gJy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IFV0aWwgfSBmcm9tICcuLi8uLi91dGlsJztcbmltcG9ydCB7IE9udGltaXplRXhwb3J0RGF0YVByb3ZpZGVyU2VydmljZSB9IGZyb20gJy4uL29udGltaXplLWV4cG9ydC1kYXRhLXByb3ZpZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgT250aW1pemVCYXNlU2VydmljZSB9IGZyb20gJy4vb250aW1pemUtYmFzZS1zZXJ2aWNlLmNsYXNzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE9udGltaXplRXhwb3J0U2VydmljZSBleHRlbmRzIE9udGltaXplQmFzZVNlcnZpY2UgaW1wbGVtZW50cyBJRXhwb3J0U2VydmljZSB7XG5cbiAgcHVibGljIGV4cG9ydFBhdGg6IHN0cmluZztcbiAgcHVibGljIGRvd25sb2FkUGF0aDogc3RyaW5nO1xuICBwdWJsaWMgc2VydmljZVBhdGg6IHN0cmluZztcbiAgcHVibGljIGV4cG9ydERhdGFQcm92aWRlcjogSUV4cG9ydERhdGFQcm92aWRlcjtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yKSB7XG4gICAgc3VwZXIoaW5qZWN0b3IpO1xuICAgIHRoaXMuZXhwb3J0RGF0YVByb3ZpZGVyID0gdGhpcy5pbmplY3Rvci5nZXQ8T250aW1pemVFeHBvcnREYXRhUHJvdmlkZXJTZXJ2aWNlPihPbnRpbWl6ZUV4cG9ydERhdGFQcm92aWRlclNlcnZpY2UpO1xuICB9XG5cbiAgcHVibGljIGNvbmZpZ3VyZVNlcnZpY2UoY29uZmlnOiBhbnkpOiB2b2lkIHtcbiAgICBzdXBlci5jb25maWd1cmVTZXJ2aWNlKGNvbmZpZyk7XG4gICAgaWYgKGNvbmZpZy5leHBvcnRQYXRoKSB7XG4gICAgICB0aGlzLmV4cG9ydFBhdGggPSBjb25maWcuZXhwb3J0UGF0aDtcbiAgICB9XG4gICAgaWYgKGNvbmZpZy5kb3dubG9hZFBhdGgpIHtcbiAgICAgIHRoaXMuZG93bmxvYWRQYXRoID0gY29uZmlnLmRvd25sb2FkUGF0aDtcbiAgICB9XG4gICAgaWYgKGNvbmZpZy5wYXRoKSB7XG4gICAgICB0aGlzLnNlcnZpY2VQYXRoID0gY29uZmlnLnBhdGg7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIGJ1aWxkSGVhZGVycygpOiBIdHRwSGVhZGVycyB7XG4gICAgbGV0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoeyAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonIH0pO1xuICAgIGNvbnN0IHNlc3Npb25JZCA9IHRoaXMuYXV0aFNlcnZpY2UuZ2V0U2Vzc2lvbkluZm8oKS5pZDtcbiAgICBpZiAoVXRpbC5pc0RlZmluZWQoc2Vzc2lvbklkKSkge1xuICAgICAgaGVhZGVycyA9IGhlYWRlcnMuYXBwZW5kKCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgc2Vzc2lvbklkKTtcbiAgICB9XG4gICAgcmV0dXJuIGhlYWRlcnM7XG4gIH1cblxuICBwdWJsaWMgZXhwb3J0RGF0YShmb3JtYXQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5leHBvcnREYXRhUHJvdmlkZXIuZW50aXR5O1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMudXJsQmFzZX0ke3RoaXMuZXhwb3J0UGF0aCA/IHRoaXMuZXhwb3J0UGF0aCA6ICcnfSR7dGhpcy5zZXJ2aWNlUGF0aH0vJHtlbnRpdHl9LyR7Zm9ybWF0fWA7XG5cbiAgICBjb25zdCBvcHRpb25zOiBIdHRwUmVxdWVzdE9wdGlvbnMgPSB7XG4gICAgICBoZWFkZXJzOiB0aGlzLmJ1aWxkSGVhZGVycygpLmFwcGVuZCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD1VVEYtOCcpLFxuICAgICAgb2JzZXJ2ZTogJ3Jlc3BvbnNlJ1xuICAgIH07XG5cbiAgICBjb25zdCBleHBvcnREYXRhID0gdGhpcy5leHBvcnREYXRhUHJvdmlkZXIuZ2V0RXhwb3J0Q29uZmlndXJhdGlvbigpO1xuICAgIGNvbnN0IGJvZHkgPSBKU09OLnN0cmluZ2lmeShleHBvcnREYXRhKTtcbiAgICAvLyBUT0RPOiB0cnkgbXVsdGlwYXJ0XG4gICAgY29uc3QgZGF0YU9ic2VydmFibGU6IE9ic2VydmFibGU8U2VydmljZVJlc3BvbnNlPiA9IG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcjogU3Vic2NyaWJlcjxTZXJ2aWNlUmVzcG9uc2U+KSA9PiB7XG4gICAgICB0aGlzLmh0dHBDbGllbnQucG9zdDxTZXJ2aWNlUmVzcG9uc2U+KHVybCwgYm9keSwgb3B0aW9ucykucGlwZShcbiAgICAgICAgbWFwKChyZXNEYXRhOiBhbnkpID0+IHRoaXMuYWRhcHRlci5hZGFwdChyZXNEYXRhKSlcbiAgICAgICkuc3Vic2NyaWJlKHJlc3AgPT4ge1xuICAgICAgICB0aGlzLnBhcnNlU3VjY2Vzc2Z1bEV4cG9ydERhdGFSZXNwb25zZShmb3JtYXQsIHJlc3AsIG9ic2VydmVyKTtcbiAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgdGhpcy5wYXJzZVVuc3VjY2Vzc2Z1bFJlc3BvbnNlKGVycm9yLCBvYnNlcnZlcik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGF0YU9ic2VydmFibGUucGlwZShzaGFyZSgpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZVN1Y2Nlc3NmdWxFeHBvcnREYXRhUmVzcG9uc2UoZm9ybWF0OiBzdHJpbmcsIHJlc3A6IFNlcnZpY2VSZXNwb25zZSwgc3Vic2NyaWJlcjogU3Vic2NyaWJlcjxTZXJ2aWNlUmVzcG9uc2U+KSB7XG4gICAgaWYgKHJlc3AgJiYgcmVzcC5pc1VuYXV0aG9yaXplZCgpKSB7XG4gICAgICB0aGlzLmNsaWVudEVycm9yRmFsbGJhY2soNDAxKTtcbiAgICB9IGVsc2UgaWYgKHJlc3AgJiYgcmVzcC5pc0ZhaWxlZCgpKSB7XG4gICAgICBzdWJzY3JpYmVyLmVycm9yKHJlc3AubWVzc2FnZSk7XG4gICAgfSBlbHNlIGlmIChyZXNwICYmIHJlc3AuaXNTdWNjZXNzZnVsKCkpIHtcbiAgICAgIHRoaXMuZG93bmxvYWRGaWxlKHJlc3AuZGF0YVswXVtmb3JtYXQgKyAnSWQnXSwgZm9ybWF0KVxuICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgIHIgPT4gc3Vic2NyaWJlci5uZXh0KHIpLFxuICAgICAgICAgIGUgPT4gc3Vic2NyaWJlci5lcnJvcihlKSxcbiAgICAgICAgICAoKSA9PiBzdWJzY3JpYmVyLmNvbXBsZXRlKClcbiAgICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVW5rbm93IHN0YXRlIC0+IGVycm9yXG4gICAgICBzdWJzY3JpYmVyLmVycm9yKCdTZXJ2aWNlIHVuYXZhaWxhYmxlJyk7XG4gICAgfVxuXG4gIH1cblxuICBwdWJsaWMgZG93bmxvYWRGaWxlKGZpbGVJZDogc3RyaW5nLCBmaWxlRXh0ZW5zaW9uOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHVybCA9IGAke3RoaXMudXJsQmFzZX0ke3RoaXMuZG93bmxvYWRQYXRoID8gdGhpcy5kb3dubG9hZFBhdGggOiAnJ30ke3RoaXMuc2VydmljZVBhdGh9LyR7ZmlsZUV4dGVuc2lvbn0vJHtmaWxlSWR9YDtcblxuICAgIGNvbnN0IG9wdGlvbnM6IGFueSA9IHtcbiAgICAgIGhlYWRlcnM6IHRoaXMuYnVpbGRIZWFkZXJzKCksXG4gICAgICBvYnNlcnZlOiAncmVzcG9uc2UnLFxuICAgICAgcmVzcG9uc2VUeXBlOiAnYmxvYidcbiAgICB9O1xuXG4gICAgY29uc3QgZGF0YU9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiB7XG4gICAgICAvLyAubWFwKChyZXM6IGFueSkgPT4gbmV3IEJsb2IoW3Jlcy5ibG9iKCldLCB7IHR5cGU6IHJlc3BvbnNlVHlwZSB9KSlcbiAgICAgIHRoaXMuaHR0cENsaWVudC5nZXQodXJsLCBvcHRpb25zKS5zdWJzY3JpYmUoXG4gICAgICAgIChyZXNwOiBhbnkpID0+IHtcbiAgICAgICAgICBjb25zdCBmaWxlRGF0YSA9IHJlc3AuYm9keTtcbiAgICAgICAgICBjb25zdCBmaWxlVVJMID0gVVJMLmNyZWF0ZU9iamVjdFVSTChmaWxlRGF0YSk7XG4gICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbiAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGEpO1xuICAgICAgICAgIGEuaHJlZiA9IGZpbGVVUkw7XG4gICAgICAgICAgYS5kb3dubG9hZCA9IGZpbGVJZCArICcuJyArIGZpbGVFeHRlbnNpb247XG4gICAgICAgICAgYS5jbGljaygpO1xuICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoYSk7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChmaWxlRGF0YSk7XG4gICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChmaWxlVVJMKTtcbiAgICAgICAgfSwgZXJyb3IgPT4gb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpLFxuICAgICAgICAoKSA9PiBvYnNlcnZlci5jb21wbGV0ZSgpXG4gICAgICApO1xuICAgIH0pO1xuICAgIHJldHVybiBkYXRhT2JzZXJ2YWJsZS5waXBlKHNoYXJlKCkpO1xuICB9XG59Il19