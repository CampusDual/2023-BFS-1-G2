import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { Codes } from '../../util/codes';
import { Util } from '../../util/util';
import { AbstractComponentStateService } from './o-component-state.service';
import { OTableComponentStateClass } from './o-table-component-state.class';
var OTableComponentStateService = (function (_super) {
    tslib_1.__extends(OTableComponentStateService, _super);
    function OTableComponentStateService() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    OTableComponentStateService.prototype.initialize = function (component) {
        this.state = new OTableComponentStateClass();
        _super.prototype.initialize.call(this, component);
    };
    OTableComponentStateService.prototype.initializeState = function (state) {
        _super.prototype.initializeState.call(this, state);
        var initialConfigurationRawObj = state.initialConfiguration || {};
        state.initialConfiguration = new OTableComponentStateClass();
        state.initialConfiguration.setData(initialConfigurationRawObj);
    };
    OTableComponentStateService.prototype.refreshSelection = function () {
        this.state.selection = this.getSelectionState();
    };
    OTableComponentStateService.prototype.getDataToStore = function () {
        var dataToStore = {};
        var propertiesKeys = [
            'sort-columns',
            'oColumns-display',
            'columns-filter',
            'quick-filter',
            'page',
            'selection',
            'initial-configuration',
            'filter-columns',
            'filter-column-active',
            'grouped-columns',
            'grouped-column-types',
            'user-stored-filters',
            'user-stored-configurations'
        ];
        Object.assign(dataToStore, this.getTablePropertiesToStore(propertiesKeys));
        return dataToStore;
    };
    OTableComponentStateService.prototype.storeFilter = function (filter) {
        var newFilter = { name: filter.name, description: filter.description };
        var storedFilter = {};
        Object.assign(storedFilter, this.getColumnFiltersState());
        Object.assign(storedFilter, this.getColumnsQuickFilterState());
        Object.assign(storedFilter, this.getFilterBuilderState());
        newFilter['stored-filter'] = storedFilter;
        this.state.addStoredFilter(newFilter);
    };
    OTableComponentStateService.prototype.storeConfiguration = function (configurationAgs, tableProperties) {
        var newConfiguration = {};
        this.component.storePaginationState = true;
        var storedConfiguration = this.getTablePropertiesToStore(tableProperties);
        this.component.storePaginationState = false;
        newConfiguration['stored-configuration'] = storedConfiguration;
        Object.assign(newConfiguration, configurationAgs);
        newConfiguration['stored-properties'] = tableProperties;
        this.state.addStoredConfiguration(newConfiguration);
    };
    OTableComponentStateService.prototype.getTablePropertiesToStore = function (properties) {
        var _this = this;
        var result = {};
        properties.forEach(function (prop) {
            Object.assign(result, _this.getTablePropertyToStore(prop));
        });
        return result;
    };
    OTableComponentStateService.prototype.getTablePropertyToStore = function (property) {
        var result = {};
        switch (property) {
            case 'sort-columns':
                result = this.getSortState();
                break;
            case 'oColumns-display':
                result = this.getColumnsDisplayState();
                break;
            case 'quick-filter':
                result = this.getColumnsQuickFilterState();
                break;
            case 'columns-filter':
                result = this.getColumnFiltersState();
                break;
            case 'page':
                result = this.getPageState();
                break;
            case 'selection':
                result['selection'] = this.getSelectionState();
                break;
            case 'initial-configuration':
                result = this.getInitialConfigurationState();
                break;
            case 'filter-column-active':
                result['filter-column-active'] = this.component.isColumnFiltersActive;
                break;
            case 'filter-columns':
                result['filter-columns'] = this.component.filterColumns;
                break;
            case 'grouped-columns':
                result['grouped-columns'] = this.component.groupedColumnsArray;
                break;
            case 'grouped-column-types':
                result['grouped-column-types'] = this.component.groupedColumnTypes;
                break;
            case 'user-stored-filters':
                result['user-stored-filters'] = this.state.storedFilters;
                break;
            case 'user-stored-configurations':
                result['user-stored-configurations'] = this.state.storedConfigurations;
                break;
            case 'filter-builder':
                if (this.component.filterBuilder) {
                    result['filter-builder'] = this.component.filterBuilder.getFilterValues();
                }
                break;
        }
        return result;
    };
    OTableComponentStateService.prototype.getColumnsDisplayState = function () {
        var oColumnsData = [];
        this.component.oTableOptions.columns.forEach(function (oCol) {
            oColumnsData.push({
                attr: oCol.attr,
                visible: oCol.visible,
                width: oCol.getWidthToStore()
            });
        });
        return {
            'oColumns-display': oColumnsData,
            'select-column-visible': this.component.oTableOptions.selectColumn.visible
        };
    };
    OTableComponentStateService.prototype.getColumnsQuickFilterState = function () {
        var tableOptions = this.component.oTableOptions;
        var oColumnsData = [];
        tableOptions.columns.forEach(function (oCol) {
            oColumnsData.push({
                attr: oCol.attr,
                searchable: oCol.searchable,
                searching: oCol.searching
            });
        });
        return {
            'oColumns': oColumnsData,
            'filter-case-sensitive': tableOptions.filterCaseSensitive,
            'filter': this.component.oTableQuickFilterComponent ? this.component.oTableQuickFilterComponent.value : ''
        };
    };
    OTableComponentStateService.prototype.getFilterBuilderState = function () {
        var result = {};
        if (this.component.filterBuilder) {
            var filterBuilder = this.component.filterBuilder.getFilterValues();
            if (!Util.isObjectEmpty(filterBuilder)) {
                result['filter-builder-values'] = filterBuilder;
            }
        }
        return result;
    };
    OTableComponentStateService.prototype.getColumnFiltersState = function () {
        var result = {};
        if (this.component.dataSource) {
            var columnValueFilters = this.component.dataSource.getColumnValueFilters();
            if (columnValueFilters.length > 0) {
                result['column-value-filters'] = columnValueFilters;
            }
        }
        return result;
    };
    OTableComponentStateService.prototype.getPageState = function () {
        var result = {
            'query-rows': this.component.matpaginator ? this.component.matpaginator.pageSize : ''
        };
        if (this.component.currentPage > 0 && this.component.storePaginationState) {
            result.currentPage = this.component.currentPage;
        }
        if (this.component.pageable && this.component.storePaginationState) {
            result.totalQueryRecordsNumber = this.component.state.totalQueryRecordsNumber;
            result.queryRecordOffset = Math.max((this.component.state.queryRecordOffset - this.component.dataSource.renderedData.length), (this.component.state.queryRecordOffset - this.component.queryRows));
        }
        return result;
    };
    OTableComponentStateService.prototype.getSelectionState = function () {
        var selection = [];
        if (this.component && this.component.keepSelectedItems) {
            var tableKeys_1 = this.component.getKeys();
            this.component.getSelectedItems().forEach(function (item) {
                var data = {};
                tableKeys_1.forEach(function (key) {
                    data[key] = item[key];
                });
                selection.push(data);
            });
        }
        return selection;
    };
    OTableComponentStateService.prototype.getInitialConfigurationState = function () {
        var _this = this;
        var oColumnsData = [];
        Util.parseArray(this.component.visibleColumns, true).forEach(function (columnAttr) {
            var oCol = _this.component.getOColumn(columnAttr);
            oColumnsData.push({
                attr: oCol.attr,
                visible: true,
                width: oCol.definition ? oCol.definition.originalWidth : undefined
            });
        });
        return {
            'initial-configuration': {
                'oColumns-display': oColumnsData,
                'sort-columns': this.component.sortColumns,
                'select-column-visible': this.component.oTableOptions.selectColumn.visible,
                'filter-case-sensitive': this.component.filterCaseSensitive,
                'query-rows': this.component.originalQueryRows,
                'filter-column-active-by-default': this.component.filterColumnActiveByDefault,
                'filter-columns': this.component.originalFilterColumns,
                'grouped-columns': this.component.originalGroupedColumnsArray
            }
        };
    };
    OTableComponentStateService.prototype.getSortState = function () {
        var sortColumns = [];
        this.component.sort.getSortColumns().forEach(function (sortData) {
            sortColumns.push(sortData.id + Codes.COLUMNS_ALIAS_SEPARATOR + sortData.direction);
        });
        return {
            'sort-columns': sortColumns.join(Codes.ARRAY_INPUT_SEPARATOR)
        };
    };
    OTableComponentStateService.decorators = [
        { type: Injectable }
    ];
    return OTableComponentStateService;
}(AbstractComponentStateService));
export { OTableComponentStateService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10YWJsZS1jb21wb25lbnQtc3RhdGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29udGltaXplLXdlYi1uZ3gvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvc3RhdGUvby10YWJsZS1jb21wb25lbnQtc3RhdGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQVMzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSw2QkFBNkIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRTVFO0lBQ2lELHVEQUF5RTtJQUQxSDs7SUFtUEEsQ0FBQztJQWhQQyxnREFBVSxHQUFWLFVBQVcsU0FBMEI7UUFDbkMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLHlCQUF5QixFQUFFLENBQUM7UUFDN0MsaUJBQU0sVUFBVSxZQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRCxxREFBZSxHQUFmLFVBQWdCLEtBQWdDO1FBQzlDLGlCQUFNLGVBQWUsWUFBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixJQUFNLDBCQUEwQixHQUFHLEtBQUssQ0FBQyxvQkFBb0IsSUFBSSxFQUFFLENBQUM7UUFDcEUsS0FBSyxDQUFDLG9CQUFvQixHQUFHLElBQUkseUJBQXlCLEVBQUUsQ0FBQztRQUM3RCxLQUFLLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVELHNEQUFnQixHQUFoQjtRQUNFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQ2xELENBQUM7SUFFRCxvREFB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QVMsQ0FBQywyQkFBMkI7YUFDOUQ7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVTLGtEQUFZLEdBQXRCO1FBQ0UsSUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxVQUFBLFFBQVE7WUFDbkQsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxHQUFHLEtBQUssQ0FBQyx1QkFBdUIsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDckYsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPO1lBQ0wsY0FBYyxFQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDO1NBQzlELENBQUM7SUFDSixDQUFDOztnQkFsUEYsVUFBVTs7SUFtUFgsa0NBQUM7Q0FBQSxBQW5QRCxDQUNpRCw2QkFBNkIsR0FrUDdFO1NBbFBZLDJCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgT0NvbHVtbiB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvdGFibGUvY29sdW1uL28tY29sdW1uLmNsYXNzJztcbmltcG9ydCB7IE9UYWJsZUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvdGFibGUvby10YWJsZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgT0ZpbHRlckRlZmluaXRpb24gfSBmcm9tICcuLi8uLi90eXBlcy9vLWZpbHRlci1kZWZpbml0aW9uLnR5cGUnO1xuaW1wb3J0IHsgT0NvbHVtbkRpc3BsYXkgfSBmcm9tICcuLi8uLi90eXBlcy90YWJsZS9vLWNvbHVtbi1kaXNwbGF5LnR5cGUnO1xuaW1wb3J0IHsgT0NvbHVtblNlYXJjaGFibGUgfSBmcm9tICcuLi8uLi90eXBlcy90YWJsZS9vLWNvbHVtbi1zZWFyY2hhYmxlLnR5cGUnO1xuaW1wb3J0IHsgT1RhYmxlQ29uZmlndXJhdGlvbiB9IGZyb20gJy4uLy4uL3R5cGVzL3RhYmxlL28tdGFibGUtY29uZmlndXJhdGlvbi50eXBlJztcbmltcG9ydCB7IE9UYWJsZUZpbHRlcnNTdGF0dXMsIE9UYWJsZVN0b3JlZEZpbHRlciB9IGZyb20gJy4uLy4uL3R5cGVzL3RhYmxlL28tdGFibGUtZmlsdGVyLXN0YXR1cy50eXBlJztcbmltcG9ydCB7IENvZGVzIH0gZnJvbSAnLi4vLi4vdXRpbC9jb2Rlcyc7XG5pbXBvcnQgeyBVdGlsIH0gZnJvbSAnLi4vLi4vdXRpbC91dGlsJztcbmltcG9ydCB7IEFic3RyYWN0Q29tcG9uZW50U3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi9vLWNvbXBvbmVudC1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7IE9UYWJsZUNvbXBvbmVudFN0YXRlQ2xhc3MgfSBmcm9tICcuL28tdGFibGUtY29tcG9uZW50LXN0YXRlLmNsYXNzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE9UYWJsZUNvbXBvbmVudFN0YXRlU2VydmljZSBleHRlbmRzIEFic3RyYWN0Q29tcG9uZW50U3RhdGVTZXJ2aWNlPE9UYWJsZUNvbXBvbmVudFN0YXRlQ2xhc3MsIE9UYWJsZUNvbXBvbmVudD4ge1xuXG4gIGluaXRpYWxpemUoY29tcG9uZW50OiBPVGFibGVDb21wb25lbnQpIHtcbiAgICB0aGlzLnN0YXRlID0gbmV3IE9UYWJsZUNvbXBvbmVudFN0YXRlQ2xhc3MoKTtcbiAgICBzdXBlci5pbml0aWFsaXplKGNvbXBvbmVudCk7XG4gIH1cblxuICBpbml0aWFsaXplU3RhdGUoc3RhdGU6IE9UYWJsZUNvbXBvbmVudFN0YXRlQ2xhc3MpIHtcbiAgICBzdXBlci5pbml0aWFsaXplU3RhdGUoc3RhdGUpO1xuICAgIGNvbnN0IGluaXRpYWxDb25maWd1cmF0aW9uUmF3T2JqID0gc3RhdGUuaW5pdGlhbENvbmZpZ3VyYXRpb24gfHwge307XG4gICAgc3RhdGUuaW5pdGlhbENvbmZpZ3VyYXRpb24gPSBuZXcgT1RhYmxlQ29tcG9uZW50U3RhdGVDbGFzcygpO1xuICAgIHN0YXRlLmluaXRpYWxDb25maWd1cmF0aW9uLnNldERhdGEoaW5pdGlhbENvbmZpZ3VyYXRpb25SYXdPYmopO1xuICB9XG5cbiAgcmVmcmVzaFNlbGVjdGlvbigpIHtcbiAgICB0aGlzLnN0YXRlLnNlbGVjdGlvbiA9IHRoaXMuZ2V0U2VsZWN0aW9uU3RhdGUoKTtcbiAgfVxuXG4gIGdldERhdGFUb1N0b3JlKCk6IGFueSB7XG4gICAgY29uc3QgZGF0YVRvU3RvcmU6IGFueSA9IHt9O1xuICAgIGNvbnN0IHByb3BlcnRpZXNLZXlzID0gW1xuICAgICAgJ3NvcnQtY29sdW1ucycsXG4gICAgICAnb0NvbHVtbnMtZGlzcGxheScsXG4gICAgICAnY29sdW1ucy1maWx0ZXInLFxuICAgICAgJ3F1aWNrLWZpbHRlcicsXG4gICAgICAncGFnZScsXG4gICAgICAnc2VsZWN0aW9uJyxcbiAgICAgICdpbml0aWFsLWNvbmZpZ3VyYXRpb24nLFxuICAgICAgJ2ZpbHRlci1jb2x1bW5zJyxcbiAgICAgICdmaWx0ZXItY29sdW1uLWFjdGl2ZScsXG4gICAgICAnZ3JvdXBlZC1jb2x1bW5zJyxcbiAgICAgICdncm91cGVkLWNvbHVtbi10eXBlcycsXG4gICAgICAndXNlci1zdG9yZWQtZmlsdGVycycsXG4gICAgICAndXNlci1zdG9yZWQtY29uZmlndXJhdGlvbnMnXG4gICAgXTtcbiAgICBPYmplY3QuYXNzaWduKGRhdGFUb1N0b3JlLCB0aGlzLmdldFRhYmxlUHJvcGVydGllc1RvU3RvcmUocHJvcGVydGllc0tleXMpKTtcbiAgICByZXR1cm4gZGF0YVRvU3RvcmU7XG4gIH1cblxuICBzdG9yZUZpbHRlcihmaWx0ZXI6IE9GaWx0ZXJEZWZpbml0aW9uKSB7XG4gICAgbGV0IG5ld0ZpbHRlcjogT1RhYmxlRmlsdGVyc1N0YXR1cyA9IHsgbmFtZTogZmlsdGVyLm5hbWUsIGRlc2NyaXB0aW9uOiBmaWx0ZXIuZGVzY3JpcHRpb24gfTtcbiAgICBjb25zdCBzdG9yZWRGaWx0ZXIgPSB7fVxuICAgIE9iamVjdC5hc3NpZ24oc3RvcmVkRmlsdGVyLCB0aGlzLmdldENvbHVtbkZpbHRlcnNTdGF0ZSgpKTtcbiAgICBPYmplY3QuYXNzaWduKHN0b3JlZEZpbHRlciwgdGhpcy5nZXRDb2x1bW5zUXVpY2tGaWx0ZXJTdGF0ZSgpKTtcbiAgICBPYmplY3QuYXNzaWduKHN0b3JlZEZpbHRlciwgdGhpcy5nZXRGaWx0ZXJCdWlsZGVyU3RhdGUoKSk7XG4gICAgbmV3RmlsdGVyWydzdG9yZWQtZmlsdGVyJ10gPSBzdG9yZWRGaWx0ZXIgYXMgT1RhYmxlU3RvcmVkRmlsdGVyO1xuICAgIHRoaXMuc3RhdGUuYWRkU3RvcmVkRmlsdGVyKG5ld0ZpbHRlcik7XG4gIH1cblxuICBzdG9yZUNvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbkFnczogT1RhYmxlQ29uZmlndXJhdGlvbiwgdGFibGVQcm9wZXJ0aWVzOiBhbnlbXSkge1xuICAgIGNvbnN0IG5ld0NvbmZpZ3VyYXRpb246IE9UYWJsZUNvbmZpZ3VyYXRpb24gPSB7fTtcbiAgICB0aGlzLmNvbXBvbmVudC5zdG9yZVBhZ2luYXRpb25TdGF0ZSA9IHRydWU7XG4gICAgY29uc3Qgc3RvcmVkQ29uZmlndXJhdGlvbiA9IHRoaXMuZ2V0VGFibGVQcm9wZXJ0aWVzVG9TdG9yZSh0YWJsZVByb3BlcnRpZXMpO1xuICAgIHRoaXMuY29tcG9uZW50LnN0b3JlUGFnaW5hdGlvblN0YXRlID0gZmFsc2U7XG5cbiAgICBuZXdDb25maWd1cmF0aW9uWydzdG9yZWQtY29uZmlndXJhdGlvbiddID0gc3RvcmVkQ29uZmlndXJhdGlvbjtcbiAgICBPYmplY3QuYXNzaWduKG5ld0NvbmZpZ3VyYXRpb24sIGNvbmZpZ3VyYXRpb25BZ3MpO1xuICAgIG5ld0NvbmZpZ3VyYXRpb25bJ3N0b3JlZC1wcm9wZXJ0aWVzJ10gPSB0YWJsZVByb3BlcnRpZXM7XG5cbiAgICB0aGlzLnN0YXRlLmFkZFN0b3JlZENvbmZpZ3VyYXRpb24obmV3Q29uZmlndXJhdGlvbik7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0VGFibGVQcm9wZXJ0aWVzVG9TdG9yZShwcm9wZXJ0aWVzOiBzdHJpbmdbXSk6IGFueSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgcHJvcGVydGllcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgT2JqZWN0LmFzc2lnbihyZXN1bHQsIHRoaXMuZ2V0VGFibGVQcm9wZXJ0eVRvU3RvcmUocHJvcCkpO1xuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0VGFibGVQcm9wZXJ0eVRvU3RvcmUocHJvcGVydHk6IHN0cmluZyk6IGFueSB7XG4gICAgbGV0IHJlc3VsdDogYW55ID0ge307XG4gICAgc3dpdGNoIChwcm9wZXJ0eSkge1xuICAgICAgY2FzZSAnc29ydC1jb2x1bW5zJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRTb3J0U3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdvQ29sdW1ucy1kaXNwbGF5JzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRDb2x1bW5zRGlzcGxheVN0YXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncXVpY2stZmlsdGVyJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRDb2x1bW5zUXVpY2tGaWx0ZXJTdGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2NvbHVtbnMtZmlsdGVyJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRDb2x1bW5GaWx0ZXJzU3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdwYWdlJzpcbiAgICAgICAgcmVzdWx0ID0gdGhpcy5nZXRQYWdlU3RhdGUoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdzZWxlY3Rpb24nOlxuICAgICAgICByZXN1bHRbJ3NlbGVjdGlvbiddID0gdGhpcy5nZXRTZWxlY3Rpb25TdGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2luaXRpYWwtY29uZmlndXJhdGlvbic6XG4gICAgICAgIHJlc3VsdCA9IHRoaXMuZ2V0SW5pdGlhbENvbmZpZ3VyYXRpb25TdGF0ZSgpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2ZpbHRlci1jb2x1bW4tYWN0aXZlJzpcbiAgICAgICAgcmVzdWx0WydmaWx0ZXItY29sdW1uLWFjdGl2ZSddID0gdGhpcy5jb21wb25lbnQuaXNDb2x1bW5GaWx0ZXJzQWN0aXZlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2ZpbHRlci1jb2x1bW5zJzpcbiAgICAgICAgcmVzdWx0WydmaWx0ZXItY29sdW1ucyddID0gdGhpcy5jb21wb25lbnQuZmlsdGVyQ29sdW1ucztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdncm91cGVkLWNvbHVtbnMnOlxuICAgICAgICByZXN1bHRbJ2dyb3VwZWQtY29sdW1ucyddID0gdGhpcy5jb21wb25lbnQuZ3JvdXBlZENvbHVtbnNBcnJheTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdncm91cGVkLWNvbHVtbi10eXBlcyc6XG4gICAgICAgIHJlc3VsdFsnZ3JvdXBlZC1jb2x1bW4tdHlwZXMnXSA9IHRoaXMuY29tcG9uZW50Lmdyb3VwZWRDb2x1bW5UeXBlcztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICd1c2VyLXN0b3JlZC1maWx0ZXJzJzpcbiAgICAgICAgcmVzdWx0Wyd1c2VyLXN0b3JlZC1maWx0ZXJzJ10gPSB0aGlzLnN0YXRlLnN0b3JlZEZpbHRlcnM7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAndXNlci1zdG9yZWQtY29uZmlndXJhdGlvbnMnOlxuICAgICAgICByZXN1bHRbJ3VzZXItc3RvcmVkLWNvbmZpZ3VyYXRpb25zJ10gPSB0aGlzLnN0YXRlLnN0b3JlZENvbmZpZ3VyYXRpb25zO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2ZpbHRlci1idWlsZGVyJzpcbiAgICAgICAgaWYgKHRoaXMuY29tcG9uZW50LmZpbHRlckJ1aWxkZXIpIHtcbiAgICAgICAgICByZXN1bHRbJ2ZpbHRlci1idWlsZGVyJ10gPSB0aGlzLmNvbXBvbmVudC5maWx0ZXJCdWlsZGVyLmdldEZpbHRlclZhbHVlcygpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldENvbHVtbnNEaXNwbGF5U3RhdGUoKSB7XG4gICAgY29uc3Qgb0NvbHVtbnNEYXRhID0gW107XG4gICAgdGhpcy5jb21wb25lbnQub1RhYmxlT3B0aW9ucy5jb2x1bW5zLmZvckVhY2goKG9Db2w6IE9Db2x1bW4pID0+IHtcbiAgICAgIG9Db2x1bW5zRGF0YS5wdXNoKHtcbiAgICAgICAgYXR0cjogb0NvbC5hdHRyLFxuICAgICAgICB2aXNpYmxlOiBvQ29sLnZpc2libGUsXG4gICAgICAgIHdpZHRoOiBvQ29sLmdldFdpZHRoVG9TdG9yZSgpXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgJ29Db2x1bW5zLWRpc3BsYXknOiBvQ29sdW1uc0RhdGEsXG4gICAgICAnc2VsZWN0LWNvbHVtbi12aXNpYmxlJzogdGhpcy5jb21wb25lbnQub1RhYmxlT3B0aW9ucy5zZWxlY3RDb2x1bW4udmlzaWJsZVxuICAgIH07XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0Q29sdW1uc1F1aWNrRmlsdGVyU3RhdGUoKSB7XG4gICAgY29uc3QgdGFibGVPcHRpb25zID0gdGhpcy5jb21wb25lbnQub1RhYmxlT3B0aW9ucztcbiAgICBjb25zdCBvQ29sdW1uc0RhdGE6IE9Db2x1bW5TZWFyY2hhYmxlW10gPSBbXTtcbiAgICB0YWJsZU9wdGlvbnMuY29sdW1ucy5mb3JFYWNoKChvQ29sOiBPQ29sdW1uKSA9PiB7XG4gICAgICBvQ29sdW1uc0RhdGEucHVzaCh7XG4gICAgICAgIGF0dHI6IG9Db2wuYXR0cixcbiAgICAgICAgc2VhcmNoYWJsZTogb0NvbC5zZWFyY2hhYmxlLFxuICAgICAgICBzZWFyY2hpbmc6IG9Db2wuc2VhcmNoaW5nXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgJ29Db2x1bW5zJzogb0NvbHVtbnNEYXRhLFxuICAgICAgJ2ZpbHRlci1jYXNlLXNlbnNpdGl2ZSc6IHRhYmxlT3B0aW9ucy5maWx0ZXJDYXNlU2Vuc2l0aXZlLFxuICAgICAgJ2ZpbHRlcic6IHRoaXMuY29tcG9uZW50Lm9UYWJsZVF1aWNrRmlsdGVyQ29tcG9uZW50ID8gdGhpcy5jb21wb25lbnQub1RhYmxlUXVpY2tGaWx0ZXJDb21wb25lbnQudmFsdWUgOiAnJ1xuICAgIH07XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0RmlsdGVyQnVpbGRlclN0YXRlKCk6IGFueSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgaWYgKHRoaXMuY29tcG9uZW50LmZpbHRlckJ1aWxkZXIpIHtcbiAgICAgIGxldCBmaWx0ZXJCdWlsZGVyID0gdGhpcy5jb21wb25lbnQuZmlsdGVyQnVpbGRlci5nZXRGaWx0ZXJWYWx1ZXMoKTtcbiAgICAgIGlmICghVXRpbC5pc09iamVjdEVtcHR5KGZpbHRlckJ1aWxkZXIpKSB7XG4gICAgICAgIHJlc3VsdFsnZmlsdGVyLWJ1aWxkZXItdmFsdWVzJ10gPSBmaWx0ZXJCdWlsZGVyO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cblxuICBwcm90ZWN0ZWQgZ2V0Q29sdW1uRmlsdGVyc1N0YXRlKCkge1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIGlmICh0aGlzLmNvbXBvbmVudC5kYXRhU291cmNlKSB7XG4gICAgICBjb25zdCBjb2x1bW5WYWx1ZUZpbHRlcnMgPSB0aGlzLmNvbXBvbmVudC5kYXRhU291cmNlLmdldENvbHVtblZhbHVlRmlsdGVycygpO1xuICAgICAgaWYgKGNvbHVtblZhbHVlRmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJlc3VsdFsnY29sdW1uLXZhbHVlLWZpbHRlcnMnXSA9IGNvbHVtblZhbHVlRmlsdGVycztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRQYWdlU3RhdGUoKTogYW55IHtcbiAgICBjb25zdCByZXN1bHQ6IGFueSA9IHtcbiAgICAgICdxdWVyeS1yb3dzJzogdGhpcy5jb21wb25lbnQubWF0cGFnaW5hdG9yID8gdGhpcy5jb21wb25lbnQubWF0cGFnaW5hdG9yLnBhZ2VTaXplIDogJydcbiAgICB9O1xuICAgIGlmICh0aGlzLmNvbXBvbmVudC5jdXJyZW50UGFnZSA+IDAgJiYgdGhpcy5jb21wb25lbnQuc3RvcmVQYWdpbmF0aW9uU3RhdGUpIHtcbiAgICAgIHJlc3VsdC5jdXJyZW50UGFnZSA9IHRoaXMuY29tcG9uZW50LmN1cnJlbnRQYWdlO1xuICAgIH1cbiAgICBpZiAodGhpcy5jb21wb25lbnQucGFnZWFibGUgJiYgdGhpcy5jb21wb25lbnQuc3RvcmVQYWdpbmF0aW9uU3RhdGUpIHtcbiAgICAgIHJlc3VsdC50b3RhbFF1ZXJ5UmVjb3Jkc051bWJlciA9IHRoaXMuY29tcG9uZW50LnN0YXRlLnRvdGFsUXVlcnlSZWNvcmRzTnVtYmVyO1xuICAgICAgcmVzdWx0LnF1ZXJ5UmVjb3JkT2Zmc2V0ID0gTWF0aC5tYXgoXG4gICAgICAgICh0aGlzLmNvbXBvbmVudC5zdGF0ZS5xdWVyeVJlY29yZE9mZnNldCAtIHRoaXMuY29tcG9uZW50LmRhdGFTb3VyY2UucmVuZGVyZWREYXRhLmxlbmd0aCksXG4gICAgICAgICh0aGlzLmNvbXBvbmVudC5zdGF0ZS5xdWVyeVJlY29yZE9mZnNldCAtIHRoaXMuY29tcG9uZW50LnF1ZXJ5Um93cylcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0U2VsZWN0aW9uU3RhdGUoKTogYW55IHtcbiAgICBjb25zdCBzZWxlY3Rpb24gPSBbXTtcbiAgICBpZiAodGhpcy5jb21wb25lbnQgJiYgdGhpcy5jb21wb25lbnQua2VlcFNlbGVjdGVkSXRlbXMpIHtcbiAgICAgIC8vIHN0b3Jpbmcgc2VsZWN0ZWQgaXRlbXMga2V5cyB2YWx1ZXNcbiAgICAgIGNvbnN0IHRhYmxlS2V5cyA9IHRoaXMuY29tcG9uZW50LmdldEtleXMoKTtcbiAgICAgIHRoaXMuY29tcG9uZW50LmdldFNlbGVjdGVkSXRlbXMoKS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCBkYXRhID0ge307XG4gICAgICAgIHRhYmxlS2V5cy5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgZGF0YVtrZXldID0gaXRlbVtrZXldO1xuICAgICAgICB9KTtcbiAgICAgICAgc2VsZWN0aW9uLnB1c2goZGF0YSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHNlbGVjdGlvbjtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRJbml0aWFsQ29uZmlndXJhdGlvblN0YXRlKCk6IGFueSB7XG4gICAgY29uc3Qgb0NvbHVtbnNEYXRhOiBPQ29sdW1uRGlzcGxheVtdID0gW107XG4gICAgVXRpbC5wYXJzZUFycmF5KHRoaXMuY29tcG9uZW50LnZpc2libGVDb2x1bW5zLCB0cnVlKS5mb3JFYWNoKChjb2x1bW5BdHRyOiBzdHJpbmcpID0+IHtcbiAgICAgIGxldCBvQ29sID0gdGhpcy5jb21wb25lbnQuZ2V0T0NvbHVtbihjb2x1bW5BdHRyKTtcbiAgICAgIG9Db2x1bW5zRGF0YS5wdXNoKHtcbiAgICAgICAgYXR0cjogb0NvbC5hdHRyLFxuICAgICAgICB2aXNpYmxlOiB0cnVlLFxuICAgICAgICB3aWR0aDogb0NvbC5kZWZpbml0aW9uID8gb0NvbC5kZWZpbml0aW9uLm9yaWdpbmFsV2lkdGggOiB1bmRlZmluZWRcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICAnaW5pdGlhbC1jb25maWd1cmF0aW9uJzoge1xuICAgICAgICAnb0NvbHVtbnMtZGlzcGxheSc6IG9Db2x1bW5zRGF0YSxcbiAgICAgICAgJ3NvcnQtY29sdW1ucyc6IHRoaXMuY29tcG9uZW50LnNvcnRDb2x1bW5zLFxuICAgICAgICAnc2VsZWN0LWNvbHVtbi12aXNpYmxlJzogdGhpcy5jb21wb25lbnQub1RhYmxlT3B0aW9ucy5zZWxlY3RDb2x1bW4udmlzaWJsZSxcbiAgICAgICAgJ2ZpbHRlci1jYXNlLXNlbnNpdGl2ZSc6IHRoaXMuY29tcG9uZW50LmZpbHRlckNhc2VTZW5zaXRpdmUsXG4gICAgICAgICdxdWVyeS1yb3dzJzogdGhpcy5jb21wb25lbnQub3JpZ2luYWxRdWVyeVJvd3MsXG4gICAgICAgICdmaWx0ZXItY29sdW1uLWFjdGl2ZS1ieS1kZWZhdWx0JzogdGhpcy5jb21wb25lbnQuZmlsdGVyQ29sdW1uQWN0aXZlQnlEZWZhdWx0LFxuICAgICAgICAnZmlsdGVyLWNvbHVtbnMnOiB0aGlzLmNvbXBvbmVudC5vcmlnaW5hbEZpbHRlckNvbHVtbnMsXG4gICAgICAgICdncm91cGVkLWNvbHVtbnMnOiB0aGlzLmNvbXBvbmVudC5vcmlnaW5hbEdyb3VwZWRDb2x1bW5zQXJyYXlcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldFNvcnRTdGF0ZSgpIHtcbiAgICBjb25zdCBzb3J0Q29sdW1ucyA9IFtdO1xuICAgIHRoaXMuY29tcG9uZW50LnNvcnQuZ2V0U29ydENvbHVtbnMoKS5mb3JFYWNoKHNvcnREYXRhID0+IHtcbiAgICAgIHNvcnRDb2x1bW5zLnB1c2goc29ydERhdGEuaWQgKyBDb2Rlcy5DT0xVTU5TX0FMSUFTX1NFUEFSQVRPUiArIHNvcnREYXRhLmRpcmVjdGlvbik7XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICdzb3J0LWNvbHVtbnMnOiBzb3J0Q29sdW1ucy5qb2luKENvZGVzLkFSUkFZX0lOUFVUX1NFUEFSQVRPUilcbiAgICB9O1xuICB9XG59XG5cblxuIl19