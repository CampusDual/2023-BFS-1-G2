import * as tslib_1 from "tslib";
import { TranslateHttpLoader } from '@ngx-translate/http-loader';
import { combineLatest, Observable, of } from 'rxjs';
import { catchError, map, share } from 'rxjs/operators';
import { AppConfig } from '../../config/app-config';
import { Codes } from '../../util/codes';
import { OTranslateService } from './o-translate.service';
var OTranslateHttpLoader = (function (_super) {
    tslib_1.__extends(OTranslateHttpLoader, _super);
    function OTranslateHttpLoader(httpClient, prefix, suffix, injector) {
        if (prefix === void 0) { prefix = OTranslateService.ASSETS_PATH; }
        if (suffix === void 0) { suffix = OTranslateService.ASSETS_EXTENSION; }
        var _this = _super.call(this, httpClient, prefix, suffix) || this;
        _this.injector = injector;
        _this.appConfig = _this.injector.get(AppConfig);
        _this.httpClient = httpClient;
        return _this;
    }
    OTranslateHttpLoader.prototype.getAssetsPath = function () {
        return this.prefix;
    };
    OTranslateHttpLoader.prototype.getAssetsExtension = function () {
        return this.suffix;
    };
    OTranslateHttpLoader.prototype.getLocalTranslation = function (lang) {
        var innerObserver;
        var dataObservable = new Observable(function (observer) { return innerObserver = observer; }).pipe(share());
        _super.prototype.getTranslation.call(this, lang)
            .subscribe(function (res) {
            innerObserver.next(res);
            innerObserver.complete();
        }, function (error) {
            innerObserver.next(undefined);
        }, function () { return innerObserver.complete(); });
        return dataObservable;
    };
    OTranslateHttpLoader.prototype.getTranslation = function (lang) {
        var translationOrigins = [];
        translationOrigins.push(this.getLocalTranslation(lang));
        if (this.appConfig.useRemoteBundle()) {
            translationOrigins.push(this.getRemoteBundle(lang));
        }
        var innerObserver;
        var dataObservable = new Observable(function (observer) { return innerObserver = observer; }).pipe(share());
        combineLatest(translationOrigins).subscribe(function (res) {
            var staticBundle = res[0] || {};
            var remoteBundle = res[1] || {};
            var allBundles = Object.assign(staticBundle, remoteBundle);
            innerObserver.next(allBundles);
        });
        return dataObservable;
    };
    OTranslateHttpLoader.prototype.getRemoteBundle = function (lang) {
        var _this = this;
        var bundleEndpoint = this.appConfig.getBundleEndpoint();
        if (!bundleEndpoint) {
            return of([]);
        }
        var url = bundleEndpoint + '?lang=' + lang;
        return this.httpClient.get(url).pipe(map(function (resp) {
            if (resp.code === Codes.ONTIMIZE_SUCCESSFUL_CODE) {
                return _this.parseBundleResponse(resp.data);
            }
            return resp;
        }), catchError(function (err) {
            console.log('Remote Bundle service is not available', err);
            return of([]);
        }));
    };
    OTranslateHttpLoader.prototype.parseBundleResponse = function (data) {
        var result = {};
        if (data) {
            data.forEach(function (item) {
                result[item[OTranslateHttpLoader.BUNDLE_KEY]] = item[OTranslateHttpLoader.BUNDLE_VALUE];
            });
        }
        return result;
    };
    OTranslateHttpLoader.BUNDLE_KEY = 'key';
    OTranslateHttpLoader.BUNDLE_VALUE = 'value';
    return OTranslateHttpLoader;
}(TranslateHttpLoader));
export { OTranslateHttpLoader };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiby10cmFuc2xhdGUtaHR0cC1sb2FkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9vbnRpbWl6ZS13ZWItbmd4LyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3RyYW5zbGF0ZS9vLXRyYW5zbGF0ZS1odHRwLWxvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDakUsT0FBTyxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXhELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDekMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFMUQ7SUFBMEMsZ0RBQW1CO0lBUTNELDhCQUNFLFVBQXNCLEVBQ3RCLE1BQThDLEVBQzlDLE1BQW1ELEVBQ3pDLFFBQWtCO1FBRjVCLHVCQUFBLEVBQUEsU0FBaUIsaUJBQWlCLENBQUMsV0FBVztRQUM5Qyx1QkFBQSxFQUFBLFNBQWlCLGlCQUFpQixDQUFDLGdCQUFnQjtRQUhyRCxZQU1FLGtCQUFNLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLFNBR2xDO1FBTFcsY0FBUSxHQUFSLFFBQVEsQ0FBVTtRQUc1QixLQUFJLENBQUMsU0FBUyxHQUFHLEtBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzlDLEtBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDOztJQUMvQixDQUFDO0lBRUQsNENBQWEsR0FBYjtRQUNFLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNyQixDQUFDO0lBRUQsaURBQWtCLEdBQWxC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LENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRVMsa0RBQW1CLEdBQTdCLFVBQThCLElBQVc7UUFDdkMsSUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLElBQUksSUFBSSxFQUFFO1lBQ1IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQUk7Z0JBQ2hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDMUYsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUF6Rk0sK0JBQVUsR0FBRyxLQUFLLENBQUM7SUFDbkIsaUNBQVksR0FBRyxPQUFPLENBQUM7SUEwRmhDLDJCQUFDO0NBQUEsQUE3RkQsQ0FBMEMsbUJBQW1CLEdBNkY1RDtTQTdGWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRyYW5zbGF0ZUh0dHBMb2FkZXIgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9odHRwLWxvYWRlcic7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzaGFyZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQXBwQ29uZmlnIH0gZnJvbSAnLi4vLi4vY29uZmlnL2FwcC1jb25maWcnO1xuaW1wb3J0IHsgQ29kZXMgfSBmcm9tICcuLi8uLi91dGlsL2NvZGVzJztcbmltcG9ydCB7IE9UcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnLi9vLXRyYW5zbGF0ZS5zZXJ2aWNlJztcblxuZXhwb3J0IGNsYXNzIE9UcmFuc2xhdGVIdHRwTG9hZGVyIGV4dGVuZHMgVHJhbnNsYXRlSHR0cExvYWRlciB7XG5cbiAgc3RhdGljIEJVTkRMRV9LRVkgPSAna2V5JztcbiAgc3RhdGljIEJVTkRMRV9WQUxVRSA9ICd2YWx1ZSc7XG5cbiAgcHJvdGVjdGVkIGFwcENvbmZpZzogQXBwQ29uZmlnO1xuICBwcm90ZWN0ZWQgaHR0cENsaWVudDogSHR0cENsaWVudDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBodHRwQ2xpZW50OiBIdHRwQ2xpZW50LFxuICAgIHByZWZpeDogc3RyaW5nID0gT1RyYW5zbGF0ZVNlcnZpY2UuQVNTRVRTX1BBVEgsXG4gICAgc3VmZml4OiBzdHJpbmcgPSBPVHJhbnNsYXRlU2VydmljZS5BU1NFVFNfRVhURU5TSU9OLFxuICAgIHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3JcbiAgKSB7XG4gICAgc3VwZXIoaHR0cENsaWVudCwgcHJlZml4LCBzdWZmaXgpO1xuICAgIHRoaXMuYXBwQ29uZmlnID0gdGhpcy5pbmplY3Rvci5nZXQoQXBwQ29uZmlnKTtcbiAgICB0aGlzLmh0dHBDbGllbnQgPSBodHRwQ2xpZW50O1xuICB9XG5cbiAgZ2V0QXNzZXRzUGF0aCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnByZWZpeDtcbiAgfVxuXG4gIGdldEFzc2V0c0V4dGVuc2lvbigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnN1ZmZpeDtcbiAgfVxuXG4gIGdldExvY2FsVHJhbnNsYXRpb24obGFuZzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBsZXQgaW5uZXJPYnNlcnZlcjogYW55O1xuICAgIGNvbnN0IGRhdGFPYnNlcnZhYmxlID0gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT4gaW5uZXJPYnNlcnZlciA9IG9ic2VydmVyKS5waXBlKHNoYXJlKCkpO1xuICAgIHN1cGVyLmdldFRyYW5zbGF0aW9uKGxhbmcpXG4gICAgICAuc3Vic2NyaWJlKChyZXMpID0+IHtcbiAgICAgICAgaW5uZXJPYnNlcnZlci5uZXh0KHJlcyk7XG4gICAgICAgIGlubmVyT2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgaW5uZXJPYnNlcnZlci5uZXh0KHVuZGVmaW5lZCk7XG4gICAgICB9LFxuICAgICAgICAoKSA9PiBpbm5lck9ic2VydmVyLmNvbXBsZXRlKCkpO1xuICAgIHJldHVybiBkYXRhT2JzZXJ2YWJsZTtcbiAgfVxuXG4gIGdldFRyYW5zbGF0aW9uKGxhbmc6IHN0cmluZyk6IGFueSB7XG4gICAgY29uc3QgdHJhbnNsYXRpb25PcmlnaW5zOiBhbnlbXSA9IFtdO1xuXG4gICAgdHJhbnNsYXRpb25PcmlnaW5zLnB1c2godGhpcy5nZXRMb2NhbFRyYW5zbGF0aW9uKGxhbmcpKTtcblxuICAgIGlmICh0aGlzLmFwcENvbmZpZy51c2VSZW1vdGVCdW5kbGUoKSkge1xuICAgICAgdHJhbnNsYXRpb25PcmlnaW5zLnB1c2godGhpcy5nZXRSZW1vdGVCdW5kbGUobGFuZykpO1xuICAgIH1cblxuICAgIGxldCBpbm5lck9ic2VydmVyOiBhbnk7XG4gICAgY29uc3QgZGF0YU9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiBpbm5lck9ic2VydmVyID0gb2JzZXJ2ZXIpLnBpcGUoc2hhcmUoKSk7XG5cbiAgICBjb21iaW5lTGF0ZXN0KHRyYW5zbGF0aW9uT3JpZ2lucykuc3Vic2NyaWJlKChyZXM6IGFueVtdKSA9PiB7XG4gICAgICBjb25zdCBzdGF0aWNCdW5kbGUgPSByZXNbMF0gfHwge307XG4gICAgICBjb25zdCByZW1vdGVCdW5kbGUgPSByZXNbMV0gfHwge307XG4gICAgICBjb25zdCBhbGxCdW5kbGVzID0gT2JqZWN0LmFzc2lnbihzdGF0aWNCdW5kbGUsIHJlbW90ZUJ1bmRsZSk7XG4gICAgICBpbm5lck9ic2VydmVyLm5leHQoYWxsQnVuZGxlcyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGRhdGFPYnNlcnZhYmxlO1xuICB9XG5cbiAgZ2V0UmVtb3RlQnVuZGxlKGxhbmc6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgYnVuZGxlRW5kcG9pbnQgPSB0aGlzLmFwcENvbmZpZy5nZXRCdW5kbGVFbmRwb2ludCgpO1xuICAgIGlmICghYnVuZGxlRW5kcG9pbnQpIHtcbiAgICAgIHJldHVybiBvZihbXSk7XG4gICAgfVxuICAgIGNvbnN0IHVybCA9IGJ1bmRsZUVuZHBvaW50ICsgJz9sYW5nPScgKyBsYW5nO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudC5nZXQodXJsKS5waXBlKFxuICAgICAgbWFwKChyZXNwOiBhbnkpID0+IHtcbiAgICAgICAgaWYgKHJlc3AuY29kZSA9PT0gQ29kZXMuT05USU1JWkVfU1VDQ0VTU0ZVTF9DT0RFKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucGFyc2VCdW5kbGVSZXNwb25zZShyZXNwLmRhdGEpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwO1xuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgQnVuZGxlIHNlcnZpY2UgaXMgbm90IGF2YWlsYWJsZScsIGVycik7XG4gICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2VCdW5kbGVSZXNwb25zZShkYXRhOiBhbnlbXSk6IGFueSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGRhdGEuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgICByZXN1bHRbaXRlbVtPVHJhbnNsYXRlSHR0cExvYWRlci5CVU5ETEVfS0VZXV0gPSBpdGVtW09UcmFuc2xhdGVIdHRwTG9hZGVyLkJVTkRMRV9WQUxVRV07XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG59XG4iXX0=